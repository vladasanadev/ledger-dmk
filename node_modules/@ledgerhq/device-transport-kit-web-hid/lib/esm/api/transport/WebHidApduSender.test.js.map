{
  "version": 3,
  "sources": ["../../../../src/api/transport/WebHidApduSender.test.ts"],
  "sourcesContent": ["import {\n  type ApduResponse,\n  type LoggerPublisherService,\n  SendApduTimeoutError,\n} from \"@ledgerhq/device-management-kit\";\nimport { Left, Maybe, Right } from \"purify-ts\";\n\nimport { WebHidSendReportError } from \"@api/model/Errors\";\n\nimport { WebHidApduSender } from \"./WebHidApduSender\";\n\ndescribe(\"WebHidApduSender\", () => {\n  const mockApduSender = {\n    getFrames: vi.fn(),\n  };\n\n  const mockApduReceiver = {\n    handleFrame: vi.fn(),\n  };\n\n  const mockLogger = {\n    info: vi.fn(),\n    debug: vi.fn(),\n    error: vi.fn(),\n  };\n\n  const mockDevice = {\n    oninputreport: vi.fn(),\n    open: vi.fn(),\n    close: vi.fn(),\n    sendReport: vi.fn(),\n  };\n\n  let webHidApduSender: WebHidApduSender;\n\n  beforeEach(() => {\n    vi.clearAllMocks();\n    const mockLoggerFactory = vi\n      .fn()\n      .mockReturnValue(mockLogger as unknown as LoggerPublisherService);\n    const mockApduSenderFactory = vi.fn().mockReturnValue(mockApduSender);\n    const mockApduReceiverFactory = vi.fn().mockReturnValue(mockApduReceiver);\n    webHidApduSender = new WebHidApduSender(\n      {\n        dependencies: { device: mockDevice as unknown as HIDDevice },\n        apduSenderFactory: mockApduSenderFactory,\n        apduReceiverFactory: mockApduReceiverFactory,\n      },\n      mockLoggerFactory,\n    );\n  });\n\n  afterEach(() => {\n    vi.restoreAllMocks();\n  });\n\n  it(\"should get dependencies\", () => {\n    const dependencies = webHidApduSender.getDependencies();\n    expect(dependencies).toEqual({\n      device: mockDevice as unknown as HIDDevice,\n    });\n  });\n\n  it(\"should set dependencies\", () => {\n    const newDevice: HIDDevice = {\n      oninputreport: null,\n      open: vi.fn(),\n      close: vi.fn(),\n      sendReport: vi.fn(),\n    } as unknown as HIDDevice;\n    webHidApduSender.setDependencies({ device: newDevice });\n    const dependencies = webHidApduSender.getDependencies();\n    expect(dependencies).toEqual({ device: newDevice });\n  });\n\n  it(\"should setup connection\", async () => {\n    await webHidApduSender.setupConnection();\n    expect(mockDevice.open).toHaveBeenCalled();\n    expect(mockDevice.oninputreport).toBeDefined();\n  });\n\n  it(\"should handle setup connection error\", async () => {\n    const error = new Error(\"Failed to open device\");\n    mockDevice.open = vi.fn().mockRejectedValue(error);\n    expect(webHidApduSender.setupConnection()).rejects.toThrowError();\n  });\n\n  it(\"should close connection\", () => {\n    webHidApduSender.closeConnection();\n    expect(mockDevice.close).toHaveBeenCalled();\n  });\n\n  it(\"should handle close connection error\", () => {\n    const error = new Error(\"Failed to close device\");\n    mockDevice.close = vi.fn().mockImplementation(() => {\n      throw error;\n    });\n    webHidApduSender.closeConnection();\n    expect(mockLogger.error).toHaveBeenCalledWith(\n      \"Error while closing device\",\n      {\n        data: { device: mockDevice, error },\n      },\n    );\n  });\n\n  it(\"should send APDU successfully\", async () => {\n    const apdu = new Uint8Array([0x00, 0x01, 0x02, 0x03]);\n    const frames = [\n      { getRawData: () => new Uint8Array([0x00, 0x01]) },\n      { getRawData: () => new Uint8Array([0x02, 0x03]) },\n    ];\n    const apduResponse = { data: new Uint8Array([0x90, 0x00]) } as ApduResponse;\n\n    mockApduSender.getFrames.mockReturnValue(frames);\n    mockDevice.sendReport.mockResolvedValue({});\n    mockApduReceiver.handleFrame.mockReturnValue(Right(Maybe.of(apduResponse)));\n\n    // Setup connection\n    await webHidApduSender.setupConnection();\n\n    // Send APDU\n    const promise = webHidApduSender.sendApdu(apdu);\n\n    // Receive response\n    mockDevice.oninputreport({ data: { buffer: Buffer.from([]) } });\n\n    // Await response\n    const result = await promise;\n    expect(mockDevice.sendReport).toHaveBeenCalled();\n    expect(result.isRight()).toBe(true);\n    expect(result.extract()).toEqual(apduResponse);\n  });\n\n  it(\"should handle send APDU error\", async () => {\n    const apdu = new Uint8Array([0x00, 0x01, 0x02, 0x03]);\n    const frames = [\n      { getRawData: () => new Uint8Array([0x00, 0x01]) },\n      { getRawData: () => new Uint8Array([0x02, 0x03]) },\n    ];\n    const error = new Error(\"Failed to send report\");\n\n    mockApduSender.getFrames.mockReturnValue(frames);\n    mockDevice.sendReport.mockRejectedValue(error);\n\n    await webHidApduSender.setupConnection();\n    const result = await webHidApduSender.sendApdu(apdu);\n    expect(result.isLeft()).toBe(true);\n    expect(result.extract()).toBeInstanceOf(WebHidSendReportError);\n  });\n\n  it(\"should handle received response error\", async () => {\n    const apdu = new Uint8Array([0x00, 0x01, 0x02, 0x03]);\n    const frames = [\n      { getRawData: () => new Uint8Array([0x00, 0x01]) },\n      { getRawData: () => new Uint8Array([0x02, 0x03]) },\n    ];\n    const apduError = new Error(\"Error while receiving APDU\");\n\n    mockApduSender.getFrames.mockReturnValue(frames);\n    mockDevice.sendReport.mockResolvedValue({});\n    mockApduReceiver.handleFrame.mockReturnValue(Left(apduError));\n\n    // Setup connection\n    await webHidApduSender.setupConnection();\n\n    // Send APDU\n    const promise = webHidApduSender.sendApdu(apdu);\n\n    // Receive response\n    mockDevice.oninputreport({ data: { buffer: Buffer.from([]) } });\n\n    // Await response\n    const result = await promise;\n    expect(mockDevice.sendReport).toHaveBeenCalled();\n    expect(result.isLeft()).toBe(true);\n    expect(result.extract()).toStrictEqual(apduError);\n  });\n\n  it(\"should handle send APDU timeout\", async () => {\n    const apdu = new Uint8Array([0x00, 0x01, 0x02, 0x03]);\n    const frames = [\n      { getRawData: () => new Uint8Array([0x00, 0x01]) },\n      { getRawData: () => new Uint8Array([0x02, 0x03]) },\n    ];\n\n    mockApduSender.getFrames.mockReturnValue(frames);\n    mockDevice.sendReport.mockResolvedValue({});\n\n    await webHidApduSender.setupConnection();\n    const result = await webHidApduSender.sendApdu(apdu, false, 100);\n    expect(result.isLeft()).toBe(true);\n    expect(result.extract()).toBeInstanceOf(SendApduTimeoutError);\n  });\n});\n"],
  "mappings": "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",
  "names": ["SendApduTimeoutError", "Left", "Maybe", "Right", "WebHidSendReportError", "WebHidApduSender", "mockApduSender", "mockApduReceiver", "mockLogger", "mockDevice", "webHidApduSender", "mockLoggerFactory", "mockApduSenderFactory", "mockApduReceiverFactory", "dependencies", "newDevice", "error", "apdu", "frames", "apduResponse", "promise", "result", "apduError"]
}

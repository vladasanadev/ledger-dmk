import{FramerUtils as c,OpeningConnectionError as a,SendApduTimeoutError as u}from"@ledgerhq/device-management-kit";import*as v from"@sentry/minimal";import{Left as p,Maybe as s,Nothing as m,Right as h}from"purify-ts";import{FRAME_SIZE as l}from"../data/WebHidConfig";import{WebHidSendReportError as A}from"../model/Errors";class b{dependencies;apduSender;apduReceiver;sendApduPromiseResolver;logger;constructor({dependencies:e,apduSenderFactory:t,apduReceiverFactory:d},r){const i=s.of(c.numberToByteArray(Math.floor(Math.random()*65535),2));this.logger=r("WebHidApduSender"),this.apduSender=t({frameSize:l,channel:i,padding:!0}),this.apduReceiver=d({channel:i}),this.sendApduPromiseResolver=m,this.dependencies=e,this.logger.info("\u{1F50C} Connected to device")}async sendApdu(e,t,d){let r;const i=new Promise(n=>{this.sendApduPromiseResolver=s.of((...o)=>(r&&clearTimeout(r),n(...o)))});for(const n of this.apduSender.getFrames(e))try{await this.dependencies.device.sendReport(0,new Uint8Array(n.getRawData()))}catch(o){return this.logger.info("Error sending frame",{data:{error:o}}),Promise.resolve(p(new A(o)))}return d&&(r=setTimeout(()=>{this.logger.debug("[sendApdu] Abort timeout",{data:{abortTimeout:d}}),this.sendApduPromiseResolver.map(n=>n(p(new u("Abort timeout"))))},d)),i}receiveHidInputReport(e){const t=new Uint8Array(e.data.buffer);this.apduReceiver.handleFrame(t).map(r=>{r.map(i=>{this.sendApduPromiseResolver.map(n=>n(h(i)))})}).mapLeft(r=>{this.sendApduPromiseResolver.map(i=>i(p(r)))})}getDependencies(){return this.dependencies}setDependencies(e){this.dependencies=e}async setupConnection(){try{this.dependencies.device.oninputreport=e=>this.receiveHidInputReport(e),await this.dependencies.device.open()}catch(e){if(e instanceof DOMException&&e.name==="InvalidStateError")this.logger.info("Device is already opened");else{const t=new a(e);throw this.logger.error("Error while opening device",{data:{error:e}}),v.captureException(t),e}}}closeConnection(){this.logger.info("\u{1F51A} Disconnect");try{this.dependencies.device.close()}catch(e){this.logger.error("Error while closing device",{data:{device:this.dependencies.device,error:e}})}}}export{b as WebHidApduSender};
//# sourceMappingURL=WebHidApduSender.js.map

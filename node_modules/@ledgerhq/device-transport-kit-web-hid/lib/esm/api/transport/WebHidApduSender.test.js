import{SendApduTimeoutError as u}from"@ledgerhq/device-management-kit";import{Left as p,Maybe as l,Right as x}from"purify-ts";import{WebHidSendReportError as m}from"../model/Errors";import{WebHidApduSender as f}from"./WebHidApduSender";describe("WebHidApduSender",()=>{const c={getFrames:vi.fn()},i={handleFrame:vi.fn()},d={info:vi.fn(),debug:vi.fn(),error:vi.fn()},t={oninputreport:vi.fn(),open:vi.fn(),close:vi.fn(),sendReport:vi.fn()};let n;beforeEach(()=>{vi.clearAllMocks();const e=vi.fn().mockReturnValue(d),r=vi.fn().mockReturnValue(c),o=vi.fn().mockReturnValue(i);n=new f({dependencies:{device:t},apduSenderFactory:r,apduReceiverFactory:o},e)}),afterEach(()=>{vi.restoreAllMocks()}),it("should get dependencies",()=>{const e=n.getDependencies();expect(e).toEqual({device:t})}),it("should set dependencies",()=>{const e={oninputreport:null,open:vi.fn(),close:vi.fn(),sendReport:vi.fn()};n.setDependencies({device:e});const r=n.getDependencies();expect(r).toEqual({device:e})}),it("should setup connection",async()=>{await n.setupConnection(),expect(t.open).toHaveBeenCalled(),expect(t.oninputreport).toBeDefined()}),it("should handle setup connection error",async()=>{const e=new Error("Failed to open device");t.open=vi.fn().mockRejectedValue(e),expect(n.setupConnection()).rejects.toThrowError()}),it("should close connection",()=>{n.closeConnection(),expect(t.close).toHaveBeenCalled()}),it("should handle close connection error",()=>{const e=new Error("Failed to close device");t.close=vi.fn().mockImplementation(()=>{throw e}),n.closeConnection(),expect(d.error).toHaveBeenCalledWith("Error while closing device",{data:{device:t,error:e}})}),it("should send APDU successfully",async()=>{const e=new Uint8Array([0,1,2,3]),r=[{getRawData:()=>new Uint8Array([0,1])},{getRawData:()=>new Uint8Array([2,3])}],o={data:new Uint8Array([144,0])};c.getFrames.mockReturnValue(r),t.sendReport.mockResolvedValue({}),i.handleFrame.mockReturnValue(x(l.of(o))),await n.setupConnection();const a=n.sendApdu(e);t.oninputreport({data:{buffer:Buffer.from([])}});const s=await a;expect(t.sendReport).toHaveBeenCalled(),expect(s.isRight()).toBe(!0),expect(s.extract()).toEqual(o)}),it("should handle send APDU error",async()=>{const e=new Uint8Array([0,1,2,3]),r=[{getRawData:()=>new Uint8Array([0,1])},{getRawData:()=>new Uint8Array([2,3])}],o=new Error("Failed to send report");c.getFrames.mockReturnValue(r),t.sendReport.mockRejectedValue(o),await n.setupConnection();const a=await n.sendApdu(e);expect(a.isLeft()).toBe(!0),expect(a.extract()).toBeInstanceOf(m)}),it("should handle received response error",async()=>{const e=new Uint8Array([0,1,2,3]),r=[{getRawData:()=>new Uint8Array([0,1])},{getRawData:()=>new Uint8Array([2,3])}],o=new Error("Error while receiving APDU");c.getFrames.mockReturnValue(r),t.sendReport.mockResolvedValue({}),i.handleFrame.mockReturnValue(p(o)),await n.setupConnection();const a=n.sendApdu(e);t.oninputreport({data:{buffer:Buffer.from([])}});const s=await a;expect(t.sendReport).toHaveBeenCalled(),expect(s.isLeft()).toBe(!0),expect(s.extract()).toStrictEqual(o)}),it("should handle send APDU timeout",async()=>{const e=new Uint8Array([0,1,2,3]),r=[{getRawData:()=>new Uint8Array([0,1])},{getRawData:()=>new Uint8Array([2,3])}];c.getFrames.mockReturnValue(r),t.sendReport.mockResolvedValue({}),await n.setupConnection();const o=await n.sendApdu(e,!1,100);expect(o.isLeft()).toBe(!0),expect(o.extract()).toBeInstanceOf(u)})});
//# sourceMappingURL=WebHidApduSender.test.js.map

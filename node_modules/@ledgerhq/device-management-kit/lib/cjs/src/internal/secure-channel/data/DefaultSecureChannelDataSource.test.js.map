{
  "version": 3,
  "sources": ["../../../../../../src/internal/secure-channel/data/DefaultSecureChannelDataSource.test.ts"],
  "sourcesContent": ["import WebSocket from \"isomorphic-ws\";\nimport { Right } from \"purify-ts\";\n\nimport { type DmkConfig } from \"@api/DmkConfig\";\nimport { WebSocketConnectionError } from \"@internal/secure-channel/model/Errors\";\n\nimport { DefaultSecureChannelDataSource } from \"./DefaultSecureChannelDataSource\";\nimport { type SecureChannelDataSource } from \"./SecureChannelDataSource\";\n\nvi.mock(\"isomorphic-ws\", () => {\n  // The chained mockImplementationOnce is used to simulate the WebSocket connection success and failure respectively, the order is important\n  return {\n    default: vi\n      .fn()\n      .mockImplementationOnce(() => {})\n      .mockImplementationOnce(() => {\n        throw new Error(\"WebSocket connection failed\");\n      }),\n  };\n});\n\ndescribe(\"Secure Channel Data Source\", () => {\n  describe(\"Connection establishment\", () => {\n    afterEach(() => {\n      vi.clearAllMocks();\n    });\n\n    it(\"should return an error if the WebSocket connection fails\", () => {\n      // given\n      const api = new DefaultSecureChannelDataSource({\n        webSocketUrl: \"wss://test-websocket-url\",\n      } as DmkConfig);\n\n      // when\n      const res = api._connectWebSocket(\"wss://test-websocket-url/test\");\n\n      // then\n      expect(WebSocket).toHaveBeenCalledWith(\"wss://test-websocket-url/test\");\n      expect(res.extract()).toBeInstanceOf(WebSocket);\n    });\n\n    it(\"should return an error if the WebSocket connection fails\", () => {\n      // given\n      const api = new DefaultSecureChannelDataSource({\n        webSocketUrl: \"wss://test-websocket-url\",\n      } as DmkConfig);\n\n      // when\n      const res = api._connectWebSocket(\"wss://test-websocket-url/test\");\n\n      // then\n      expect(res.extract()).toBeInstanceOf(WebSocketConnectionError);\n    });\n  });\n  describe(\"Connections with different pathname\", () => {\n    let api: SecureChannelDataSource;\n\n    beforeEach(() => {\n      api = new DefaultSecureChannelDataSource({\n        webSocketUrl: \"wss://test-websocket-url\",\n      } as DmkConfig);\n    });\n\n    afterEach(() => {\n      vi.clearAllMocks();\n    });\n\n    it(\"should call _connectWebSocket with parameters for genuineCheck\", () => {\n      // given\n      vi.spyOn(\n        api as DefaultSecureChannelDataSource,\n        \"_connectWebSocket\",\n      ).mockReturnValue(Right({} as WebSocket));\n\n      // when\n      api.genuineCheck({\n        targetId: \"targetId\",\n        perso: \"perso\",\n      });\n\n      // then\n      expect(\n        (api as DefaultSecureChannelDataSource)._connectWebSocket,\n      ).toHaveBeenCalledWith(\n        \"wss://test-websocket-url/genuine?targetId=targetId&perso=perso\",\n      );\n    });\n\n    it(\"should call _connectWebSocket with parameters for listInstalledApps\", () => {\n      // given\n      vi.spyOn(\n        api as DefaultSecureChannelDataSource,\n        \"_connectWebSocket\",\n      ).mockReturnValue(Right({} as WebSocket));\n\n      // when\n      api.listInstalledApps({\n        targetId: \"targetId\",\n        perso: \"perso\",\n      });\n\n      // then\n      expect(\n        (api as DefaultSecureChannelDataSource)._connectWebSocket,\n      ).toHaveBeenCalledWith(\n        \"wss://test-websocket-url/apps/list?targetId=targetId&perso=perso\",\n      );\n    });\n\n    it(\"should call _connectWebSocket with parameters for updateMcu\", () => {\n      // given\n      vi.spyOn(\n        api as DefaultSecureChannelDataSource,\n        \"_connectWebSocket\",\n      ).mockReturnValue(Right({} as WebSocket));\n\n      // when\n      api.updateMcu({\n        targetId: \"targetId\",\n        version: \"version\",\n      });\n\n      // then\n      expect(\n        (api as DefaultSecureChannelDataSource)._connectWebSocket,\n      ).toHaveBeenCalledWith(\n        \"wss://test-websocket-url/mcu?targetId=targetId&version=version\",\n      );\n    });\n\n    it(\"should call _connectWebSocket with parameters for updateFirmware\", () => {\n      // given\n      vi.spyOn(\n        api as DefaultSecureChannelDataSource,\n        \"_connectWebSocket\",\n      ).mockReturnValue(Right({} as WebSocket));\n\n      // when\n      api.updateFirmware({\n        targetId: \"targetId\",\n        perso: \"perso\",\n        firmware: \"firmware\",\n        firmwareKey: \"firmwareKey\",\n      });\n\n      // then\n      expect(\n        (api as DefaultSecureChannelDataSource)._connectWebSocket,\n      ).toHaveBeenCalledWith(\n        \"wss://test-websocket-url/install?targetId=targetId&perso=perso&firmware=firmware&firmwareKey=firmwareKey\",\n      );\n    });\n\n    it(\"should call _connectWebSocket with parameters for installApp\", () => {\n      // given\n      vi.spyOn(\n        api as DefaultSecureChannelDataSource,\n        \"_connectWebSocket\",\n      ).mockReturnValue(Right({} as WebSocket));\n\n      // when\n      api.installApp({\n        targetId: \"targetId\",\n        perso: \"perso\",\n        firmware: \"firmware\",\n        firmwareKey: \"firmwareKey\",\n        hash: \"hash\",\n      });\n\n      // then\n      expect(\n        (api as DefaultSecureChannelDataSource)._connectWebSocket,\n      ).toHaveBeenCalledWith(\n        \"wss://test-websocket-url/install?targetId=targetId&perso=perso&firmware=firmware&firmwareKey=firmwareKey&hash=hash\",\n      );\n    });\n\n    it(\"should call _connectWebSocket with parameters for uninstallApp\", () => {\n      // given\n      vi.spyOn(\n        api as DefaultSecureChannelDataSource,\n        \"_connectWebSocket\",\n      ).mockReturnValue(Right({} as WebSocket));\n\n      // when\n      api.uninstallApp({\n        targetId: \"targetId\",\n        perso: \"perso\",\n        firmware: \"firmware\",\n        firmwareKey: \"firmwareKey\",\n        hash: \"hash\",\n      });\n\n      // then\n      expect(\n        (api as DefaultSecureChannelDataSource)._connectWebSocket,\n      ).toHaveBeenCalledWith(\n        \"wss://test-websocket-url/install?targetId=targetId&perso=perso&firmware=firmware&firmwareKey=firmwareKey&hash=hash\",\n      );\n    });\n  });\n});\n"],
  "mappings": "wdAAA,IAAAA,EAAsB,4BACtBC,EAAsB,qBAGtBC,EAAyC,iDAEzCC,EAA+C,4CAG/C,GAAG,KAAK,gBAAiB,KAEhB,CACL,QAAS,GACN,GAAG,EACH,uBAAuB,IAAM,CAAC,CAAC,EAC/B,uBAAuB,IAAM,CAC5B,MAAM,IAAI,MAAM,6BAA6B,CAC/C,CAAC,CACL,EACD,EAED,SAAS,6BAA8B,IAAM,CAC3C,SAAS,2BAA4B,IAAM,CACzC,UAAU,IAAM,CACd,GAAG,cAAc,CACnB,CAAC,EAED,GAAG,2DAA4D,IAAM,CAOnE,MAAMC,EALM,IAAI,iCAA+B,CAC7C,aAAc,0BAChB,CAAc,EAGE,kBAAkB,+BAA+B,EAGjE,OAAO,EAAAC,OAAS,EAAE,qBAAqB,+BAA+B,EACtE,OAAOD,EAAI,QAAQ,CAAC,EAAE,eAAe,EAAAC,OAAS,CAChD,CAAC,EAED,GAAG,2DAA4D,IAAM,CAOnE,MAAMD,EALM,IAAI,iCAA+B,CAC7C,aAAc,0BAChB,CAAc,EAGE,kBAAkB,+BAA+B,EAGjE,OAAOA,EAAI,QAAQ,CAAC,EAAE,eAAe,0BAAwB,CAC/D,CAAC,CACH,CAAC,EACD,SAAS,sCAAuC,IAAM,CACpD,IAAIE,EAEJ,WAAW,IAAM,CACfA,EAAM,IAAI,iCAA+B,CACvC,aAAc,0BAChB,CAAc,CAChB,CAAC,EAED,UAAU,IAAM,CACd,GAAG,cAAc,CACnB,CAAC,EAED,GAAG,iEAAkE,IAAM,CAEzE,GAAG,MACDA,EACA,mBACF,EAAE,mBAAgB,SAAM,CAAC,CAAc,CAAC,EAGxCA,EAAI,aAAa,CACf,SAAU,WACV,MAAO,OACT,CAAC,EAGD,OACGA,EAAuC,iBAC1C,EAAE,qBACA,gEACF,CACF,CAAC,EAED,GAAG,sEAAuE,IAAM,CAE9E,GAAG,MACDA,EACA,mBACF,EAAE,mBAAgB,SAAM,CAAC,CAAc,CAAC,EAGxCA,EAAI,kBAAkB,CACpB,SAAU,WACV,MAAO,OACT,CAAC,EAGD,OACGA,EAAuC,iBAC1C,EAAE,qBACA,kEACF,CACF,CAAC,EAED,GAAG,8DAA+D,IAAM,CAEtE,GAAG,MACDA,EACA,mBACF,EAAE,mBAAgB,SAAM,CAAC,CAAc,CAAC,EAGxCA,EAAI,UAAU,CACZ,SAAU,WACV,QAAS,SACX,CAAC,EAGD,OACGA,EAAuC,iBAC1C,EAAE,qBACA,gEACF,CACF,CAAC,EAED,GAAG,mEAAoE,IAAM,CAE3E,GAAG,MACDA,EACA,mBACF,EAAE,mBAAgB,SAAM,CAAC,CAAc,CAAC,EAGxCA,EAAI,eAAe,CACjB,SAAU,WACV,MAAO,QACP,SAAU,WACV,YAAa,aACf,CAAC,EAGD,OACGA,EAAuC,iBAC1C,EAAE,qBACA,0GACF,CACF,CAAC,EAED,GAAG,+DAAgE,IAAM,CAEvE,GAAG,MACDA,EACA,mBACF,EAAE,mBAAgB,SAAM,CAAC,CAAc,CAAC,EAGxCA,EAAI,WAAW,CACb,SAAU,WACV,MAAO,QACP,SAAU,WACV,YAAa,cACb,KAAM,MACR,CAAC,EAGD,OACGA,EAAuC,iBAC1C,EAAE,qBACA,oHACF,CACF,CAAC,EAED,GAAG,iEAAkE,IAAM,CAEzE,GAAG,MACDA,EACA,mBACF,EAAE,mBAAgB,SAAM,CAAC,CAAc,CAAC,EAGxCA,EAAI,aAAa,CACf,SAAU,WACV,MAAO,QACP,SAAU,WACV,YAAa,cACb,KAAM,MACR,CAAC,EAGD,OACGA,EAAuC,iBAC1C,EAAE,qBACA,oHACF,CACF,CAAC,CACH,CAAC,CACH,CAAC",
  "names": ["import_isomorphic_ws", "import_purify_ts", "import_Errors", "import_DefaultSecureChannelDataSource", "res", "WebSocket", "api"]
}

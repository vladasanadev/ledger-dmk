"use strict";var p=Object.create;var c=Object.defineProperty;var u=Object.getOwnPropertyDescriptor;var h=Object.getOwnPropertyNames;var g=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var v=(a,e,r,d)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of h(e))!m.call(a,n)&&n!==r&&c(a,n,{get:()=>e[n],enumerable:!(d=u(e,n))||d.enumerable});return a};var _=(a,e,r)=>(r=a!=null?p(g(a)):{},v(e||!a||!a.__esModule?c(r,"default",{value:a,enumerable:!0}):r,a));var s=_(require("axios")),t=require("purify-ts"),o=require("../../../api/device-action/__test-utils__/data"),l=require("../../manager-api/model/Errors"),i=require("./AxiosManagerApiDataSource");vi.mock("axios");describe("AxiosManagerApiDataSource",()=>{describe("getAppList",()=>{let a;beforeEach(()=>{a=new i.AxiosManagerApiDataSource({})}),afterEach(()=>{vi.clearAllMocks()}),it("should return a list of applications",async()=>{const e=[o.BTC_APP_METADATA,o.ETH_APP_METADATA];vi.spyOn(s.default,"get").mockResolvedValue({data:e});const r=await a.getAppList({targetId:"targetId",firmwareVersionName:"firmwareVersionName"});expect(r).toEqual((0,t.Right)(e))}),it("should return an error if payload don't match the dto",async()=>{const{versionId:e,...r}=o.BTC_APP_METADATA,d=[{versionId:"invalidVersion",...r}];vi.spyOn(s.default,"get").mockResolvedValue({data:d});const n=await a.getAppList({targetId:"targetId",firmwareVersionName:"firmwareVersionName"});expect(n.isRight()).toEqual(!1)}),it("should return an error if the request fails",async()=>{const e=new Error("fetch error");vi.spyOn(s.default,"get").mockRejectedValue(e);const r=await a.getAppList({targetId:"targetId",firmwareVersionName:"firmwareVersionName"});expect(r).toEqual((0,t.Left)(new l.HttpFetchApiError(e)))})}),describe("getAppsByHash",()=>{describe("success cases",()=>{let a;beforeEach(()=>{a=new i.AxiosManagerApiDataSource({})}),afterEach(()=>{vi.clearAllMocks()}),it("with BTC app, should return the metadata",async()=>{vi.spyOn(s.default,"post").mockResolvedValue({data:[o.BTC_APP_METADATA]});const e=[o.BTC_APP.appFullHash],r=await a.getAppsByHash({hashes:e});expect(r).toEqual((0,t.Right)([o.BTC_APP_METADATA]))}),it("with no apps, should return an empty list",async()=>{vi.spyOn(s.default,"post").mockResolvedValue({data:[]});const e=[],r=await a.getAppsByHash({hashes:e});expect(r).toEqual((0,t.Right)([]))}),it("with BTC app and custom lock screen, should return the metadata",async()=>{vi.spyOn(s.default,"post").mockResolvedValue({data:[o.BTC_APP_METADATA,o.CUSTOM_LOCK_SCREEN_APP_METADATA]});const e=[o.BTC_APP.appFullHash,o.CUSTOM_LOCK_SCREEN_APP.appFullHash],r=await a.getAppsByHash({hashes:e});expect(r).toEqual((0,t.Right)([o.BTC_APP_METADATA,o.CUSTOM_LOCK_SCREEN_APP_METADATA]))})}),describe("error cases",()=>{let a;beforeEach(()=>{a=new i.AxiosManagerApiDataSource({})}),afterEach(()=>{vi.clearAllMocks()}),it("with BTC app, should fail if payload don't match the dto",async()=>{const{versionId:e,...r}=o.BTC_APP_METADATA;vi.spyOn(s.default,"post").mockResolvedValue({data:[{versionId:"invalidVersion",...r}]});const d=[o.BTC_APP.appFullHash],n=await a.getAppsByHash({hashes:d});expect(n.isRight()).toEqual(!1)}),it("should throw an error if the request fails",async()=>{const e=new i.AxiosManagerApiDataSource({}),r=new Error("fetch error");vi.spyOn(s.default,"post").mockRejectedValue(r);const d=[o.BTC_APP.appFullHash],n=await e.getAppsByHash({hashes:d});expect(n).toEqual((0,t.Left)(new l.HttpFetchApiError(r)))})})}),describe("getDeviceVersion",()=>{let a;beforeEach(()=>{a=new i.AxiosManagerApiDataSource({})}),afterEach(()=>{vi.clearAllMocks()}),it("should return a complete device version",async()=>{vi.spyOn(s.default,"get").mockResolvedValue({data:{id:17,target_id:"857735172"}});const e=await a.getDeviceVersion({targetId:"targetId"});expect(e).toEqual((0,t.Right)({id:17}))}),it("should return an error if payload don't match dto",async()=>{vi.spyOn(s.default,"get").mockResolvedValue({data:{target_id:"857735172"}});const e=await a.getDeviceVersion({targetId:"targetId"});expect(e.isRight()).toEqual(!1)}),it("should return an error if the request fails",async()=>{const e=new Error("fetch error");vi.spyOn(s.default,"get").mockRejectedValue(e);const r=await a.getDeviceVersion({targetId:"targetId"});expect(r).toEqual((0,t.Left)(new l.HttpFetchApiError(e)))})}),describe("getFirmwareVersion",()=>{let a;beforeEach(()=>{a=new i.AxiosManagerApiDataSource({})}),afterEach(()=>{vi.clearAllMocks()}),it("should return a complete firmware version",async()=>{vi.spyOn(s.default,"get").mockResolvedValue({data:{id:361,version:"1.6.0",perso:"perso_11",firmware:null,firmware_key:"testKey",hash:"hash",bytes:194,mcu_versions:[1,5,7]}});const e=await a.getFirmwareVersion({version:"versionName",deviceId:42});expect(e).toEqual((0,t.Right)({id:361,version:"1.6.0",perso:"perso_11",firmware:null,firmwareKey:"testKey",hash:"hash",bytes:194,mcuVersions:[1,5,7]}))}),it("should return an error if payload don't match the dto",async()=>{vi.spyOn(s.default,"get").mockResolvedValue({data:{id:"invalidId",version:"1.6.0",perso:"perso_11",firmware:null,firmware_key:"testKey",hash:"hash",bytes:194,mcu_versions:[1,5,7]}});const e=await a.getFirmwareVersion({version:"versionName",deviceId:42});expect(e.isRight()).toEqual(!1)}),it("should return an error if the request fails",async()=>{const e=new Error("fetch error");vi.spyOn(s.default,"get").mockRejectedValue(e);const r=await a.getFirmwareVersion({version:"versionName",deviceId:42});expect(r).toEqual((0,t.Left)(new l.HttpFetchApiError(e)))})}),describe("setProvider",()=>{let a;beforeEach(()=>{a=new i.AxiosManagerApiDataSource({managerApiUrl:"http://fake-url.com",provider:1})}),it("should not change the provider if the new value is the same",()=>{const e=a._provider;a.setProvider(e),expect(a._provider).toBe(e)}),it("should not change the provider if the new value is less than 1",()=>{const e=a._provider;a.setProvider(0),a.setProvider(-5),expect(a._provider).toBe(e)}),it("should update the provider if a valid and different value is provided",()=>{a.setProvider(2),expect(a._provider).toBe(2)})}),describe("getFirmwareVersionById",()=>{let a;beforeEach(()=>{a=new i.AxiosManagerApiDataSource({})}),afterEach(()=>{vi.clearAllMocks()}),it("should return a complete firmware version",async()=>{vi.spyOn(s.default,"get").mockResolvedValue({data:{id:361,version:"1.6.0",perso:"perso_11",firmware:null,firmware_key:"testKey",hash:"hash",bytes:194,mcu_versions:[1,5,7]}});const e=await a.getFirmwareVersionById(42);expect(e).toEqual((0,t.Right)({id:361,version:"1.6.0",perso:"perso_11",firmware:null,firmwareKey:"testKey",hash:"hash",bytes:194,mcuVersions:[1,5,7]}))})}),describe("getLatestFirmwareVersion",()=>{let a;beforeEach(()=>{a=new i.AxiosManagerApiDataSource({})}),afterEach(()=>{vi.clearAllMocks()}),it("should return the latest firmware version",async()=>{vi.spyOn(s.default,"get").mockResolvedValue({data:{result:"success",se_firmware_osu_version:{id:361,perso:"perso_11",firmware:"test",firmware_key:"testKey",hash:"hash",next_se_firmware_final_version:567}}});const e=await a.getLatestFirmwareVersion({currentFinalFirmwareId:200,deviceId:42});expect(e).toEqual((0,t.Right)({id:361,perso:"perso_11",firmware:"test",firmwareKey:"testKey",hash:"hash",nextFinalFirmware:567}))}),it("should return an error if result is not success",async()=>{vi.spyOn(s.default,"get").mockResolvedValue({data:{result:"failed",se_firmware_osu_version:null}});const e=await a.getLatestFirmwareVersion({currentFinalFirmwareId:200,deviceId:42});expect(e.isRight()).toEqual(!1)}),it("should return an error if payload don't match the dto",async()=>{vi.spyOn(s.default,"get").mockResolvedValue({data:{result:"success",se_firmware_osu_version:{id:"InvalidId",perso:"perso_11",firmware:"test",firmware_key:"testKey",hash:"hash",next_se_firmware_final_version:567}}});const e=await a.getLatestFirmwareVersion({currentFinalFirmwareId:200,deviceId:42});expect(e.isRight()).toEqual(!1)}),it("should return an error if the request fails",async()=>{const e=new Error("fetch error");vi.spyOn(s.default,"get").mockRejectedValue(e);const r=await a.getLatestFirmwareVersion({currentFinalFirmwareId:200,deviceId:42});expect(r).toEqual((0,t.Left)(new l.HttpFetchApiError(e)))})}),describe("getOsuFirmwareVersion",()=>{let a;beforeEach(()=>{a=new i.AxiosManagerApiDataSource({})}),afterEach(()=>{vi.clearAllMocks()}),it("should return a complete OSU firmware version",async()=>{vi.spyOn(s.default,"get").mockResolvedValue({data:{id:361,perso:"perso_11",firmware:"test",firmware_key:"testKey",hash:"hash",next_se_firmware_final_version:567}});const e=await a.getOsuFirmwareVersion({version:"versionName",deviceId:42});expect(e).toEqual((0,t.Right)({id:361,perso:"perso_11",firmware:"test",firmwareKey:"testKey",hash:"hash",nextFinalFirmware:567}))}),it("should return an error if payload don't match the dto",async()=>{vi.spyOn(s.default,"get").mockResolvedValue({data:{id:"invalidId",perso:"perso_11",firmware:"test",firmware_key:"testKey",hash:"hash",next_se_firmware_final_version:567}});const e=await a.getOsuFirmwareVersion({version:"versionName",deviceId:42});expect(e.isRight()).toEqual(!1)}),it("should return an error if the request fails",async()=>{const e=new Error("fetch error");vi.spyOn(s.default,"get").mockRejectedValue(e);const r=await a.getOsuFirmwareVersion({version:"versionName",deviceId:42});expect(r).toEqual((0,t.Left)(new l.HttpFetchApiError(e)))})}),describe("getLanguagePackages",()=>{let a;beforeEach(()=>{a=new i.AxiosManagerApiDataSource({})}),afterEach(()=>{vi.clearAllMocks()}),it("should return the langage packages version",async()=>{vi.spyOn(s.default,"get").mockResolvedValue({data:[{language:"turkish",languagePackageVersionId:474,version:"0.0.4",language_package_id:57,apdu_install_url:"https://download.languages.ledger.com/stax/turkish/bolos_1.6.2_pack_0.0.4_tr.apdu",apdu_uninstall_url:"https://download.languages.ledger.com/stax/turkish/bolos_1.6.2_pack_0.0.4_tr_del.apdu",device_versions:[17],se_firmware_final_versions:[432],bytes:20800,date_creation:"2025-03-04T10:48:27.910630Z",date_last_modified:"2025-03-04T10:48:27.910630Z"},{language:"russian",languagePackageVersionId:470,version:"0.0.4",language_package_id:56,apdu_install_url:"https://download.languages.ledger.com/stax/russian/bolos_1.6.2_pack_0.0.4_ru.apdu",apdu_uninstall_url:"https://download.languages.ledger.com/stax/russian/bolos_1.6.2_pack_0.0.4_ru_del.apdu",device_versions:[17],se_firmware_final_versions:[432],bytes:46592,date_creation:"2025-03-04T10:48:26.218729Z",date_last_modified:"2025-03-04T10:48:26.218729Z"}]});const e=await a.getLanguagePackages({deviceId:1,currentFinalFirmwareId:42});expect(e).toEqual((0,t.Right)([{language:"turkish",languagePackageVersionId:474,version:"0.0.4",languagePackageId:57,apduInstallUrl:"https://download.languages.ledger.com/stax/turkish/bolos_1.6.2_pack_0.0.4_tr.apdu",apduUninstallUrl:"https://download.languages.ledger.com/stax/turkish/bolos_1.6.2_pack_0.0.4_tr_del.apdu",bytes:20800,dateCreation:"2025-03-04T10:48:27.910630Z",dateLastModified:"2025-03-04T10:48:27.910630Z"},{language:"russian",languagePackageVersionId:470,version:"0.0.4",languagePackageId:56,apduInstallUrl:"https://download.languages.ledger.com/stax/russian/bolos_1.6.2_pack_0.0.4_ru.apdu",apduUninstallUrl:"https://download.languages.ledger.com/stax/russian/bolos_1.6.2_pack_0.0.4_ru_del.apdu",bytes:46592,dateCreation:"2025-03-04T10:48:26.218729Z",dateLastModified:"2025-03-04T10:48:26.218729Z"}]))}),it("should return an error if payload don't match the dto",async()=>{vi.spyOn(s.default,"get").mockResolvedValue({data:[{language:"turkish",version:"0.0.4",language_package_id:"invalid"}]});const e=await a.getLanguagePackages({deviceId:1,currentFinalFirmwareId:42});expect(e.isRight()).toEqual(!1)}),it("should return an error if the request fails",async()=>{const e=new Error("fetch error");vi.spyOn(s.default,"get").mockRejectedValue(e);const r=await a.getLanguagePackages({deviceId:1,currentFinalFirmwareId:42});expect(r).toEqual((0,t.Left)(new l.HttpFetchApiError(e)))})}),describe("getMcuList",()=>{let a;beforeEach(()=>{a=new i.AxiosManagerApiDataSource({})}),afterEach(()=>{vi.clearAllMocks()}),it("should return a the list of MCUs",async()=>{vi.spyOn(s.default,"get").mockResolvedValue({data:[{id:1,mcu:1,name:"1.0",description:null,providers:[],device_versions:[1,2],from_bootloader_version:"",from_bootloader_version_id:2,se_firmware_final_versions:[7,12,13,14,15],date_creation:"2018-09-20T13:30:50.156394Z",date_last_modified:"2018-09-20T13:30:50.156453Z"},{id:2,mcu:1,name:"1.1",description:null,providers:[],device_versions:[1,2],from_bootloader_version:"",from_bootloader_version_id:2,se_firmware_final_versions:[7,12,13,14,15],date_creation:"2018-09-20T13:30:50.339966Z",date_last_modified:"2018-09-20T13:30:50.340031Z"}]});const e=await a.getMcuList();expect(e).toEqual((0,t.Right)([{id:1,name:"1.0"},{id:2,name:"1.1"}]))}),it("should return an error when the payload don't match the dto",async()=>{vi.spyOn(s.default,"get").mockResolvedValue({data:[{id:"invalid id",mcu:1,name:"1.0",description:null,providers:[],se_firmware_final_versions:[7,12,13,14,15],date_creation:"2018-09-20T13:30:50.156394Z",date_last_modified:"2018-09-20T13:30:50.156453Z"}]});const e=await a.getMcuList();expect(e.isRight()).toEqual(!1)}),it("should return an error if the request fails",async()=>{const e=new Error("fetch error");vi.spyOn(s.default,"get").mockRejectedValue(e);const r=await a.getMcuList();expect(r).toEqual((0,t.Left)(new l.HttpFetchApiError(e)))})}),describe("getProvider",()=>{let a;beforeEach(()=>{a=new i.AxiosManagerApiDataSource({managerApiUrl:"http://fake-url.com",provider:123})}),afterEach(()=>{vi.clearAllMocks()}),it("should return the initial provider",()=>{expect(a.getProvider()).toBe(123)}),it("should return the updated provider after setProvider is called",()=>{a.setProvider(321),expect(a.getProvider()).toBe(321)})})});
//# sourceMappingURL=AxiosManagerApiDataSource.test.js.map

{
  "version": 3,
  "sources": ["../../../../../../src/internal/discovery/use-case/ConnectUseCase.test.ts"],
  "sourcesContent": ["import { Left, Maybe, Right } from \"purify-ts\";\n\nimport { type DeviceModel, type DeviceModelId } from \"@api/device/DeviceModel\";\nimport { type DeviceSessionState } from \"@api/device-session/DeviceSessionState\";\nimport { type ConnectionType } from \"@api/discovery/ConnectionType\";\nimport { type DmkConfig } from \"@api/DmkConfig\";\nimport { type LoggerPublisherService } from \"@api/logger-publisher/service/LoggerPublisherService\";\nimport { TransportMock } from \"@api/transport/model/__mocks__/TransportMock\";\nimport { type ConnectedDevice } from \"@api/transport/model/ConnectedDevice\";\nimport { type DiscoveredDevice } from \"@api/transport/model/DiscoveredDevice\";\nimport { UnknownDeviceError } from \"@api/transport/model/Errors\";\nimport { type Transport } from \"@api/transport/model/Transport\";\nimport { connectedDeviceStubBuilder } from \"@api/transport/model/TransportConnectedDevice.stub\";\nimport { DefaultDeviceSessionService } from \"@internal/device-session/service/DefaultDeviceSessionService\";\nimport { type DeviceSessionService } from \"@internal/device-session/service/DeviceSessionService\";\nimport { DefaultLoggerPublisherService } from \"@internal/logger-publisher/service/DefaultLoggerPublisherService\";\nimport { AxiosManagerApiDataSource } from \"@internal/manager-api/data/AxiosManagerApiDataSource\";\nimport { type ManagerApiDataSource } from \"@internal/manager-api/data/ManagerApiDataSource\";\nimport { DefaultManagerApiService } from \"@internal/manager-api/service/DefaultManagerApiService\";\nimport { type ManagerApiService } from \"@internal/manager-api/service/ManagerApiService\";\nimport { DefaultSecureChannelDataSource } from \"@internal/secure-channel/data/DefaultSecureChannelDataSource\";\nimport { type SecureChannelDataSource } from \"@internal/secure-channel/data/SecureChannelDataSource\";\nimport { DefaultSecureChannelService } from \"@internal/secure-channel/service/DefaultSecureChannelService\";\nimport { type SecureChannelService } from \"@internal/secure-channel/service/SecureChannelService\";\nimport { DefaultTransportService } from \"@internal/transport/service/DefaultTransportService\";\nimport { type TransportService } from \"@internal/transport/service/TransportService\";\n\nimport { ConnectUseCase } from \"./ConnectUseCase\";\n\nvi.mock(\"uuid\", () => ({\n  v4: vi.fn().mockReturnValue(\"fakeSessionId\"),\n}));\n\nvi.mock(\"@internal/manager-api/data/AxiosManagerApiDataSource\");\nvi.mock(\"@internal/transport/service/DefaultTransportService\");\n\n// TODO test several transports\n// let transports: WebUsbHidTransport[];\nlet transport: Transport;\nlet transportService: TransportService;\nlet logger: LoggerPublisherService;\nlet sessionService: DeviceSessionService;\nlet managerApi: ManagerApiService;\nlet managerApiDataSource: ManagerApiDataSource;\nlet secureChannelDataSource: SecureChannelDataSource;\nlet secureChannel: SecureChannelService;\nconst fakeSessionId = \"fakeSessionId\";\nconst fakeSessionIdConnectedDevice = \"fakeSessionIdConnectedDevice\";\n\ndescribe(\"ConnectUseCase\", () => {\n  const stubDiscoveredDevice: DiscoveredDevice = {\n    id: \"\",\n    deviceModel: {} as DeviceModel,\n    transport: \"USB\",\n    name: \"TEST\",\n  };\n  const stubTransportConnectedDevice = connectedDeviceStubBuilder({ id: \"1\" });\n  const stubConnectedDevice = {\n    id: \"1\",\n    sessionId: fakeSessionIdConnectedDevice,\n    modelId: \"model-id\" as unknown as DeviceModelId,\n    name: \"device-name\",\n    type: \"MOCK\" as unknown as ConnectionType,\n    transport: \"USB\",\n  } as unknown as ConnectedDevice;\n  const tag = \"logger-tag\";\n\n  beforeAll(() => {\n    logger = new DefaultLoggerPublisherService([], tag);\n    transport = new TransportMock();\n    sessionService = new DefaultDeviceSessionService(() => logger);\n    managerApiDataSource = new AxiosManagerApiDataSource({} as DmkConfig);\n    managerApi = new DefaultManagerApiService(managerApiDataSource);\n    secureChannelDataSource = new DefaultSecureChannelDataSource(\n      {} as DmkConfig,\n    );\n    secureChannel = new DefaultSecureChannelService(secureChannelDataSource);\n    // @ts-expect-error mock\n    transportService = new DefaultTransportService();\n  });\n\n  afterEach(() => {\n    for (const session of sessionService.getDeviceSessions()) {\n      sessionService.removeDeviceSession(session.id);\n    }\n  });\n\n  afterAll(() => {\n    vi.restoreAllMocks();\n  });\n\n  test(\"If connect use case encounter an error, return it\", async () => {\n    vi.spyOn(transport, \"connect\").mockResolvedValue(\n      Left(new UnknownDeviceError()),\n    );\n\n    vi.spyOn(transportService, \"getTransport\").mockReturnValue(\n      Maybe.of(transport),\n    );\n\n    const usecase = new ConnectUseCase(\n      transportService,\n      sessionService,\n      () => logger,\n      managerApi,\n      secureChannel,\n    );\n\n    await expect(\n      usecase.execute({ device: stubDiscoveredDevice }),\n    ).rejects.toBeInstanceOf(UnknownDeviceError);\n  });\n\n  test(\"If connect is in success, return a deviceSession id\", async () => {\n    vi.spyOn(transport, \"connect\").mockResolvedValue(\n      Right(stubTransportConnectedDevice),\n    );\n    vi.spyOn(transportService, \"getTransport\").mockReturnValue(\n      Maybe.of(transport),\n    );\n    vi.spyOn(sessionService, \"addDeviceSession\").mockImplementation(\n      (deviceSession) => {\n        deviceSession.setDeviceSessionState({} as DeviceSessionState);\n        return sessionService;\n      },\n    );\n\n    const usecase = new ConnectUseCase(\n      transportService,\n      sessionService,\n      () => logger,\n      managerApi,\n      secureChannel,\n    );\n\n    const sessionId = await usecase.execute({\n      device: stubDiscoveredDevice,\n    });\n    expect(sessionId).toBe(fakeSessionId);\n    sessionService.removeDeviceSession(sessionId);\n  });\n\n  test(\"If connect is in success after a reconnect, return the same deviceSession id\", async () => {\n    vi.spyOn(transport, \"connect\").mockResolvedValue(\n      Right(stubTransportConnectedDevice),\n    );\n    vi.spyOn(transportService, \"getTransport\").mockReturnValue(\n      Maybe.of(transport),\n    );\n    vi.spyOn(sessionService, \"addDeviceSession\").mockImplementation(\n      (deviceSession) => {\n        deviceSession.setDeviceSessionState({} as DeviceSessionState);\n        return sessionService;\n      },\n    );\n\n    const usecase = new ConnectUseCase(\n      transportService,\n      sessionService,\n      () => logger,\n      managerApi,\n      secureChannel,\n    );\n\n    const sessionId = await usecase.execute({\n      device: stubConnectedDevice,\n    });\n    expect(sessionId).toBe(fakeSessionIdConnectedDevice); // same session id as the connected device\n    sessionService.removeDeviceSession(sessionId);\n  });\n});\n"],
  "mappings": "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",
  "names": ["import_purify_ts", "import_TransportMock", "import_Errors", "import_TransportConnectedDevice", "import_DefaultDeviceSessionService", "import_DefaultLoggerPublisherService", "import_AxiosManagerApiDataSource", "import_DefaultManagerApiService", "import_DefaultSecureChannelDataSource", "import_DefaultSecureChannelService", "import_DefaultTransportService", "import_ConnectUseCase", "transport", "transportService", "logger", "sessionService", "managerApi", "managerApiDataSource", "secureChannelDataSource", "secureChannel", "fakeSessionId", "fakeSessionIdConnectedDevice", "stubDiscoveredDevice", "stubTransportConnectedDevice", "stubConnectedDevice", "tag", "session", "usecase", "deviceSession", "sessionId"]
}

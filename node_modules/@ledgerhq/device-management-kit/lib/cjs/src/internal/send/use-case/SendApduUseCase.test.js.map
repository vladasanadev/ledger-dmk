{
  "version": 3,
  "sources": ["../../../../../../src/internal/send/use-case/SendApduUseCase.test.ts"],
  "sourcesContent": ["import { Left } from \"purify-ts\";\n\nimport { type DmkConfig } from \"@api/DmkConfig\";\nimport { type LoggerPublisherService } from \"@api/logger-publisher/service/LoggerPublisherService\";\nimport { connectedDeviceStubBuilder } from \"@api/transport/model/TransportConnectedDevice.stub\";\nimport { DEVICE_SESSION_REFRESHER_DEFAULT_OPTIONS } from \"@internal/device-session/data/DeviceSessionRefresherConst\";\nimport { deviceSessionStubBuilder } from \"@internal/device-session/model/DeviceSession.stub\";\nimport {\n  DeviceSessionNotFound,\n  ReceiverApduError,\n} from \"@internal/device-session/model/Errors\";\nimport { DefaultDeviceSessionService } from \"@internal/device-session/service/DefaultDeviceSessionService\";\nimport { type DeviceSessionService } from \"@internal/device-session/service/DeviceSessionService\";\nimport { DefaultLoggerPublisherService } from \"@internal/logger-publisher/service/DefaultLoggerPublisherService\";\nimport { AxiosManagerApiDataSource } from \"@internal/manager-api/data/AxiosManagerApiDataSource\";\nimport { type ManagerApiDataSource } from \"@internal/manager-api/data/ManagerApiDataSource\";\nimport { DefaultManagerApiService } from \"@internal/manager-api/service/DefaultManagerApiService\";\nimport { type ManagerApiService } from \"@internal/manager-api/service/ManagerApiService\";\nimport { DefaultSecureChannelDataSource } from \"@internal/secure-channel/data/DefaultSecureChannelDataSource\";\nimport { type SecureChannelDataSource } from \"@internal/secure-channel/data/SecureChannelDataSource\";\nimport { DefaultSecureChannelService } from \"@internal/secure-channel/service/DefaultSecureChannelService\";\nimport { type SecureChannelService } from \"@internal/secure-channel/service/SecureChannelService\";\nimport { SendApduUseCase } from \"@internal/send/use-case/SendApduUseCase\";\n\nvi.mock(\"@internal/manager-api/data/AxiosManagerApiDataSource\");\n\nlet logger: LoggerPublisherService;\nlet sessionService: DeviceSessionService;\nlet managerApiDataSource: ManagerApiDataSource;\nlet managerApi: ManagerApiService;\nlet secureChannelDataSource: SecureChannelDataSource;\nlet secureChannel: SecureChannelService;\nconst fakeSessionId = \"fakeSessionId\";\n\ndescribe(\"SendApduUseCase\", () => {\n  beforeEach(() => {\n    logger = new DefaultLoggerPublisherService([], \"send-apdu-use-case\");\n    sessionService = new DefaultDeviceSessionService(() => logger);\n    managerApiDataSource = new AxiosManagerApiDataSource({} as DmkConfig);\n    managerApi = new DefaultManagerApiService(managerApiDataSource);\n    secureChannelDataSource = new DefaultSecureChannelDataSource(\n      {} as DmkConfig,\n    );\n    secureChannel = new DefaultSecureChannelService(secureChannelDataSource);\n  });\n\n  it(\"should send an APDU to a connected device\", async () => {\n    // given\n    const deviceSession = deviceSessionStubBuilder(\n      {},\n      () => logger,\n      managerApi,\n      secureChannel,\n      DEVICE_SESSION_REFRESHER_DEFAULT_OPTIONS,\n    );\n    sessionService.addDeviceSession(deviceSession);\n    const useCase = new SendApduUseCase(sessionService, () => logger);\n\n    // when\n    const response = await useCase.execute({\n      sessionId: fakeSessionId,\n      apdu: new Uint8Array([0x00, 0x01, 0x02, 0x03]),\n    });\n\n    deviceSession.close();\n    // then\n    expect(deviceSession.connectedDevice.sendApdu).toHaveBeenCalledTimes(1);\n    expect(response).toBeDefined();\n  });\n\n  it(\"should throw an error if the deviceSession is not found\", async () => {\n    // given\n    const useCase = new SendApduUseCase(sessionService, () => logger);\n\n    // when\n    const response = useCase.execute({\n      sessionId: fakeSessionId,\n      apdu: new Uint8Array([0x00, 0x01, 0x02, 0x03]),\n    });\n\n    // then\n    await expect(response).rejects.toBeInstanceOf(DeviceSessionNotFound);\n  });\n\n  it(\"should throw an error if the apdu receiver failed\", async () => {\n    // given\n    const connectedDevice = connectedDeviceStubBuilder({\n      sendApdu: vi.fn(async () =>\n        Promise.resolve(Left(new ReceiverApduError())),\n      ),\n    });\n    const deviceSession = deviceSessionStubBuilder(\n      { connectedDevice },\n      () => logger,\n      managerApi,\n      secureChannel,\n      DEVICE_SESSION_REFRESHER_DEFAULT_OPTIONS,\n    );\n    sessionService.addDeviceSession(deviceSession);\n    const useCase = new SendApduUseCase(sessionService, () => logger);\n\n    // when\n    const response = useCase.execute({\n      sessionId: fakeSessionId,\n      apdu: new Uint8Array([0x00, 0x01, 0x02, 0x03]),\n    });\n\n    deviceSession.close();\n\n    // then\n    await expect(response).rejects.toBeInstanceOf(ReceiverApduError);\n  });\n});\n"],
  "mappings": "aAAA,IAAAA,EAAqB,qBAIrBC,EAA2C,8DAC3CC,EAAyD,qEACzDC,EAAyC,6DACzCC,EAGO,iDACPC,EAA4C,wEAE5CC,EAA8C,4EAC9CC,EAA0C,gEAE1CC,EAAyC,kEAEzCC,EAA+C,wEAE/CC,EAA4C,wEAE5CC,EAAgC,mDAEhC,GAAG,KAAK,sDAAsD,EAE9D,IAAIC,EACAC,EACAC,EACAC,EACAC,EACAC,EACJ,MAAMC,EAAgB,gBAEtB,SAAS,kBAAmB,IAAM,CAChC,WAAW,IAAM,CACfN,EAAS,IAAI,gCAA8B,CAAC,EAAG,oBAAoB,EACnEC,EAAiB,IAAI,8BAA4B,IAAMD,CAAM,EAC7DE,EAAuB,IAAI,4BAA0B,CAAC,CAAc,EACpEC,EAAa,IAAI,2BAAyBD,CAAoB,EAC9DE,EAA0B,IAAI,iCAC5B,CAAC,CACH,EACAC,EAAgB,IAAI,8BAA4BD,CAAuB,CACzE,CAAC,EAED,GAAG,4CAA6C,SAAY,CAE1D,MAAMG,KAAgB,4BACpB,CAAC,EACD,IAAMP,EACNG,EACAE,EACA,0CACF,EACAJ,EAAe,iBAAiBM,CAAa,EAI7C,MAAMC,EAAW,MAHD,IAAI,kBAAgBP,EAAgB,IAAMD,CAAM,EAGjC,QAAQ,CACrC,UAAWM,EACX,KAAM,IAAI,WAAW,CAAC,EAAM,EAAM,EAAM,CAAI,CAAC,CAC/C,CAAC,EAEDC,EAAc,MAAM,EAEpB,OAAOA,EAAc,gBAAgB,QAAQ,EAAE,sBAAsB,CAAC,EACtE,OAAOC,CAAQ,EAAE,YAAY,CAC/B,CAAC,EAED,GAAG,0DAA2D,SAAY,CAKxE,MAAMA,EAHU,IAAI,kBAAgBP,EAAgB,IAAMD,CAAM,EAGvC,QAAQ,CAC/B,UAAWM,EACX,KAAM,IAAI,WAAW,CAAC,EAAM,EAAM,EAAM,CAAI,CAAC,CAC/C,CAAC,EAGD,MAAM,OAAOE,CAAQ,EAAE,QAAQ,eAAe,uBAAqB,CACrE,CAAC,EAED,GAAG,oDAAqD,SAAY,CAElE,MAAMC,KAAkB,8BAA2B,CACjD,SAAU,GAAG,GAAG,SACd,QAAQ,WAAQ,QAAK,IAAI,mBAAmB,CAAC,CAC/C,CACF,CAAC,EACKF,KAAgB,4BACpB,CAAE,gBAAAE,CAAgB,EAClB,IAAMT,EACNG,EACAE,EACA,0CACF,EACAJ,EAAe,iBAAiBM,CAAa,EAI7C,MAAMC,EAHU,IAAI,kBAAgBP,EAAgB,IAAMD,CAAM,EAGvC,QAAQ,CAC/B,UAAWM,EACX,KAAM,IAAI,WAAW,CAAC,EAAM,EAAM,EAAM,CAAI,CAAC,CAC/C,CAAC,EAEDC,EAAc,MAAM,EAGpB,MAAM,OAAOC,CAAQ,EAAE,QAAQ,eAAe,mBAAiB,CACjE,CAAC,CACH,CAAC",
  "names": ["import_purify_ts", "import_TransportConnectedDevice", "import_DeviceSessionRefresherConst", "import_DeviceSession", "import_Errors", "import_DefaultDeviceSessionService", "import_DefaultLoggerPublisherService", "import_AxiosManagerApiDataSource", "import_DefaultManagerApiService", "import_DefaultSecureChannelDataSource", "import_DefaultSecureChannelService", "import_SendApduUseCase", "logger", "sessionService", "managerApiDataSource", "managerApi", "secureChannelDataSource", "secureChannel", "fakeSessionId", "deviceSession", "response", "connectedDevice"]
}

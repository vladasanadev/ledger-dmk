{
  "version": 3,
  "sources": ["../../../../../../src/internal/transport/service/DefaultTransportService.ts"],
  "sourcesContent": ["import { inject, injectable } from \"inversify\";\nimport { Either, Left, Maybe, Right } from \"purify-ts\";\n\nimport { type DeviceModelDataSource } from \"@api/device-model/data/DeviceModelDataSource\";\nimport { type ApduReceiverServiceFactory } from \"@api/device-session/service/ApduReceiverService\";\nimport { type ApduSenderServiceFactory } from \"@api/device-session/service/ApduSenderService\";\nimport { type DmkConfig } from \"@api/DmkConfig\";\nimport { LoggerPublisherService } from \"@api/logger-publisher/service/LoggerPublisherService\";\nimport {\n  NoTransportProvidedError,\n  TransportAlreadyExistsError,\n} from \"@api/transport/model/Errors\";\nimport { TransportFactory } from \"@api/transport/model/Transport\";\nimport { TransportConnectedDevice } from \"@api/transport/model/TransportConnectedDevice\";\nimport { Transport } from \"@api/types\";\nimport { deviceModelTypes } from \"@internal/device-model/di/deviceModelTypes\";\nimport { deviceSessionTypes } from \"@internal/device-session/di/deviceSessionTypes\";\nimport { loggerTypes } from \"@internal/logger-publisher/di/loggerTypes\";\nimport { transportDiTypes } from \"@internal/transport/di/transportDiTypes\";\n\nimport { TransportService } from \"./TransportService\";\n\n@injectable()\nexport class DefaultTransportService implements TransportService {\n  private _transports: Map<string, Transport> = new Map();\n  private _logger: LoggerPublisherService;\n\n  constructor(\n    @inject(transportDiTypes.TransportsInput)\n    _transports: TransportFactory[],\n    @inject(transportDiTypes.DmkConfig)\n    private readonly _config: DmkConfig,\n    @inject(loggerTypes.LoggerPublisherServiceFactory)\n    private readonly _loggerModuleFactory: (\n      tag: string,\n    ) => LoggerPublisherService,\n    @inject(deviceModelTypes.DeviceModelDataSource)\n    private readonly _deviceModelDataSource: DeviceModelDataSource,\n    @inject(deviceSessionTypes.ApduSenderServiceFactory)\n    private readonly _apduSenderServiceFactory: ApduSenderServiceFactory,\n    @inject(deviceSessionTypes.ApduReceiverServiceFactory)\n    private readonly _apduReceiverServiceFactory: ApduReceiverServiceFactory,\n  ) {\n    this._logger = _loggerModuleFactory(\"TransportService\");\n\n    if (_transports.length === 0) {\n      this._logger.warn(\n        \"No transports provided, please check your configuration\",\n      );\n\n      throw new NoTransportProvidedError(\n        \"No transports provided, please check your configuration\",\n      );\n    }\n\n    for (const transport of _transports) {\n      const either = this.addTransport(transport);\n\n      if (either.isLeft()) {\n        throw either.extract();\n      }\n    }\n  }\n\n  addTransport(\n    factory: TransportFactory,\n  ): Either<TransportAlreadyExistsError, void> {\n    const transport = factory({\n      deviceModelDataSource: this._deviceModelDataSource,\n      loggerServiceFactory: this._loggerModuleFactory,\n      config: this._config,\n      apduSenderServiceFactory: this._apduSenderServiceFactory,\n      apduReceiverServiceFactory: this._apduReceiverServiceFactory,\n    });\n\n    return this.addTransportInternal(transport);\n  }\n\n  private addTransportInternal(\n    transport: Transport,\n  ): Either<TransportAlreadyExistsError, void> {\n    const MaybeTransport = this.getTransport(transport.getIdentifier());\n\n    if (MaybeTransport.isJust()) {\n      this._logger.warn(\n        `Transport ${transport.getIdentifier()} already exists, please check your configuration`,\n      );\n\n      return Left(\n        new TransportAlreadyExistsError(\n          `Transport ${transport.getIdentifier()} already exists, please check your configuration`,\n        ),\n      );\n    }\n\n    this._transports.set(transport.getIdentifier(), transport);\n    return Right(undefined);\n  }\n\n  getTransport(identifier: string): Maybe<Transport> {\n    return Maybe.fromNullable(this._transports.get(identifier));\n  }\n\n  getAllTransports(): Transport[] {\n    return Array.from(this._transports.values());\n  }\n\n  closeConnection(connectedDevice: TransportConnectedDevice) {\n    const transport = this.getTransport(connectedDevice.transport);\n    transport.map((t) =>\n      t.disconnect({\n        connectedDevice,\n      }),\n    );\n  }\n}\n"],
  "mappings": "okBAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,6BAAAE,IAAA,eAAAC,EAAAH,GAAA,IAAAI,EAAmC,qBACnCC,EAA2C,qBAO3CC,EAGO,uCAIPC,EAAiC,sDACjCC,EAAmC,0DACnCC,EAA4B,qDAC5BC,EAAiC,mDAK1B,IAAMC,EAAN,KAA0D,CAI/D,YAEEC,EAEiBC,EAEAC,EAIAC,EAEAC,EAEAC,EACjB,CAXiB,aAAAJ,EAEA,0BAAAC,EAIA,4BAAAC,EAEA,+BAAAC,EAEA,iCAAAC,EAIjB,GAFA,KAAK,QAAUH,EAAqB,kBAAkB,EAElDF,EAAY,SAAW,EACzB,WAAK,QAAQ,KACX,yDACF,EAEM,IAAI,2BACR,yDACF,EAGF,UAAWM,KAAaN,EAAa,CACnC,MAAMO,EAAS,KAAK,aAAaD,CAAS,EAE1C,GAAIC,EAAO,OAAO,EAChB,MAAMA,EAAO,QAAQ,CAEzB,CACF,CAtCQ,YAAsC,IAAI,IAC1C,QAuCR,aACEC,EAC2C,CAC3C,MAAMF,EAAYE,EAAQ,CACxB,sBAAuB,KAAK,uBAC5B,qBAAsB,KAAK,qBAC3B,OAAQ,KAAK,QACb,yBAA0B,KAAK,0BAC/B,2BAA4B,KAAK,2BACnC,CAAC,EAED,OAAO,KAAK,qBAAqBF,CAAS,CAC5C,CAEQ,qBACNA,EAC2C,CAG3C,OAFuB,KAAK,aAAaA,EAAU,cAAc,CAAC,EAE/C,OAAO,GACxB,KAAK,QAAQ,KACX,aAAaA,EAAU,cAAc,CAAC,kDACxC,KAEO,QACL,IAAI,8BACF,aAAaA,EAAU,cAAc,CAAC,kDACxC,CACF,IAGF,KAAK,YAAY,IAAIA,EAAU,cAAc,EAAGA,CAAS,KAClD,SAAM,MAAS,EACxB,CAEA,aAAaG,EAAsC,CACjD,OAAO,QAAM,aAAa,KAAK,YAAY,IAAIA,CAAU,CAAC,CAC5D,CAEA,kBAAgC,CAC9B,OAAO,MAAM,KAAK,KAAK,YAAY,OAAO,CAAC,CAC7C,CAEA,gBAAgBC,EAA2C,CACvC,KAAK,aAAaA,EAAgB,SAAS,EACnD,IAAKC,GACbA,EAAE,WAAW,CACX,gBAAAD,CACF,CAAC,CACH,CACF,CACF,EA5FaX,EAANa,EAAA,IADN,cAAW,EAMPC,EAAA,eAAO,mBAAiB,eAAe,GAEvCA,EAAA,eAAO,mBAAiB,SAAS,GAEjCA,EAAA,eAAO,cAAY,6BAA6B,GAIhDA,EAAA,eAAO,mBAAiB,qBAAqB,GAE7CA,EAAA,eAAO,qBAAmB,wBAAwB,GAElDA,EAAA,eAAO,qBAAmB,0BAA0B,IAjB5Cd",
  "names": ["DefaultTransportService_exports", "__export", "DefaultTransportService", "__toCommonJS", "import_inversify", "import_purify_ts", "import_Errors", "import_deviceModelTypes", "import_deviceSessionTypes", "import_loggerTypes", "import_transportDiTypes", "DefaultTransportService", "_transports", "_config", "_loggerModuleFactory", "_deviceModelDataSource", "_apduSenderServiceFactory", "_apduReceiverServiceFactory", "transport", "either", "factory", "identifier", "connectedDevice", "t", "__decorateClass", "__decorateParam"]
}

{
  "version": 3,
  "sources": ["../../../../../../src/internal/device-session/model/DeviceSession.ts"],
  "sourcesContent": ["import { type Either } from \"purify-ts\";\nimport { BehaviorSubject, type Observable } from \"rxjs\";\nimport { v4 as uuidv4 } from \"uuid\";\n\nimport { type Command } from \"@api/command/Command\";\nimport { type CommandResult } from \"@api/command/model/CommandResult\";\nimport { CommandUtils } from \"@api/command/utils/CommandUtils\";\nimport { DeviceStatus } from \"@api/device/DeviceStatus\";\nimport {\n  type DeviceAction,\n  type DeviceActionIntermediateValue,\n  type ExecuteDeviceActionReturnType,\n} from \"@api/device-action/DeviceAction\";\nimport { type ApduResponse } from \"@api/device-session/ApduResponse\";\nimport {\n  type DeviceSessionState,\n  DeviceSessionStateType,\n} from \"@api/device-session/DeviceSessionState\";\nimport { type DeviceSessionId } from \"@api/device-session/types\";\nimport { type DmkError } from \"@api/Error\";\nimport { bufferToHexaString } from \"@api/index\";\nimport { type LoggerPublisherService } from \"@api/logger-publisher/service/LoggerPublisherService\";\nimport { type TransportConnectedDevice } from \"@api/transport/model/TransportConnectedDevice\";\nimport { DEVICE_SESSION_REFRESHER_DEFAULT_OPTIONS } from \"@internal/device-session/data/DeviceSessionRefresherConst\";\nimport { MutexService } from \"@internal/device-session/service/MutexService\";\nimport { RefresherService } from \"@internal/device-session/service/RefresherService\";\nimport { type ManagerApiService } from \"@internal/manager-api/service/ManagerApiService\";\nimport { type SecureChannelService } from \"@internal/secure-channel/service/SecureChannelService\";\n\nimport { DevicePinger } from \"./DevicePinger\";\nimport {\n  DeviceSessionEventDispatcher,\n  SessionEvents,\n} from \"./DeviceSessionEventDispatcher\";\nimport { DeviceSessionRefresher } from \"./DeviceSessionRefresher\";\nimport { DeviceSessionStateHandler } from \"./DeviceSessionStateHandler\";\n\nexport type SessionConstructorArgs = {\n  connectedDevice: TransportConnectedDevice;\n  id?: DeviceSessionId;\n};\n\nexport type DeviceSessionRefresherOptions = {\n  isRefresherDisabled: boolean;\n  pollingInterval?: number;\n};\n\ntype SendApduOptions = {\n  isPolling?: boolean;\n  triggersDisconnection?: boolean;\n  abortTimeout?: number;\n};\n\n/**\n * Represents a session with a device.\n */\nexport class DeviceSession {\n  private readonly _id: DeviceSessionId;\n  private readonly _connectedDevice: TransportConnectedDevice;\n  private readonly _deviceState: BehaviorSubject<DeviceSessionState>;\n  private readonly _managerApiService: ManagerApiService;\n  private readonly _secureChannelService: SecureChannelService;\n  private readonly _logger: LoggerPublisherService;\n  private readonly _refresherOptions: DeviceSessionRefresherOptions;\n  private _pinger: DevicePinger;\n  private _deviceSessionRefresher: DeviceSessionRefresher;\n  private readonly _refresherService: RefresherService;\n  private _commandMutex = new MutexService();\n  private _sessionEventDispatcher = new DeviceSessionEventDispatcher();\n\n  constructor(\n    { connectedDevice, id = uuidv4() }: SessionConstructorArgs,\n    loggerModuleFactory: (tag: string) => LoggerPublisherService,\n    managerApiService: ManagerApiService,\n    secureChannelService: SecureChannelService,\n    deviceSessionRefresherOptions: DeviceSessionRefresherOptions | undefined,\n  ) {\n    this._id = id;\n    this._connectedDevice = connectedDevice;\n    this._logger = loggerModuleFactory(\"device-session\");\n    this._managerApiService = managerApiService;\n    this._secureChannelService = secureChannelService;\n    this._refresherOptions = {\n      ...DEVICE_SESSION_REFRESHER_DEFAULT_OPTIONS,\n      ...deviceSessionRefresherOptions,\n    };\n    this._deviceState = new BehaviorSubject<DeviceSessionState>({\n      sessionStateType: DeviceSessionStateType.Connected,\n      deviceStatus: DeviceStatus.CONNECTED,\n      deviceModelId: this._connectedDevice.deviceModel.id,\n    });\n\n    this._pinger = new DevicePinger(\n      loggerModuleFactory,\n      connectedDevice,\n      this._sessionEventDispatcher,\n      (command, abortTimeout) => this.sendCommand(command, abortTimeout),\n    );\n    this._deviceSessionRefresher = new DeviceSessionRefresher(\n      loggerModuleFactory,\n      this._refresherOptions,\n      this._sessionEventDispatcher,\n      this._connectedDevice,\n    );\n    new DeviceSessionStateHandler(\n      loggerModuleFactory,\n      this._sessionEventDispatcher,\n      this._connectedDevice,\n      this._deviceState,\n      (state) => this.setDeviceSessionState(state),\n    );\n\n    this._refresherService = new RefresherService(loggerModuleFactory, {\n      start: () => this._deviceSessionRefresher.restartRefresher(),\n      stop: () => this._deviceSessionRefresher.stopRefresher(),\n    });\n  }\n\n  public async initialiseSession(): Promise<void> {\n    try {\n      await this._pinger.ping();\n    } catch (error) {\n      this._logger.error(\"Error while initialising session\", {\n        data: { error },\n      });\n      throw error;\n    } finally {\n      if (!this._refresherOptions.isRefresherDisabled) {\n        this._deviceSessionRefresher.startRefresher();\n      }\n    }\n  }\n\n  public get id(): DeviceSessionId {\n    return this._id;\n  }\n\n  public get connectedDevice(): TransportConnectedDevice {\n    return this._connectedDevice;\n  }\n\n  public get state(): Observable<DeviceSessionState> {\n    return this._deviceState.asObservable();\n  }\n\n  public getDeviceSessionState(): DeviceSessionState {\n    return this._deviceState.getValue();\n  }\n\n  public setDeviceSessionState(state: DeviceSessionState): void {\n    this._deviceState.next(state);\n  }\n\n  public async sendApdu(\n    rawApdu: Uint8Array,\n    options: SendApduOptions = {\n      isPolling: false,\n      triggersDisconnection: false,\n      abortTimeout: undefined,\n    },\n  ): Promise<Either<DmkError, ApduResponse>> {\n    const release = await this._commandMutex.lock();\n\n    try {\n      this._sessionEventDispatcher.dispatch({\n        eventName: SessionEvents.DEVICE_STATE_UPDATE_BUSY,\n      });\n\n      this._logger.debug(`[exchange] => ${bufferToHexaString(rawApdu, false)}`);\n      const result = await this._connectedDevice.sendApdu(\n        rawApdu,\n        options.triggersDisconnection,\n        options.abortTimeout,\n      );\n\n      result\n        .ifRight((response: ApduResponse) => {\n          this._logger.debug(\n            `[exchange] <= ${bufferToHexaString(response.data, false)}${bufferToHexaString(response.statusCode, false)}`,\n          );\n          if (CommandUtils.isLockedDeviceResponse(response)) {\n            this._sessionEventDispatcher.dispatch({\n              eventName: SessionEvents.DEVICE_STATE_UPDATE_LOCKED,\n            });\n          } else {\n            this._sessionEventDispatcher.dispatch({\n              eventName: SessionEvents.DEVICE_STATE_UPDATE_CONNECTED,\n            });\n          }\n        })\n        .ifLeft(() => {\n          this._sessionEventDispatcher.dispatch({\n            eventName: SessionEvents.DEVICE_STATE_UPDATE_CONNECTED,\n          });\n        });\n      return result;\n    } finally {\n      release();\n    }\n  }\n\n  public async sendCommand<Response, Args, ErrorStatusCodes>(\n    command: Command<Response, Args, ErrorStatusCodes>,\n    abortTimeout?: number,\n  ): Promise<CommandResult<Response, ErrorStatusCodes>> {\n    this._logger.debug(`[sendCommand] ${command.name}`);\n    const apdu = command.getApdu();\n\n    const response = await this.sendApdu(apdu.getRawApdu(), {\n      isPolling: false,\n      triggersDisconnection: command.triggersDisconnection ?? false,\n      abortTimeout,\n    });\n\n    return response.caseOf({\n      Left: (err) => {\n        this._logger.error(\"[sendCommand] error\", { data: { err } });\n        throw err;\n      },\n      Right: (r) => {\n        const result = command.parseResponse(\n          r,\n          this._connectedDevice.deviceModel.id,\n        );\n        this._logger.debug(\"[sendCommand] result\", { data: { result } });\n        return result;\n      },\n    });\n  }\n\n  public executeDeviceAction<\n    Output,\n    Input,\n    E extends DmkError,\n    IntermediateValue extends DeviceActionIntermediateValue,\n  >(\n    deviceAction: DeviceAction<Output, Input, E, IntermediateValue>,\n  ): ExecuteDeviceActionReturnType<Output, E, IntermediateValue> {\n    const { observable, cancel } = deviceAction._execute({\n      sendApdu: async (apdu: Uint8Array) => this.sendApdu(apdu),\n      sendCommand: async <Response, ErrorStatusCodes, Args>(\n        command: Command<Response, ErrorStatusCodes, Args>,\n        abortTimeout?: number,\n      ) => this.sendCommand(command, abortTimeout),\n      getDeviceModel: () => this._connectedDevice.deviceModel,\n      getDeviceSessionState: () => this._deviceState.getValue(),\n      getDeviceSessionStateObservable: () => this.state,\n      setDeviceSessionState: (state: DeviceSessionState) => {\n        this.setDeviceSessionState(state);\n        return this._deviceState.getValue();\n      },\n      disableRefresher: (blockerId: string) =>\n        this._refresherService.disableRefresher(blockerId),\n      getManagerApiService: () => this._managerApiService,\n      getSecureChannelService: () => this._secureChannelService,\n    });\n    return { observable, cancel };\n  }\n\n  public close(): void {\n    this._updateDeviceStatus(DeviceStatus.NOT_CONNECTED);\n    this._deviceState.complete();\n    this._deviceSessionRefresher.stopRefresher();\n  }\n\n  public disableRefresher(id: string): () => void {\n    return this._refresherService.disableRefresher(id);\n  }\n\n  private _updateDeviceStatus(deviceStatus: DeviceStatus): void {\n    const state = this._deviceState.getValue();\n    this._deviceState.next({ ...state, deviceStatus });\n  }\n}\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,mBAAAE,IAAA,eAAAC,EAAAH,GACA,IAAAI,EAAiD,gBACjDC,EAA6B,gBAI7BC,EAA6B,2CAC7BC,EAA6B,oCAO7BC,EAGO,kDAGPC,EAAmC,sBAGnCC,EAAyD,qEACzDC,EAA6B,yDAC7BC,EAAiC,6DAIjCC,EAA6B,0BAC7BC,EAGO,0CACPC,EAAuC,oCACvCC,EAA0C,uCAqBnC,MAAMd,CAAc,CACR,IACA,iBACA,aACA,mBACA,sBACA,QACA,kBACT,QACA,wBACS,kBACT,cAAgB,IAAI,eACpB,wBAA0B,IAAI,+BAEtC,YACE,CAAE,gBAAAe,EAAiB,GAAAC,KAAK,EAAAC,IAAO,CAAE,EACjCC,EACAC,EACAC,EACAC,EACA,CACA,KAAK,IAAML,EACX,KAAK,iBAAmBD,EACxB,KAAK,QAAUG,EAAoB,gBAAgB,EACnD,KAAK,mBAAqBC,EAC1B,KAAK,sBAAwBC,EAC7B,KAAK,kBAAoB,CACvB,GAAG,2CACH,GAAGC,CACL,EACA,KAAK,aAAe,IAAI,kBAAoC,CAC1D,iBAAkB,yBAAuB,UACzC,aAAc,eAAa,UAC3B,cAAe,KAAK,iBAAiB,YAAY,EACnD,CAAC,EAED,KAAK,QAAU,IAAI,eACjBH,EACAH,EACA,KAAK,wBACL,CAACO,EAASC,IAAiB,KAAK,YAAYD,EAASC,CAAY,CACnE,EACA,KAAK,wBAA0B,IAAI,yBACjCL,EACA,KAAK,kBACL,KAAK,wBACL,KAAK,gBACP,EACA,IAAI,4BACFA,EACA,KAAK,wBACL,KAAK,iBACL,KAAK,aACJM,GAAU,KAAK,sBAAsBA,CAAK,CAC7C,EAEA,KAAK,kBAAoB,IAAI,mBAAiBN,EAAqB,CACjE,MAAO,IAAM,KAAK,wBAAwB,iBAAiB,EAC3D,KAAM,IAAM,KAAK,wBAAwB,cAAc,CACzD,CAAC,CACH,CAEA,MAAa,mBAAmC,CAC9C,GAAI,CACF,MAAM,KAAK,QAAQ,KAAK,CAC1B,OAASO,EAAO,CACd,WAAK,QAAQ,MAAM,mCAAoC,CACrD,KAAM,CAAE,MAAAA,CAAM,CAChB,CAAC,EACKA,CACR,QAAE,CACK,KAAK,kBAAkB,qBAC1B,KAAK,wBAAwB,eAAe,CAEhD,CACF,CAEA,IAAW,IAAsB,CAC/B,OAAO,KAAK,GACd,CAEA,IAAW,iBAA4C,CACrD,OAAO,KAAK,gBACd,CAEA,IAAW,OAAwC,CACjD,OAAO,KAAK,aAAa,aAAa,CACxC,CAEO,uBAA4C,CACjD,OAAO,KAAK,aAAa,SAAS,CACpC,CAEO,sBAAsBD,EAAiC,CAC5D,KAAK,aAAa,KAAKA,CAAK,CAC9B,CAEA,MAAa,SACXE,EACAC,EAA2B,CACzB,UAAW,GACX,sBAAuB,GACvB,aAAc,MAChB,EACyC,CACzC,MAAMC,EAAU,MAAM,KAAK,cAAc,KAAK,EAE9C,GAAI,CACF,KAAK,wBAAwB,SAAS,CACpC,UAAW,gBAAc,wBAC3B,CAAC,EAED,KAAK,QAAQ,MAAM,oBAAiB,sBAAmBF,EAAS,EAAK,CAAC,EAAE,EACxE,MAAMG,EAAS,MAAM,KAAK,iBAAiB,SACzCH,EACAC,EAAQ,sBACRA,EAAQ,YACV,EAEA,OAAAE,EACG,QAASC,GAA2B,CACnC,KAAK,QAAQ,MACX,oBAAiB,sBAAmBA,EAAS,KAAM,EAAK,CAAC,MAAG,sBAAmBA,EAAS,WAAY,EAAK,CAAC,EAC5G,EACI,eAAa,uBAAuBA,CAAQ,EAC9C,KAAK,wBAAwB,SAAS,CACpC,UAAW,gBAAc,0BAC3B,CAAC,EAED,KAAK,wBAAwB,SAAS,CACpC,UAAW,gBAAc,6BAC3B,CAAC,CAEL,CAAC,EACA,OAAO,IAAM,CACZ,KAAK,wBAAwB,SAAS,CACpC,UAAW,gBAAc,6BAC3B,CAAC,CACH,CAAC,EACID,CACT,QAAE,CACAD,EAAQ,CACV,CACF,CAEA,MAAa,YACXN,EACAC,EACoD,CACpD,KAAK,QAAQ,MAAM,iBAAiBD,EAAQ,IAAI,EAAE,EAClD,MAAMS,EAAOT,EAAQ,QAAQ,EAQ7B,OANiB,MAAM,KAAK,SAASS,EAAK,WAAW,EAAG,CACtD,UAAW,GACX,sBAAuBT,EAAQ,uBAAyB,GACxD,aAAAC,CACF,CAAC,GAEe,OAAO,CACrB,KAAOS,GAAQ,CACb,WAAK,QAAQ,MAAM,sBAAuB,CAAE,KAAM,CAAE,IAAAA,CAAI,CAAE,CAAC,EACrDA,CACR,EACA,MAAQ,GAAM,CACZ,MAAMH,EAASP,EAAQ,cACrB,EACA,KAAK,iBAAiB,YAAY,EACpC,EACA,YAAK,QAAQ,MAAM,uBAAwB,CAAE,KAAM,CAAE,OAAAO,CAAO,CAAE,CAAC,EACxDA,CACT,CACF,CAAC,CACH,CAEO,oBAMLI,EAC6D,CAC7D,KAAM,CAAE,WAAAC,EAAY,OAAAC,CAAO,EAAIF,EAAa,SAAS,CACnD,SAAU,MAAOF,GAAqB,KAAK,SAASA,CAAI,EACxD,YAAa,MACXT,EACAC,IACG,KAAK,YAAYD,EAASC,CAAY,EAC3C,eAAgB,IAAM,KAAK,iBAAiB,YAC5C,sBAAuB,IAAM,KAAK,aAAa,SAAS,EACxD,gCAAiC,IAAM,KAAK,MAC5C,sBAAwBC,IACtB,KAAK,sBAAsBA,CAAK,EACzB,KAAK,aAAa,SAAS,GAEpC,iBAAmBY,GACjB,KAAK,kBAAkB,iBAAiBA,CAAS,EACnD,qBAAsB,IAAM,KAAK,mBACjC,wBAAyB,IAAM,KAAK,qBACtC,CAAC,EACD,MAAO,CAAE,WAAAF,EAAY,OAAAC,CAAO,CAC9B,CAEO,OAAc,CACnB,KAAK,oBAAoB,eAAa,aAAa,EACnD,KAAK,aAAa,SAAS,EAC3B,KAAK,wBAAwB,cAAc,CAC7C,CAEO,iBAAiBnB,EAAwB,CAC9C,OAAO,KAAK,kBAAkB,iBAAiBA,CAAE,CACnD,CAEQ,oBAAoBqB,EAAkC,CAC5D,MAAMb,EAAQ,KAAK,aAAa,SAAS,EACzC,KAAK,aAAa,KAAK,CAAE,GAAGA,EAAO,aAAAa,CAAa,CAAC,CACnD,CACF",
  "names": ["DeviceSession_exports", "__export", "DeviceSession", "__toCommonJS", "import_rxjs", "import_uuid", "import_CommandUtils", "import_DeviceStatus", "import_DeviceSessionState", "import_api", "import_DeviceSessionRefresherConst", "import_MutexService", "import_RefresherService", "import_DevicePinger", "import_DeviceSessionEventDispatcher", "import_DeviceSessionRefresher", "import_DeviceSessionStateHandler", "connectedDevice", "id", "uuidv4", "loggerModuleFactory", "managerApiService", "secureChannelService", "deviceSessionRefresherOptions", "command", "abortTimeout", "state", "error", "rawApdu", "options", "release", "result", "response", "apdu", "err", "deviceAction", "observable", "cancel", "blockerId", "deviceStatus"]
}

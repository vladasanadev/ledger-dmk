"use strict";var d=require("rxjs"),e=require("vitest"),v=require("../../../api/device/DeviceModel"),c=require("../../device-session/data/DeviceSessionRefresherConst"),h=require("../../device-session/model/DeviceSessionEventDispatcher"),n=require("./DeviceSessionRefresher");(0,e.describe)("DeviceSessionRefresher",()=>{let p,r,o;const l={deviceModel:{id:v.DeviceModelId.FLEX}},m={deviceModel:{id:v.DeviceModelId.NANO_S}},i=e.vi.fn(()=>o);let s;(0,e.beforeEach)(()=>{e.vi.useFakeTimers(),p=new d.Subject,r={listen:()=>p.asObservable(),dispatch:e.vi.fn()},o={info:e.vi.fn(),warn:e.vi.fn(),error:e.vi.fn(),debug:e.vi.fn(),subscribers:[]}}),(0,e.afterEach)(()=>{s?.destroy(),e.vi.useRealTimers(),e.vi.restoreAllMocks()}),(0,e.it)("should not start refresher if disabled",()=>{const t={isRefresherDisabled:!0,pollingInterval:1e3};s=new n.DeviceSessionRefresher(i,t,r,l),s.startRefresher(),e.vi.advanceTimersByTime(2e3),(0,e.expect)(r.dispatch).not.toHaveBeenCalled()}),(0,e.it)("should warn and use minimum polling interval for default device when provided interval is too low",()=>{const t=c.DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL-100,a={isRefresherDisabled:!1,pollingInterval:t};s=new n.DeviceSessionRefresher(i,a,r,l),s.startRefresher();const f=`Polling interval of ${t} is too low, setting to minimum as ${c.DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL}`;(0,e.expect)(o.warn).toHaveBeenCalledWith(f)}),(0,e.it)("should warn and use minimum polling interval for NANO_S device when provided interval is too low",()=>{const t=c.DEVICE_SESSION_REFRESHER_POLLING_INTERVAL*2,a=t-100,f={isRefresherDisabled:!1,pollingInterval:a};s=new n.DeviceSessionRefresher(i,f,r,m),s.startRefresher();const R=`Polling interval of ${a} is too low, setting to minimum as ${t}`;(0,e.expect)(o.warn).toHaveBeenCalledWith(R)}),(0,e.it)("should not warn when provided polling interval is valid for default device",()=>{const a={isRefresherDisabled:!1,pollingInterval:c.DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL+100};s=new n.DeviceSessionRefresher(i,a,r,l),s.startRefresher(),(0,e.expect)(o.warn).not.toHaveBeenCalled()}),(0,e.it)("should dispatch refresh event on timer ticks",()=>{const t=c.DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL+100,a={isRefresherDisabled:!1,pollingInterval:t};s=new n.DeviceSessionRefresher(i,a,r,l),s.startRefresher();const f=t*2;e.vi.advanceTimersByTime(f*3),(0,e.expect)(r.dispatch.mock.calls.length).toBe(4),(0,e.expect)(r.dispatch.mock.calls[0][0]).toEqual({eventName:h.SessionEvents.REFRESH_NEEDED})}),(0,e.it)("should stop refresher",()=>{const t={isRefresherDisabled:!1,pollingInterval:1e3};s=new n.DeviceSessionRefresher(i,t,r,l),s.startRefresher(),r.dispatch.mockClear(),s.stopRefresher(),e.vi.advanceTimersByTime(2e3),(0,e.expect)(r.dispatch).not.toHaveBeenCalled(),(0,e.expect)(o.info).toHaveBeenCalledWith("Refresher stopped.")}),(0,e.it)("should restart refresher",()=>{const t={isRefresherDisabled:!1,pollingInterval:1e3};s=new n.DeviceSessionRefresher(i,t,r,l),s.startRefresher(),r.dispatch.mockClear(),e.vi.clearAllTimers(),s.restartRefresher(),(0,e.expect)(o.info).toHaveBeenCalledWith("Refresher stopped."),(0,e.expect)(o.info).toHaveBeenCalledWith("Refresher restarted."),e.vi.advanceTimersByTime(2e3),(0,e.expect)(r.dispatch.mock.calls.length).toBeGreaterThan(0)}),(0,e.it)("should destroy refresher",()=>{const t={isRefresherDisabled:!1,pollingInterval:1e3};s=new n.DeviceSessionRefresher(i,t,r,l),s.startRefresher(),s.destroy(),e.vi.advanceTimersByTime(2e3),(0,e.expect)(r.dispatch).not.toHaveBeenCalled()})});
//# sourceMappingURL=DeviceSessionRefresher.test.js.map

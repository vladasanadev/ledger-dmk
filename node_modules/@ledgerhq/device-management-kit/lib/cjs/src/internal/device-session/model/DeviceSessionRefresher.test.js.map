{
  "version": 3,
  "sources": ["../../../../../../src/internal/device-session/model/DeviceSessionRefresher.test.ts"],
  "sourcesContent": ["import { Subject } from \"rxjs\";\nimport { afterEach, beforeEach, describe, expect, it, vi } from \"vitest\";\n\nimport { DeviceModelId } from \"@api/device/DeviceModel\";\nimport { type TransportConnectedDevice } from \"@api/transport/model/TransportConnectedDevice\";\nimport type { LoggerPublisherService } from \"@api/types\";\nimport {\n  DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL,\n  DEVICE_SESSION_REFRESHER_POLLING_INTERVAL,\n} from \"@internal/device-session/data/DeviceSessionRefresherConst\";\nimport type {\n  DeviceSessionEventDispatcher,\n  NewEvent,\n} from \"@internal/device-session/model/DeviceSessionEventDispatcher\";\nimport { SessionEvents } from \"@internal/device-session/model/DeviceSessionEventDispatcher\";\n\nimport {\n  DeviceSessionRefresher,\n  type DeviceSessionRefresherOptions,\n} from \"./DeviceSessionRefresher\";\n\ndescribe(\"DeviceSessionRefresher\", () => {\n  let subject: Subject<NewEvent>;\n  let mockSessionEventDispatcher: DeviceSessionEventDispatcher;\n  let mockLogger: LoggerPublisherService & {\n    info: ReturnType<typeof vi.fn>;\n    warn: ReturnType<typeof vi.fn>;\n    error: ReturnType<typeof vi.fn>;\n    debug: ReturnType<typeof vi.fn>;\n    subscribers?: unknown[];\n  };\n\n  const stubDefaultDevice = {\n    deviceModel: {\n      id: DeviceModelId.FLEX,\n    },\n  } as TransportConnectedDevice;\n\n  const stubNanoSDevice = {\n    deviceModel: {\n      id: DeviceModelId.NANO_S,\n    },\n  } as TransportConnectedDevice;\n\n  const mockedLoggerModuleFactory = vi.fn(() => mockLogger);\n  let refresher: DeviceSessionRefresher;\n\n  beforeEach(() => {\n    vi.useFakeTimers();\n    subject = new Subject<NewEvent>();\n    mockSessionEventDispatcher = {\n      listen: () => subject.asObservable(),\n      dispatch: vi.fn(),\n    } as unknown as DeviceSessionEventDispatcher;\n    mockLogger = {\n      info: vi.fn(),\n      warn: vi.fn(),\n      error: vi.fn(),\n      debug: vi.fn(),\n      subscribers: [],\n    };\n  });\n\n  afterEach(() => {\n    refresher?.destroy();\n    vi.useRealTimers();\n    vi.restoreAllMocks();\n  });\n\n  it(\"should not start refresher if disabled\", () => {\n    const options: DeviceSessionRefresherOptions = {\n      isRefresherDisabled: true,\n      pollingInterval: 1000,\n    };\n\n    refresher = new DeviceSessionRefresher(\n      mockedLoggerModuleFactory,\n      options,\n      mockSessionEventDispatcher,\n      stubDefaultDevice,\n    );\n    refresher.startRefresher();\n    vi.advanceTimersByTime(2000);\n\n    expect(mockSessionEventDispatcher.dispatch).not.toHaveBeenCalled();\n  });\n\n  it(\"should warn and use minimum polling interval for default device when provided interval is too low\", () => {\n    const lowInterval = DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL - 100;\n    const options: DeviceSessionRefresherOptions = {\n      isRefresherDisabled: false,\n      pollingInterval: lowInterval,\n    };\n\n    refresher = new DeviceSessionRefresher(\n      mockedLoggerModuleFactory,\n      options,\n      mockSessionEventDispatcher,\n      stubDefaultDevice,\n    );\n    refresher.startRefresher();\n\n    const expectedMessage = `Polling interval of ${lowInterval} is too low, setting to minimum as ${DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL}`;\n    expect(mockLogger.warn).toHaveBeenCalledWith(expectedMessage);\n  });\n\n  it(\"should warn and use minimum polling interval for NANO_S device when provided interval is too low\", () => {\n    const defaultNanoPollingInterval =\n      DEVICE_SESSION_REFRESHER_POLLING_INTERVAL * 2;\n    const lowInterval = defaultNanoPollingInterval - 100;\n    const options: DeviceSessionRefresherOptions = {\n      isRefresherDisabled: false,\n      pollingInterval: lowInterval,\n    };\n\n    refresher = new DeviceSessionRefresher(\n      mockedLoggerModuleFactory,\n      options,\n      mockSessionEventDispatcher,\n      stubNanoSDevice,\n    );\n    refresher.startRefresher();\n\n    const expectedMessage = `Polling interval of ${lowInterval} is too low, setting to minimum as ${defaultNanoPollingInterval}`;\n    expect(mockLogger.warn).toHaveBeenCalledWith(expectedMessage);\n  });\n\n  it(\"should not warn when provided polling interval is valid for default device\", () => {\n    const validInterval =\n      DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL + 100;\n    const options: DeviceSessionRefresherOptions = {\n      isRefresherDisabled: false,\n      pollingInterval: validInterval,\n    };\n\n    refresher = new DeviceSessionRefresher(\n      mockedLoggerModuleFactory,\n      options,\n      mockSessionEventDispatcher,\n      stubDefaultDevice,\n    );\n    refresher.startRefresher();\n\n    expect(mockLogger.warn).not.toHaveBeenCalled();\n  });\n\n  it(\"should dispatch refresh event on timer ticks\", () => {\n    const validInterval =\n      DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL + 100;\n    const options: DeviceSessionRefresherOptions = {\n      isRefresherDisabled: false,\n      pollingInterval: validInterval,\n    };\n\n    refresher = new DeviceSessionRefresher(\n      mockedLoggerModuleFactory,\n      options,\n      mockSessionEventDispatcher,\n      stubDefaultDevice,\n    );\n    refresher.startRefresher();\n\n    const timerInterval = validInterval * 2;\n\n    vi.advanceTimersByTime(timerInterval * 3);\n\n    expect(\n      (mockSessionEventDispatcher.dispatch as ReturnType<typeof vi.fn>).mock\n        .calls.length,\n    ).toBe(4);\n    expect(\n      (mockSessionEventDispatcher.dispatch as ReturnType<typeof vi.fn>).mock\n        .calls[0]![0],\n    ).toEqual({\n      eventName: SessionEvents.REFRESH_NEEDED,\n    });\n  });\n\n  it(\"should stop refresher\", () => {\n    const options: DeviceSessionRefresherOptions = {\n      isRefresherDisabled: false,\n      pollingInterval: 1000,\n    };\n    refresher = new DeviceSessionRefresher(\n      mockedLoggerModuleFactory,\n      options,\n      mockSessionEventDispatcher,\n      stubDefaultDevice,\n    );\n    refresher.startRefresher();\n    (\n      mockSessionEventDispatcher.dispatch as ReturnType<typeof vi.fn>\n    ).mockClear();\n\n    refresher.stopRefresher();\n    vi.advanceTimersByTime(2000);\n\n    expect(mockSessionEventDispatcher.dispatch).not.toHaveBeenCalled();\n    expect(mockLogger.info).toHaveBeenCalledWith(\"Refresher stopped.\");\n  });\n\n  it(\"should restart refresher\", () => {\n    const options: DeviceSessionRefresherOptions = {\n      isRefresherDisabled: false,\n      pollingInterval: 1000,\n    };\n    refresher = new DeviceSessionRefresher(\n      mockedLoggerModuleFactory,\n      options,\n      mockSessionEventDispatcher,\n      stubDefaultDevice,\n    );\n    refresher.startRefresher();\n    (\n      mockSessionEventDispatcher.dispatch as ReturnType<typeof vi.fn>\n    ).mockClear();\n    vi.clearAllTimers();\n\n    refresher.restartRefresher();\n    expect(mockLogger.info).toHaveBeenCalledWith(\"Refresher stopped.\");\n    expect(mockLogger.info).toHaveBeenCalledWith(\"Refresher restarted.\");\n\n    vi.advanceTimersByTime(2000);\n    expect(\n      (mockSessionEventDispatcher.dispatch as ReturnType<typeof vi.fn>).mock\n        .calls.length,\n    ).toBeGreaterThan(0);\n  });\n\n  it(\"should destroy refresher\", () => {\n    const options: DeviceSessionRefresherOptions = {\n      isRefresherDisabled: false,\n      pollingInterval: 1000,\n    };\n    refresher = new DeviceSessionRefresher(\n      mockedLoggerModuleFactory,\n      options,\n      mockSessionEventDispatcher,\n      stubDefaultDevice,\n    );\n    refresher.startRefresher();\n\n    refresher.destroy();\n    vi.advanceTimersByTime(2000);\n\n    expect(mockSessionEventDispatcher.dispatch).not.toHaveBeenCalled();\n  });\n});\n"],
  "mappings": "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",
  "names": ["import_rxjs", "import_vitest", "import_DeviceModel", "import_DeviceSessionRefresherConst", "import_DeviceSessionEventDispatcher", "import_DeviceSessionRefresher", "subject", "mockSessionEventDispatcher", "mockLogger", "stubDefaultDevice", "stubNanoSDevice", "mockedLoggerModuleFactory", "refresher", "options", "lowInterval", "expectedMessage", "defaultNanoPollingInterval", "validInterval", "timerInterval"]
}

"use strict";var e=require("purify-ts"),s=require("../../../api/device-session/ApduResponse"),c=require("../../device-session/model/Errors"),f=require("../../logger-publisher/service/DefaultLoggerPublisherService"),d=require("./DefaultApduReceiverService");vi.mock("uuid");const u=new f.DefaultLoggerPublisherService([],"frame"),o=new Uint8Array([170,170,5,0,0,0,33,51,0,0,4,5,50,46,50,46,51,4,230,0,0,0,4,50,46,51,48,4,49,46,49,54,1,1,1,0,1,0,144,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),p=new Uint8Array([170,170,5,0,0,0,2,85,21,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),t=[new Uint8Array([170,170,5,0,0,0,158,1,77,0,19,202,80,250,161,145,64,154,107,250,108,15,187,178,231,196,169,207,229,87,65,0,93,189,132,171,154,189,102,199,108,144,221,8,121,13,8,71,185,58,143,167,111,96,51,174,211,37,215,177,229,124,235,215]),new Uint8Array([170,170,5,0,1,75,46,44,159,180,70,120,222,5,95,158,128,10,7,66,105,116,99,111,105,110,78,0,21,202,64,6,3,40,248,143,198,214,66,152,208,73,0,199,4,152,25,27,108,235,237,216,203,132,93,245,75,227,189,187,37,122,63,111]),new Uint8Array([170,170,5,0,2,104,143,84,239,127,170,196,34,170,84,231,184,10,200,163,47,150,229,94,67,45,243,163,69,141,142,170,241,78,209,30,8,69,116,104,101,114,101,117,109,144,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])];describe("DefaultApduReceiverService",()=>{let r;beforeAll(()=>{vi.mock("uuid",()=>({v4:vi.fn().mockReturnValue("42")}))}),describe("without dataSize",()=>{beforeEach(()=>{r=new d.DefaultApduReceiverService({channel:(0,e.Just)(new Uint8Array([170,170]))},()=>u)}),it("should return a left error when the first frame has no dataSize",()=>{const a=t[1],x=r.handleFrame(a);expect(x).toEqual((0,e.Left)(new c.ReceiverApduError))})}),describe("[USB] With padding and channel",()=>{beforeEach(()=>{r=new d.DefaultApduReceiverService({channel:(0,e.Just)(new Uint8Array([170,170]))},()=>u)}),it("should return a response directly when a frame is complete",()=>{const a=o,x=r.handleFrame(a);expect(x).toEqual((0,e.Right)((0,e.Just)(new s.ApduResponse({data:o.slice(7,38),statusCode:new Uint8Array([144,0])}))))}),it("should return a response on a third frame when the two first are not complete",()=>{const a=[...t];let x=e.Nothing;const n=[];for(;x.isNothing();){const i=a.shift();r.handleFrame(i).map(l=>{x=l,n.push(x)})}expect(n).toEqual([e.Nothing,e.Nothing,(0,e.Just)(new s.ApduResponse({data:new Uint8Array([...Array.from(t[0].slice(7)),...Array.from(t[1].slice(5)),...Array.from(t[2]).slice(5,45)]),statusCode:new Uint8Array([144,0])}))])}),it("should return two response directly when each frame is complete",()=>{const a=p,x=o,n=r.handleFrame(a),i=r.handleFrame(x);expect(n).toEqual((0,e.Right)((0,e.Just)(new s.ApduResponse({data:new Uint8Array([]),statusCode:new Uint8Array([85,21])})))),expect(i).toEqual((0,e.Right)((0,e.Just)(new s.ApduResponse({data:o.slice(7,38),statusCode:new Uint8Array([144,0])}))))}),it("should return an error if the frame is without index",()=>{const a=t[0].slice(0,4),x=r.handleFrame(a);expect(x).toEqual((0,e.Left)(new c.ReceiverApduError("Unable to parse header from apdu")))}),it("should return an error if the frame is without datasize",()=>{const a=t[0].slice(0,6),x=r.handleFrame(a);expect(x).toEqual((0,e.Left)(new c.ReceiverApduError("Unable to parse header from apdu")))})}),describe("[BLE] Without padding nor channel",()=>{beforeEach(()=>{r=new d.DefaultApduReceiverService({},()=>u)}),it("should return a response directly when a frame is complete",()=>{const a=o.slice(2,40),x=r.handleFrame(a);expect(x).toEqual((0,e.Right)((0,e.Just)(new s.ApduResponse({data:o.slice(7,38),statusCode:new Uint8Array([144,0])}))))}),it("should return a response on a third frame when the two first are not complete",()=>{const a=[t[0].slice(2),t[1].slice(2),t[2].slice(2,47)];let x=e.Nothing;const n=[];for(;x.isNothing();){const i=a.shift();r.handleFrame(i).map(l=>{x=l,n.push(x)})}expect(n).toEqual([e.Nothing,e.Nothing,(0,e.Just)(new s.ApduResponse({data:new Uint8Array([...Array.from(t[0].slice(7)),...Array.from(t[1].slice(5)),...Array.from(t[2]).slice(5,45)]),statusCode:new Uint8Array([144,0])}))])}),it("should return two response directly when each frame is complete",()=>{const a=p.slice(2,9),x=o.slice(2,40),n=r.handleFrame(a),i=r.handleFrame(x);expect(n).toEqual((0,e.Right)((0,e.Just)(new s.ApduResponse({data:new Uint8Array([]),statusCode:new Uint8Array([85,21])})))),expect(i).toEqual((0,e.Right)((0,e.Just)(new s.ApduResponse({data:o.slice(7,38),statusCode:new Uint8Array([144,0])}))))}),it("should return an error if the frame is without index",()=>{const a=t[0].slice(2,4),x=r.handleFrame(a);expect(x).toEqual((0,e.Left)(new c.ReceiverApduError("Unable to parse header from apdu")))}),it("should return an error if the frame is without datasize",()=>{const a=t[0].slice(2,6),x=r.handleFrame(a);expect(x).toEqual((0,e.Left)(new c.ReceiverApduError("Unable to parse header from apdu")))})})});
//# sourceMappingURL=DefaultApduReceiverService.test.js.map

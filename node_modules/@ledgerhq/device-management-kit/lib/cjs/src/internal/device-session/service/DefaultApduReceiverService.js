"use strict";var p=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var C=Object.prototype.hasOwnProperty;var D=(o,e)=>{for(var r in e)p(o,r,{get:e[r],enumerable:!0})},G=(o,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of H(e))!C.call(o,t)&&t!==r&&p(o,t,{get:()=>e[t],enumerable:!(n=F(e,t))||n.enumerable});return o};var P=o=>G(p({},"__esModule",{value:!0}),o),_=(o,e,r,n)=>{for(var t=n>1?void 0:n?F(e,r):e,s=o.length-1,m;s>=0;s--)(m=o[s])&&(t=(n?m(e,r,t):m(t))||t);return n&&t&&p(e,r,t),t},A=(o,e)=>(r,n)=>e(r,n,o);var z={};D(z,{DefaultApduReceiverService:()=>c});module.exports=P(z);var d=require("inversify"),a=require("purify-ts"),f=require("uuid"),y=require("../../../api/device-session/ApduResponse"),i=require("../../../api/device-session/data/FramerConst"),h=require("../../../api/device-session/utils/FramerUtils"),l=require("../../device-session/data/ApduResponseConst"),u=require("../../device-session/model/Errors"),v=require("../../device-session/model/Frame"),E=require("../../device-session/model/FrameHeader"),L=require("../../logger-publisher/di/loggerTypes");let c=class{_channel;_logger;_pendingFrames;constructor({channel:e=a.Maybe.zero()},r){this._channel=e,this._logger=r("ApduReceiverService"),this._pendingFrames=[]}handleFrame(e){return this.getFrameFromBytes(e).map(n=>{if(this._pendingFrames.push(n),!this._pendingFrames[0])return a.Nothing;const t=this._pendingFrames[0].getHeader().getDataLength();return this.getCompleteFrame(t)})}getCompleteFrame(e){return e.chain(r=>{if(!this.isComplete(r))return this._logger.debug("frame is not complete, waiting for more"),a.Nothing;const n=h.FramerUtils.getFirstBytesFrom(this.concatFrames(this._pendingFrames),r),t=h.FramerUtils.getFirstBytesFrom(n,n.length-l.APDU_RESPONSE_STATUS_CODE_LENGTH),s=h.FramerUtils.getLastBytesFrom(n,l.APDU_RESPONSE_STATUS_CODE_LENGTH);return this._pendingFrames=[],(0,a.Just)(new y.ApduResponse({data:t,statusCode:s}))})}getFrameFromBytes(e){const r=this._channel.caseOf({Just:()=>i.CHANNEL_LENGTH,Nothing:()=>0}),n=e.slice(r,r+i.HEAD_TAG_LENGTH),t=e.slice(r+i.HEAD_TAG_LENGTH,r+i.HEAD_TAG_LENGTH+i.INDEX_LENGTH),s=t.reduce((T,U)=>T+U,0)===0;if(!s&&this._pendingFrames.length===0)return(0,a.Left)(new u.ReceiverApduError);const m=r+i.HEAD_TAG_LENGTH+i.INDEX_LENGTH,g=s?i.APDU_DATA_LENGTH_LENGTH:0;if(e.length<r+i.HEAD_TAG_LENGTH+i.INDEX_LENGTH+g)return(0,a.Left)(new u.ReceiverApduError("Unable to parse header from apdu"));const b=s?(0,a.Just)(e.slice(m,m+g)):a.Nothing,S=m+g,N=e.slice(S),R=new v.Frame({header:new E.FrameHeader({uuid:(0,f.v4)(),channel:this._channel,dataSize:b,headTag:n,index:t,length:r+i.HEAD_TAG_LENGTH+i.INDEX_LENGTH+g}),data:N});return(0,a.Right)(R)}isComplete(e){return this._pendingFrames.reduce((n,t)=>n+t.getData().length,0)>=e}concatFrames(e){return e.reduce((r,n)=>Uint8Array.from([...r,...n.getData()]),new Uint8Array(0))}};c=_([(0,d.injectable)(),A(1,(0,d.inject)(L.loggerTypes.LoggerPublisherServiceFactory))],c);0&&(module.exports={DefaultApduReceiverService});
//# sourceMappingURL=DefaultApduReceiverService.js.map

"use strict";var h=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var g=Object.prototype.hasOwnProperty;var W=(n,e)=>{for(var r in e)h(n,r,{get:e[r],enumerable:!0})},E=(n,e,r,p)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of L(e))!g.call(n,s)&&s!==r&&h(n,s,{get:()=>e[s],enumerable:!(p=v(e,s))||p.enumerable});return n};var f=n=>E(h({},"__esModule",{value:!0}),n);var I={};W(I,{ListAppsWithMetadataDeviceAction:()=>x});module.exports=f(I);var u=require("purify-ts"),a=require("xstate"),l=require("../../../device-action/model/UserInteractionRequired"),d=require("../../../device-action/os/Const"),S=require("../../../device-action/os/ListApps/ListAppsDeviceAction"),M=require("../../../device-action/xstate-utils/XStateDeviceAction");class x extends M.XStateDeviceAction{makeStateMachine(e){const{getAppsByHash:r,setDeviceSessionState:p,getDeviceSessionState:s}=this.extractDependencies(e),o=this.input.unlockTimeout??d.DEFAULT_UNLOCK_TIMEOUT_MS,c=new S.ListAppsDeviceAction({input:{unlockTimeout:o}}).makeStateMachine(e);return(0,a.setup)({types:{input:{unlockTimeout:o},context:{},output:{}},actors:{listApps:c,getAppsByHash:(0,a.fromPromise)(r),updateDeviceSessionState:(0,a.fromCallback)(({input:t,sendBack:i})=>{const{appsWithMetadata:D}=t,y=D.filter(A=>A!==null),m={...s(),installedApps:y};try{p(m),i({type:"done"})}catch(A){i({type:"error",error:A})}})},guards:{hasError:({context:t})=>t._internalState.error!==null,hasNoAppsInstalled:({context:t})=>t._internalState.apps.length===0},actions:{assignErrorFromEvent:(0,a.assign)({_internalState:t=>({...t.context._internalState,error:t.event.error})})}}).createMachine({id:"ListAppsWithMetadataDeviceAction",initial:"DeviceReady",context:t=>({input:t.input,_internalState:{error:null,apps:[],appsWithMetadata:[]},intermediateValue:{requiredUserInteraction:l.UserInteractionRequired.None}}),states:{DeviceReady:{always:{target:"ListApps"}},ListApps:{invoke:{id:"listApps",src:"listApps",input:t=>({unlockTimeout:t.context.input.unlockTimeout}),onSnapshot:{actions:(0,a.assign)({intermediateValue:t=>t.event.snapshot.context.intermediateValue})},onDone:{target:"ListAppsCheck",actions:(0,a.assign)({intermediateValue:t=>({requiredUserInteraction:l.UserInteractionRequired.None}),_internalState:t=>t.event.output.caseOf({Right:i=>({...t.context._internalState,apps:i}),Left:i=>({...t.context._internalState,error:i})})})}}},ListAppsCheck:{always:[{target:"Error",guard:"hasError"},{target:"Success",guard:"hasNoAppsInstalled",actions:(0,a.assign)({_internalState:t=>({...t.context._internalState,appsWithMetadata:[]})})},{target:"FetchMetadata"}]},FetchMetadata:{invoke:{id:"getAppsByHash",src:"getAppsByHash",input:t=>t.context._internalState.apps,onDone:{target:"FetchMetadataCheck",actions:(0,a.assign)({_internalState:t=>t.event.output.caseOf({Right:i=>({...t.context._internalState,appsWithMetadata:i}),Left:i=>({...t.context._internalState,error:i})})})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},FetchMetadataCheck:{always:[{target:"Error",guard:"hasError"},{target:"SaveSession"}]},SaveSession:{invoke:{src:"updateDeviceSessionState",input:t=>({appsWithMetadata:t.context._internalState.appsWithMetadata})},on:{done:{target:"Success"},error:{target:"Error",actions:"assignErrorFromEvent"}}},Success:{type:"final"},Error:{type:"final"}},output:t=>t.context._internalState.error?(0,u.Left)(t.context._internalState.error):(0,u.Right)(t.context._internalState.appsWithMetadata)})}extractDependencies(e){return{getAppsByHash:({input:p})=>{const s=p.reduce((o,c)=>c.appFullHash?o.concat(c.appFullHash):o,[]);return e.getManagerApiService().getAppsByHash(s)},getDeviceSessionState:()=>e.getDeviceSessionState(),setDeviceSessionState:p=>e.setDeviceSessionState(p)}}}0&&(module.exports={ListAppsWithMetadataDeviceAction});
//# sourceMappingURL=ListAppsWithMetadataDeviceAction.js.map

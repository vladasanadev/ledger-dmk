{
  "version": 3,
  "sources": ["../../../../../../../src/api/device-action/os/GoToDashboard/GoToDashboardDeviceAction.ts"],
  "sourcesContent": ["import { Left, Right } from \"purify-ts\";\nimport { assign, fromPromise, setup } from \"xstate\";\n\nimport { isSuccessCommandResult } from \"@api/command/model/CommandResult\";\nimport {\n  CloseAppCommand,\n  type CloseAppCommandResult,\n} from \"@api/command/os/CloseAppCommand\";\nimport {\n  GetAppAndVersionCommand,\n  type GetAppAndVersionCommandResult,\n} from \"@api/command/os/GetAppAndVersionCommand\";\nimport { type InternalApi } from \"@api/device-action/DeviceAction\";\nimport { UserInteractionRequired } from \"@api/device-action/model/UserInteractionRequired\";\nimport { DEFAULT_UNLOCK_TIMEOUT_MS } from \"@api/device-action/os/Const\";\nimport { UnknownDAError } from \"@api/device-action/os/Errors\";\nimport { GetDeviceStatusDeviceAction } from \"@api/device-action/os/GetDeviceStatus/GetDeviceStatusDeviceAction\";\nimport { type StateMachineTypes } from \"@api/device-action/xstate-utils/StateMachineTypes\";\nimport {\n  type DeviceActionStateMachine,\n  XStateDeviceAction,\n} from \"@api/device-action/xstate-utils/XStateDeviceAction\";\nimport {\n  type DeviceSessionState,\n  DeviceSessionStateType,\n} from \"@api/device-session/DeviceSessionState\";\nimport { isDashboardName } from \"@api/utils/AppName\";\n\nimport type {\n  GoToDashboardDAError,\n  GoToDashboardDAInput,\n  GoToDashboardDAIntermediateValue,\n  GoToDashboardDAOutput,\n} from \"./types\";\n\ntype GoToDashboardMachineInternalState = {\n  readonly currentApp: string | null;\n  readonly error: GoToDashboardDAError | null;\n};\n\nexport type MachineDependencies = {\n  readonly getAppAndVersion: () => Promise<GetAppAndVersionCommandResult>;\n  readonly closeApp: () => Promise<CloseAppCommandResult>;\n  readonly getDeviceSessionState: () => DeviceSessionState;\n  readonly setDeviceSessionState: (\n    state: DeviceSessionState,\n  ) => DeviceSessionState;\n};\n\nexport type ExtractMachineDependencies = (\n  internalApi: InternalApi,\n) => MachineDependencies;\n\nexport class GoToDashboardDeviceAction extends XStateDeviceAction<\n  GoToDashboardDAOutput,\n  GoToDashboardDAInput,\n  GoToDashboardDAError,\n  GoToDashboardDAIntermediateValue,\n  GoToDashboardMachineInternalState\n> {\n  makeStateMachine(\n    internalApi: InternalApi,\n  ): DeviceActionStateMachine<\n    GoToDashboardDAOutput,\n    GoToDashboardDAInput,\n    GoToDashboardDAError,\n    GoToDashboardDAIntermediateValue,\n    GoToDashboardMachineInternalState\n  > {\n    type types = StateMachineTypes<\n      GoToDashboardDAOutput,\n      GoToDashboardDAInput,\n      GoToDashboardDAError,\n      GoToDashboardDAIntermediateValue,\n      GoToDashboardMachineInternalState\n    >;\n\n    const {\n      getDeviceSessionState,\n      setDeviceSessionState,\n      closeApp,\n      getAppAndVersion,\n    } = this.extractDependencies(internalApi);\n\n    const unlockTimeout = this.input.unlockTimeout ?? DEFAULT_UNLOCK_TIMEOUT_MS;\n\n    const getDeviceStatusMachine = new GetDeviceStatusDeviceAction({\n      input: {\n        unlockTimeout,\n      },\n    }).makeStateMachine(internalApi);\n    return setup({\n      types: {\n        input: {\n          unlockTimeout,\n        } as types[\"input\"],\n        context: {} as types[\"context\"],\n        output: {} as types[\"output\"],\n      },\n      actors: {\n        getAppAndVersion: fromPromise(getAppAndVersion),\n        closeApp: fromPromise(closeApp),\n        getDeviceStatus: getDeviceStatusMachine,\n      },\n      guards: {\n        hasError: ({ context }: { context: types[\"context\"] }) => {\n          return context._internalState.error !== null;\n        },\n        isDashboardOpen: ({ context }: { context: types[\"context\"] }) =>\n          context._internalState.currentApp !== null &&\n          isDashboardName(context._internalState.currentApp),\n      },\n      actions: {\n        // assignGetDeviceStatusUnknownError: assign({\n        //   _internalState: (_) => ({\n        //     ..._.context._internalState,\n        //     error: new UnknownDAError(\"GetDeviceUnknownStatusError\"),\n        //   }),\n        // }),\n        assignErrorFromEvent: assign({\n          _internalState: (_) => ({\n            ..._.context._internalState,\n            error: _.event[\"error\"], // NOTE: it should never happen, the error is not typed anymore here\n          }),\n        }),\n      },\n    }).createMachine({\n      /** @xstate-layout N4IgpgJg5mDOIC5QHED2AVVARAhrAFgEao4BOEWYAbgJYDGYAgnQC42oB2AdJbQwEpgcEAJ4BiANoAGALqJQAB1SwabTvJAAPRAHYAjFwDMATikA2MwA5DOnQBYArGeOGANCBGI9VrlcvmpRyknQwcAXzD3NExcAmIyCmp6JlZ2bmQwFl5kgGUWHBYAV1gxCE4wLhoOKlQAawqIJIY8guLpOSQQJRU1Dg1tBAAmOy49QYcpHQdBvR0pMcszO3dPBEM7My4HYz1pqWNLPRsdJYiojGw8IhJybIZmXq4AYXwwOlq7sBaikvaNbtUaX6iDsgy2g3Wdksjn8JlBDhWiAchk2OkMgysB2RzlBZxA0UucRuiT4KUeLzeHyaX3yP0keg6imUgPUnQGgxmo3hdkcemMwwcG0RCGxXDRGMsWJRxlxkXxF1i1wSnweaR4V3i5Ap70ksn+zN6wIQfMsYsG0LMg2MZlm60mwucDi4HMli0GgX0zjxBMVmpJyVVnHVRIS2tq9MZXQNQLZII5XEcoQx5kO3mWHkQjud5oOlo93mM3oVGuJKtSQd9xLDkkGkYBhtjCEtxi41h5fJs+ysOgdOjBE2Gw1sUmC5qLMRLyupge4ldDrx1EkMdejrNAA2sTu8jsO0Lsej5wr7prsoTGs2CJz748JStu0-L3CeABtlEwFApSuVKtU6hUfZO96kjOzyvrA74KAgVQ1HQBRpO0fydPWMbrl4kwGFMzizMYcyCsK-gjE4OiWBC-jGDK+g3nOQEBo+oFvowH5iGApCkKgpBcAoz4FAAZuxAC2XAASGNH3HRL4MR+UG-rBvQIXqSGrn0jaHGCNocoYko2BiUzCvymyadsdg6Dh+zTFRgH+mJ5JgRB1aIUyPQoVoaHEWKegjsYDgOGi9hjMKHmGAYdg7KCVhLOagoWSJVlkmqEngYxCj2Qy+pOWuLnGuMUhcNagoHMZgqhMYAVSEFCahRKEWWFFcrCXesUgRkLBJYwHAQAAaixKicF+HAVNBf5CcWMVlo8zWte1XWkD1HDSTBcGcPJK7pcpqEIARCZQsMqZSDM+7Cg4limjaXnbHMlhzIYERyhwqCNPAnT1X6Y3OchGUDAAtDKvj6NYgQohYljCsMRjzIYASTN2NjXXVI0Na9FbUoIwirI5LJrZloJcCOI52GVZihD5goIhmxoHq24OQycl02NFCMPuNmSfN8xRpRjRqfRsv16P9p4WFYIOGIYCYjgex1mD5oLrPTL2M-FC5UqSrOPejDbrbMraniZ+4nGV6J6OmqwbJsl3jPY2wQ2YaKy6W8sVpZYbs+rmUzDl4y84T7rBDyZgOvsWvqd4EI67bU7AeJtlJc7zkbnyYrBORxGaVCDh6PhhtGAcJjjPye3EWHolxUGCV2YrMcfWhFi5TyjgUYb9h+2TFG+GMIUhRyUy7IXjV0RNH5tZ13VvUpRpjOYYpBWZCxzOnZNHQZGweSR7qhDLcMTqN9vcDkhR0AwsCq1Gq1GhyIxWvsSYWMZ-I9mTJGEbXsx7Av4Qb7ecsR48ACirHsRXmMBjIi2JaRwEIDzeWtsDMmgUdCthwjadSaJFiWBumEIAA */\n      id: \"GoToDashboardDeviceAction\",\n      initial: \"DeviceReady\",\n      context: (_) => {\n        const sessionState = getDeviceSessionState();\n        return {\n          input: {\n            unlockTimeout: _.input.unlockTimeout,\n          },\n          intermediateValue: {\n            requiredUserInteraction: UserInteractionRequired.None,\n          },\n          _internalState: {\n            currentApp:\n              \"currentApp\" in sessionState\n                ? sessionState.currentApp.name\n                : null,\n            error: null,\n          },\n        };\n      },\n      states: {\n        DeviceReady: {\n          always: {\n            target: \"GetDeviceStatus\",\n          },\n        },\n        GetDeviceStatus: {\n          // We run the GetDeviceStatus flow to get information about the device state\n          invoke: {\n            id: \"deviceStatus\",\n            src: \"getDeviceStatus\",\n            input: (_) => ({\n              unlockTimeout: _.context.input.unlockTimeout,\n            }),\n            onSnapshot: {\n              actions: assign({\n                intermediateValue: (_) =>\n                  _.event.snapshot.context.intermediateValue,\n              }),\n            },\n            onDone: {\n              target: \"CheckDeviceStatus\",\n              actions: assign({\n                _internalState: (_) => {\n                  return _.event.output.caseOf<GoToDashboardMachineInternalState>(\n                    {\n                      Right: (output) => ({\n                        ..._.context._internalState,\n                        currentApp: output.currentApp,\n                      }),\n                      Left: (error) => ({\n                        ..._.context._internalState,\n                        error,\n                      }),\n                    },\n                  );\n                },\n              }),\n            },\n            // NOTE: The way we handle our DeviceActions means that we should never as we return an Either\n            // onError: {\n            //   target: \"Error\",\n            //   actions: \"assignGetDeviceStatusUnknownError\",\n            // },\n          },\n        },\n        CheckDeviceStatus: {\n          // We check the device status to see if we can have an error\n          always: [\n            {\n              target: \"Error\",\n              guard: \"hasError\",\n            },\n            {\n              target: \"DashboardCheck\",\n            },\n          ],\n        },\n        DashboardCheck: {\n          // We check if the dashboard is open\n          always: [\n            {\n              target: \"Success\",\n              guard: \"isDashboardOpen\",\n            },\n            {\n              target: \"Error\",\n              guard: \"hasError\",\n            },\n            {\n              target: \"Error\",\n              guard: (_) => {\n                return _.context._internalState.currentApp === null;\n              },\n              actions: assign({\n                _internalState: (_) => ({\n                  ..._.context._internalState,\n                  error: new UnknownDAError(\"currentApp === null\"),\n                }),\n              }),\n            },\n            {\n              target: \"CloseApp\",\n            },\n          ],\n        },\n        CloseApp: {\n          invoke: {\n            src: \"closeApp\",\n            onDone: {\n              target: \"CloseAppCheck\",\n              actions: assign({\n                _internalState: (_) => {\n                  if (isSuccessCommandResult(_.event.output)) {\n                    return _.context._internalState;\n                  }\n                  return {\n                    ..._.context._internalState,\n                    error: _.event.output.error,\n                  };\n                },\n              }),\n            },\n            onError: {\n              target: \"Error\",\n              actions: \"assignErrorFromEvent\",\n            },\n          },\n        },\n        CloseAppCheck: {\n          always: [\n            {\n              target: \"Error\",\n              guard: \"hasError\",\n            },\n            {\n              target: \"GetAppAndVersion\",\n              reenter: true,\n            },\n          ],\n        },\n        GetAppAndVersion: {\n          invoke: {\n            src: \"getAppAndVersion\",\n            onDone: {\n              target: \"DashboardCheck\",\n              actions: assign({\n                _internalState: (_) => {\n                  if (isSuccessCommandResult(_.event.output)) {\n                    const state: DeviceSessionState = getDeviceSessionState();\n                    // Narrow the type to ReadyWithoutSecureChannelState or ReadyWithSecureChannelState\n                    if (\n                      state.sessionStateType !==\n                      DeviceSessionStateType.Connected\n                    ) {\n                      setDeviceSessionState({\n                        ...state,\n                        currentApp: _.event.output.data,\n                      });\n                    }\n                    return {\n                      ..._.context._internalState,\n                      currentApp: _.event.output.data.name,\n                    };\n                  }\n                  return {\n                    ..._.context._internalState,\n                    error: _.event.output.error,\n                  };\n                },\n              }),\n            },\n          },\n        },\n        Success: {\n          type: \"final\",\n        },\n        Error: {\n          type: \"final\",\n        },\n      },\n      output: (_) => {\n        if (_.context._internalState.error) {\n          return Left(_.context._internalState.error);\n        }\n\n        return Right(undefined);\n      },\n    });\n  }\n\n  extractDependencies(internalApi: InternalApi): MachineDependencies {\n    const closeApp = async () => internalApi.sendCommand(new CloseAppCommand());\n    const getAppAndVersion = async () =>\n      internalApi.sendCommand(new GetAppAndVersionCommand());\n\n    return {\n      closeApp,\n      getAppAndVersion,\n      getDeviceSessionState: () => internalApi.getDeviceSessionState(),\n      setDeviceSessionState: (state: DeviceSessionState) =>\n        internalApi.setDeviceSessionState(state),\n    };\n  }\n}\n"],
  "mappings": "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",
  "names": ["GoToDashboardDeviceAction_exports", "__export", "GoToDashboardDeviceAction", "__toCommonJS", "import_purify_ts", "import_xstate", "import_CommandResult", "import_CloseAppCommand", "import_GetAppAndVersionCommand", "import_UserInteractionRequired", "import_Const", "import_Errors", "import_GetDeviceStatusDeviceAction", "import_XStateDeviceAction", "import_DeviceSessionState", "import_AppName", "internalApi", "getDeviceSessionState", "setDeviceSessionState", "closeApp", "getAppAndVersion", "unlockTimeout", "getDeviceStatusMachine", "context", "_", "sessionState", "output", "error", "state"]
}

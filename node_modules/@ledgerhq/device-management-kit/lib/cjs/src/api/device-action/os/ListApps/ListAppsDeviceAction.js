"use strict";var u=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var y=Object.prototype.hasOwnProperty;var S=(o,e)=>{for(var a in e)u(o,a,{get:e[a],enumerable:!0})},g=(o,e,a,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of L(e))!y.call(o,r)&&r!==a&&u(o,r,{get:()=>e[r],enumerable:!(s=D(e,r))||s.enumerable});return o};var x=o=>g(u({},"__esModule",{value:!0}),o);var v={};S(v,{ListAppsDeviceAction:()=>E});module.exports=x(v);var p=require("purify-ts"),n=require("xstate"),c=require("../../../command/model/CommandResult"),l=require("../../../command/os/ListAppsCommand"),i=require("../../../device-action/model/UserInteractionRequired"),A=require("../../../device-action/os/Const"),m=require("../../../device-action/os/GoToDashboard/GoToDashboardDeviceAction"),d=require("../../../device-action/xstate-utils/XStateDeviceAction");class E extends d.XStateDeviceAction{makeStateMachine(e){const{listApps:a}=this.extractDependencies(e),s=this.input.unlockTimeout??A.DEFAULT_UNLOCK_TIMEOUT_MS,r=new m.GoToDashboardDeviceAction({input:{unlockTimeout:s}}).makeStateMachine(e);return(0,n.setup)({types:{input:{unlockTimeout:s},context:{},output:{}},actors:{listApps:(0,n.fromPromise)(a),goToDashboard:r},guards:{hasError:({context:t})=>t._internalState.error!==null,hasMoreApps:t=>t.context._internalState.shouldContinue},actions:{assignAllowListApps:(0,n.assign)({intermediateValue:t=>({requiredUserInteraction:i.UserInteractionRequired.AllowListApps})}),assignErrorFromEvent:(0,n.assign)({_internalState:t=>({...t.context._internalState,error:t.event.error})})}}).createMachine({id:"ListAppsDeviceAction",initial:"DeviceReady",context:t=>({input:{unlockTimeout:t.input.unlockTimeout},intermediateValue:{requiredUserInteraction:i.UserInteractionRequired.None},_internalState:{error:null,apps:[],shouldContinue:!1}}),states:{DeviceReady:{always:{target:"GoToDashboard"}},GoToDashboard:{invoke:{id:"dashboard",src:"goToDashboard",input:t=>({unlockTimeout:t.context.input.unlockTimeout}),onSnapshot:{actions:(0,n.assign)({intermediateValue:t=>t.event.snapshot.context.intermediateValue})},onDone:{target:"GoToDashboardCheck",actions:(0,n.assign)({_internalState:t=>t.event.output.caseOf({Right:()=>t.context._internalState,Left:h=>({...t.context._internalState,error:h})})})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},GoToDashboardCheck:{always:[{target:"Error",guard:"hasError"},{target:"ListApps"}]},ListApps:{entry:"assignAllowListApps",invoke:{src:"listApps",input:t=>!1,onDone:{target:"Continue",actions:(0,n.assign)({_internalState:t=>(0,c.isSuccessCommandResult)(t.event.output)?{...t.context._internalState,apps:t.context._internalState.apps.concat(t.event.output.data),shouldContinue:t.event.output.data.length>=2}:{...t.context._internalState,error:t.event.output.error},intermediateValue:t=>({...t.context.intermediateValue,requiredUserInteraction:i.UserInteractionRequired.None})})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},ListAppsCheck:{always:[{target:"Error",guard:"hasError"},"ListAppsContinue"]},ListAppsContinue:{invoke:{src:"listApps",input:t=>!0,onDone:{target:"Continue",actions:(0,n.assign)({_internalState:t=>(0,c.isSuccessCommandResult)(t.event.output)?{...t.context._internalState,apps:t.context._internalState.apps.concat(t.event.output.data),shouldContinue:t.event.output.data.length>=2}:{...t.context._internalState,error:t.event.output.error}})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},Continue:{always:[{target:"ListAppsContinue",guard:"hasMoreApps"},{target:"Success"}]},Success:{type:"final"},Error:{type:"final"}},output:t=>t.context._internalState.error?(0,p.Left)(t.context._internalState.error):(0,p.Right)(t.context._internalState.apps)})}extractDependencies(e){return{listApps:async({input:s})=>{const r=new l.ListAppsCommand({isContinue:s});return e.sendCommand(r)}}}}0&&(module.exports={ListAppsDeviceAction});
//# sourceMappingURL=ListAppsDeviceAction.js.map

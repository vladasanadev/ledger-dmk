{
  "version": 3,
  "sources": ["../../../../../../../src/api/device-action/os/ListAppsWithMetadata/ListAppsWithMetadataDeviceAction.ts"],
  "sourcesContent": ["import { type EitherAsync, Left, Right } from \"purify-ts\";\nimport {\n  type AnyEventObject,\n  assign,\n  fromCallback,\n  fromPromise,\n  setup,\n} from \"xstate\";\n\nimport { type ListAppsResponse } from \"@api/command/os/ListAppsCommand\";\nimport { type InternalApi } from \"@api/device-action/DeviceAction\";\nimport { UserInteractionRequired } from \"@api/device-action/model/UserInteractionRequired\";\nimport { DEFAULT_UNLOCK_TIMEOUT_MS } from \"@api/device-action/os/Const\";\nimport { ListAppsDeviceAction } from \"@api/device-action/os/ListApps/ListAppsDeviceAction\";\nimport { type ListAppsDAOutput } from \"@api/device-action/os/ListApps/types\";\nimport { type StateMachineTypes } from \"@api/device-action/xstate-utils/StateMachineTypes\";\nimport {\n  type DeviceActionStateMachine,\n  XStateDeviceAction,\n} from \"@api/device-action/xstate-utils/XStateDeviceAction\";\nimport { type DeviceSessionState } from \"@api/device-session/DeviceSessionState\";\nimport { type Application } from \"@internal/manager-api/model/Application\";\nimport { type HttpFetchApiError } from \"@internal/manager-api/model/Errors\";\n\nimport {\n  type ListAppsWithMetadataDAError,\n  type ListAppsWithMetadataDAInput,\n  type ListAppsWithMetadataDAIntermediateValue,\n  type ListAppsWithMetadataDAOutput,\n} from \"./types\";\n\ntype ListAppsWithMetadataMachineInternalState = {\n  error: ListAppsWithMetadataDAError | null;\n  apps: ListAppsResponse;\n  appsWithMetadata: ListAppsWithMetadataDAOutput;\n};\n\nexport type MachineDependencies = {\n  getAppsByHash: ({\n    input,\n  }: {\n    input: ListAppsDAOutput;\n  }) => EitherAsync<HttpFetchApiError, Array<Application | null>>;\n  getDeviceSessionState: () => DeviceSessionState;\n  setDeviceSessionState: (state: DeviceSessionState) => DeviceSessionState;\n};\n\nexport class ListAppsWithMetadataDeviceAction extends XStateDeviceAction<\n  ListAppsWithMetadataDAOutput,\n  ListAppsWithMetadataDAInput,\n  ListAppsWithMetadataDAError,\n  ListAppsWithMetadataDAIntermediateValue,\n  ListAppsWithMetadataMachineInternalState\n> {\n  makeStateMachine(\n    internalAPI: InternalApi,\n  ): DeviceActionStateMachine<\n    ListAppsWithMetadataDAOutput,\n    ListAppsWithMetadataDAInput,\n    ListAppsWithMetadataDAError,\n    ListAppsWithMetadataDAIntermediateValue,\n    ListAppsWithMetadataMachineInternalState\n  > {\n    type types = StateMachineTypes<\n      ListAppsWithMetadataDAOutput,\n      ListAppsWithMetadataDAInput,\n      ListAppsWithMetadataDAError,\n      ListAppsWithMetadataDAIntermediateValue,\n      ListAppsWithMetadataMachineInternalState\n    >;\n\n    const { getAppsByHash, setDeviceSessionState, getDeviceSessionState } =\n      this.extractDependencies(internalAPI);\n\n    const unlockTimeout = this.input.unlockTimeout ?? DEFAULT_UNLOCK_TIMEOUT_MS;\n\n    const listAppsMachine = new ListAppsDeviceAction({\n      input: {\n        unlockTimeout,\n      },\n    }).makeStateMachine(internalAPI);\n\n    return setup({\n      types: {\n        input: {\n          unlockTimeout,\n        } as types[\"input\"],\n        context: {} as types[\"context\"],\n        output: {} as types[\"output\"],\n      },\n      actors: {\n        listApps: listAppsMachine,\n        getAppsByHash: fromPromise(getAppsByHash),\n        updateDeviceSessionState: fromCallback(\n          ({\n            input,\n            sendBack,\n          }: {\n            sendBack: (event: AnyEventObject) => void;\n            input: {\n              appsWithMetadata: Array<Application | null>;\n            };\n          }) => {\n            const { appsWithMetadata } = input;\n\n            const filterted = appsWithMetadata.filter((app) => app !== null);\n\n            const sessionState = getDeviceSessionState();\n            const updatedState = {\n              ...sessionState,\n              installedApps: filterted,\n            };\n            try {\n              setDeviceSessionState(updatedState);\n              sendBack({ type: \"done\" });\n            } catch (error) {\n              sendBack({ type: \"error\", error });\n            }\n          },\n        ),\n      },\n      guards: {\n        hasError: ({ context }: { context: types[\"context\"] }) => {\n          return context._internalState.error !== null;\n        },\n        hasNoAppsInstalled: ({ context }: { context: types[\"context\"] }) =>\n          context._internalState.apps.length === 0,\n      },\n      actions: {\n        assignErrorFromEvent: assign({\n          _internalState: (_) => ({\n            ..._.context._internalState,\n            error: _.event[\"error\"], // NOTE: it should never happen, the error is not typed anymore here\n          }),\n        }),\n      },\n    }).createMachine({\n      /** @xstate-layout N4IgpgJg5mDOIC5QBkCWsAuBBADj2A6qhgBYCyYGAhhFdQCJgBuqAxmFqxqgPYB2AOkYt2AJTA0AngGIA2gAYAuolA4esYrz4qQAD0QBGAJzyBADgBsAdgNWAzPIAs8+TceOANCEmILAJjMBKwsHOyMjAzN7SIBfGK80TFx8IlIKaloGZjYOLi0BROw8WGkIfjABVD4mHgBrCoAbdCL8BWUkEDUNbn4dfQQAVgCBIz9IgacQ6z8-Lx8Ef1N5OwsBlbs7dyNHCziE5uTCYnJKGjoqYRzOHsFCw+kwACdHnkeBHAa6ADNXgFsBJpJYptHRdTS9Dr9IaBUbjSYrKwzOaIMwGAQTFx2MxmOx+AYDKxGAZ7EB3YqpE4Zc6XdjXfJk-AAYRIYFYtTkSlB6nB2khKKGAj89jCRjCFmWdmRCD8LiCGIMMysqIsCpJDKOaVOmQu2VpeX4BQOxWZrPZsgM7VU3JufX5fkFwvCYolUqVjkFyxlA3FeO9VjVRpSx3SZyyIlyN0NQKZLLZcj8ls61q0toQZgFQo2TqM4o2UosjjsQRC8iFa1GfiJAejGspoZ14bpBoAYpRWHXtaVypVqnUKjAWrAAEKSAASVFgJBBHTBNr5CAM7gsAkcY3TZmW-iMiPzm0Flkc2PX8gMTmrg4pIe1NIj+VbGHbV-OD2er3enwwP0e-wHhxH48nacrW6FN50XHYVzXAYNxWSsd28RA7GMQUMUcaCLFFTZdniUlA1rJ8wyufVBHvR8tXOE04yApMQIhUB+kiVYBFLTYbBmPwCwsKUdjRRxghVMwAlWSIjHPQ5L3Iwi9UjUiOwo2MzQtLlaN5ejDEsAZmL8ViFRmTj8wLSDt3kbFtzGZYxPJYNJIbIjIwAZSoJgwHsuANH4Ls+DAajZ1AtTpQ4wJnH8UyHB9fNgiMjCzCdcUzEcSyg01KkpNvA1HOc1zYHcvgXxeR4fOTOi9EQPSgvkEKYrC0spQJIwRn4pw8QLAwQjiHC+B4CA4B0dUJJS2zpL8mieVTABaLiEIQMbNPCOb5vmyxEvwmybybQQb3EKRlNG+dV3zIVizCxwc3sPxlv6+s1uIqNBx2ud-ICWa1lPexsWMb18ycQUS3FfEFTsb0LusgbrsjdVKNqe7hv6CwogECwCxPQGhSsNCjHzVdmIMMKBgMBV8eMYHkqu3U0pIts5OoaHioY093QCEwMNFJV5Gg-NInRHGKoqnNSzR4mqcG8mBFkgiqEhmnVJKhdVndQTlncKxXCsfF829H6HFsEJvSFbD9hrS7rzJ9aBAyly3OG3zadK-nzAGUUzKsQlxQxqaQnq2xt1XNnnBMuxBfFsH8nsgBXVh2GyqXUzxCqBEB7YxlXGLIisV0cy5sLlcR53RUD1aTZugBRV9Hmj+dY+XBPV0XRnU9qyxzGiiqNwmOxgnamIgA */\n      id: \"ListAppsWithMetadataDeviceAction\",\n      initial: \"DeviceReady\",\n      context: (_) => {\n        return {\n          input: _.input,\n          _internalState: {\n            error: null,\n            apps: [],\n            appsWithMetadata: [],\n          },\n          intermediateValue: {\n            requiredUserInteraction: UserInteractionRequired.None,\n          },\n        };\n      },\n      states: {\n        DeviceReady: {\n          always: {\n            target: \"ListApps\",\n          },\n        },\n        ListApps: {\n          invoke: {\n            id: \"listApps\",\n            src: \"listApps\",\n            input: (_) => ({\n              unlockTimeout: _.context.input.unlockTimeout,\n            }),\n            onSnapshot: {\n              actions: assign({\n                intermediateValue: (_) =>\n                  _.event.snapshot.context.intermediateValue,\n              }),\n            },\n            onDone: {\n              target: \"ListAppsCheck\",\n              actions: assign({\n                intermediateValue: (_) => ({\n                  requiredUserInteraction: UserInteractionRequired.None,\n                }),\n                _internalState: (_) => {\n                  return _.event.output.caseOf({\n                    Right: (apps) => ({\n                      ..._.context._internalState,\n                      apps,\n                    }),\n                    Left: (error) => ({\n                      ..._.context._internalState,\n                      error,\n                    }),\n                  });\n                },\n              }),\n            },\n          },\n        },\n        ListAppsCheck: {\n          always: [\n            {\n              target: \"Error\",\n              guard: \"hasError\",\n            },\n            {\n              target: \"Success\",\n              guard: \"hasNoAppsInstalled\",\n              actions: assign({\n                _internalState: (_) => {\n                  return {\n                    ..._.context._internalState,\n                    appsWithMetadata: [],\n                  };\n                },\n              }),\n            },\n            {\n              target: \"FetchMetadata\",\n            },\n          ],\n        },\n        FetchMetadata: {\n          invoke: {\n            id: \"getAppsByHash\",\n            src: \"getAppsByHash\",\n            input: (_) => _.context._internalState.apps,\n            onDone: {\n              target: \"FetchMetadataCheck\",\n              actions: assign({\n                _internalState: (_) => {\n                  return _.event.output.caseOf({\n                    Right: (appsWithMetadata) => ({\n                      ..._.context._internalState,\n                      appsWithMetadata,\n                    }),\n                    Left: (error) => ({\n                      ..._.context._internalState,\n                      error,\n                    }),\n                  });\n                },\n              }),\n            },\n            onError: {\n              target: \"Error\",\n              actions: \"assignErrorFromEvent\",\n            },\n          },\n        },\n        FetchMetadataCheck: {\n          always: [\n            {\n              target: \"Error\",\n              guard: \"hasError\",\n            },\n            {\n              target: \"SaveSession\",\n            },\n          ],\n        },\n        SaveSession: {\n          invoke: {\n            src: \"updateDeviceSessionState\",\n            input: (_) => ({\n              appsWithMetadata: _.context._internalState.appsWithMetadata,\n            }),\n          },\n          on: {\n            done: {\n              target: \"Success\",\n            },\n            error: {\n              target: \"Error\",\n              actions: \"assignErrorFromEvent\",\n            },\n          },\n        },\n        Success: {\n          type: \"final\",\n        },\n        Error: {\n          type: \"final\",\n        },\n      },\n      output: (_) => {\n        if (_.context._internalState.error) {\n          return Left(_.context._internalState.error);\n        }\n\n        return Right(_.context._internalState.appsWithMetadata);\n      },\n    });\n  }\n\n  extractDependencies(internalApi: InternalApi): MachineDependencies {\n    const getAppsByHash = ({ input }: { input: ListAppsDAOutput }) => {\n      const appHashes = input.reduce<string[]>((acc, app) => {\n        if (app.appFullHash) {\n          return acc.concat(app.appFullHash);\n        }\n        return acc;\n      }, []);\n      return internalApi.getManagerApiService().getAppsByHash(appHashes);\n    };\n    return {\n      getAppsByHash,\n      getDeviceSessionState: () => internalApi.getDeviceSessionState(),\n      setDeviceSessionState: (state: DeviceSessionState) =>\n        internalApi.setDeviceSessionState(state),\n    };\n  }\n}\n"],
  "mappings": "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",
  "names": ["ListAppsWithMetadataDeviceAction_exports", "__export", "ListAppsWithMetadataDeviceAction", "__toCommonJS", "import_purify_ts", "import_xstate", "import_UserInteractionRequired", "import_Const", "import_ListAppsDeviceAction", "import_XStateDeviceAction", "internalAPI", "getAppsByHash", "setDeviceSessionState", "getDeviceSessionState", "unlockTimeout", "listAppsMachine", "input", "sendBack", "appsWithMetadata", "filterted", "app", "updatedState", "error", "context", "_", "apps", "internalApi", "appHashes", "acc", "state"]
}

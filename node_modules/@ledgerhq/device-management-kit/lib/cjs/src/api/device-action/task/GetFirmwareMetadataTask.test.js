"use strict";var n=require("purify-ts"),s=require("../../command/Errors"),e=require("../../command/model/CommandResult"),v=require("../../device-action/__test-utils__/makeInternalApi"),m=require("./GetFirmwareMetadataTask");describe("GetFirmwareMetadataTask",()=>{const a=(0,v.makeDeviceActionInternalApiMock)(),o={mcuSephVersion:"mcu_version",mcuBootloaderVersion:"bl_version",seVersion:"se_version"},w=97,u={id:7},i={id:361,version:"1.6.0",perso:"perso_11"},l={id:362,perso:"perso_11"},d={id:363,version:"1.7.0",perso:"perso_11",mcuVersions:[1]},V=[{id:3,name:"other_version"},{id:1,name:"mcu_version"}],r={getDeviceVersion:vi.fn(),getFirmwareVersion:vi.fn(),getLatestFirmwareVersion:vi.fn(),getNextFirmwareVersion:vi.fn(),getMcuList:vi.fn()};beforeEach(()=>{vi.clearAllMocks(),a.getManagerApiService.mockReturnValue(r),r.getDeviceVersion.mockReturnValue((0,n.EitherAsync)(async()=>u)),r.getFirmwareVersion.mockReturnValue((0,n.EitherAsync)(async()=>i)),r.getLatestFirmwareVersion.mockReturnValue((0,n.EitherAsync)(async()=>l)),r.getNextFirmwareVersion.mockReturnValue((0,n.EitherAsync)(async()=>d)),r.getMcuList.mockReturnValue((0,n.EitherAsync)(async()=>V))}),it("success with no firmware update available",async()=>{a.sendCommand.mockResolvedValueOnce((0,e.CommandResultFactory)({data:o})).mockResolvedValueOnce((0,e.CommandResultFactory)({data:w})),r.getLatestFirmwareVersion.mockReturnValueOnce((0,n.EitherAsync)(async({throwE:c})=>{c(new Error("error"))}));const t=await new m.GetFirmwareMetadataTask(a).run();expect(t).toStrictEqual((0,e.CommandResultFactory)({data:{deviceVersion:u,firmware:i,firmwareVersion:{mcu:"mcu_version",bootloader:"bl_version",os:"se_version",metadata:o},firmwareUpdateContext:{currentFirmware:i,availableUpdate:void 0},customImage:{size:w}}}))}),it("success with a firmware update available",async()=>{a.sendCommand.mockResolvedValueOnce((0,e.CommandResultFactory)({data:o})).mockResolvedValueOnce((0,e.CommandResultFactory)({error:new s.InvalidStatusWordError("error")}));const t=await new m.GetFirmwareMetadataTask(a).run();expect(t).toStrictEqual((0,e.CommandResultFactory)({data:{deviceVersion:u,firmware:i,firmwareVersion:{mcu:"mcu_version",bootloader:"bl_version",os:"se_version",metadata:o},firmwareUpdateContext:{currentFirmware:i,availableUpdate:{osuFirmware:l,finalFirmware:d,mcuUpdateRequired:!1}},customImage:{}}})),expect(r.getDeviceVersion).toHaveBeenCalledWith(o),expect(r.getFirmwareVersion).toHaveBeenCalledWith(o,u),expect(r.getLatestFirmwareVersion).toHaveBeenCalledWith(i,u),expect(r.getNextFirmwareVersion).toHaveBeenCalledWith(l)}),it("success with a firmware update available and MCU update",async()=>{a.sendCommand.mockResolvedValueOnce((0,e.CommandResultFactory)({data:o})).mockResolvedValueOnce((0,e.CommandResultFactory)({error:new s.InvalidStatusWordError("error")}));const t={...d,mcuVersions:[3]};r.getNextFirmwareVersion.mockReturnValue((0,n.EitherAsync)(async()=>t));const c=await new m.GetFirmwareMetadataTask(a).run();expect(c).toStrictEqual((0,e.CommandResultFactory)({data:{deviceVersion:u,firmware:i,firmwareVersion:{mcu:"mcu_version",bootloader:"bl_version",os:"se_version",metadata:o},firmwareUpdateContext:{currentFirmware:i,availableUpdate:{osuFirmware:l,finalFirmware:t,mcuUpdateRequired:!0}},customImage:{}}}))}),it("should fail when OS version cannot be retrieved",async()=>{a.sendCommand.mockResolvedValueOnce((0,e.CommandResultFactory)({error:new s.InvalidStatusWordError("error")}));const t=await new m.GetFirmwareMetadataTask(a).run();expect(t).toStrictEqual((0,e.CommandResultFactory)({error:new s.InvalidStatusWordError("error")}))}),it("should fail if device version cannot be fetched with InvalidGetFirmwareMetadataResponseError",async()=>{a.sendCommand.mockResolvedValueOnce((0,e.CommandResultFactory)({data:o})),r.getDeviceVersion.mockReturnValueOnce((0,n.EitherAsync)(async({throwE:c})=>{c(new Error("error"))}));const t=await new m.GetFirmwareMetadataTask(a).run();expect(t).toStrictEqual((0,e.CommandResultFactory)({error:new s.InvalidGetFirmwareMetadataResponseError}))}),it("should fail if firmware version cannot be fetched with InvalidGetFirmwareMetadataResponseError",async()=>{a.sendCommand.mockResolvedValueOnce((0,e.CommandResultFactory)({data:o})),r.getFirmwareVersion.mockReturnValueOnce((0,n.EitherAsync)(async({throwE:c})=>{c(new Error("error"))}));const t=await new m.GetFirmwareMetadataTask(a).run();expect(t).toStrictEqual((0,e.CommandResultFactory)({error:new s.InvalidGetFirmwareMetadataResponseError}))})});
//# sourceMappingURL=GetFirmwareMetadataTask.test.js.map

"use strict";var u=require("purify-ts"),S=require("../../../device/DeviceStatus"),i=require("../../../device-action/__test-utils__/data"),o=require("../../../device-action/__test-utils__/makeInternalApi"),p=require("../../../device-action/__test-utils__/setupTestMachine"),c=require("../../../device-action/__test-utils__/testDeviceActionStates"),e=require("../../../device-action/model/DeviceActionState"),t=require("../../../device-action/model/UserInteractionRequired"),l=require("../../../device-action/os/Errors"),g=require("../../../device-session/DeviceSessionState"),w=require("../../../../internal/manager-api/model/Errors"),d=require("./ListAppsWithMetadataDeviceAction");vi.mock("@api/device-action/os/ListApps/ListAppsDeviceAction");describe("ListAppsWithMetadataDeviceAction",()=>{const{getManagerApiService:A}=(0,o.makeDeviceActionInternalApiMock)(),m=vi.fn(),v=vi.fn(),h=vi.fn();function P(){return{getAppsByHash:h,getDeviceSessionState:v,setDeviceSessionState:m}}beforeEach(()=>{vi.resetAllMocks()}),describe("success case",()=>{it("should run the device actions with no apps installed",()=>new Promise((s,a)=>{(0,p.setupListAppsMock)([]);const n=new d.ListAppsWithMetadataDeviceAction({input:{}});A.mockReturnValue({getAppsByHash:vi.fn().mockResolvedValue((0,u.Right)([]))});const r=[{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.AllowListApps},status:e.DeviceActionStatus.Pending},{status:e.DeviceActionStatus.Completed,output:[]}];(0,c.testDeviceActionStates)(n,r,(0,o.makeDeviceActionInternalApiMock)(),{onDone:s,onError:a})})),it("should run the device actions with 1 app installed",()=>new Promise((s,a)=>{(0,p.setupListAppsMock)([i.BTC_APP]);const n=new d.ListAppsWithMetadataDeviceAction({input:{}});A.mockReturnValue({getAppsByHash:vi.fn().mockResolvedValue((0,u.Right)([i.BTC_APP_METADATA]))});const r=[{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.AllowListApps},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{status:e.DeviceActionStatus.Completed,output:[i.BTC_APP_METADATA]}];(0,c.testDeviceActionStates)(n,r,(0,o.makeDeviceActionInternalApiMock)(),{onDone:s,onError:a})})),it("should run the device actions with 2 apps installed",()=>new Promise((s,a)=>{(0,p.setupListAppsMock)([i.BTC_APP,i.ETH_APP]);const n=new d.ListAppsWithMetadataDeviceAction({input:{}});A.mockReturnValue({getAppsByHash:vi.fn().mockResolvedValue((0,u.Right)([i.BTC_APP_METADATA,i.ETH_APP_METADATA]))});const r=[{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.AllowListApps},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{status:e.DeviceActionStatus.Completed,output:[i.BTC_APP_METADATA,i.ETH_APP_METADATA]}];(0,c.testDeviceActionStates)(n,r,(0,o.makeDeviceActionInternalApiMock)(),{onDone:s,onError:a})})),it("should run the device actions with 1 app installed and a custom lock screen",()=>new Promise((s,a)=>{(0,p.setupListAppsMock)([i.BTC_APP,i.CUSTOM_LOCK_SCREEN_APP]);const n=new d.ListAppsWithMetadataDeviceAction({input:{}});A.mockReturnValue({getAppsByHash:vi.fn().mockResolvedValue((0,u.Right)([i.BTC_APP_METADATA,i.CUSTOM_LOCK_SCREEN_APP_METADATA]))});const r=[{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.AllowListApps},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{status:e.DeviceActionStatus.Completed,output:[i.BTC_APP_METADATA,i.CUSTOM_LOCK_SCREEN_APP_METADATA]}];(0,c.testDeviceActionStates)(n,r,(0,o.makeDeviceActionInternalApiMock)(),{onDone:s,onError:a})}))}),describe("error case",()=>{it("should error when ListApps fails",()=>new Promise((s,a)=>{(0,p.setupListAppsMock)([],!0);const n=new d.ListAppsWithMetadataDeviceAction({input:{}}),r=[{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.AllowListApps},status:e.DeviceActionStatus.Pending},{status:e.DeviceActionStatus.Error,error:new l.UnknownDAError("ListApps failed")}];(0,c.testDeviceActionStates)(n,r,(0,o.makeDeviceActionInternalApiMock)(),{onDone:s,onError:a})})),it("should error when getAppsByHash rejects",()=>new Promise((s,a)=>{(0,p.setupListAppsMock)([i.BTC_APP]);const n=new d.ListAppsWithMetadataDeviceAction({input:{}});A.mockReturnValue({getAppsByHash:vi.fn().mockRejectedValue(new l.UnknownDAError("getAppsByHash failed"))});const r=[{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.AllowListApps},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{status:e.DeviceActionStatus.Error,error:new l.UnknownDAError("getAppsByHash failed")}];(0,c.testDeviceActionStates)(n,r,(0,o.makeDeviceActionInternalApiMock)(),{onDone:s,onError:a})})),it("should error when getAppsByHash fails but error is known",()=>new Promise((s,a)=>{(0,p.setupListAppsMock)([i.BTC_APP]);const n=new d.ListAppsWithMetadataDeviceAction({input:{}}),r=new w.HttpFetchApiError(new Error("Failed to fetch data"));A.mockReturnValue({getAppsByHash:vi.fn().mockResolvedValue((0,u.Left)(r))});const D=[{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.AllowListApps},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{status:e.DeviceActionStatus.Error,error:r}];(0,c.testDeviceActionStates)(n,D,(0,o.makeDeviceActionInternalApiMock)(),{onDone:s,onError:a})})),it("should error when SaveSession fails",()=>new Promise((s,a)=>{(0,p.setupListAppsMock)([i.BTC_APP]);const n=new d.ListAppsWithMetadataDeviceAction({input:{}});h.mockImplementation(async()=>Promise.resolve((0,u.Right)([i.BTC_APP_METADATA]))),vi.spyOn(n,"extractDependencies").mockReturnValue(P()),v.mockReturnValue({sessionStateType:g.DeviceSessionStateType.ReadyWithoutSecureChannel,deviceStatus:S.DeviceStatus.CONNECTED,currentApp:"BOLOS",installedApps:[]}),m.mockImplementation(()=>{throw new l.UnknownDAError("SaveSession failed")});const r=[{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.AllowListApps},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{status:e.DeviceActionStatus.Error,error:new l.UnknownDAError("SaveSession failed")}];(0,c.testDeviceActionStates)(n,r,(0,o.makeDeviceActionInternalApiMock)(),{onDone:s,onError:a})}))})});
//# sourceMappingURL=ListAppsWithMetadataDeviceAction.test.js.map

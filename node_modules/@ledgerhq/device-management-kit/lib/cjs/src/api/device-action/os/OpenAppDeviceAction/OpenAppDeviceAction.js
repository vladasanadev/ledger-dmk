"use strict";var l=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var k=(a,t)=>{for(var i in t)l(a,i,{get:t[i],enumerable:!0})},_=(a,t,i,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of N(t))!I.call(a,r)&&r!==i&&l(a,r,{get:()=>t[r],enumerable:!(o=x(t,r))||o.enumerable});return a};var M=a=>_(l({},"__esModule",{value:!0}),a);var V={};k(V,{OpenAppDeviceAction:()=>b});module.exports=M(V);var u=require("purify-ts"),n=require("xstate"),A=require("../../../command/model/CommandResult"),S=require("../../../command/os/CloseAppCommand"),m=require("../../../command/os/OpenAppCommand"),c=require("../../../device-action/model/UserInteractionRequired"),D=require("../../../device-action/os/Const"),g=require("../../../device-action/os/Errors"),y=require("../../../device-action/os/GetDeviceStatus/GetDeviceStatusDeviceAction"),O=require("../../../device-action/xstate-utils/XStateDeviceAction"),d=require("../../../device-session/DeviceSessionState"),v=require("../../../transport/model/Errors"),h=require("../../../utils/AppName");class b extends O.XStateDeviceAction{makeStateMachine(t){const{closeApp:i,openApp:o,getDeviceSessionState:r,isDeviceOnboarded:E,setDeviceSessionState:f}=this.extractDependencies(t),R=this.input.unlockTimeout??D.DEFAULT_UNLOCK_TIMEOUT_MS,C=new y.GetDeviceStatusDeviceAction({input:{unlockTimeout:R}}).makeStateMachine(t);return(0,n.setup)({types:{input:{},context:{},output:{}},actors:{closeApp:(0,n.fromPromise)(i),openApp:(0,n.fromPromise)(o),getDeviceStatus:C},guards:{isDeviceOnboarded:()=>E(),isRequestedAppOpen:({context:e})=>e._internalState.currentlyRunningApp===null?!1:e._internalState.currentlyRunningApp===e.input.appName,isDashboardOpen:({context:e})=>{if(e._internalState.currentlyRunningApp===null)throw new Error("context.currentlyRunningApp === null");return(0,h.isDashboardName)(e._internalState.currentlyRunningApp)},hasDisconnectedWhileSending:({context:e})=>e._internalState.error!==null&&e._internalState.error instanceof v.DeviceDisconnectedWhileSendingError,hasError:({context:e})=>e._internalState.error!==null},actions:{assignErrorDeviceNotOnboarded:(0,n.assign)({_internalState:e=>({...e.context._internalState,error:new g.DeviceNotOnboardedError})}),assignUserActionNeededOpenApp:(0,n.assign)({intermediateValue:e=>({...e.context.intermediateValue,requiredUserInteraction:c.UserInteractionRequired.ConfirmOpenApp})}),assignNoUserActionNeeded:(0,n.assign)({intermediateValue:e=>({...e.context.intermediateValue,requiredUserInteraction:c.UserInteractionRequired.None})}),assignErrorFromEvent:(0,n.assign)({_internalState:e=>({...e.context._internalState,error:e.event.error})}),assignNoError:(0,n.assign)({_internalState:e=>({...e.context._internalState,error:null})})}}).createMachine({id:"OpenAppDeviceAction",initial:"DeviceReady",context:({input:e})=>{const p=r(),{sessionStateType:s}=p;return{input:e,intermediateValue:{requiredUserInteraction:c.UserInteractionRequired.None},_internalState:{error:null,currentlyRunningApp:s===d.DeviceSessionStateType.ReadyWithoutSecureChannel?p.currentApp.name:null}}},states:{DeviceReady:{always:{target:"OnboardingCheck"}},OnboardingCheck:{always:[{target:"GetDeviceStatus",guard:{type:"isDeviceOnboarded"}},{target:"Error",actions:"assignErrorDeviceNotOnboarded"}]},GetDeviceStatus:{invoke:{id:"deviceStatus",src:"getDeviceStatus",input:e=>({unlockTimeout:e.context.input.unlockTimeout}),onSnapshot:{actions:(0,n.assign)({intermediateValue:e=>e.event.snapshot.context.intermediateValue})},onDone:{target:"CheckDeviceStatus",actions:(0,n.assign)({_internalState:e=>e.event.output.caseOf({Right:p=>{const s=r();return s.sessionStateType!==d.DeviceSessionStateType.Connected&&f({...s,currentApp:{name:p.currentApp,version:p.currentAppVersion}}),{...e.context._internalState,currentlyRunningApp:p.currentApp}},Left:p=>({...e.context._internalState,currentlyRunningApp:null,error:p})})})},onError:{target:"Error",actions:[(0,n.assign)({_internalState:e=>({...e.context._internalState,currentlyRunningApp:null})}),"assignErrorFromEvent"]}}},CheckDeviceStatus:{always:[{target:"ApplicationReady",guard:"isRequestedAppOpen",actions:"assignNoError"},{target:"Error",guard:"hasError"},{target:"DashboardCheck"}]},DashboardCheck:{always:[{target:"OpenApplication",guard:"isDashboardOpen"},"CloseApplication"]},OpenApplication:{entry:"assignUserActionNeededOpenApp",exit:"assignNoUserActionNeeded",invoke:{src:"openApp",input:({context:e})=>({appName:e.input.appName}),onDone:{target:"OpenApplicationResultCheck",actions:(0,n.assign)({_internalState:e=>(0,A.isSuccessCommandResult)(e.event.output)?{...e.context._internalState,currentlyRunningApp:e.context.input.appName}:{...e.context._internalState,error:e.event.output.error}})},onError:{target:"OpenApplicationResultCheck",actions:"assignErrorFromEvent"}}},OpenApplicationResultCheck:{always:[{target:"GetDeviceStatus",guard:"hasDisconnectedWhileSending"},{target:"Error",guard:"hasError"},{target:"GetDeviceStatus"}]},CloseApplication:{invoke:{src:"closeApp",onDone:{target:"CloseApplicationResultCheck",actions:(0,n.assign)({_internalState:e=>(0,A.isSuccessCommandResult)(e.event.output)?{...e.context._internalState,currentlyRunningApp:"BOLOS"}:{...e.context._internalState,error:e.event.output.error}})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},CloseApplicationResultCheck:{always:[{target:"Error",guard:"hasError"},{target:"OpenApplication"}]},ApplicationReady:{always:"Success"},Success:{type:"final",actions:"assignNoError"},Error:{type:"final"}},output:({context:e})=>e._internalState.error?(0,u.Left)(e._internalState.error):(0,u.Right)(void 0)})}extractDependencies(t){return{closeApp:async()=>t.sendCommand(new S.CloseAppCommand),openApp:async r=>t.sendCommand(new m.OpenAppCommand({appName:r.input.appName})),getDeviceSessionState:()=>t.getDeviceSessionState(),setDeviceSessionState:r=>t.setDeviceSessionState(r),isDeviceOnboarded:()=>!0}}}0&&(module.exports={OpenAppDeviceAction});
//# sourceMappingURL=OpenAppDeviceAction.js.map

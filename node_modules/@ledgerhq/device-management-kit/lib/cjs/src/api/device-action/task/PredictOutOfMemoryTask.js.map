{
  "version": 3,
  "sources": ["../../../../../../src/api/device-action/task/PredictOutOfMemoryTask.ts"],
  "sourcesContent": ["import type { InternalApi } from \"@api/device-action/DeviceAction\";\nimport { UnknownDAError } from \"@api/device-action/os/Errors\";\nimport { type TransportDeviceModel } from \"@api/device-model/model/DeviceModel\";\nimport {\n  type CustomImage,\n  DeviceSessionStateType,\n  type FirmwareUpdateContext,\n  type FirmwareVersion,\n  type InstalledLanguagePackage,\n} from \"@api/device-session/DeviceSessionState\";\nimport type { Application } from \"@internal/manager-api/model/Application\";\n\nexport type PredictOutOfMemoryTaskArgs = {\n  installPlan: Application[];\n};\n\nexport type PredictOutOfMemoryTaskResult =\n  | {\n      outOfMemory: boolean;\n    }\n  | {\n      error: UnknownDAError;\n    };\n\nexport class PredictOutOfMemoryTask {\n  private readonly deviceModel: TransportDeviceModel;\n\n  constructor(\n    private readonly api: InternalApi,\n    private readonly args: PredictOutOfMemoryTaskArgs,\n  ) {\n    this.deviceModel = api.getDeviceModel();\n  }\n\n  run(): PredictOutOfMemoryTaskResult {\n    const deviceState = this.api.getDeviceSessionState();\n\n    if (deviceState.sessionStateType === DeviceSessionStateType.Connected) {\n      return { error: new UnknownDAError(\"Invalid device state\") };\n    }\n\n    const {\n      firmwareUpdateContext,\n      customImage,\n      firmwareVersion,\n      installedLanguages,\n      installedApps,\n    } = deviceState;\n\n    if (\n      firmwareUpdateContext === undefined ||\n      customImage === undefined ||\n      firmwareVersion === undefined ||\n      installedLanguages === undefined\n    ) {\n      return { error: new UnknownDAError(\"Device metadata not fetched\") };\n    }\n\n    const { blockSize, totalMemoryBlocks } =\n      this.getMemoryConstants(firmwareVersion);\n\n    const currentMemoryBlocksUsage = this.getCurrentMemoryBlocksUsage({\n      firmwareUpdateContext,\n      customImage,\n      installedApps,\n      installedLanguages,\n      blockSize,\n    });\n\n    const installPlanBlocksUsage = this.getInstallPlanMemoryBlocksUsage(\n      this.args.installPlan,\n      blockSize,\n    );\n\n    return {\n      outOfMemory:\n        currentMemoryBlocksUsage + installPlanBlocksUsage > totalMemoryBlocks,\n    };\n  }\n\n  private getMemoryConstants(firmwareVersion: FirmwareVersion): {\n    blockSize: number;\n    totalMemoryBlocks: number;\n  } {\n    const blockSize = this.deviceModel.getBlockSize({\n      firmwareVersion: firmwareVersion.os,\n    });\n    const totalMemoryBlocks = Math.floor(\n      this.deviceModel.memorySize / blockSize,\n    );\n    return { blockSize, totalMemoryBlocks };\n  }\n\n  private getCurrentMemoryBlocksUsage({\n    firmwareUpdateContext,\n    customImage,\n    installedApps,\n    installedLanguages,\n    blockSize,\n  }: {\n    firmwareUpdateContext: FirmwareUpdateContext;\n    customImage: CustomImage;\n    installedApps: Application[];\n    installedLanguages: InstalledLanguagePackage[];\n    blockSize: number;\n  }): number {\n    const bytesToBlocks = (size: number) => Math.ceil(size / blockSize);\n    const firmwareBlocks = bytesToBlocks(\n      firmwareUpdateContext.currentFirmware.bytes || 0,\n    );\n    const customImageBlocks = bytesToBlocks(customImage.size || 0);\n    const applicationsBlocks = installedApps.reduce(\n      (size, app) => size + bytesToBlocks(app.bytes || 0),\n      0,\n    );\n    const languagesBlocks = installedLanguages.reduce(\n      (size, lang) => size + bytesToBlocks(lang.size),\n      0,\n    );\n    return (\n      firmwareBlocks + customImageBlocks + applicationsBlocks + languagesBlocks\n    );\n  }\n\n  private getInstallPlanMemoryBlocksUsage(\n    installPlan: Application[],\n    blockSize: number,\n  ): number {\n    const bytesToBlocks = (size: number) => Math.ceil(size / blockSize);\n    return installPlan.reduce(\n      (size, app) => size + bytesToBlocks(app.bytes || 0),\n      0,\n    );\n  }\n}\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,4BAAAE,IAAA,eAAAC,EAAAH,GACA,IAAAI,EAA+B,wCAE/BC,EAMO,kDAeA,MAAMH,CAAuB,CAGlC,YACmBI,EACAC,EACjB,CAFiB,SAAAD,EACA,UAAAC,EAEjB,KAAK,YAAcD,EAAI,eAAe,CACxC,CAPiB,YASjB,KAAoC,CAClC,MAAME,EAAc,KAAK,IAAI,sBAAsB,EAEnD,GAAIA,EAAY,mBAAqB,yBAAuB,UAC1D,MAAO,CAAE,MAAO,IAAI,iBAAe,sBAAsB,CAAE,EAG7D,KAAM,CACJ,sBAAAC,EACA,YAAAC,EACA,gBAAAC,EACA,mBAAAC,EACA,cAAAC,CACF,EAAIL,EAEJ,GACEC,IAA0B,QAC1BC,IAAgB,QAChBC,IAAoB,QACpBC,IAAuB,OAEvB,MAAO,CAAE,MAAO,IAAI,iBAAe,6BAA6B,CAAE,EAGpE,KAAM,CAAE,UAAAE,EAAW,kBAAAC,CAAkB,EACnC,KAAK,mBAAmBJ,CAAe,EAEnCK,EAA2B,KAAK,4BAA4B,CAChE,sBAAAP,EACA,YAAAC,EACA,cAAAG,EACA,mBAAAD,EACA,UAAAE,CACF,CAAC,EAEKG,EAAyB,KAAK,gCAClC,KAAK,KAAK,YACVH,CACF,EAEA,MAAO,CACL,YACEE,EAA2BC,EAAyBF,CACxD,CACF,CAEQ,mBAAmBJ,EAGzB,CACA,MAAMG,EAAY,KAAK,YAAY,aAAa,CAC9C,gBAAiBH,EAAgB,EACnC,CAAC,EACKI,EAAoB,KAAK,MAC7B,KAAK,YAAY,WAAaD,CAChC,EACA,MAAO,CAAE,UAAAA,EAAW,kBAAAC,CAAkB,CACxC,CAEQ,4BAA4B,CAClC,sBAAAN,EACA,YAAAC,EACA,cAAAG,EACA,mBAAAD,EACA,UAAAE,CACF,EAMW,CACT,MAAMI,EAAiBC,GAAiB,KAAK,KAAKA,EAAOL,CAAS,EAC5DM,EAAiBF,EACrBT,EAAsB,gBAAgB,OAAS,CACjD,EACMY,EAAoBH,EAAcR,EAAY,MAAQ,CAAC,EACvDY,EAAqBT,EAAc,OACvC,CAACM,EAAMI,IAAQJ,EAAOD,EAAcK,EAAI,OAAS,CAAC,EAClD,CACF,EACMC,EAAkBZ,EAAmB,OACzC,CAACO,EAAMM,IAASN,EAAOD,EAAcO,EAAK,IAAI,EAC9C,CACF,EACA,OACEL,EAAiBC,EAAoBC,EAAqBE,CAE9D,CAEQ,gCACNE,EACAZ,EACQ,CACR,MAAMI,EAAiBC,GAAiB,KAAK,KAAKA,EAAOL,CAAS,EAClE,OAAOY,EAAY,OACjB,CAACP,EAAMI,IAAQJ,EAAOD,EAAcK,EAAI,OAAS,CAAC,EAClD,CACF,CACF,CACF",
  "names": ["PredictOutOfMemoryTask_exports", "__export", "PredictOutOfMemoryTask", "__toCommonJS", "import_Errors", "import_DeviceSessionState", "api", "args", "deviceState", "firmwareUpdateContext", "customImage", "firmwareVersion", "installedLanguages", "installedApps", "blockSize", "totalMemoryBlocks", "currentMemoryBlocksUsage", "installPlanBlocksUsage", "bytesToBlocks", "size", "firmwareBlocks", "customImageBlocks", "applicationsBlocks", "app", "languagesBlocks", "lang", "installPlan"]
}

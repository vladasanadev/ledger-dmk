"use strict";var c=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var f=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var C=(a,t)=>{for(var s in t)c(a,s,{get:t[s],enumerable:!0})},E=(a,t,s,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of f(t))!x.call(a,n)&&n!==s&&c(a,n,{get:()=>t[n],enumerable:!(i=b(t,n))||i.enumerable});return a};var I=a=>E(c({},"__esModule",{value:!0}),a);var M={};C(M,{GoToDashboardDeviceAction:()=>k});module.exports=I(M);var p=require("purify-ts"),r=require("xstate"),u=require("../../../command/model/CommandResult"),D=require("../../../command/os/CloseAppCommand"),l=require("../../../command/os/GetAppAndVersionCommand"),S=require("../../../device-action/model/UserInteractionRequired"),A=require("../../../device-action/os/Const"),m=require("../../../device-action/os/Errors"),h=require("../../../device-action/os/GetDeviceStatus/GetDeviceStatusDeviceAction"),v=require("../../../device-action/xstate-utils/XStateDeviceAction"),y=require("../../../device-session/DeviceSessionState"),g=require("../../../utils/AppName");class k extends v.XStateDeviceAction{makeStateMachine(t){const{getDeviceSessionState:s,setDeviceSessionState:i,closeApp:n,getAppAndVersion:T}=this.extractDependencies(t),d=this.input.unlockTimeout??A.DEFAULT_UNLOCK_TIMEOUT_MS,G=new h.GetDeviceStatusDeviceAction({input:{unlockTimeout:d}}).makeStateMachine(t);return(0,r.setup)({types:{input:{unlockTimeout:d},context:{},output:{}},actors:{getAppAndVersion:(0,r.fromPromise)(T),closeApp:(0,r.fromPromise)(n),getDeviceStatus:G},guards:{hasError:({context:e})=>e._internalState.error!==null,isDashboardOpen:({context:e})=>e._internalState.currentApp!==null&&(0,g.isDashboardName)(e._internalState.currentApp)},actions:{assignErrorFromEvent:(0,r.assign)({_internalState:e=>({...e.context._internalState,error:e.event.error})})}}).createMachine({id:"GoToDashboardDeviceAction",initial:"DeviceReady",context:e=>{const o=s();return{input:{unlockTimeout:e.input.unlockTimeout},intermediateValue:{requiredUserInteraction:S.UserInteractionRequired.None},_internalState:{currentApp:"currentApp"in o?o.currentApp.name:null,error:null}}},states:{DeviceReady:{always:{target:"GetDeviceStatus"}},GetDeviceStatus:{invoke:{id:"deviceStatus",src:"getDeviceStatus",input:e=>({unlockTimeout:e.context.input.unlockTimeout}),onSnapshot:{actions:(0,r.assign)({intermediateValue:e=>e.event.snapshot.context.intermediateValue})},onDone:{target:"CheckDeviceStatus",actions:(0,r.assign)({_internalState:e=>e.event.output.caseOf({Right:o=>({...e.context._internalState,currentApp:o.currentApp}),Left:o=>({...e.context._internalState,error:o})})})}}},CheckDeviceStatus:{always:[{target:"Error",guard:"hasError"},{target:"DashboardCheck"}]},DashboardCheck:{always:[{target:"Success",guard:"isDashboardOpen"},{target:"Error",guard:"hasError"},{target:"Error",guard:e=>e.context._internalState.currentApp===null,actions:(0,r.assign)({_internalState:e=>({...e.context._internalState,error:new m.UnknownDAError("currentApp === null")})})},{target:"CloseApp"}]},CloseApp:{invoke:{src:"closeApp",onDone:{target:"CloseAppCheck",actions:(0,r.assign)({_internalState:e=>(0,u.isSuccessCommandResult)(e.event.output)?e.context._internalState:{...e.context._internalState,error:e.event.output.error}})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},CloseAppCheck:{always:[{target:"Error",guard:"hasError"},{target:"GetAppAndVersion",reenter:!0}]},GetAppAndVersion:{invoke:{src:"getAppAndVersion",onDone:{target:"DashboardCheck",actions:(0,r.assign)({_internalState:e=>{if((0,u.isSuccessCommandResult)(e.event.output)){const o=s();return o.sessionStateType!==y.DeviceSessionStateType.Connected&&i({...o,currentApp:e.event.output.data}),{...e.context._internalState,currentApp:e.event.output.data.name}}return{...e.context._internalState,error:e.event.output.error}}})}}},Success:{type:"final"},Error:{type:"final"}},output:e=>e.context._internalState.error?(0,p.Left)(e.context._internalState.error):(0,p.Right)(void 0)})}extractDependencies(t){return{closeApp:async()=>t.sendCommand(new D.CloseAppCommand),getAppAndVersion:async()=>t.sendCommand(new l.GetAppAndVersionCommand),getDeviceSessionState:()=>t.getDeviceSessionState(),setDeviceSessionState:n=>t.setDeviceSessionState(n)}}}0&&(module.exports={GoToDashboardDeviceAction});
//# sourceMappingURL=GoToDashboardDeviceAction.js.map

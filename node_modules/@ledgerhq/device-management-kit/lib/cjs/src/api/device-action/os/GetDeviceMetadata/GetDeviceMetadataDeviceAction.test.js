"use strict";var P=require("rxjs"),u=require("../../../command/model/CommandResult"),C=require("../../../device/DeviceStatus"),R=require("../../../device-action/__test-utils__/data"),h=require("../../../device-action/__test-utils__/makeInternalApi"),A=require("../../../device-action/__test-utils__/setupTestMachine"),q=require("../../../device-action/__test-utils__/setupTestMachine"),l=require("../../../device-action/__test-utils__/testDeviceActionStates"),e=require("../../../device-action/model/DeviceActionState"),t=require("../../../device-action/model/UserInteractionRequired"),N=require("../../../device-action/os/Errors"),E=require("../../../device-session/DeviceSessionState"),y=require("../../../Error"),k=require("../../../secure-channel/task/types"),m=require("./GetDeviceMetadataDeviceAction");vi.mock("@api/device-action/os/GoToDashboard/GoToDashboardDeviceAction");vi.mock("@api/device-action/os/ListApps/ListAppsDeviceAction");describe("GetDeviceMetadataDeviceAction",()=>{const c=(0,h.makeDeviceActionInternalApiMock)(),w=vi.fn(),I=vi.fn(),S=vi.fn(),x=vi.fn(),f="device_version",D="firmware",o="firmware_version",s="fm_update",d="image",p="apps",g="apps_update",V="lang",v="catalog";function U(){return{getDeviceMetadata:w,getFirmwareMetadata:I,getApplicationsMetadata:S,listAppsSecureChannel:x}}beforeEach(()=>{vi.clearAllMocks(),c.getDeviceSessionState.mockReturnValue({sessionStateType:E.DeviceSessionStateType.Connected,deviceStatus:C.DeviceStatus.CONNECTED})}),describe("success cases",()=>{it("get metadata from device state",()=>new Promise((n,r)=>{const a=new m.GetDeviceMetadataDeviceAction({input:{}});w.mockResolvedValueOnce({firmwareVersion:o,firmwareUpdateContext:s,customImage:d,applications:p,applicationsUpdates:g,installedLanguages:V,catalog:v}),vi.spyOn(a,"extractDependencies").mockReturnValue(U());const i=[{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{output:{firmwareVersion:o,firmwareUpdateContext:s,customImage:d,applications:p,applicationsUpdates:g,installedLanguages:V,catalog:v},status:e.DeviceActionStatus.Completed}];(0,l.testDeviceActionStates)(a,i,c,{onDone:n,onError:r})})),it("fetch metadata without secure channel",()=>new Promise((n,r)=>{(0,A.setupGoToDashboardMock)(),(0,q.setupListAppsMock)([R.BTC_APP]);const a=new m.GetDeviceMetadataDeviceAction({input:{}});w.mockResolvedValueOnce(null),I.mockResolvedValueOnce((0,u.CommandResultFactory)({data:{deviceVersion:f,firmware:D,firmwareVersion:o,firmwareUpdateContext:s,customImage:d}})),S.mockResolvedValueOnce((0,u.CommandResultFactory)({data:{applications:p,applicationsUpdates:g,installedLanguages:V,catalog:v}})),vi.spyOn(a,"extractDependencies").mockReturnValue(U());const i=[{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.AllowListApps},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{output:{firmwareVersion:o,firmwareUpdateContext:s,customImage:d,applications:p,applicationsUpdates:g,installedLanguages:V,catalog:v},status:e.DeviceActionStatus.Completed}];(0,l.testDeviceActionStates)(a,i,c,{onDone:n,onError:r})})),it("fetch metadata with forced update",()=>new Promise((n,r)=>{(0,A.setupGoToDashboardMock)(),(0,q.setupListAppsMock)([R.BTC_APP]);const a=new m.GetDeviceMetadataDeviceAction({input:{forceUpdate:!0}});I.mockResolvedValueOnce((0,u.CommandResultFactory)({data:{deviceVersion:f,firmware:D,firmwareVersion:o,firmwareUpdateContext:s,customImage:d}})),S.mockResolvedValueOnce((0,u.CommandResultFactory)({data:{applications:p,applicationsUpdates:g,installedLanguages:V,catalog:v}})),vi.spyOn(a,"extractDependencies").mockReturnValue(U());const i=[{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.AllowListApps},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{output:{firmwareVersion:o,firmwareUpdateContext:s,customImage:d,applications:p,applicationsUpdates:g,installedLanguages:V,catalog:v},status:e.DeviceActionStatus.Completed}];(0,l.testDeviceActionStates)(a,i,c,{onDone:n,onError:r})})),it("fetch metadata with secure channel",()=>new Promise((n,r)=>{(0,A.setupGoToDashboardMock)();const a=new m.GetDeviceMetadataDeviceAction({input:{useSecureChannel:!0}});w.mockResolvedValueOnce(null),I.mockResolvedValueOnce((0,u.CommandResultFactory)({data:{deviceVersion:f,firmware:D,firmwareVersion:o,firmwareUpdateContext:s,customImage:d}})),x.mockReturnValue((0,P.of)({type:k.SecureChannelEventType.Exchange},{type:k.SecureChannelEventType.PermissionRequested},{type:k.SecureChannelEventType.PermissionGranted},{type:k.SecureChannelEventType.Result,payload:[{flags:123456,hash:"hash_test",hash_code_data:"hash_code_data_test",name:"Bitcoin"}]})),S.mockResolvedValueOnce((0,u.CommandResultFactory)({data:{applications:p,applicationsUpdates:g,installedLanguages:V,catalog:v}})),vi.spyOn(a,"extractDependencies").mockReturnValue(U());const i=[{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.AllowSecureConnection},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{output:{firmwareVersion:o,firmwareUpdateContext:s,customImage:d,applications:p,applicationsUpdates:g,installedLanguages:V,catalog:v},status:e.DeviceActionStatus.Completed}];(0,l.testDeviceActionStates)(a,i,c,{onDone:n,onError:r})})),it("get metadata from device state with external dependencies",()=>new Promise((n,r)=>{const a=new m.GetDeviceMetadataDeviceAction({input:{}});c.getDeviceSessionState.mockReturnValue({sessionStateType:E.DeviceSessionStateType.ReadyWithoutSecureChannel,deviceStatus:C.DeviceStatus.CONNECTED,firmwareVersion:{metadata:o},firmwareUpdateContext:s,customImage:d,installedApps:[p],appsUpdates:g,installedLanguages:V,catalog:v});const i=[{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{output:{firmwareVersion:{metadata:o},firmwareUpdateContext:s,customImage:d,applications:[p],applicationsUpdates:g,installedLanguages:V,catalog:v},status:e.DeviceActionStatus.Completed}];(0,l.testDeviceActionStates)(a,i,c,{onDone:n,onError:r})}))}),describe("Error cases",()=>{it("error during GoToDashboard",()=>new Promise((n,r)=>{(0,A.setupGoToDashboardMock)(!0);const a=new m.GetDeviceMetadataDeviceAction({input:{}});w.mockResolvedValueOnce(null),vi.spyOn(a,"extractDependencies").mockReturnValue(U());const i=[{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{error:new N.UnknownDAError("GoToDashboard failed"),status:e.DeviceActionStatus.Error}];(0,l.testDeviceActionStates)(a,i,c,{onDone:n,onError:r})})),it("error during GetFirmwareMetadata",()=>new Promise((n,r)=>{(0,A.setupGoToDashboardMock)();const a=new m.GetDeviceMetadataDeviceAction({input:{}});w.mockResolvedValueOnce(null),I.mockResolvedValueOnce((0,u.CommandResultFactory)({error:new y.UnknownDeviceExchangeError("GetFirmwareMetadata failed")})),vi.spyOn(a,"extractDependencies").mockReturnValue(U());const i=[{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{error:new y.UnknownDeviceExchangeError("GetFirmwareMetadata failed"),status:e.DeviceActionStatus.Error}];(0,l.testDeviceActionStates)(a,i,c,{onDone:n,onError:r})})),it("error during ListApps",()=>new Promise((n,r)=>{(0,A.setupGoToDashboardMock)(),(0,q.setupListAppsMock)([],!0);const a=new m.GetDeviceMetadataDeviceAction({input:{}});w.mockResolvedValueOnce(null),I.mockResolvedValueOnce((0,u.CommandResultFactory)({data:{deviceVersion:f,firmware:D,firmwareVersion:o,firmwareUpdateContext:s,customImage:d}})),vi.spyOn(a,"extractDependencies").mockReturnValue(U());const i=[{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.AllowListApps},status:e.DeviceActionStatus.Pending},{error:new N.UnknownDAError("ListApps failed"),status:e.DeviceActionStatus.Error}];(0,l.testDeviceActionStates)(a,i,c,{onDone:n,onError:r})})),it("error during GetApplicationsMetadata",()=>new Promise((n,r)=>{(0,A.setupGoToDashboardMock)(),(0,q.setupListAppsMock)([R.BTC_APP]);const a=new m.GetDeviceMetadataDeviceAction({input:{}});w.mockResolvedValueOnce(null),I.mockResolvedValueOnce((0,u.CommandResultFactory)({data:{deviceVersion:f,firmware:D,firmwareVersion:o,firmwareUpdateContext:s,customImage:d}})),S.mockResolvedValueOnce((0,u.CommandResultFactory)({error:new y.UnknownDeviceExchangeError("GetApplicationsMetadata failed")})),vi.spyOn(a,"extractDependencies").mockReturnValue(U());const i=[{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.AllowListApps},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{error:new y.UnknownDeviceExchangeError("GetApplicationsMetadata failed"),status:e.DeviceActionStatus.Error}];(0,l.testDeviceActionStates)(a,i,c,{onDone:n,onError:r})})),it("error during ListAppsSecureChannel",()=>new Promise((n,r)=>{(0,A.setupGoToDashboardMock)();const a=new m.GetDeviceMetadataDeviceAction({input:{useSecureChannel:!0}});w.mockResolvedValueOnce(null),I.mockResolvedValueOnce((0,u.CommandResultFactory)({data:{deviceVersion:f,firmware:D,firmwareVersion:o,firmwareUpdateContext:s,customImage:d}})),x.mockReturnValue((0,P.concat)((0,P.of)({type:k.SecureChannelEventType.Exchange,payload:{data:new Uint8Array([0,1,2,3])}}),(0,P.throwError)(()=>new N.UnknownDAError("Secure channel error")))),vi.spyOn(a,"extractDependencies").mockReturnValue(U());const i=[{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None},status:e.DeviceActionStatus.Pending},{error:new N.UnknownDAError("Secure channel error"),status:e.DeviceActionStatus.Error}];(0,l.testDeviceActionStates)(a,i,c,{onDone:n,onError:r})}))})});
//# sourceMappingURL=GetDeviceMetadataDeviceAction.test.js.map

"use strict";var g=require("rxjs"),V=require("../../../device/DeviceStatus"),y=require("../../../device-action/__test-utils__/makeInternalApi"),v=require("../../../device-action/__test-utils__/setupTestMachine"),l=require("../../../device-action/__test-utils__/setupTestMachine"),u=require("../../../device-action/__test-utils__/testDeviceActionStates"),e=require("../../../device-action/model/DeviceActionState"),n=require("../../../device-action/model/UserInteractionRequired"),c=require("../../../device-action/os/Errors"),D=require("../../../device-action/os/Errors"),f=require("../../../device-session/DeviceSessionState"),d=require("../../../secure-channel/task/types"),m=require("./InstallOrUpdateAppsDeviceAction");vi.mock("@api/device-action/os/GoToDashboard/GoToDashboardDeviceAction");vi.mock("@api/device-action/os/GetDeviceMetadata/GetDeviceMetadataDeviceAction");describe("InstallOrUpdateAppsDeviceAction",()=>{const o=(0,y.makeDeviceActionInternalApiMock)(),p=vi.fn(),I=vi.fn(),A=vi.fn();function P(){return{buildInstallPlan:p,predictOutOfMemory:I,installApp:A}}beforeEach(()=>{vi.clearAllMocks(),o.getDeviceSessionState.mockReturnValue({sessionStateType:f.DeviceSessionStateType.Connected,deviceStatus:V.DeviceStatus.CONNECTED})}),describe("success cases",()=>{it("Install two applications",()=>new Promise((r,i)=>{(0,v.setupGoToDashboardMock)(),(0,l.setupGetDeviceMetadataMock)({firmwareVersion:{metadata:{targetId:857735172}}});const a=new m.InstallOrUpdateAppsDeviceAction({input:{applications:[{name:"Bitcoin"},{name:"Ethereum"},{name:"Solana"},{name:"XRP"},{name:"MyShitCoin"}],allowMissingApplication:!1}}),t={installPlan:[{versionName:"Bitcoin"},{versionName:"XRP"}],alreadyInstalled:["Ethereum","Solana"],missingApplications:["MyShitCoin"]};p.mockResolvedValueOnce(t),I.mockResolvedValueOnce({outOfMemory:!1}),A.mockReturnValueOnce((0,g.of)({type:d.SecureChannelEventType.PermissionRequested},{type:d.SecureChannelEventType.PermissionGranted},{type:d.SecureChannelEventType.Progress,payload:{progress:.5}},{type:d.SecureChannelEventType.Progress,payload:{progress:1}})).mockReturnValueOnce((0,g.of)({type:d.SecureChannelEventType.Progress,payload:{progress:.25}},{type:d.SecureChannelEventType.Progress,payload:{progress:.75}},{type:d.SecureChannelEventType.Progress,payload:{progress:1}})),vi.spyOn(a,"extractDependencies").mockReturnValue(P());const s=[{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.AllowSecureConnection,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:.5}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:1}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:1}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:1}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:1,currentProgress:.25}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:1,currentProgress:.75}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:1,currentProgress:1}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:1,currentProgress:1}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:1,currentProgress:1}},status:e.DeviceActionStatus.Pending},{output:{successfullyInstalled:[{versionName:"Bitcoin"},{versionName:"XRP"}],alreadyInstalled:["Ethereum","Solana"],missingApplications:["MyShitCoin"]},status:e.DeviceActionStatus.Completed}];(0,u.testDeviceActionStates)(a,s,o,{onDone:r,onError:i})})),it("No install is needed",()=>new Promise((r,i)=>{(0,v.setupGoToDashboardMock)(),(0,l.setupGetDeviceMetadataMock)({firmwareVersion:{metadata:{targetId:857735172}}});const a=new m.InstallOrUpdateAppsDeviceAction({input:{applications:[{name:"Bitcoin"},{name:"Ethereum"},{name:"Solana"},{name:"XRP"},{name:"MyShitCoin"}],allowMissingApplication:!1}}),t={installPlan:[],alreadyInstalled:["Ethereum","Solana","Bitcoin","XRP"],missingApplications:["MyShitCoin"]};p.mockResolvedValueOnce(t),vi.spyOn(a,"extractDependencies").mockReturnValue(P());const s=[{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{output:{successfullyInstalled:[],alreadyInstalled:["Ethereum","Solana","Bitcoin","XRP"],missingApplications:["MyShitCoin"]},status:e.DeviceActionStatus.Completed}];(0,u.testDeviceActionStates)(a,s,o,{onDone:r,onError:i})}))}),describe("error cases",()=>{it("Update device metadata failure",()=>new Promise((r,i)=>{(0,l.setupGetDeviceMetadataMock)({firmwareVersion:{metadata:{targetId:857735172}}},!0);const a=new m.InstallOrUpdateAppsDeviceAction({input:{applications:[{name:"Bitcoin"}],allowMissingApplication:!1}});vi.spyOn(a,"extractDependencies").mockReturnValue(P());const t=[{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{error:new c.UnknownDAError("GetDeviceMetadata failed"),status:e.DeviceActionStatus.Error}];(0,u.testDeviceActionStates)(a,t,o,{onDone:r,onError:i})})),it("Build install plan failure",()=>new Promise((r,i)=>{(0,l.setupGetDeviceMetadataMock)({firmwareVersion:{metadata:{targetId:857735172}}});const a=new m.InstallOrUpdateAppsDeviceAction({input:{applications:[{name:"Bitcoin"}],allowMissingApplication:!1}});p.mockResolvedValueOnce({error:new c.UnknownDAError("BuildInstallPlan failed")}),vi.spyOn(a,"extractDependencies").mockReturnValue(P());const t=[{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{error:new c.UnknownDAError("BuildInstallPlan failed"),status:e.DeviceActionStatus.Error}];(0,u.testDeviceActionStates)(a,t,o,{onDone:r,onError:i})})),it("Predict out of memory failure",()=>new Promise((r,i)=>{(0,l.setupGetDeviceMetadataMock)({firmwareVersion:{metadata:{targetId:857735172}}});const a=new m.InstallOrUpdateAppsDeviceAction({input:{applications:[{name:"Bitcoin"},{name:"Ethereum"},{name:"Solana"},{name:"XRP"},{name:"MyShitCoin"}],allowMissingApplication:!1}}),t={installPlan:[{versionName:"Bitcoin"},{versionName:"XRP"}],alreadyInstalled:["Ethereum","Solana"],missingApplications:["MyShitCoin"]};p.mockResolvedValueOnce(t),I.mockResolvedValueOnce({error:new c.UnknownDAError("PredictOutOfMemory failed")}),vi.spyOn(a,"extractDependencies").mockReturnValue(P());const s=[{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.DeviceActionStatus.Pending},{error:new c.UnknownDAError("PredictOutOfMemory failed"),status:e.DeviceActionStatus.Error}];(0,u.testDeviceActionStates)(a,s,o,{onDone:r,onError:i})})),it("Is out of memory",()=>new Promise((r,i)=>{(0,l.setupGetDeviceMetadataMock)({firmwareVersion:{metadata:{targetId:857735172}}});const a=new m.InstallOrUpdateAppsDeviceAction({input:{applications:[{name:"Bitcoin"},{name:"Ethereum"},{name:"Solana"},{name:"XRP"},{name:"MyShitCoin"}],allowMissingApplication:!1}}),t={installPlan:[{versionName:"Bitcoin"},{versionName:"XRP"}],alreadyInstalled:["Ethereum","Solana"],missingApplications:["MyShitCoin"]};p.mockResolvedValueOnce(t),I.mockResolvedValueOnce({outOfMemory:!0}),vi.spyOn(a,"extractDependencies").mockReturnValue(P());const s=[{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.DeviceActionStatus.Pending},{error:new D.OutOfMemoryDAError("Not enough memory for those applications"),status:e.DeviceActionStatus.Error}];(0,u.testDeviceActionStates)(a,s,o,{onDone:r,onError:i})})),it("Go to dashboard failure",()=>new Promise((r,i)=>{(0,v.setupGoToDashboardMock)(!0),(0,l.setupGetDeviceMetadataMock)({firmwareVersion:{metadata:{targetId:857735172}}});const a=new m.InstallOrUpdateAppsDeviceAction({input:{applications:[{name:"Bitcoin"},{name:"Ethereum"},{name:"Solana"},{name:"XRP"},{name:"MyShitCoin"}],allowMissingApplication:!1}}),t={installPlan:[{versionName:"Bitcoin"},{versionName:"XRP"}],alreadyInstalled:["Ethereum","Solana"],missingApplications:["MyShitCoin"]};p.mockResolvedValueOnce(t),I.mockResolvedValueOnce({outOfMemory:!1}),vi.spyOn(a,"extractDependencies").mockReturnValue(P());const s=[{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.DeviceActionStatus.Pending},{error:new c.UnknownDAError("GoToDashboard failed"),status:e.DeviceActionStatus.Error}];(0,u.testDeviceActionStates)(a,s,o,{onDone:r,onError:i})})),it("Install app failure",()=>new Promise((r,i)=>{(0,v.setupGoToDashboardMock)(),(0,l.setupGetDeviceMetadataMock)({firmwareVersion:{metadata:{targetId:857735172}}});const a=new m.InstallOrUpdateAppsDeviceAction({input:{applications:[{name:"Bitcoin"},{name:"Ethereum"},{name:"Solana"},{name:"XRP"},{name:"MyShitCoin"}],allowMissingApplication:!1}}),t={installPlan:[{versionName:"Bitcoin"},{versionName:"XRP"}],alreadyInstalled:["Ethereum","Solana"],missingApplications:["MyShitCoin"]};p.mockResolvedValueOnce(t),I.mockResolvedValueOnce({outOfMemory:!1}),A.mockReturnValue((0,g.concat)((0,g.of)({type:d.SecureChannelEventType.Exchange,payload:{data:new Uint8Array([0,1,2,3])}}),(0,g.throwError)(()=>new c.UnknownDAError("Secure channel error")))),vi.spyOn(a,"extractDependencies").mockReturnValue(P());const s=[{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:null},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.DeviceActionStatus.Pending},{intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.DeviceActionStatus.Pending},{error:new c.UnknownDAError("Secure channel error"),status:e.DeviceActionStatus.Error}];(0,u.testDeviceActionStates)(a,s,o,{onDone:r,onError:i})}))})});
//# sourceMappingURL=InstallOrUpdateAppsDeviceAction.test.js.map

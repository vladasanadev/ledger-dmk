{
  "version": 3,
  "sources": ["../../../../../../../src/api/device-action/os/CallTaskInAppDeviceAction/CallTaskInAppDeviceAction.ts"],
  "sourcesContent": ["import { Left, Right } from \"purify-ts\";\nimport { assign, fromPromise, setup } from \"xstate\";\n\nimport {\n  type CommandResult,\n  isSuccessCommandResult,\n} from \"@api/command/model/CommandResult\";\nimport { type InternalApi } from \"@api/device-action/DeviceAction\";\nimport { UserInteractionRequired } from \"@api/device-action/model/UserInteractionRequired\";\nimport { UnknownDAError } from \"@api/device-action/os/Errors\";\nimport { OpenAppDeviceAction } from \"@api/device-action/os/OpenAppDeviceAction/OpenAppDeviceAction\";\nimport { type StateMachineTypes } from \"@api/device-action/xstate-utils/StateMachineTypes\";\nimport {\n  type DeviceActionStateMachine,\n  XStateDeviceAction,\n} from \"@api/device-action/xstate-utils/XStateDeviceAction\";\n\nimport {\n  type CallTaskInAppDAError,\n  type CallTaskInAppDAInput,\n  type CallTaskInAppDAIntermediateValue,\n  type CallTaskInAppDAInternalState,\n  type CallTaskInAppDAOutput,\n} from \"./CallTaskInAppDeviceActionTypes\";\n\n/**\n * Tries to open an app on the device, and if it is successful, calls a task\n * in the app.\n * The output will be the result of the task.\n *\n * ```ts\n * input: {\n *  appName: string;\n *  task: (internalApi: InternalApi) => Promise<CommandResult<TaskResponse, TaskErrorCodes>>;\n *  requiredUserInteraction: UserInteraction;\n * }\n * ```\n *\n * Example of usage:\n *\n * ```ts\n * const deviceAction = new CallTaskInAppDeviceAction({\n *  input: {\n *   appName: \"MyApp\",\n *   task: async (internalApi: InternalApi) => internalApi.sendCommand(new MyAppSpecificCommand()),\n *   requiredUserInteraction: UserInteractionRequired.None,\n *  },\n * });\n * dmk.executeDeviceAction({ sessionId: \"mySessionId\", deviceAction });\n * ```\n */\nexport class CallTaskInAppDeviceAction<\n  TaskResponse,\n  TaskErrorCodes,\n  UserInteraction extends UserInteractionRequired,\n> extends XStateDeviceAction<\n  CallTaskInAppDAOutput<TaskResponse>,\n  CallTaskInAppDAInput<TaskResponse, TaskErrorCodes, UserInteraction>,\n  CallTaskInAppDAError<TaskErrorCodes>,\n  CallTaskInAppDAIntermediateValue<UserInteraction>,\n  CallTaskInAppDAInternalState<TaskResponse, TaskErrorCodes>\n> {\n  makeStateMachine(\n    internalAPI: InternalApi,\n  ): DeviceActionStateMachine<\n    CallTaskInAppDAOutput<TaskResponse>,\n    CallTaskInAppDAInput<TaskResponse, TaskErrorCodes, UserInteraction>,\n    CallTaskInAppDAError<TaskErrorCodes>,\n    CallTaskInAppDAIntermediateValue<UserInteraction>,\n    CallTaskInAppDAInternalState<TaskResponse, TaskErrorCodes>\n  > {\n    type types = StateMachineTypes<\n      CallTaskInAppDAOutput<TaskResponse>,\n      CallTaskInAppDAInput<TaskResponse, TaskErrorCodes, UserInteraction>,\n      CallTaskInAppDAError<TaskErrorCodes>,\n      CallTaskInAppDAIntermediateValue<UserInteraction>,\n      CallTaskInAppDAInternalState<TaskResponse, TaskErrorCodes>\n    >;\n\n    const { callTask } = this.extractDependencies(internalAPI);\n\n    return setup({\n      types: {\n        input: {} as types[\"input\"],\n        context: {} as types[\"context\"],\n        output: {} as types[\"output\"],\n      },\n      actors: {\n        callTask: fromPromise(callTask),\n        openAppStateMachine: new OpenAppDeviceAction({\n          input: {\n            appName: this.input.appName,\n          },\n        }).makeStateMachine(internalAPI),\n      },\n      guards: {\n        skipOpenApp: () => this.input.skipOpenApp,\n        noInternalError: ({ context }) => context._internalState.error === null,\n      },\n      actions: {\n        assignErrorFromEvent: assign({\n          _internalState: (_) => ({\n            ..._.context._internalState,\n            error: _.event[\"error\"], // NOTE: it should never happen, the error is not typed anymore here\n          }),\n        }),\n      },\n    }).createMachine({\n      id: \"CallTaskInAppDeviceAction\",\n      initial: \"InitialState\",\n      context: ({ input }) => {\n        return {\n          input: input,\n          intermediateValue: {\n            requiredUserInteraction: UserInteractionRequired.None,\n          },\n          _internalState: {\n            taskResponse: null,\n            error: null,\n          },\n        };\n      },\n      states: {\n        InitialState: {\n          always: [\n            {\n              target: \"CallTask\",\n              guard: \"skipOpenApp\",\n            },\n            \"OpenAppDeviceAction\",\n          ],\n        },\n        OpenAppDeviceAction: {\n          invoke: {\n            id: \"openAppStateMachine\",\n            input: {\n              appName: this.input.appName,\n            },\n            src: \"openAppStateMachine\",\n            onSnapshot: {\n              actions: assign({\n                intermediateValue: (_) =>\n                  _.event.snapshot.context.intermediateValue,\n              }),\n            },\n            onDone: {\n              actions: assign({\n                _internalState: (_) => {\n                  return _.event.output.caseOf<\n                    CallTaskInAppDAInternalState<TaskResponse, TaskErrorCodes>\n                  >({\n                    Right: () => _.context._internalState,\n                    Left: (error) => ({\n                      ..._.context._internalState,\n                      error,\n                    }),\n                  });\n                },\n              }),\n              target: \"CheckOpenAppDeviceActionResult\",\n            },\n          },\n        },\n        CheckOpenAppDeviceActionResult: {\n          always: [\n            {\n              target: \"CallTask\",\n              guard: \"noInternalError\",\n            },\n            \"Error\",\n          ],\n        },\n        CallTask: {\n          entry: assign({\n            intermediateValue: {\n              requiredUserInteraction: this.input.requiredUserInteraction,\n            },\n          }),\n          exit: assign({\n            intermediateValue: {\n              requiredUserInteraction: UserInteractionRequired.None,\n            },\n          }),\n          invoke: {\n            id: \"callTask\",\n            src: \"callTask\",\n            input: (_: { context: types[\"context\"] }) => _.context.input.task,\n            onDone: {\n              target: \"CallTaskResultCheck\",\n              actions: [\n                assign({\n                  _internalState: ({ event, context }) => {\n                    if (isSuccessCommandResult(event.output)) {\n                      return {\n                        ...context._internalState,\n                        taskResponse: event.output.data,\n                      };\n                    }\n                    return {\n                      ...context._internalState,\n                      error: event.output.error,\n                    };\n                  },\n                }),\n              ],\n            },\n            onError: {\n              target: \"Error\",\n              actions: \"assignErrorFromEvent\",\n            },\n          },\n        },\n        CallTaskResultCheck: {\n          always: [\n            {\n              target: \"Success\",\n              guard: \"noInternalError\",\n            },\n            \"Error\",\n          ],\n        },\n        Success: {\n          type: \"final\",\n        },\n        Error: {\n          type: \"final\",\n        },\n      },\n      output: ({ context }) =>\n        context._internalState.taskResponse\n          ? Right(context._internalState.taskResponse)\n          : Left(\n              context._internalState.error ||\n                new UnknownDAError(\"No error in final state\"),\n            ),\n    });\n  }\n\n  extractDependencies(internalApi: InternalApi) {\n    return {\n      callTask: (_: {\n        input: (\n          internalApi: InternalApi,\n        ) => Promise<CommandResult<TaskResponse, TaskErrorCodes>>;\n      }): Promise<CommandResult<TaskResponse, TaskErrorCodes>> =>\n        _.input(internalApi),\n    };\n  }\n}\n"],
  "mappings": "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",
  "names": ["CallTaskInAppDeviceAction_exports", "__export", "CallTaskInAppDeviceAction", "__toCommonJS", "import_purify_ts", "import_xstate", "import_CommandResult", "import_UserInteractionRequired", "import_Errors", "import_OpenAppDeviceAction", "import_XStateDeviceAction", "internalAPI", "callTask", "context", "_", "input", "error", "event", "internalApi"]
}

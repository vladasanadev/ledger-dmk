"use strict";var c=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var g=Object.prototype.hasOwnProperty;var I=(o,e)=>{for(var n in e)c(o,n,{get:e[n],enumerable:!0})},y=(o,e,n,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of v(e))!g.call(o,i)&&i!==n&&c(o,i,{get:()=>e[i],enumerable:!(a=A(e,i))||a.enumerable});return o};var D=o=>y(c({},"__esModule",{value:!0}),o);var M={};I(M,{BuildAppsInstallPlanTask:()=>w});module.exports=D(M);var f=require("semver"),s=require("../../device-action/os/Errors"),u=require("../../device-session/DeviceSessionState");class w{constructor(e,n){this.api=e;this.args=n;const a=e.getDeviceModel();this.deviceModelId=a.id}deviceModelId;run(){const e=this.api.getDeviceSessionState();if(e.sessionStateType===u.DeviceSessionStateType.Connected)return{error:new s.UnknownDAError("Invalid device state")};if(e.catalog===void 0)return{error:new s.UnknownDAError("Device apps metadata not fetched")};let n=[],a=[],i=[];for(const t of this.args.applications){const r=e.catalog.applications.find(p=>p.versionName===t.name),l=e.installedApps.find(p=>p.versionName===t.name);if(l!==void 0&&this.validateConstraint(l,r,t.constraints)){a=[...a,t.name];continue}if(r!==void 0&&this.validateConstraint(r,void 0,t.constraints))n=[...n,r];else if(this.args.allowMissingApplication)i=[...i,t.name];else return e.firmwareUpdateContext?.availableUpdate!==void 0&&r!==void 0?{error:new s.UnsupportedFirmwareDAError(`Application ${t.name} needs latest firmware`)}:e.firmwareUpdateContext?.availableUpdate!==void 0?{error:new s.UnsupportedFirmwareDAError(`Application ${t.name} needs latest firmware`)}:{error:new s.UnsupportedApplicationDAError(`Application ${t.name} not supported for this device`)}}return n=[...n.reduce((t,r)=>{const l=r.parentName;if(l){const p=e.catalog.applications.find(d=>d.versionName===l),m=e.installedApps.find(d=>d.versionName===l);if(p&&!m)return[...t,p]}return t},[]),...n],{installPlan:n.filter((t,r)=>n.findIndex(l=>l.versionName===t.versionName)===r),missingApplications:i,alreadyInstalled:a}}validateConstraint(e,n,a){if(a===void 0)return!0;for(const i of a)if(!(i.exemptModels!==void 0&&i.exemptModels.includes(this.deviceModelId))&&!(i.applicableModels!==void 0&&!i.applicableModels.includes(this.deviceModelId)))return i.minVersion==="latest"?!n||(0,f.gte)(e.version,n.version):(0,f.gte)(e.version,i.minVersion);return!0}}0&&(module.exports={BuildAppsInstallPlanTask});
//# sourceMappingURL=BuildAppsInstallPlanTask.js.map

{
  "version": 3,
  "sources": ["../../../../../../src/api/device-action/task/GetFirmwareMetadataTask.ts"],
  "sourcesContent": ["import { InvalidGetFirmwareMetadataResponseError } from \"@api/command/Errors\";\nimport {\n  type CommandResult,\n  CommandResultFactory,\n  isSuccessCommandResult,\n} from \"@api/command/model/CommandResult\";\nimport { GetCustomImageSizeCommand } from \"@api/command/os/GetCustomImageSizeCommand\";\nimport { GetOsVersionCommand } from \"@api/command/os/GetOsVersionCommand\";\nimport type { InternalApi } from \"@api/device-action/DeviceAction\";\nimport {\n  type CustomImage,\n  type FirmwareUpdate,\n  type FirmwareUpdateContext,\n  type FirmwareVersion,\n} from \"@api/device-session/DeviceSessionState\";\nimport { type DeviceVersion } from \"@internal/manager-api/model/Device\";\nimport { type FinalFirmware } from \"@internal/manager-api/model/Firmware\";\n\nexport type GetFirmwareMetadataTaskResult = CommandResult<{\n  deviceVersion: DeviceVersion;\n  firmware: FinalFirmware;\n  firmwareVersion: FirmwareVersion;\n  firmwareUpdateContext: FirmwareUpdateContext;\n  customImage: CustomImage;\n}>;\n\nexport class GetFirmwareMetadataTask {\n  constructor(private readonly api: InternalApi) {}\n\n  async run(): Promise<GetFirmwareMetadataTaskResult> {\n    // Get installed firmware metadata\n    const osVersion = await this.api.sendCommand(new GetOsVersionCommand());\n    if (!isSuccessCommandResult(osVersion)) {\n      return osVersion;\n    }\n    const firmwareVersion: FirmwareVersion = {\n      mcu: osVersion.data.mcuSephVersion,\n      bootloader: osVersion.data.mcuBootloaderVersion,\n      os: osVersion.data.seVersion,\n      metadata: osVersion.data,\n    };\n\n    // Fetch current firmware metadata from app store\n    const manager = this.api.getManagerApiService();\n    const result = await manager\n      .getDeviceVersion(osVersion.data)\n      .chain((deviceVersion) =>\n        manager\n          .getFirmwareVersion(osVersion.data, deviceVersion)\n          .map((currentFirmware) => ({ deviceVersion, currentFirmware })),\n      );\n    if (result.isLeft()) {\n      return CommandResultFactory({\n        error: new InvalidGetFirmwareMetadataResponseError(),\n      });\n    }\n    const { deviceVersion, currentFirmware } = result.unsafeCoerce();\n\n    // Fetch latest firmware available, if any\n    const maybeUpdate = await manager\n      .getLatestFirmwareVersion(currentFirmware, deviceVersion)\n      .chain((osuFirmware) =>\n        manager.getNextFirmwareVersion(osuFirmware).chain((finalFirmware) =>\n          manager\n            .getMcuList()\n            .map((mcus) => mcus.find((mcu) => mcu.name === firmwareVersion.mcu))\n            .map(\n              (mcu) =>\n                mcu === undefined ||\n                !finalFirmware.mcuVersions.includes(mcu.id),\n            )\n            .map((mcuUpdateRequired) => ({\n              osuFirmware,\n              finalFirmware,\n              mcuUpdateRequired,\n            })),\n        ),\n      );\n    const availableUpdate: FirmwareUpdate | undefined = maybeUpdate.caseOf({\n      Right: (data) => data,\n      Left: (_error) => undefined,\n    });\n    const firmwareUpdateContext = {\n      currentFirmware,\n      availableUpdate,\n    };\n\n    // Get custom image metadata\n    let customImage: CustomImage = {};\n    const imageSize = await this.api.sendCommand(\n      new GetCustomImageSizeCommand(),\n    );\n    if (isSuccessCommandResult(imageSize)) {\n      customImage = { size: imageSize.data };\n    }\n\n    // Return firmware metadata\n    return CommandResultFactory({\n      data: {\n        deviceVersion,\n        firmware: currentFirmware,\n        firmwareVersion,\n        firmwareUpdateContext,\n        customImage,\n      },\n    });\n  }\n}\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,6BAAAE,IAAA,eAAAC,EAAAH,GAAA,IAAAI,EAAwD,+BACxDC,EAIO,4CACPC,EAA0C,qDAC1CC,EAAoC,+CAmB7B,MAAML,CAAwB,CACnC,YAA6BM,EAAkB,CAAlB,SAAAA,CAAmB,CAEhD,MAAM,KAA8C,CAElD,MAAMC,EAAY,MAAM,KAAK,IAAI,YAAY,IAAI,qBAAqB,EACtE,GAAI,IAAC,0BAAuBA,CAAS,EACnC,OAAOA,EAET,MAAMC,EAAmC,CACvC,IAAKD,EAAU,KAAK,eACpB,WAAYA,EAAU,KAAK,qBAC3B,GAAIA,EAAU,KAAK,UACnB,SAAUA,EAAU,IACtB,EAGME,EAAU,KAAK,IAAI,qBAAqB,EACxCC,EAAS,MAAMD,EAClB,iBAAiBF,EAAU,IAAI,EAC/B,MAAOI,GACNF,EACG,mBAAmBF,EAAU,KAAMI,CAAa,EAChD,IAAKC,IAAqB,CAAE,cAAAD,EAAe,gBAAAC,CAAgB,EAAE,CAClE,EACF,GAAIF,EAAO,OAAO,EAChB,SAAO,wBAAqB,CAC1B,MAAO,IAAI,yCACb,CAAC,EAEH,KAAM,CAAE,cAAAC,EAAe,gBAAAC,CAAgB,EAAIF,EAAO,aAAa,EAsBzDG,GAnBc,MAAMJ,EACvB,yBAAyBG,EAAiBD,CAAa,EACvD,MAAOG,GACNL,EAAQ,uBAAuBK,CAAW,EAAE,MAAOC,GACjDN,EACG,WAAW,EACX,IAAKO,GAASA,EAAK,KAAMC,GAAQA,EAAI,OAAST,EAAgB,GAAG,CAAC,EAClE,IACES,GACCA,IAAQ,QACR,CAACF,EAAc,YAAY,SAASE,EAAI,EAAE,CAC9C,EACC,IAAKC,IAAuB,CAC3B,YAAAJ,EACA,cAAAC,EACA,kBAAAG,CACF,EAAE,CACN,CACF,GAC8D,OAAO,CACrE,MAAQC,GAASA,EACjB,KAAOC,GAAQ,EACjB,CAAC,EACKC,EAAwB,CAC5B,gBAAAT,EACA,gBAAAC,CACF,EAGA,IAAIS,EAA2B,CAAC,EAChC,MAAMC,EAAY,MAAM,KAAK,IAAI,YAC/B,IAAI,2BACN,EACA,SAAI,0BAAuBA,CAAS,IAClCD,EAAc,CAAE,KAAMC,EAAU,IAAK,MAIhC,wBAAqB,CAC1B,KAAM,CACJ,cAAAZ,EACA,SAAUC,EACV,gBAAAJ,EACA,sBAAAa,EACA,YAAAC,CACF,CACF,CAAC,CACH,CACF",
  "names": ["GetFirmwareMetadataTask_exports", "__export", "GetFirmwareMetadataTask", "__toCommonJS", "import_Errors", "import_CommandResult", "import_GetCustomImageSizeCommand", "import_GetOsVersionCommand", "api", "osVersion", "firmwareVersion", "manager", "result", "deviceVersion", "currentFirmware", "availableUpdate", "osuFirmware", "finalFirmware", "mcus", "mcu", "mcuUpdateRequired", "data", "_error", "firmwareUpdateContext", "customImage", "imageSize"]
}

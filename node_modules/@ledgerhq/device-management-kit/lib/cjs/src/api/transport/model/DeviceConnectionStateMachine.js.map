{
  "version": 3,
  "sources": ["../../../../../../src/api/transport/model/DeviceConnectionStateMachine.ts"],
  "sourcesContent": ["// import { createBrowserInspector } from \"@statelyai/inspect\";\nimport { type Either, Left, Maybe, Nothing, Right } from \"purify-ts\";\nimport { type Actor, assign, createActor, emit, setup } from \"xstate\";\n\nimport { GetAppAndVersionCommand } from \"@api/command/os/GetAppAndVersionCommand\";\nimport { CommandUtils } from \"@api/command/utils/CommandUtils\";\nimport { type ApduResponse } from \"@api/device-session/ApduResponse\";\nimport { type DmkError, UnknownDeviceExchangeError } from \"@api/Error\";\nimport { type DeviceId } from \"@api/types\";\n\nimport { type DeviceApduSender } from \"./DeviceApduSender\";\nimport {\n  AlreadySendingApduError,\n  DeviceDisconnectedBeforeSendingApdu,\n  DeviceDisconnectedWhileSendingError,\n} from \"./Errors\";\n\n// const { inspect } = createBrowserInspector();\n\ntype DeviceDisconnectedEvent = {\n  type: \"DeviceDisconnected\";\n};\n\ntype DeviceConnectedEvent = {\n  type: \"DeviceConnected\";\n};\n\ntype ApduResponseReceived = {\n  type: \"ApduResponseReceived\";\n  apduResponse: ApduResponse;\n};\n\ntype ApduSendingError = {\n  type: \"ApduSendingError\";\n  error: DmkError;\n};\n\ntype SendApduCalled = {\n  type: \"SendApduCalled\";\n  apdu: Uint8Array;\n  triggersDisconnection: boolean;\n  abortTimeout?: number;\n  responseCallback: (response: Either<DmkError, ApduResponse>) => void;\n};\n\ntype ReconnectionTimedOut = {\n  type: \"ReconnectionTimedOut\";\n};\n\ntype CloseConnectionCalled = {\n  type: \"CloseConnectionCalled\";\n};\n\nexport type Events =\n  | DeviceDisconnectedEvent\n  | DeviceConnectedEvent\n  | ApduResponseReceived\n  | ApduSendingError\n  | SendApduCalled\n  | CloseConnectionCalled\n  | ReconnectionTimedOut;\n\nexport type DeviceConnectionStateMachineParams<Dependencies> = {\n  deviceId: DeviceId;\n  deviceApduSender: DeviceApduSender<Dependencies>;\n  timeoutDuration: number;\n  tryToReconnect: (timeoutDuration: number) => void;\n  onTerminated: () => void;\n};\n\nexport class DeviceConnectionStateMachine<Dependencies> {\n  private deviceId: DeviceId;\n  private deviceAdpuSender: DeviceApduSender<Dependencies>;\n\n  private machineActor: Actor<ReturnType<typeof makeStateMachine>>;\n\n  private timeoutDuration: number;\n  private timeout: ReturnType<typeof setTimeout> | null = null;\n\n  startReconnectionTimeout() {\n    this.timeout = setTimeout(() => {\n      this.machineActor.send({ type: \"ReconnectionTimedOut\" });\n    }, this.timeoutDuration);\n  }\n\n  constructor(params: DeviceConnectionStateMachineParams<Dependencies>) {\n    this.deviceId = params.deviceId;\n    this.deviceAdpuSender = params.deviceApduSender;\n    this.timeoutDuration = params.timeoutDuration;\n    this.machineActor = createActor(\n      makeStateMachine({\n        sendApduFn: (apdu, triggersDisconnection, abortTimeout) =>\n          this.sendApduToDeviceConnection(\n            apdu,\n            triggersDisconnection,\n            abortTimeout,\n          ),\n        startReconnectionTimeout: () => this.startReconnectionTimeout(),\n        cancelReconnectionTimeout: () => {\n          if (this.timeout) {\n            clearTimeout(this.timeout);\n            this.timeout = null;\n          }\n        },\n        tryToReconnect: () => {\n          params.tryToReconnect(this.timeoutDuration);\n        },\n        onTerminated: params.onTerminated,\n        closeConnection: () => {\n          this.deviceAdpuSender.closeConnection();\n        },\n      }),\n      // {\n      //   // inspect,\n      // },\n    );\n    this.machineActor.start();\n  }\n\n  private sendApduToDeviceConnection(\n    apdu: Uint8Array,\n    triggersDisconnection?: boolean,\n    abortTimeout?: number,\n  ) {\n    this.deviceAdpuSender\n      .sendApdu(apdu, triggersDisconnection, abortTimeout)\n      .then((response) => {\n        response.caseOf({\n          Left: (error) => {\n            this.machineActor.send({ type: \"ApduSendingError\", error });\n          },\n          Right: (apduResponse) => {\n            this.machineActor.send({\n              type: \"ApduResponseReceived\",\n              apduResponse,\n            });\n          },\n        });\n      })\n      .catch((error) => {\n        this.machineActor.send({\n          type: \"ApduSendingError\",\n          error: new UnknownDeviceExchangeError(error),\n        });\n      });\n  }\n\n  /**\n   * Called by the transport\n   */\n\n  public getDependencies(): Dependencies {\n    return this.deviceAdpuSender.getDependencies();\n  }\n\n  public setDependencies(dependencies: Dependencies) {\n    this.deviceAdpuSender.setDependencies(dependencies);\n  }\n\n  public getDeviceId() {\n    return this.deviceId;\n  }\n\n  public sendApdu(\n    apdu: Uint8Array,\n    triggersDisconnection?: boolean,\n    abortTimeout?: number,\n  ): Promise<Either<DmkError, ApduResponse>> {\n    return new Promise((responseCallback) => {\n      this.machineActor.send({\n        type: \"SendApduCalled\",\n        apdu,\n        triggersDisconnection: !!triggersDisconnection,\n        abortTimeout,\n        responseCallback,\n      });\n    });\n  }\n\n  public async setupConnection() {\n    await this.deviceAdpuSender.setupConnection();\n  }\n\n  // State Machine Events\n\n  public eventDeviceConnected() {\n    this.machineActor.send({ type: \"DeviceConnected\" });\n  }\n\n  public eventDeviceDisconnected() {\n    this.machineActor.send({ type: \"DeviceDisconnected\" });\n  }\n\n  public closeConnection() {\n    this.machineActor.send({ type: \"CloseConnectionCalled\" });\n  }\n}\n\nfunction makeStateMachine({\n  sendApduFn,\n  startReconnectionTimeout,\n  cancelReconnectionTimeout,\n  tryToReconnect,\n  onTerminated,\n  closeConnection,\n}: {\n  sendApduFn: (\n    apdu: Uint8Array,\n    triggersDisconnection: boolean,\n    abortTimeout?: number,\n  ) => void;\n  startReconnectionTimeout: () => void;\n  cancelReconnectionTimeout: () => void;\n  tryToReconnect: () => void;\n  onTerminated: () => void;\n  closeConnection: () => void;\n}) {\n  return setup({\n    types: {} as {\n      context: {\n        apduInProgress: Maybe<{\n          apdu: Uint8Array;\n          triggersDisconnection: boolean;\n          abortTimeout?: number;\n          responseCallback: (response: Either<DmkError, ApduResponse>) => void;\n        }>;\n        apduResponse: Maybe<ApduResponse>;\n      };\n      events: Events;\n    },\n    actions: {\n      // event transitions\n      startTimer: () => {\n        startReconnectionTimeout();\n      },\n      cancelTimer: () => {\n        cancelReconnectionTimeout();\n      },\n      reconnectionTimeoutEvent: emit({ type: \"ReconnectionTimedOut\" }),\n      sendApdu: ({ context }) => {\n        context.apduInProgress.map(({ apdu, abortTimeout }) => {\n          sendApduFn(apdu, false, abortTimeout);\n        });\n      },\n      sendApduResponse: (\n        { context },\n        params: { response: Either<DmkError, ApduResponse> },\n      ) => {\n        context.apduInProgress.map(({ responseCallback }) =>\n          responseCallback(params.response),\n        );\n      },\n      sendGetAppAndVersion: () => {\n        sendApduFn(new GetAppAndVersionCommand().getApdu().getRawApdu(), false);\n      },\n      tryToReconnect: () => {\n        tryToReconnect();\n      },\n      clearApduInProgress: assign({\n        apduInProgress: Nothing,\n      }),\n      clearApduResponse: assign({\n        apduResponse: Nothing,\n      }),\n      signalTermination: () => {\n        onTerminated();\n      },\n      closeConnection: () => {\n        closeConnection(); // ASK: how do we handle errors ?\n      },\n    },\n    guards: {\n      isApduThatTriggersDisconnection: ({ context, event }) => {\n        if (event.type !== \"ApduResponseReceived\") {\n          return false;\n        }\n        return context.apduInProgress.caseOf({\n          /**\n           * If the apdu is known as one that triggers a disconnection,\n           * and if it's a success response,\n           * then will trigger a disconnection (on Ledger OS prior to the IO revamp).\n           */\n          Just: ({ triggersDisconnection, apdu }) =>\n            (triggersDisconnection ||\n              CommandUtils.isApduThatTriggersDisconnection(apdu)) &&\n            CommandUtils.isSuccessResponse(event.apduResponse),\n          Nothing: () => false,\n        });\n      },\n      isSendApduBusyError: ({ event }) => {\n        if (event.type !== \"ApduResponseReceived\") {\n          return false;\n        }\n        return (\n          event.apduResponse.statusCode[0] === 0x66 &&\n          event.apduResponse.statusCode[1] === 0x01\n        );\n      },\n    },\n  }).createMachine({\n    /** @xstate-layout N4IgpgJg5mDOIC5QTANwJYGMwGED2AdgWJgC7qEB0+RJpkAxACJpZgukCGmAFpANoAGALqJQABzyx05QmJAAPRAA4A7AGZKywQEYAnAFYATMoAsBg6fUA2ADQgAnolUnKBjUdXXVpnUb0aAL6B9igY2DTEZBQE1IRR9BAMAMpgBBAAguIQAK44nAA2BQIi8pLSsgTySgjW6oKU6uo61kbWyh06Vsr2TgjqAZR6HUaWXcrqBmrBoawR8XQxcbRkjDgFUrgL0YT5RSWiSCDlMjHVKnrWjaO6ev6qlnp6vYim1qaN9YLqGuPKOjpVDMQGE2JFFlRUul0AQoFlcgx4TkAEpwSQEWBgVHYdCoA5lKSnORHGpNVSUPwGXQDQSmNTDF4IZTWPRDJotUw+HwAnTA0HzFaVShQiAwuHZHKIiWo2DozHYsC4gQ6Q4SQmVc79TxDIzqG6eJq+VSM94NPQ6CYuUzmQGCax8uZbQVLEVipFS3Ku2EAUQATr68L6hKrjuqziTEJNNHrTG1dIIDE8jLTGVTlJQboI2i56QZeSEQY7wTtYl7xQiWOF2GAuLx8UcThqIwh-OmdBZPF0qQCBoydIJlAZKK0jP4bHntBaHVXi0Ky+71ptZzE9sUIMGCRVw6Aau2dJQ6WZlMM-D9+89HIh++mbndVHpdNYLAnp2DtnO0qLYe6RUjV-W1S3Ykd0QABac1KFpbx3kHCxumNS9ak5SDTHNax0NUDRfFMV8BQSJYAHVOFOWEADFA2xd8YmYR0MlIWs+HXUoGzDYDFEQQx90mVozABJ9BAvPo6iuFpRgtQRdDUWNcKdfCqCIkioHI31KOdQgUk-P9CjXDcWKAqpmx0dR-gpCTaXNUxvh7RkvCHWlaWM9RfC6dCZOXeTiPIMiKJIKj1NUuSCAAFXQABbSAAHkclIXTAKJAyQIQLpBHJAEXB8AS1HvdRGT0a0D2ZZpBxjSc3L82IFK8pSfMwcqGEXTF3IIf8mJDRtt3YpLLPJZMWkmTtzJyxD+1UBofifVQOm8YyWjKtSKs8sVlICiECAImQeAARRyMAdogX8JRoqs6IYgDQ30zUjJ8CkWQmYZbOsFLGWzUyzE5bssx8ObAsoSqlpq8r1tILadr2g6ERWksQvCiAopi5i4qbRKjH7Bo4N1dsvFjOxEIeIwUPQ9o9AGSYvG+1bfsW7yVN8+agZB3bIHByUGtk1aWti874s1FGJOHYy6gTLo3lMVN7wPBNVAtbRRg0IEC35NmS0pxTltpwL6e2xn9s0w7mY5hGuaRzrAWZIYBJpc0pd1E18tNMZLOMAwnOCAsCDwFB4CORWms3bnm1AozWSgrHYMsYyEL6FGKXcDleMMO5rXJ5XZ0gP3jZqB4evaLwXEeqwnJNKYDypWlzHePwcIVotyuFT83QldOOpqWNU30A8rEmrMjPcAJk6FP7qch432rY3dxnN1onlaZ9idy5NILuCxl+UEwrH7wiqeqmnarpjatbB3Xcibser3eckfmd3xOkrnpce0DMjHMeoAgLjeqCCsBfVCmFOESE+EqdSfnmNwLJjBPBSs0QwuV3CQWPN3AwT4LTtldoEIAA */\n    id: \"deviceConnection\",\n    initial: \"Connected\",\n    context: {\n      apduInProgress: Nothing,\n      apduResponse: Nothing,\n    },\n    states: {\n      Connected: {\n        on: {\n          DeviceDisconnected: {\n            target: \"WaitingForReconnection\",\n          },\n          SendApduCalled: {\n            target: \"SendingApdu\",\n            actions: assign({\n              apduInProgress: ({ event }) => {\n                return Maybe.of({\n                  apdu: event.apdu,\n                  triggersDisconnection: event.triggersDisconnection,\n                  abortTimeout: event.abortTimeout,\n                  responseCallback: event.responseCallback,\n                });\n              },\n            }),\n          },\n          CloseConnectionCalled: {\n            target: \"Terminated\",\n          },\n        },\n      },\n      SendingApdu: {\n        entry: \"sendApdu\",\n        on: {\n          ApduResponseReceived: [\n            {\n              guard: \"isApduThatTriggersDisconnection\",\n              target: \"WaitingForDisconnection\",\n              actions: [\n                assign({\n                  apduResponse: ({ event }) => Maybe.of(event.apduResponse),\n                }),\n              ],\n            },\n            {\n              target: \"Connected\",\n              actions: [\n                {\n                  type: \"sendApduResponse\",\n                  // https://stately.ai/docs/actions#dynamic-action-parameters\n                  params: ({ event }) => {\n                    return {\n                      response: Right(event.apduResponse),\n                    };\n                  },\n                },\n                { type: \"clearApduInProgress\" },\n              ],\n            },\n          ],\n          ApduSendingError: {\n            target: \"Connected\",\n            actions: [\n              {\n                type: \"sendApduResponse\",\n                // https://stately.ai/docs/actions#dynamic-action-parameters\n                params: ({ event }) => {\n                  return {\n                    response: Left(event.error),\n                  };\n                },\n              },\n              \"clearApduInProgress\",\n            ],\n          },\n          DeviceDisconnected: {\n            target: \"WaitingForReconnection\",\n            actions: [\n              {\n                type: \"sendApduResponse\",\n                params: {\n                  response: Left(new DeviceDisconnectedWhileSendingError()),\n                },\n              },\n              \"clearApduInProgress\",\n            ],\n          },\n          CloseConnectionCalled: {\n            target: \"Terminated\",\n            actions: [\n              {\n                type: \"sendApduResponse\",\n                params: {\n                  response: Left(new DeviceDisconnectedWhileSendingError()),\n                },\n              },\n              \"clearApduInProgress\",\n            ],\n          },\n          SendApduCalled: {\n            actions: ({ event }) => {\n              event.responseCallback(Left(new AlreadySendingApduError()));\n            },\n          },\n        },\n      },\n      WaitingForDisconnection: {\n        entry: [\"sendGetAppAndVersion\"],\n        exit: [\n          {\n            type: \"sendApduResponse\",\n            params: ({ context }) => {\n              return {\n                response: context.apduResponse.caseOf({\n                  Just: (apduResponse) => Right(apduResponse),\n                  Nothing: () => Left(new UnknownDeviceExchangeError()),\n                }),\n              };\n            },\n          },\n          { type: \"clearApduInProgress\" },\n          { type: \"clearApduResponse\" },\n        ],\n        on: {\n          ApduResponseReceived: [\n            {\n              guard: \"isSendApduBusyError\",\n              actions: [\"sendGetAppAndVersion\"],\n              target: \"WaitingForDisconnection\",\n            },\n            {\n              target: \"Connected\",\n            },\n          ],\n          ApduSendingError: [\n            {\n              target: \"WaitingForReconnection\",\n            },\n          ],\n          SendApduCalled: {\n            actions: ({ event }) => {\n              event.responseCallback(Left(new AlreadySendingApduError()));\n            },\n          },\n          DeviceDisconnected: {\n            target: \"WaitingForReconnection\",\n          },\n          CloseConnectionCalled: {\n            target: \"Terminated\",\n          },\n        },\n      },\n      WaitingForReconnection: {\n        entry: [\"startTimer\", \"tryToReconnect\"],\n        on: {\n          DeviceConnected: {\n            target: \"Connected\",\n            actions: \"cancelTimer\",\n          },\n          SendApduCalled: {\n            target: \"WaitingForReconnectionWithQueuedSendApdu\",\n            actions: assign({\n              apduInProgress: ({ event }) => {\n                return Maybe.of({\n                  apdu: event.apdu,\n                  triggersDisconnection: event.triggersDisconnection,\n                  abortTimeout: event.abortTimeout,\n                  responseCallback: event.responseCallback,\n                });\n              },\n            }),\n          },\n          ReconnectionTimedOut: {\n            target: \"Terminated\",\n          },\n          CloseConnectionCalled: {\n            target: \"Terminated\",\n          },\n        },\n      },\n      WaitingForReconnectionWithQueuedSendApdu: {\n        on: {\n          DeviceConnected: {\n            target: \"SendingApdu\",\n            actions: \"cancelTimer\",\n          },\n          ReconnectionTimedOut: {\n            target: \"Terminated\",\n            actions: [\n              {\n                type: \"sendApduResponse\",\n                params: {\n                  response: Left(new DeviceDisconnectedBeforeSendingApdu()),\n                },\n              },\n              {\n                type: \"clearApduInProgress\",\n              },\n            ],\n          },\n          CloseConnectionCalled: {\n            target: \"Terminated\",\n            actions: [\n              {\n                type: \"sendApduResponse\",\n                params: {\n                  response: Left(new DeviceDisconnectedWhileSendingError()),\n                },\n              },\n              \"clearApduInProgress\",\n            ],\n          },\n          SendApduCalled: {\n            actions: ({ event }) => {\n              event.responseCallback(Left(new AlreadySendingApduError()));\n            },\n          },\n        },\n      },\n      // TODO: ADD INACTIVE STATE\n      Terminated: {\n        entry: [\"signalTermination\", \"closeConnection\"],\n        type: \"final\",\n      },\n    },\n  });\n}\n"],
  "mappings": "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",
  "names": ["DeviceConnectionStateMachine_exports", "__export", "DeviceConnectionStateMachine", "__toCommonJS", "import_purify_ts", "import_xstate", "import_GetAppAndVersionCommand", "import_CommandUtils", "import_Error", "import_Errors", "params", "makeStateMachine", "apdu", "triggersDisconnection", "abortTimeout", "response", "error", "apduResponse", "dependencies", "responseCallback", "sendApduFn", "startReconnectionTimeout", "cancelReconnectionTimeout", "tryToReconnect", "onTerminated", "closeConnection", "context", "event"]
}

{
  "version": 3,
  "sources": ["../../../../../../src/api/command/os/ListAppsCommand.ts"],
  "sourcesContent": ["import { type Apdu } from \"@api/apdu/model/Apdu\";\nimport { ApduBuilder, type ApduBuilderArgs } from \"@api/apdu/utils/ApduBuilder\";\nimport { ApduParser } from \"@api/apdu/utils/ApduParser\";\nimport { type Command } from \"@api/command/Command\";\nimport {\n  type CommandResult,\n  CommandResultFactory,\n} from \"@api/command/model/CommandResult\";\nimport {\n  type CommandErrors,\n  isCommandErrorCode,\n} from \"@api/command/utils/CommandErrors\";\nimport { CommandUtils } from \"@api/command/utils/CommandUtils\";\nimport { GlobalCommandErrorHandler } from \"@api/command/utils/GlobalCommandError\";\nimport { type ApduResponse } from \"@api/device-session/ApduResponse\";\nimport { type CommandErrorArgs, DeviceExchangeError } from \"@api/Error\";\n\nexport type AppResponse = {\n  readonly appEntryLength: number;\n  readonly appSizeInBlocks: number;\n  readonly appCodeHash: string;\n  readonly appFullHash: string;\n  readonly appName: string;\n};\n\nexport type ListAppsResponse = AppResponse[];\n\nexport type ListAppsArgs = {\n  readonly isContinue: boolean;\n};\n\nexport type ListAppsErrorCodes = \"6624\";\n\nconst LIST_APP_ERRORS: CommandErrors<ListAppsErrorCodes> = {\n  \"6624\": { message: \"Invalid state (List applications command must be sent)\" },\n};\n\nexport type ListAppsCommandResult = CommandResult<\n  ListAppsResponse,\n  ListAppsErrorCodes\n>;\n\nexport class ListAppsCommandError extends DeviceExchangeError<ListAppsErrorCodes> {\n  constructor({ message, errorCode }: CommandErrorArgs<ListAppsErrorCodes>) {\n    super({ message, errorCode, tag: \"ListAppsCommandError\" });\n  }\n}\n\nexport class ListAppsCommand\n  implements Command<ListAppsResponse, ListAppsArgs, ListAppsErrorCodes>\n{\n  readonly name = \"listApps\";\n  readonly args: ListAppsArgs;\n\n  constructor(args = { isContinue: false }) {\n    this.args = args;\n  }\n\n  getApdu(): Apdu {\n    const listAppApduArgs: ApduBuilderArgs = {\n      cla: 0xe0,\n      ins: this.args.isContinue ? 0xdf : 0xde,\n      p1: 0x00,\n      p2: 0x00,\n    };\n    return new ApduBuilder(listAppApduArgs).build();\n  }\n\n  parseResponse(apduResponse: ApduResponse): ListAppsCommandResult {\n    const res = [];\n    const parser = new ApduParser(apduResponse);\n\n    if (!CommandUtils.isSuccessResponse(apduResponse)) {\n      const errorCode = parser.encodeToHexaString(apduResponse.statusCode);\n      if (isCommandErrorCode(errorCode, LIST_APP_ERRORS)) {\n        return CommandResultFactory({\n          error: new ListAppsCommandError({\n            ...LIST_APP_ERRORS[errorCode],\n            errorCode,\n          }),\n        });\n      }\n      return CommandResultFactory({\n        error: GlobalCommandErrorHandler.handle(apduResponse),\n      });\n    }\n\n    if (apduResponse.data.length <= 0) {\n      return CommandResultFactory({\n        data: [],\n      });\n    }\n\n    // [NOTE] version of parsing, not used for now, skipping 1 byte\n    parser.extract8BitUInt()!;\n\n    while (parser.getUnparsedRemainingLength() > 0) {\n      const appEntryLength = parser.extract8BitUInt()!;\n      const appSizeInBlocks = parser.extract16BitUInt()!;\n      parser.extract16BitUInt()!; // Skip 2 bytes (flags, missing in doc for now)\n      const appCodeHash = parser.encodeToHexaString(\n        parser.extractFieldByLength(0x20), // 32 bytes\n      );\n      const appFullHash = parser.encodeToHexaString(\n        parser.extractFieldByLength(0x20), // 32 bytes\n      );\n\n      const appName = parser.encodeToString(parser.extractFieldLVEncoded());\n\n      res.push({\n        appEntryLength,\n        appSizeInBlocks,\n        appCodeHash,\n        appFullHash,\n        appName,\n      });\n    }\n\n    return CommandResultFactory({\n      data: res,\n    });\n  }\n}\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,qBAAAE,EAAA,yBAAAC,IAAA,eAAAC,EAAAJ,GACA,IAAAK,EAAkD,uCAClDC,EAA2B,sCAE3BC,EAGO,4CACPC,EAGO,4CACPC,EAA6B,2CAC7BC,EAA0C,iDAE1CC,EAA2D,sBAkB3D,MAAMC,EAAqD,CACzD,KAAQ,CAAE,QAAS,wDAAyD,CAC9E,EAOO,MAAMT,UAA6B,qBAAwC,CAChF,YAAY,CAAE,QAAAU,EAAS,UAAAC,CAAU,EAAyC,CACxE,MAAM,CAAE,QAAAD,EAAS,UAAAC,EAAW,IAAK,sBAAuB,CAAC,CAC3D,CACF,CAEO,MAAMZ,CAEb,CACW,KAAO,WACP,KAET,YAAYa,EAAO,CAAE,WAAY,EAAM,EAAG,CACxC,KAAK,KAAOA,CACd,CAEA,SAAgB,CACd,MAAMC,EAAmC,CACvC,IAAK,IACL,IAAK,KAAK,KAAK,WAAa,IAAO,IACnC,GAAI,EACJ,GAAI,CACN,EACA,OAAO,IAAI,cAAYA,CAAe,EAAE,MAAM,CAChD,CAEA,cAAcC,EAAmD,CAC/D,MAAMC,EAAM,CAAC,EACPC,EAAS,IAAI,aAAWF,CAAY,EAE1C,GAAI,CAAC,eAAa,kBAAkBA,CAAY,EAAG,CACjD,MAAMH,EAAYK,EAAO,mBAAmBF,EAAa,UAAU,EACnE,SAAI,sBAAmBH,EAAWF,CAAe,KACxC,wBAAqB,CAC1B,MAAO,IAAIT,EAAqB,CAC9B,GAAGS,EAAgBE,CAAS,EAC5B,UAAAA,CACF,CAAC,CACH,CAAC,KAEI,wBAAqB,CAC1B,MAAO,4BAA0B,OAAOG,CAAY,CACtD,CAAC,CACH,CAEA,GAAIA,EAAa,KAAK,QAAU,EAC9B,SAAO,wBAAqB,CAC1B,KAAM,CAAC,CACT,CAAC,EAMH,IAFAE,EAAO,gBAAgB,EAEhBA,EAAO,2BAA2B,EAAI,GAAG,CAC9C,MAAMC,EAAiBD,EAAO,gBAAgB,EACxCE,EAAkBF,EAAO,iBAAiB,EAChDA,EAAO,iBAAiB,EACxB,MAAMG,EAAcH,EAAO,mBACzBA,EAAO,qBAAqB,EAAI,CAClC,EACMI,EAAcJ,EAAO,mBACzBA,EAAO,qBAAqB,EAAI,CAClC,EAEMK,EAAUL,EAAO,eAAeA,EAAO,sBAAsB,CAAC,EAEpED,EAAI,KAAK,CACP,eAAAE,EACA,gBAAAC,EACA,YAAAC,EACA,YAAAC,EACA,QAAAC,CACF,CAAC,CACH,CAEA,SAAO,wBAAqB,CAC1B,KAAMN,CACR,CAAC,CACH,CACF",
  "names": ["ListAppsCommand_exports", "__export", "ListAppsCommand", "ListAppsCommandError", "__toCommonJS", "import_ApduBuilder", "import_ApduParser", "import_CommandResult", "import_CommandErrors", "import_CommandUtils", "import_GlobalCommandError", "import_Error", "LIST_APP_ERRORS", "message", "errorCode", "args", "listAppApduArgs", "apduResponse", "res", "parser", "appEntryLength", "appSizeInBlocks", "appCodeHash", "appFullHash", "appName"]
}

"use strict";var S=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var T=Object.getOwnPropertyNames;var k=Object.prototype.hasOwnProperty;var C=(r,e)=>{for(var i in e)S(r,i,{get:e[i],enumerable:!0})},M=(r,e,i,c)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of T(e))!k.call(r,s)&&s!==i&&S(r,s,{get:()=>e[s],enumerable:!(c=V(e,s))||c.enumerable});return r};var N=r=>M(S({},"__esModule",{value:!0}),r);var L={};C(L,{UninstallAppDeviceAction:()=>G});module.exports=N(L);var A=require("purify-ts"),a=require("xstate"),D=require("../../../command/model/CommandResult"),v=require("../../../command/os/GetOsVersionCommand"),d=require("../../../device-action/model/UserInteractionRequired"),I=require("../../../device-action/os/Const"),h=require("../../../device-action/os/Errors"),y=require("../../../device-action/os/GoToDashboard/GoToDashboardDeviceAction"),f=require("../../../device-action/xstate-utils/XStateDeviceAction"),g=require("../../../device-session/DeviceSessionState"),x=require("../../../secure-channel/device-action/ListInstalledApps/ListInstalledAppsDeviceAction"),E=require("../../../secure-channel/task/ConnectToSecureChannelTask"),u=require("../../../secure-channel/task/types");class G extends f.XStateDeviceAction{makeStateMachine(e){const{getOsVersion:i,getAppsByHash:c,uninstallApp:s,getDeviceSessionState:o,setDeviceSessionState:p}=this.extractDependencies(e),l=this.input.unlockTimeout??I.DEFAULT_UNLOCK_TIMEOUT_MS,m=new y.GoToDashboardDeviceAction({input:{unlockTimeout:l}}).makeStateMachine(e),U=new x.ListInstalledAppsDeviceAction({input:{unlockTimeout:l}}).makeStateMachine(e);return(0,a.setup)({types:{input:{},context:{},output:{}},actors:{listInstalledApps:U,goToDashboard:m,getOsVersion:(0,a.fromPromise)(i),getAppsByHash:(0,a.fromPromise)(c),uninstallApp:(0,a.fromObservable)(s)},guards:{hasError:t=>t.context._internalState.error!==null,appNotInstalled:t=>!t.context._internalState.installedApps.some(n=>n.name===t.context.input.appName),appNotFound:t=>t.context._internalState.appList.findIndex(n=>n?.versionName===t.context.input.appName)===-1,isDepAppOfOther:t=>t.context._internalState.appList.some(n=>n?.parentName===t.context.input.appName)},actions:{assignErrorFromEvent:(0,a.assign)({_internalState:t=>({...t.context._internalState,error:t.event.error})}),assignAppNotFound:(0,a.assign)({_internalState:t=>({...t.context._internalState,error:new h.UnknownDAError("App to uninstall not found in manager API")})}),assignIsDepAppOfOther:(0,a.assign)({_internalState:t=>({...t.context._internalState,error:new h.UnknownDAError("App to uninstall is a dependency of another installed app")})}),cleanupDeviceState:()=>{const t=o();t.sessionStateType!==g.DeviceSessionStateType.Connected&&p({...t,installedApps:[],appsUpdates:void 0})}}}).createMachine({id:"UninstallAppDeviceAction",initial:"DeviceReady",context:t=>({input:{unlockTimeout:t.input.unlockTimeout,appName:t.input.appName},intermediateValue:{requiredUserInteraction:d.UserInteractionRequired.None},_internalState:{error:null,installedApps:[],appList:[],getOsVersionResponse:null}}),states:{DeviceReady:{always:{target:"ListInstalledApps"}},ListInstalledApps:{invoke:{id:"listInstalledApps",src:"listInstalledApps",input:t=>({unlockTimeout:t.context.input.unlockTimeout}),onSnapshot:{actions:(0,a.assign)({intermediateValue:t=>({...t.context.intermediateValue,requiredUserInteraction:t.event.snapshot.context.intermediateValue.requiredUserInteraction})})},onDone:{target:"ListInstalledAppsCheck",actions:(0,a.assign)({_internalState:t=>t.event.output.caseOf({Right:({installedApps:n})=>({...t.context._internalState,installedApps:n,hasCheckedInstalledApps:!0}),Left:n=>({...t.context._internalState,error:n})})})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},ListInstalledAppsCheck:{always:[{target:"Error",guard:"hasError"},{target:"Success",guard:"appNotInstalled"},{target:"GetAppsByHash"}]},GetAppsByHash:{invoke:{id:"getAppsByHash",src:"getAppsByHash",input:t=>t.context._internalState.installedApps,onDone:{target:"GetAppsByHashCheck",actions:(0,a.assign)({_internalState:t=>t.event.output.caseOf({Right:n=>({...t.context._internalState,appList:n}),Left:n=>({...t.context._internalState,error:n})})})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},GetAppsByHashCheck:{always:[{target:"Error",guard:"hasError"},{target:"Error",guard:"appNotFound",actions:"assignAppNotFound"},{target:"Error",guard:"isDepAppOfOther",actions:"assignIsDepAppOfOther"},{target:"GoToDashboard"}]},GoToDashboard:{invoke:{id:"goToDashboard",src:"goToDashboard",input:t=>({unlockTimeout:t.context.input.unlockTimeout}),onSnapshot:{actions:(0,a.assign)({intermediateValue:t=>({...t.context.intermediateValue,requiredUserInteraction:t.event.snapshot.context.intermediateValue.requiredUserInteraction})})},onDone:{target:"GoToDashboardCheck",actions:(0,a.assign)({_internalState:t=>t.event.output.caseOf({Right:()=>t.context._internalState,Left:n=>({...t.context._internalState,error:n})})})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},GoToDashboardCheck:{always:[{target:"Error",guard:"hasError"},{target:"GetOsVersion"}]},GetOsVersion:{invoke:{id:"getOsVersion",src:"getOsVersion",input:t=>{},onDone:{target:"GetOsVersionCheck",actions:(0,a.assign)({_internalState:t=>{if((0,D.isSuccessCommandResult)(t.event.output)){const n=o(),O=t.event.output.data.secureElementFlags.isSecureConnectionAllowed;return n.sessionStateType!==g.DeviceSessionStateType.Connected&&p({...n,isSecureConnectionAllowed:O}),{...t.context._internalState,getOsVersionResponse:t.event.output.data}}return{...t.context._internalState,error:t.event.output.error}}})}}},GetOsVersionCheck:{always:[{target:"Error",guard:"hasError"},{target:"UninstallApp"}]},UninstallApp:{invoke:{id:"uninstallApp",src:"uninstallApp",input:t=>({deviceInfo:t.context._internalState.getOsVersionResponse,app:t.context._internalState.appList.find(n=>n?.versionName===t.context.input.appName)}),onSnapshot:{actions:(0,a.assign)({intermediateValue:t=>{switch(t.event.snapshot.context?.type){case u.SecureChannelEventType.DeviceId:return{...t.context.intermediateValue,deviceId:t.event.snapshot.context.payload.deviceId};case u.SecureChannelEventType.PermissionRequested:return{...t.context.intermediateValue,requiredUserInteraction:d.UserInteractionRequired.AllowSecureConnection};case u.SecureChannelEventType.PermissionGranted:return{...t.context.intermediateValue,requiredUserInteraction:d.UserInteractionRequired.None};default:return{...t.context.intermediateValue}}},_internalState:t=>t.event.snapshot.context?.type===u.SecureChannelEventType.Error?{...t.context._internalState,error:t.event.snapshot.context.error.mapDAErrors()}:t.context._internalState})},onDone:{target:"ListInstalledApps",actions:"cleanupDeviceState"},onError:{target:"Error",actions:"assignErrorFromEvent"}}},Success:{type:"final",description:"App uninstalled successfully"},Error:{type:"final"}},output:({context:t})=>t._internalState.error?(0,A.Left)(t._internalState.error):(0,A.Right)(void 0)})}extractDependencies(e){return{getOsVersion:()=>e.sendCommand(new v.GetOsVersionCommand),getAppsByHash:({input:o})=>{const p=o.map(l=>l.hash);return e.getManagerApiService().getAppsByHash(p)},uninstallApp:({input:o})=>{const{deviceInfo:p,app:l}=o,m=e.getSecureChannelService().uninstallApp(p,l);return new E.ConnectToSecureChannelTask(e,{connection:m}).run()},getDeviceSessionState:()=>e.getDeviceSessionState(),setDeviceSessionState:o=>e.setDeviceSessionState(o)}}}0&&(module.exports={UninstallAppDeviceAction});
//# sourceMappingURL=UninstallAppDeviceAction.js.map

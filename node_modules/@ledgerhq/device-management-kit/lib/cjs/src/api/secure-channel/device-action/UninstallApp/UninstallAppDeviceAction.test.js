"use strict";var A=require("purify-ts"),f=require("rxjs"),v=require("../../../command/model/CommandResult"),I=require("../../../device/DeviceStatus"),o=require("../../../device-action/__test-utils__/makeInternalApi"),i=require("../../../device-action/__test-utils__/setupTestMachine"),c=require("../../../device-action/__test-utils__/testDeviceActionStates"),e=require("../../../device-action/model/DeviceActionState"),t=require("../../../device-action/model/UserInteractionRequired"),S=require("../../../device-action/os/Errors"),V=require("../../../device-session/DeviceSessionState"),D=require("../../../secure-channel/task/types"),g=require("../../../../internal/secure-channel/model/Errors"),l=require("./UninstallAppDeviceAction");vi.mock("@api/secure-channel/device-action/ListInstalledApps/ListInstalledAppsDeviceAction");vi.mock("@api/device-action/os/GoToDashboard/GoToDashboardDeviceAction");describe("UninstallAppDeviceAction",()=>{const u=vi.fn(),p=vi.fn(),h=vi.fn(),d=vi.fn(),N=vi.fn(),m=()=>({getOsVersion:u,getAppsByHash:p,uninstallApp:h,getDeviceSessionState:d,setDeviceSessionState:N});beforeEach(()=>{vi.resetAllMocks()}),it("should finish successfully when the app is not installed on the device",()=>new Promise((s,r)=>{(0,i.setupListInstalledAppsMock)([{installedApps:[{name:"Bitcoin"}]}]);const a=[{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Completed,output:void 0}],n=new l.UninstallAppDeviceAction({input:{appName:"Ethereum"}});vi.spyOn(n,"extractDependencies").mockImplementation(m),(0,c.testDeviceActionStates)(n,a,(0,o.makeDeviceActionInternalApiMock)(),{onDone:s,onError:r})})),it("should finish successfully when the app is installed on the device",()=>new Promise((s,r)=>{(0,i.setupListInstalledAppsMock)([{installedApps:[{name:"Bitcoin"}]},{installedApps:[]}]),(0,i.setupGoToDashboardMock)(),u.mockResolvedValue((0,v.CommandResultFactory)({data:{targetId:12345678,secureElementFlags:{isSecureConnectionAllowed:!0}}})),d.mockReturnValue({sessionStateType:V.DeviceSessionStateType.ReadyWithoutSecureChannel,deviceStatus:I.DeviceStatus.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),p.mockResolvedValue((0,A.Right)([{versionName:"Bitcoin",perso:"test_perso",firmware:"test_firmware_for_bitcoin",firmwareKey:"test_firmware_key_for_bitcoin",hash:"test_hash_for_bitcoin"}])),h.mockReturnValue((0,f.of)({type:D.SecureChannelEventType.Exchange}));const a=[{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Completed,output:void 0}],n=new l.UninstallAppDeviceAction({input:{appName:"Bitcoin"}});vi.spyOn(n,"extractDependencies").mockImplementation(m),(0,c.testDeviceActionStates)(n,a,(0,o.makeDeviceActionInternalApiMock)(),{onDone:s,onError:r})})),it("should finish unsuccessfully when the app is a dependency of other installed apps",()=>new Promise((s,r)=>{(0,i.setupListInstalledAppsMock)([{installedApps:[{name:"Bitcoin"},{name:"Testcoin"}]}]),(0,i.setupGoToDashboardMock)(),u.mockResolvedValue((0,v.CommandResultFactory)({data:{targetId:12345678,secureElementFlags:{isSecureConnectionAllowed:!0}}})),d.mockReturnValue({sessionStateType:V.DeviceSessionStateType.ReadyWithoutSecureChannel,deviceStatus:I.DeviceStatus.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),p.mockResolvedValue((0,A.Right)([{versionName:"Testcoin",parentName:"Bitcoin"},{versionName:"Bitcoin"}]));const a=[{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Error,error:new S.UnknownDAError("App to uninstall is a dependency of another installed app")}],n=new l.UninstallAppDeviceAction({input:{appName:"Bitcoin"}});vi.spyOn(n,"extractDependencies").mockImplementation(m),(0,c.testDeviceActionStates)(n,a,(0,o.makeDeviceActionInternalApiMock)(),{onDone:s,onError:r})})),it("should finish unsuccessfully when the app is not found in manager API",()=>new Promise((s,r)=>{(0,i.setupListInstalledAppsMock)([{installedApps:[{name:"Bitcoin"}]}]),(0,i.setupGoToDashboardMock)(),u.mockResolvedValue((0,v.CommandResultFactory)({data:{targetId:12345678,secureElementFlags:{isSecureConnectionAllowed:!0}}})),d.mockReturnValue({}),p.mockResolvedValueOnce((0,A.Right)([]));const a=[{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Error,error:new S.UnknownDAError("App to uninstall not found in manager API")}],n=new l.UninstallAppDeviceAction({input:{appName:"Bitcoin"}});vi.spyOn(n,"extractDependencies").mockImplementation(m),(0,c.testDeviceActionStates)(n,a,(0,o.makeDeviceActionInternalApiMock)(),{onDone:s,onError:r})})),it("should finish unsuccessfully when there is error in uninstallApp",()=>new Promise((s,r)=>{(0,i.setupListInstalledAppsMock)([{installedApps:[{name:"Bitcoin"}]}]),(0,i.setupGoToDashboardMock)(),u.mockResolvedValue((0,v.CommandResultFactory)({data:{targetId:12345678,secureElementFlags:{isSecureConnectionAllowed:!0}}})),d.mockReturnValue({}),p.mockResolvedValueOnce((0,A.Right)([{versionName:"Bitcoin"}])),h.mockReturnValue((0,f.throwError)(()=>new g.SecureChannelError("Uninstall app error in secure channel")));const a=[{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Error,error:new g.SecureChannelError("Uninstall app error in secure channel")}],n=new l.UninstallAppDeviceAction({input:{appName:"Bitcoin"}});vi.spyOn(n,"extractDependencies").mockImplementation(m),(0,c.testDeviceActionStates)(n,a,(0,o.makeDeviceActionInternalApiMock)(),{onDone:s,onError:r})}))});
//# sourceMappingURL=UninstallAppDeviceAction.test.js.map

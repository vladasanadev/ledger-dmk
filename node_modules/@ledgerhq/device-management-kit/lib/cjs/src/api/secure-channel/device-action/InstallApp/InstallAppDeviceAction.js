"use strict";var m=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var k=Object.prototype.hasOwnProperty;var M=(r,n)=>{for(var i in n)m(r,i,{get:n[i],enumerable:!0})},C=(r,n,i,l)=>{if(n&&typeof n=="object"||typeof n=="function")for(let o of O(n))!k.call(r,o)&&o!==i&&m(r,o,{get:()=>n[o],enumerable:!(l=L(n,o))||l.enumerable});return r};var N=r=>C(m({},"__esModule",{value:!0}),r);var R={};M(R,{InstallAppDeviceAction:()=>G});module.exports=N(R);var A=require("purify-ts"),a=require("xstate"),h=require("../../../command/model/CommandResult"),D=require("../../../command/os/GetOsVersionCommand"),v=require("../../../device-action/model/UserInteractionRequired"),f=require("../../../device-action/os/Const"),I=require("../../../device-action/os/Errors"),x=require("../../../device-action/os/GoToDashboard/GoToDashboardDeviceAction"),y=require("../../../device-action/xstate-utils/XStateDeviceAction"),g=require("../../../device-session/DeviceSessionState"),E=require("../../../secure-channel/device-action/ListInstalledApps/ListInstalledAppsDeviceAction"),V=require("../../../secure-channel/task/ConnectToSecureChannelTask"),d=require("../../../secure-channel/task/types");class G extends y.XStateDeviceAction{makeStateMachine(n){const{getOsVersion:i,getAppList:l,installApp:o,getDeviceSessionState:s,setDeviceSessionState:p}=this.extractDependencies(n),u=this.input.unlockTimeout??f.DEFAULT_UNLOCK_TIMEOUT_MS,S=new E.ListInstalledAppsDeviceAction({input:{unlockTimeout:u}}).makeStateMachine(n),T=new x.GoToDashboardDeviceAction({input:{unlockTimeout:u}}).makeStateMachine(n);return(0,a.setup)({types:{input:{},context:{},output:{}},actors:{listInstalledApps:S,goToDashboard:T,getOsVersion:(0,a.fromPromise)(i),getAppList:(0,a.fromPromise)(l),installApp:(0,a.fromObservable)(o)},guards:{hasError:t=>t.context._internalState.error!==null,appInstalled:t=>t.context._internalState.installedApps.some(e=>e.name===t.context.input.appName),appNotFound:t=>t.context._internalState.appList.findIndex(({versionName:e})=>e===t.context.input.appName)===-1,depAppNotInstalled:t=>{const e=t.context._internalState.appList.find(({versionName:c})=>c===t.context.input.appName);return e?.parentName?t.context._internalState.installedApps.findIndex(({name:c})=>c===e.parentName)===-1:!1}},actions:{assignErrorFromEvent:(0,a.assign)({_internalState:t=>({...t.context._internalState,error:t.event.error})}),assignAppNotFound:(0,a.assign)({_internalState:t=>({...t.context._internalState,error:new I.UnknownDAError("App to install not found in manager API")})}),assignDepAppNotInstalled:(0,a.assign)({_internalState:t=>({...t.context._internalState,error:new I.UnknownDAError("Dep app is not installed on the device")})}),cleanupDeviceState:()=>{const t=s();t.sessionStateType!==g.DeviceSessionStateType.Connected&&p({...t,installedApps:[],appsUpdates:void 0})}}}).createMachine({id:"InstallAppDeviceAction",initial:"DeviceReady",context:t=>({input:{unlockTimeout:t.input.unlockTimeout,appName:t.input.appName},intermediateValue:{requiredUserInteraction:v.UserInteractionRequired.None,progress:0},_internalState:{error:null,installedApps:[],getOsVersionResponse:null,appList:[]}}),states:{DeviceReady:{always:{target:"ListInstalledApps"}},ListInstalledApps:{value:"ListInstalledApps",invoke:{id:"listInstalledApps",src:"listInstalledApps",input:t=>({unlockTimeout:t.context.input.unlockTimeout}),onSnapshot:{actions:(0,a.assign)({intermediateValue:t=>({...t.context.intermediateValue,requiredUserInteraction:t.event.snapshot.context.intermediateValue.requiredUserInteraction})})},onDone:{target:"ListInstalledAppsCheck",actions:(0,a.assign)({_internalState:t=>t.event.output.caseOf({Right:({installedApps:e})=>({...t.context._internalState,installedApps:e}),Left:e=>({...t.context._internalState,error:e})})})}}},ListInstalledAppsCheck:{always:[{target:"Error",guard:"hasError"},{target:"Success",guard:"appInstalled"},{target:"GoToDashboard"}]},GoToDashboard:{invoke:{id:"goToDashboard",src:"goToDashboard",input:t=>({unlockTimeout:t.context.input.unlockTimeout}),onSnapshot:{actions:(0,a.assign)({intermediateValue:t=>({...t.context.intermediateValue,requiredUserInteraction:t.event.snapshot.context.intermediateValue.requiredUserInteraction})})},onDone:{target:"GoToDashboardCheck",actions:(0,a.assign)({_internalState:t=>t.event.output.caseOf({Right:()=>t.context._internalState,Left:e=>({...t.context._internalState,error:e})})})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},GoToDashboardCheck:{always:[{target:"Error",guard:"hasError"},{target:"GetOsVersion"}]},GetOsVersion:{invoke:{id:"getOsVersion",src:"getOsVersion",input:t=>{},onDone:{target:"GetOsVersionCheck",actions:(0,a.assign)({_internalState:t=>{if((0,h.isSuccessCommandResult)(t.event.output)){const e=s(),c=t.event.output.data.secureElementFlags.isSecureConnectionAllowed;return e.sessionStateType!==g.DeviceSessionStateType.Connected&&p({...e,isSecureConnectionAllowed:c}),{...t.context._internalState,getOsVersionResponse:t.event.output.data}}return{...t.context._internalState,error:t.event.output.error}}})}}},GetOsVersionCheck:{always:[{target:"Error",guard:"hasError"},{target:"GetAppList"}]},GetAppList:{invoke:{id:"getAppList",src:"getAppList",input:t=>({deviceInfo:t.context._internalState.getOsVersionResponse}),onDone:{target:"GetAppListCheck",actions:(0,a.assign)({_internalState:t=>t.event.output.caseOf({Right:e=>({...t.context._internalState,appList:e}),Left:e=>({...t.context._internalState,error:e})})})}}},GetAppListCheck:{always:[{target:"Error",guard:"hasError"},{target:"Error",guard:"appNotFound",actions:"assignAppNotFound"},{target:"Error",guard:"depAppNotInstalled",actions:"assignDepAppNotInstalled"},{target:"InstallApp"}]},InstallApp:{invoke:{id:"installApp",src:"installApp",input:t=>({deviceInfo:t.context._internalState.getOsVersionResponse,app:t.context._internalState.appList.find(({versionName:e})=>e===t.context.input.appName)}),onSnapshot:{actions:(0,a.assign)({intermediateValue:t=>t.event.snapshot.context?.type===d.SecureChannelEventType.DeviceId?{...t.context.intermediateValue,deviceId:t.event.snapshot.context.payload.deviceId}:t.event.snapshot.context?.type===d.SecureChannelEventType.Progress?{...t.context.intermediateValue,progress:t.event.snapshot.context.payload.progress}:{...t.context.intermediateValue},_internalState:t=>t.event.snapshot.context?.type===d.SecureChannelEventType.Error?{...t.context._internalState,error:t.event.snapshot.context.error.mapInstallDAErrors()}:t.context._internalState})},onDone:{target:"ListInstalledApps",actions:"cleanupDeviceState"},onError:{target:"Error",actions:"assignErrorFromEvent"}}},Success:{type:"final",description:"App installed successfully"},Error:{type:"final"}},output:({context:t})=>t._internalState.error?(0,A.Left)(t._internalState.error):(0,A.Right)(void 0)})}extractDependencies(n){return{getOsVersion:()=>n.sendCommand(new D.GetOsVersionCommand),getAppList:({input:s})=>{const{deviceInfo:p}=s;return n.getManagerApiService().getAppList(p)},installApp:({input:s})=>{const{deviceInfo:p,app:u}=s,S=n.getSecureChannelService().installApp(p,u);return new V.ConnectToSecureChannelTask(n,{connection:S}).run()},getDeviceSessionState:()=>n.getDeviceSessionState(),setDeviceSessionState:s=>n.setDeviceSessionState(s)}}}0&&(module.exports={InstallAppDeviceAction});
//# sourceMappingURL=InstallAppDeviceAction.js.map

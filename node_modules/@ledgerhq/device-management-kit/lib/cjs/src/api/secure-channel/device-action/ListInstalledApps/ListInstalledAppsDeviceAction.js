"use strict";var v=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var O=Object.prototype.hasOwnProperty;var F=(i,t)=>{for(var a in t)v(i,a,{get:t[a],enumerable:!0})},T=(i,t,a,l)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of w(t))!O.call(i,o)&&o!==a&&v(i,o,{get:()=>t[o],enumerable:!(l=L(t,o))||l.enumerable});return i};var G=i=>T(v({},"__esModule",{value:!0}),i);var C={};F(C,{ListInstalledAppsDeviceAction:()=>k});module.exports=G(C);var m=require("purify-ts"),n=require("xstate"),g=require("../../../command/model/CommandResult"),D=require("../../../command/os/GetOsVersionCommand"),d=require("../../../device-action/model/UserInteractionRequired"),h=require("../../../device-action/os/Const"),V=require("../../../device-action/os/GoToDashboard/GoToDashboardDeviceAction"),A=require("../../../device-action/xstate-utils/XStateDeviceAction"),f=require("../../../device-session/DeviceSessionState"),x=require("../../../secure-channel/task/ConnectToSecureChannelTask"),p=require("../../../secure-channel/task/types"),y=require("./types");class k extends A.XStateDeviceAction{makeStateMachine(t){const{getOsVersion:a,getDeviceVersion:l,getFirmwareVersion:o,listInstalledApps:I,getDeviceSessionState:s,setDeviceSessionState:c}=this.extractDependencies(t),u=this.input.unlockTimeout??h.DEFAULT_UNLOCK_TIMEOUT_MS,S=new V.GoToDashboardDeviceAction({input:{unlockTimeout:u}}).makeStateMachine(t);return(0,n.setup)({types:{input:{},context:{},output:{}},actors:{goToDashboard:S,getOsVersion:(0,n.fromPromise)(a),getDeviceVersion:(0,n.fromPromise)(l),getFirmwareVersion:(0,n.fromPromise)(o),listInstalledApps:(0,n.fromObservable)(I)},guards:{hasError:e=>e.context._internalState.error!==null},actions:{assignErrorFromEvent:(0,n.assign)({_internalState:e=>({...e.context._internalState,error:e.event.error})})}}).createMachine({id:"ListInstalledAppsDeviceAction",initial:"DeviceReady",context:e=>({input:{unlockTimeout:e.input.unlockTimeout},intermediateValue:{requiredUserInteraction:d.UserInteractionRequired.None},_internalState:{error:null,getOsVersionResponse:null,deviceVersion:null,firmwareVersion:null,result:{installedApps:[]}}}),states:{DeviceReady:{always:{target:"GoToDashboard"}},GoToDashboard:{invoke:{id:"goToDashboard",src:"goToDashboard",input:e=>({unlockTimeout:e.context.input.unlockTimeout}),onSnapshot:{actions:(0,n.assign)({intermediateValue:e=>({...e.context.intermediateValue,requiredUserInteraction:e.event.snapshot.context.intermediateValue.requiredUserInteraction})})},onDone:{target:"GoToDashboardCheck",actions:(0,n.assign)({_internalState:e=>e.event.output.caseOf({Right:()=>e.context._internalState,Left:r=>({...e.context._internalState,error:r})})})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},GoToDashboardCheck:{always:[{target:"Error",guard:"hasError"},{target:"GetOsVersion"}]},GetOsVersion:{invoke:{id:"getOsVersion",src:"getOsVersion",input:e=>{},onDone:{target:"GetOsVersionCheck",actions:(0,n.assign)({_internalState:e=>{if((0,g.isSuccessCommandResult)(e.event.output)){const r=s(),E=e.event.output.data.secureElementFlags.isSecureConnectionAllowed;return r.sessionStateType!==f.DeviceSessionStateType.Connected&&c({...r,isSecureConnectionAllowed:E}),{...e.context._internalState,getOsVersionResponse:e.event.output.data}}return{...e.context._internalState,error:e.event.output.error}}})}}},GetOsVersionCheck:{always:[{target:"Error",guard:"hasError"},{target:"GetDeviceVersion"}]},GetDeviceVersion:{invoke:{id:"getDeviceVersion",src:"getDeviceVersion",input:e=>({deviceInfo:e.context._internalState.getOsVersionResponse}),onDone:{target:"GetDeviceVersionCheck",actions:(0,n.assign)({_internalState:e=>e.event.output.caseOf({Right:r=>({...e.context._internalState,deviceVersion:r}),Left:r=>({...e.context._internalState,error:r})})})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},GetDeviceVersionCheck:{always:[{target:"Error",guard:"hasError"},{target:"GetFirmwareVersion"}]},GetFirmwareVersion:{invoke:{id:"getFirmwareVersion",src:"getFirmwareVersion",input:e=>({deviceInfo:e.context._internalState.getOsVersionResponse,deviceVersion:e.context._internalState.deviceVersion}),onDone:{target:"GetFirmwareVersionCheck",actions:(0,n.assign)({_internalState:e=>e.event.output.caseOf({Right:r=>({...e.context._internalState,firmwareVersion:r}),Left:r=>({...e.context._internalState,error:r})})})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},GetFirmwareVersionCheck:{always:[{target:"Error",guard:"hasError"},{target:"ListInstalledApps"}]},ListInstalledApps:{invoke:{id:"listInstalledApps",src:"listInstalledApps",input:e=>({deviceInfo:e.context._internalState.getOsVersionResponse,finalFirmware:e.context._internalState.firmwareVersion}),onSnapshot:{actions:(0,n.assign)({intermediateValue:e=>{switch(e.event.snapshot.context?.type){case p.SecureChannelEventType.DeviceId:return{...e.context.intermediateValue,deviceId:e.event.snapshot.context.payload.deviceId};case p.SecureChannelEventType.PermissionRequested:return{...e.context.intermediateValue,requiredUserInteraction:d.UserInteractionRequired.AllowSecureConnection};case p.SecureChannelEventType.PermissionGranted:return{...e.context.intermediateValue,requiredUserInteraction:d.UserInteractionRequired.None};default:return{...e.context.intermediateValue}}},_internalState:e=>{if(e.event.snapshot.context?.type===p.SecureChannelEventType.Error)return{...e.context._internalState,error:e.event.snapshot.context.error.mapDAErrors()};if(e.event.snapshot.context?.type===p.SecureChannelEventType.Result){if((0,y.installedAppResultGuard)(e.event.snapshot.context.payload))return{...e.context._internalState,result:{installedApps:e.event.snapshot.context.payload}};throw new Error(`Invalid result ${JSON.stringify(e.event.snapshot.context.payload)}`)}return{...e.context._internalState}}})},onDone:{target:"Success"},onError:{target:"Error",actions:"assignErrorFromEvent"}}},ListInstalledAppsCheck:{always:[{target:"Error",guard:"hasError"},{target:"Success"}]},Success:{type:"final"},Error:{type:"final"}},output:e=>e.context._internalState.error?(0,m.Left)(e.context._internalState.error):(0,m.Right)(e.context._internalState.result)})}extractDependencies(t){return{getOsVersion:()=>t.sendCommand(new D.GetOsVersionCommand),getDeviceVersion:({input:s})=>{const{deviceInfo:c}=s;return t.getManagerApiService().getDeviceVersion(c)},getFirmwareVersion:({input:s})=>{const{deviceInfo:c,deviceVersion:u}=s;return t.getManagerApiService().getFirmwareVersion(c,u)},listInstalledApps:({input:s})=>{const{deviceInfo:c,finalFirmware:u}=s,S=t.getSecureChannelService().listInstalledApps(c,u);return new x.ConnectToSecureChannelTask(t,{connection:S}).run()},getDeviceSessionState:()=>t.getDeviceSessionState(),setDeviceSessionState:s=>t.setDeviceSessionState(s)}}}0&&(module.exports={ListInstalledAppsDeviceAction});
//# sourceMappingURL=ListInstalledAppsDeviceAction.js.map

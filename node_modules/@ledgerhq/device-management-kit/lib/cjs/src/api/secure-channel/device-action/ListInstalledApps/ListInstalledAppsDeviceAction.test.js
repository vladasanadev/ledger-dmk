"use strict";var r=require("purify-ts"),i=require("rxjs"),v=require("../../../command/model/CommandResult"),h=require("../../../device/DeviceStatus"),V=require("../../../device-action/__test-utils__/makeInternalApi"),g=require("../../../device-action/__test-utils__/setupTestMachine"),S=require("../../../device-action/__test-utils__/testDeviceActionStates"),e=require("../../../device-action/model/DeviceActionState"),t=require("../../../device-action/model/UserInteractionRequired"),A=require("../../../device-session/DeviceSessionState"),a=require("../../../secure-channel/task/types"),I=require("../../../../internal/manager-api/model/Errors"),y=require("../../../../internal/secure-channel/model/Errors"),f=require("./ListInstalledAppsDeviceAction");vi.mock("@api/device-action/os/GoToDashboard/GoToDashboardDeviceAction");describe("ListInstalledAppsDeviceAction",()=>{const d=vi.fn(),l=vi.fn(),u=vi.fn(),m=vi.fn(),p=vi.fn(),w=vi.fn(),D=()=>({getOsVersion:d,getDeviceVersion:l,getFirmwareVersion:u,listInstalledApps:m,getDeviceSessionState:p,setDeviceSessionState:w});beforeEach(()=>{vi.resetAllMocks()}),it("should return a list that contains all installed apps on the device",()=>new Promise((o,s)=>{(0,g.setupGoToDashboardMock)(),d.mockResolvedValue((0,v.CommandResultFactory)({data:{targetId:"123456",secureElementFlags:{isSecureConnectionAllowed:!0}}})),l.mockResolvedValue((0,r.Right)({id:123456})),u.mockResolvedValue((0,r.Right)({perso:"perso_test"})),p.mockReturnValue({sessionStateType:A.DeviceSessionStateType.ReadyWithoutSecureChannel,deviceStatus:h.DeviceStatus.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),m.mockReturnValue((0,i.of)({type:a.SecureChannelEventType.Exchange},{type:a.SecureChannelEventType.Result,payload:[{flags:123456,hash:"hash_test",hash_code_data:"hash_code_data_test",name:"Bitcoin"}]}));const c=[{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Completed,output:{installedApps:[{flags:123456,hash:"hash_test",hash_code_data:"hash_code_data_test",name:"Bitcoin"}]}}],n=new f.ListInstalledAppsDeviceAction({input:{}});vi.spyOn(n,"extractDependencies").mockImplementation(D),(0,S.testDeviceActionStates)(n,c,(0,V.makeDeviceActionInternalApiMock)(),{onDone:o,onError:s})})),it("should return error when error occurs in fetching device version",()=>new Promise((o,s)=>{(0,g.setupGoToDashboardMock)(),d.mockResolvedValue((0,v.CommandResultFactory)({data:{targetId:"123456",secureElementFlags:{isSecureConnectionAllowed:!1}}})),l.mockResolvedValue((0,r.Left)(new I.HttpFetchApiError("Device version fetch failed"))),u.mockResolvedValue((0,r.Right)({perso:"perso_test"})),p.mockReturnValue({sessionStateType:A.DeviceSessionStateType.ReadyWithoutSecureChannel,deviceStatus:h.DeviceStatus.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),m.mockReturnValue((0,i.of)({type:a.SecureChannelEventType.Exchange,payload:{data:new Uint8Array([0,1,2,3])}},{type:a.SecureChannelEventType.Result,payload:[]}));const c=[{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Error,error:new I.HttpFetchApiError("Device version fetch failed")}],n=new f.ListInstalledAppsDeviceAction({input:{}});vi.spyOn(n,"extractDependencies").mockImplementation(D),(0,S.testDeviceActionStates)(n,c,(0,V.makeDeviceActionInternalApiMock)(),{onDone:o,onError:s})})),it("should return error when error occurs in fetching firmware version",()=>new Promise((o,s)=>{(0,g.setupGoToDashboardMock)(),d.mockResolvedValue((0,v.CommandResultFactory)({data:{targetId:"123456",secureElementFlags:{isSecureConnectionAllowed:!1}}})),l.mockResolvedValue((0,r.Right)({id:123456})),u.mockResolvedValue((0,r.Left)(new I.HttpFetchApiError("Firmware version fetch failed"))),p.mockReturnValue({sessionStateType:A.DeviceSessionStateType.ReadyWithoutSecureChannel,deviceStatus:h.DeviceStatus.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),m.mockReturnValue((0,i.of)({type:a.SecureChannelEventType.Exchange,payload:{data:new Uint8Array([0,1,2,3])}},{type:a.SecureChannelEventType.Result,payload:[]}));const c=[{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Error,error:new I.HttpFetchApiError("Firmware version fetch failed")}],n=new f.ListInstalledAppsDeviceAction({input:{}});vi.spyOn(n,"extractDependencies").mockImplementation(D),(0,S.testDeviceActionStates)(n,c,(0,V.makeDeviceActionInternalApiMock)(),{onDone:o,onError:s})})),it("should return error when error occurs in communicating with secure channel",()=>new Promise((o,s)=>{(0,g.setupGoToDashboardMock)(),d.mockResolvedValue((0,v.CommandResultFactory)({data:{targetId:"123456",secureElementFlags:{isSecureConnectionAllowed:!1}}})),l.mockResolvedValue((0,r.Right)({id:123456})),u.mockResolvedValue((0,r.Right)({perso:"perso_test"})),p.mockReturnValue({sessionStateType:A.DeviceSessionStateType.ReadyWithoutSecureChannel,deviceStatus:h.DeviceStatus.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),m.mockReturnValue((0,i.concat)((0,i.of)({type:a.SecureChannelEventType.Exchange,payload:{data:new Uint8Array([0,1,2,3])}}),(0,i.throwError)(()=>new y.SecureChannelError("Secure channel error"))));const c=[{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Error,error:new y.SecureChannelError("Secure channel error")}],n=new f.ListInstalledAppsDeviceAction({input:{}});vi.spyOn(n,"extractDependencies").mockImplementation(D),(0,S.testDeviceActionStates)(n,c,(0,V.makeDeviceActionInternalApiMock)(),{onDone:o,onError:s})}))});
//# sourceMappingURL=ListInstalledAppsDeviceAction.test.js.map

"use strict";var S=Object.create;var f=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var E=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty;var A=(e,i,d,r)=>{if(i&&typeof i=="object"||typeof i=="function")for(let c of C(i))!k.call(e,c)&&c!==d&&f(e,c,{get:()=>i[c],enumerable:!(r=w(i,c))||r.enumerable});return e};var T=(e,i,d)=>(d=e!=null?S(E(e)):{},A(i||!e||!e.__esModule?f(d,"default",{value:e,enumerable:!0}):d,e));var v=T(require("isomorphic-ws")),u=require("purify-ts"),n=require("vitest"),x=require("../../secure-channel/task/types"),p=require("../../../internal/secure-channel/model/Errors"),b=require("./ConnectToSecureChannelTask");n.vi.mock("isomorphic-ws",()=>({...n.vi.importActual("isomorphic-ws"),__esModule:!0,default:class{onopen=null;onmessage=null;send=n.vi.fn();close=n.vi.fn();url;constructor(e){this.url=e}}}));const m=5;(0,n.describe)("ConnectToSecureChannelTask",()=>{let e,i,d,r;const c=n.vi.fn(),l={uuid:"5b776c8d-8af2-48c0-8250-04edca2ef5e9",session:"39ce749e-00a4-4c31-a697-1dc1a29e2cab",query:"success",nonce:15};beforeEach(()=>{e=new v.default("wss://test-host.com"),i={sendApdu:c,disableRefresher:t=>n.vi.fn()},d={connection:(0,u.Right)(e)},r=new b.ConnectToSecureChannelTask(i,d)}),afterEach(()=>{n.vi.resetAllMocks()}),(0,n.it)("should emit Opened event on WebSocket open",async()=>{const t=[];r.run().subscribe(s=>t.push(s)),expect(e.onopen).toBeDefined(),e.onopen({type:"open",target:{}}),await new Promise(s=>setTimeout(s,m)),expect(t).toStrictEqual([{type:x.SecureChannelEventType.Opened}])}),(0,n.it)("Error on wrongly formatted message",async()=>{const t=[];r.run().subscribe({next:s=>{t.push(s)}}),expect(e.onmessage).toBeDefined(),e.onmessage({data:"invalidData",type:"",target:{}}),await new Promise(s=>setTimeout(s,m)),expect(t).toStrictEqual([{type:x.SecureChannelEventType.Error,error:new p.SecureChannelError({url:"wss://test-host.com",errorMessage:"Invalid message received: invalidData"})}])}),(0,n.it)("should handle incoming EXCHANGE message including requesting user permission",async()=>{c.mockResolvedValue((0,u.Right)({data:new Uint8Array([144,0]),statusCode:new Uint8Array([144,0])}));const t=n.vi.spyOn(e,"send");n.vi.spyOn(r,"isSecureConnectionAllowed").mockReturnValueOnce(!1);const a=[];r.run().subscribe({next:o=>{a.push(o)}}),expect(e.onmessage).toBeDefined(),e.onmessage({data:JSON.stringify({...l,query:"exchange",nonce:1,data:"e051000000"}),type:"",target:{}}),await new Promise(o=>setTimeout(o,m)),expect(t).toHaveBeenCalledExactlyOnceWith(JSON.stringify({nonce:1,response:"success",data:"9000"})),expect(a).toStrictEqual([{type:x.SecureChannelEventType.PreExchange,payload:{nonce:1,apdu:new Uint8Array([224,81,0,0,0])}},{type:x.SecureChannelEventType.PermissionRequested},{type:x.SecureChannelEventType.Exchange,payload:{nonce:1,apdu:new Uint8Array([224,81,0,0,0]),data:new Uint8Array([144,0]),status:new Uint8Array([144,0])}},{type:x.SecureChannelEventType.PermissionGranted}])}),(0,n.it)("should capture and emit device ID on first GetCertificate APDU",async()=>{const t=new Uint8Array([7,74,7,161,82,230,187,193,65,4,28,116,122,78,8,27,92,30,208,39,252,175,128,218,218,31,132,252,142,67,96,203,83,196,182,158,99,203,145,183,202,211,21,99,104,89,27,251,5,143,114,15,151,175,196,115,249,120,85,251,150,228,84,212,128,24,22,0,52,159,216,220,18,81,70,48,68,2,32,126,60,221,29,21,8,246,141,22,99,74,58,30,225,151,196,80,201,23,101,229,226,72,36,23,178,94,227,160,25,129,200,2,32,89,121,93,9,41,199,216,75,173,173,229,5,14,59,33,25,125,170,255,163,41,234,7,213,180,41,28,166,233,42,114,217]);c.mockResolvedValue((0,u.Right)({data:t,statusCode:new Uint8Array([144,0])}));const a=new Uint8Array([170,187,204,221]),s={sha3_256:n.vi.fn().mockReturnValue(a)},o=new b.ConnectToSecureChannelTask(i,{connection:(0,u.Right)(e),cryptoService:s}),g=[];o.run().subscribe({next:y=>{g.push(y)}}),expect(e.onmessage).toBeDefined(),e.onmessage({data:JSON.stringify({...l,query:"exchange",nonce:1,data:"e052000000"}),type:"",target:{}}),await new Promise(y=>setTimeout(y,m)),expect(s.sha3_256).toHaveBeenCalledWith(Uint8Array.from([4,28,116,122,78,8,27,92,30,208,39,252,175,128,218,218,31,132,252,142,67,96,203,83,196,182,158,99,203,145,183,202,211,21,99,104,89,27,251,5,143,114,15,151,175,196,115,249,120,85,251,150,228,84,212,128,24,22,0,52,159,216,220,18,81]));const h=g.find(y=>y.type===x.SecureChannelEventType.DeviceId);expect(h).toBeDefined(),expect(h?.payload?.deviceId).toBe(a)}),(0,n.it)("should handle incoming EXCHANGE message with a device error",async()=>{c.mockResolvedValue((0,u.Right)({data:new Uint8Array([]),statusCode:new Uint8Array([85,21])}));const t=n.vi.spyOn(e,"send"),a=[];r.run().subscribe({next:o=>{a.push(o)}}),expect(e.onmessage).toBeDefined(),e.onmessage({data:JSON.stringify({...l,query:"exchange",nonce:1,data:"e053000000"}),type:"",target:{}}),await new Promise(o=>setTimeout(o,m)),expect(t).toHaveBeenCalledExactlyOnceWith(JSON.stringify({nonce:1,response:"error",data:""})),expect(a).toStrictEqual([{type:x.SecureChannelEventType.PreExchange,payload:{nonce:1,apdu:new Uint8Array([224,83,0,0,0])}},{type:x.SecureChannelEventType.Error,error:new p.SecureChannelError({url:"wss://test-host.com",errorMessage:"Device is locked"},p.SecureChannelErrorType.DeviceLocked)}])}),(0,n.it)("should handle incoming BULK message",async()=>{c.mockResolvedValue((0,u.Right)({data:new Uint8Array([144,0]),statusCode:new Uint8Array([144,0])}));const t=n.vi.fn(),a=r.run(),s=[];a.subscribe({next:o=>{s.push(o)},complete:()=>t()}),expect(e.onmessage).toBeDefined(),e.onmessage({data:JSON.stringify({...l,query:"bulk",nonce:1,data:["0000000100","0000000200","0000000300"]}),type:"",target:{}}),await new Promise(o=>setTimeout(o,m)),expect(c).toHaveBeenCalledTimes(3),expect(s).toStrictEqual([{type:x.SecureChannelEventType.Progress,payload:{progress:.33,index:0,total:3}},{type:x.SecureChannelEventType.Progress,payload:{progress:.67,index:1,total:3}},{type:x.SecureChannelEventType.Progress,payload:{progress:1,index:2,total:3}}]),expect(t).toHaveBeenCalledOnce()}),(0,n.it)("should handle incoming BULK message with a device error",async()=>{c.mockResolvedValue((0,u.Right)({data:new Uint8Array([]),statusCode:new Uint8Array([85,1])}));const t=n.vi.fn(),a=r.run(),s=[];a.subscribe({next:o=>{s.push(o)},complete:()=>t()}),expect(e.onmessage).toBeDefined(),e.onmessage({data:JSON.stringify({...l,query:"bulk",nonce:1,data:["0000000100","0000000200","0000000300"]}),type:"",target:{}}),await new Promise(o=>setTimeout(o,m)),expect(c).toHaveBeenCalledTimes(1),expect(s).toStrictEqual([{type:x.SecureChannelEventType.Error,error:new p.SecureChannelError({url:"wss://test-host.com",errorMessage:"User refused on the device"},p.SecureChannelErrorType.RefusedByUser)}]),expect(t).toHaveBeenCalledOnce()}),(0,n.it)("should handle incoming SUCCESS message",()=>{const t=n.vi.fn(),a=[];r.run().subscribe({next:o=>a.push(o),complete:()=>t()}),e.onmessage({data:JSON.stringify({...l,query:"success",nonce:1,result:"success result"}),type:"",target:{}}),expect(a).toStrictEqual([{type:x.SecureChannelEventType.Result,payload:"success result"}]),expect(t).toHaveBeenCalledOnce()}),(0,n.it)("should handle incoming WARNING message",()=>{const t=[];r.run().subscribe({next:s=>t.push(s)}),expect(e.onmessage).toBeDefined(),e.onmessage({data:JSON.stringify({...l,query:"warning",nonce:1,data:"warning message"}),type:"",target:{}}),expect(t).toStrictEqual([{type:x.SecureChannelEventType.Warning,payload:{message:"warning message"}}])}),(0,n.it)("should handle incoming ERROR message",()=>{const t=[];r.run().subscribe({next:s=>t.push(s)}),expect(e.onmessage).toBeDefined(),e.onmessage({data:JSON.stringify({...l,query:"error",data:"My error"}),type:"",target:{}}),expect(t).toStrictEqual([{type:x.SecureChannelEventType.Error,error:new p.SecureChannelError({url:"wss://test-host.com",errorMessage:"My error"})}])})});
//# sourceMappingURL=ConnectToSecureChannelTask.test.js.map

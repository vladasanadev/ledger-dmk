"use strict";var i=require("purify-ts"),o=require("rxjs"),v=require("../../../command/model/CommandResult"),g=require("../../../device/DeviceStatus"),h=require("../../../device-action/__test-utils__/makeInternalApi"),V=require("../../../device-action/__test-utils__/setupTestMachine"),S=require("../../../device-action/__test-utils__/testDeviceActionStates"),e=require("../../../device-action/model/DeviceActionState"),n=require("../../../device-action/model/UserInteractionRequired"),k=require("../../../device-session/DeviceSessionState"),r=require("../../../secure-channel/task/types"),y=require("../../../../internal/manager-api/model/Errors"),C=require("../../../../internal/secure-channel/model/Errors"),f=require("./GenuineCheckDeviceAction");vi.mock("@api/device-action/os/GoToDashboard/GoToDashboardDeviceAction");describe("GenuineCheckDeviceAction",()=>{const u=vi.fn(),d=vi.fn(),l=vi.fn(),m=vi.fn(),p=vi.fn(),w=vi.fn(),D=()=>({getOsVersion:u,getDeviceVersion:d,getFirmwareVersion:l,genuineCheck:m,getDeviceSessionState:p,setDeviceSessionState:w});beforeEach(()=>{vi.resetAllMocks()}),it("should return the result of the genuine check",()=>new Promise((a,s)=>{(0,V.setupGoToDashboardMock)(),u.mockResolvedValue((0,v.CommandResultFactory)({data:{targetId:"123456",secureElementFlags:{isSecureConnectionAllowed:!1}}})),d.mockResolvedValue((0,i.Right)({id:123456})),l.mockResolvedValue((0,i.Right)({perso:"perso_test"})),p.mockReturnValue({sessionStateType:k.DeviceSessionStateType.ReadyWithoutSecureChannel,deviceStatus:g.DeviceStatus.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),m.mockReturnValue((0,o.of)({type:r.SecureChannelEventType.Exchange,payload:{data:new Uint8Array([0,1,2,3])}},{type:r.SecureChannelEventType.PermissionRequested},{type:r.SecureChannelEventType.PermissionGranted},{type:r.SecureChannelEventType.Result,payload:"0000"}));const c=[{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.AllowSecureConnection}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Completed,output:{isGenuine:!0}}],t=new f.GenuineCheckDeviceAction({input:{}});vi.spyOn(t,"extractDependencies").mockImplementation(D),(0,S.testDeviceActionStates)(t,c,(0,h.makeDeviceActionInternalApiMock)(),{onDone:a,onError:s})})),it("should return error when error occurs in fetching device version",()=>new Promise((a,s)=>{(0,V.setupGoToDashboardMock)(),u.mockResolvedValue((0,v.CommandResultFactory)({data:{targetId:"123456",secureElementFlags:{isSecureConnectionAllowed:!1}}})),d.mockResolvedValue((0,i.Left)(new y.HttpFetchApiError("Device version fetch failed"))),l.mockResolvedValue((0,i.Right)({perso:"perso_test"})),p.mockReturnValue({sessionStateType:k.DeviceSessionStateType.ReadyWithoutSecureChannel,deviceStatus:g.DeviceStatus.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),m.mockReturnValue((0,o.of)({type:r.SecureChannelEventType.Exchange,payload:{data:new Uint8Array([0,1,2,3])}},{type:r.SecureChannelEventType.Result,payload:"0000"}));const c=[{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Error,error:new y.HttpFetchApiError("Device version fetch failed")}],t=new f.GenuineCheckDeviceAction({input:{}});vi.spyOn(t,"extractDependencies").mockImplementation(D),(0,S.testDeviceActionStates)(t,c,(0,h.makeDeviceActionInternalApiMock)(),{onDone:a,onError:s})})),it("should return error when error occurs in fetching firmware version",()=>new Promise((a,s)=>{(0,V.setupGoToDashboardMock)(),u.mockResolvedValue((0,v.CommandResultFactory)({data:{targetId:"123456",secureElementFlags:{isSecureConnectionAllowed:!1}}})),d.mockResolvedValue((0,i.Right)({id:123456})),l.mockResolvedValue((0,i.Left)(new y.HttpFetchApiError("Firmware version fetch failed"))),p.mockReturnValue({sessionStateType:k.DeviceSessionStateType.ReadyWithoutSecureChannel,deviceStatus:g.DeviceStatus.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),m.mockReturnValue((0,o.of)({type:r.SecureChannelEventType.Exchange,payload:{data:new Uint8Array([0,1,2,3])}},{type:r.SecureChannelEventType.Result,payload:"0000"}));const c=[{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Error,error:new y.HttpFetchApiError("Firmware version fetch failed")}],t=new f.GenuineCheckDeviceAction({input:{}});vi.spyOn(t,"extractDependencies").mockImplementation(D),(0,S.testDeviceActionStates)(t,c,(0,h.makeDeviceActionInternalApiMock)(),{onDone:a,onError:s})})),it("should return error when error occurs in communicating with secure channel",()=>new Promise((a,s)=>{(0,V.setupGoToDashboardMock)(),u.mockResolvedValue((0,v.CommandResultFactory)({data:{targetId:"123456",secureElementFlags:{isSecureConnectionAllowed:!1}}})),d.mockResolvedValue((0,i.Right)({id:123456})),l.mockResolvedValue((0,i.Right)({perso:"perso_test"})),p.mockReturnValue({sessionStateType:k.DeviceSessionStateType.ReadyWithoutSecureChannel,deviceStatus:g.DeviceStatus.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),m.mockReturnValue((0,o.concat)((0,o.of)({type:r.SecureChannelEventType.Exchange,payload:{data:new Uint8Array([0,1,2,3])}}),(0,o.throwError)(()=>new C.SecureChannelError("Secure channel error"))));const c=[{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:n.UserInteractionRequired.None}},{status:e.DeviceActionStatus.Error,error:new C.SecureChannelError("Secure channel error")}],t=new f.GenuineCheckDeviceAction({input:{}});vi.spyOn(t,"extractDependencies").mockImplementation(D),(0,S.testDeviceActionStates)(t,c,(0,h.makeDeviceActionInternalApiMock)(),{onDone:a,onError:s})}))});
//# sourceMappingURL=GenuineCheckDeviceAction.test.js.map

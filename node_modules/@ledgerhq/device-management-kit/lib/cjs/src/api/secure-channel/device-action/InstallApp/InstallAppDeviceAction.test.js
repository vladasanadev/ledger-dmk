"use strict";var g=require("purify-ts"),v=require("rxjs"),A=require("../../../command/model/CommandResult"),P=require("../../../device/DeviceStatus"),a=require("../../../device-action/__test-utils__/makeInternalApi"),r=require("../../../device-action/__test-utils__/setupTestMachine"),p=require("../../../device-action/__test-utils__/testDeviceActionStates"),e=require("../../../device-action/model/DeviceActionState"),t=require("../../../device-action/model/UserInteractionRequired"),S=require("../../../device-action/os/Errors"),f=require("../../../device-session/DeviceSessionState"),I=require("../../../secure-channel/task/types"),N=require("../../../../internal/secure-channel/model/Errors"),c=require("./InstallAppDeviceAction");vi.mock("@api/secure-channel/device-action/ListInstalledApps/ListInstalledAppsDeviceAction");vi.mock("@api/device-action/os/GoToDashboard/GoToDashboardDeviceAction");describe("InstallAppDeviceAction",()=>{const l=vi.fn(),u=vi.fn(),V=vi.fn(),d=vi.fn(),h=vi.fn(),m=()=>({getOsVersion:l,getAppList:u,installApp:V,getDeviceSessionState:d,setDeviceSessionState:h});beforeEach(()=>{vi.resetAllMocks()}),it("should finish successfully when the app is already installed on the device",()=>new Promise((s,i)=>{(0,r.setupListInstalledAppsMock)([{installedApps:[{name:"Bitcoin"}]}]);const o=[{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Completed,output:void 0}],n=new c.InstallAppDeviceAction({input:{appName:"Bitcoin"}});vi.spyOn(n,"extractDependencies").mockImplementation(m),(0,p.testDeviceActionStates)(n,o,(0,a.makeDeviceActionInternalApiMock)(),{onDone:s,onError:i})})),it("should finish successfully when the app is not installed",()=>new Promise((s,i)=>{(0,r.setupListInstalledAppsMock)([{installedApps:[]},{installedApps:[{name:"Bitcoin"}]}]),(0,r.setupGoToDashboardMock)(),l.mockResolvedValue((0,A.CommandResultFactory)({data:{targetId:12345678,secureElementFlags:{isSecureConnectionAllowed:!0}}})),d.mockReturnValue({sessionStateType:f.DeviceSessionStateType.ReadyWithoutSecureChannel,deviceStatus:P.DeviceStatus.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),u.mockResolvedValue((0,g.Right)([{versionName:"Bitcoin",perso:"test_perso",firmware:"test_firmware_for_bitcoin",firmwareKey:"test_firmware_key_for_bitcoin",hash:"test_hash_for_bitcoin"}])),V.mockImplementation(()=>(0,v.of)({type:I.SecureChannelEventType.Progress,payload:{progress:0}},{type:I.SecureChannelEventType.Progress,payload:{progress:.55}},{type:I.SecureChannelEventType.Progress,payload:{progress:1}}));const o=[{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:.55}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:1}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:1}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:1}},{status:e.DeviceActionStatus.Completed,output:void 0}],n=new c.InstallAppDeviceAction({input:{appName:"Bitcoin"}});vi.spyOn(n,"extractDependencies").mockImplementation(m),(0,p.testDeviceActionStates)(n,o,(0,a.makeDeviceActionInternalApiMock)(),{onDone:s,onError:i})})),it("should finish unsuccessfully when the dep app is not installed",()=>new Promise((s,i)=>{(0,r.setupListInstalledAppsMock)([{installedApps:[]}]),(0,r.setupGoToDashboardMock)(),l.mockResolvedValue((0,A.CommandResultFactory)({data:{targetId:12345678,secureElementFlags:{isSecureConnectionAllowed:!0}}})),d.mockReturnValue({sessionStateType:f.DeviceSessionStateType.ReadyWithoutSecureChannel,deviceStatus:P.DeviceStatus.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),u.mockResolvedValue((0,g.Right)([{versionName:"Bitcoin",parentName:"test_parent"}]));const o=[{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Error,error:new S.UnknownDAError("Dep app is not installed on the device")}],n=new c.InstallAppDeviceAction({input:{appName:"Bitcoin"}});vi.spyOn(n,"extractDependencies").mockImplementation(m),(0,p.testDeviceActionStates)(n,o,(0,a.makeDeviceActionInternalApiMock)(),{onDone:s,onError:i})})),it("should finish unsuccessfully when the app is not found in manager API",()=>new Promise((s,i)=>{(0,r.setupListInstalledAppsMock)([{installedApps:[]}]),(0,r.setupGoToDashboardMock)(),l.mockResolvedValue((0,A.CommandResultFactory)({data:{targetId:12345678,secureElementFlags:{isSecureConnectionAllowed:!0}}})),d.mockReturnValue({}),u.mockResolvedValueOnce((0,g.Right)([]));const o=[{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Error,error:new S.UnknownDAError("App to install not found in manager API")}],n=new c.InstallAppDeviceAction({input:{appName:"Bitcoin"}});vi.spyOn(n,"extractDependencies").mockImplementation(m),(0,p.testDeviceActionStates)(n,o,(0,a.makeDeviceActionInternalApiMock)(),{onDone:s,onError:i})})),it("should finish unsuccessfully when there is error in installApp",()=>new Promise((s,i)=>{(0,r.setupListInstalledAppsMock)([{installedApps:[]}]),(0,r.setupGoToDashboardMock)(),l.mockResolvedValue((0,A.CommandResultFactory)({data:{targetId:12345678,secureElementFlags:{isSecureConnectionAllowed:!0}}})),d.mockReturnValue({}),u.mockResolvedValueOnce((0,g.Right)([{versionName:"Bitcoin"}])),V.mockReturnValue((0,v.throwError)(()=>new N.SecureChannelError("Install app error in secure channel")));const o=[{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Pending,intermediateValue:{requiredUserInteraction:t.UserInteractionRequired.None,progress:0}},{status:e.DeviceActionStatus.Error,error:new N.SecureChannelError("Install app error in secure channel")}],n=new c.InstallAppDeviceAction({input:{appName:"Bitcoin"}});vi.spyOn(n,"extractDependencies").mockImplementation(m),(0,p.testDeviceActionStates)(n,o,(0,a.makeDeviceActionInternalApiMock)(),{onDone:s,onError:i})}))});
//# sourceMappingURL=InstallAppDeviceAction.test.js.map

{
  "version": 3,
  "sources": ["../../../../../../src/api/command/os/LoadCertificateCommand.ts"],
  "sourcesContent": ["import { type Apdu } from \"@api/apdu/model/Apdu\";\nimport { ApduBuilder, type ApduBuilderArgs } from \"@api/apdu/utils/ApduBuilder\";\nimport { ApduParser } from \"@api/apdu/utils/ApduParser\";\nimport {\n  type CommandResult,\n  CommandResultFactory,\n} from \"@api/command/model/CommandResult\";\nimport {\n  type CommandErrors,\n  isCommandErrorCode,\n} from \"@api/command/utils/CommandErrors\";\nimport { CommandUtils } from \"@api/command/utils/CommandUtils\";\nimport { GlobalCommandErrorHandler } from \"@api/command/utils/GlobalCommandError\";\nimport { type ApduResponse } from \"@api/device-session/ApduResponse\";\nimport { DeviceExchangeError } from \"@api/Error\";\nimport { type Command, type CommandErrorArgs } from \"@api/types\";\n\nexport type LoadCertificateArgs = {\n  readonly keyUsage: number;\n  readonly certificate: Uint8Array;\n};\n\nexport type LoadCertificateErrorCodes =\n  | \"422f\"\n  | \"4230\"\n  | \"4231\"\n  | \"4232\"\n  | \"4233\"\n  | \"4234\"\n  | \"4235\"\n  | \"4236\"\n  | \"4237\"\n  | \"4238\"\n  | \"4239\"\n  | \"422d\"\n  | \"3301\"\n  | \"422e\"\n  | \"5720\"\n  | \"4118\"\n  | \"ffff\";\n\nconst LOAD_CERTIFICATE_ERRORS: CommandErrors<LoadCertificateErrorCodes> = {\n  \"422f\": { message: \"Incorrect structure type\" },\n  \"4230\": { message: \"Incorrect certificate version\" },\n  \"4231\": { message: \"Incorrect certificate validity\" },\n  \"4232\": { message: \"Incorrect certificate validity index\" },\n  \"4233\": { message: \"Unknown signer key ID\" },\n  \"4234\": { message: \"Unknown signature algorithm\" },\n  \"4235\": { message: \"Unknown public key ID\" },\n  \"4236\": { message: \"Unknown public key usage\" },\n  \"4237\": { message: \"Incorrect elliptic curve ID\" },\n  \"4238\": {\n    message: \"Incorrect signature algorithm associated to the public key\",\n  },\n  \"4239\": { message: \"Unknown target device\" },\n  \"422d\": { message: \"Unknown certificate tag\" },\n  \"3301\": { message: \"Failed to hash data\" },\n  \"422e\": {\n    message: \"expected_key_usage doesn't match certificate key usage\",\n  },\n  \"5720\": { message: \"Failed to verify signature\" },\n  \"4118\": {\n    message: \"trusted_name buffer is too small to contain the trusted name\",\n  },\n  ffff: { message: \"Cryptography-related error\" },\n};\n\nexport class LoadCertificateCommandError extends DeviceExchangeError<LoadCertificateErrorCodes> {\n  constructor({\n    message,\n    errorCode,\n  }: CommandErrorArgs<LoadCertificateErrorCodes>) {\n    super({ tag: \"ProvidePkiCertificateCommandError\", message, errorCode });\n  }\n}\n\nexport type LoadCertificateCommandResult = CommandResult<\n  void,\n  LoadCertificateErrorCodes\n>;\n\n/**\n * The command to load a certificate on the device.\n */\nexport class LoadCertificateCommand\n  implements Command<void, LoadCertificateArgs, LoadCertificateErrorCodes>\n{\n  readonly name = \"loadCertificate\";\n  readonly args: LoadCertificateArgs;\n  readonly triggersDisconnection = false;\n\n  constructor(args: LoadCertificateArgs) {\n    this.args = args;\n  }\n\n  getApdu(): Apdu {\n    const providePkiApduArgs: ApduBuilderArgs = {\n      cla: 0xb0,\n      ins: 0x06,\n      p1: this.args.keyUsage,\n      p2: 0x00,\n    };\n    return new ApduBuilder(providePkiApduArgs)\n      .addBufferToData(this.args.certificate)\n      .build();\n  }\n\n  parseResponse(apduResponse: ApduResponse): LoadCertificateCommandResult {\n    if (CommandUtils.isSuccessResponse(apduResponse)) {\n      return CommandResultFactory({\n        data: undefined,\n      });\n    }\n    const parser = new ApduParser(apduResponse);\n    const errorCode = parser.encodeToHexaString(apduResponse.statusCode);\n    if (isCommandErrorCode(errorCode, LOAD_CERTIFICATE_ERRORS)) {\n      return CommandResultFactory({\n        error: new LoadCertificateCommandError({\n          ...LOAD_CERTIFICATE_ERRORS[errorCode],\n          errorCode,\n        }),\n      });\n    }\n    return CommandResultFactory({\n      error: GlobalCommandErrorHandler.handle(apduResponse),\n    });\n  }\n}\n"],
  "mappings": "AACA,OAAS,eAAAA,MAAyC,8BAClD,OAAS,cAAAC,MAAkB,6BAC3B,OAEE,wBAAAC,MACK,mCACP,OAEE,sBAAAC,MACK,mCACP,OAAS,gBAAAC,MAAoB,kCAC7B,OAAS,6BAAAC,MAAiC,wCAE1C,OAAS,uBAAAC,MAA2B,aA2BpC,MAAMC,EAAoE,CACxE,OAAQ,CAAE,QAAS,0BAA2B,EAC9C,KAAQ,CAAE,QAAS,+BAAgC,EACnD,KAAQ,CAAE,QAAS,gCAAiC,EACpD,KAAQ,CAAE,QAAS,sCAAuC,EAC1D,KAAQ,CAAE,QAAS,uBAAwB,EAC3C,KAAQ,CAAE,QAAS,6BAA8B,EACjD,KAAQ,CAAE,QAAS,uBAAwB,EAC3C,KAAQ,CAAE,QAAS,0BAA2B,EAC9C,KAAQ,CAAE,QAAS,6BAA8B,EACjD,KAAQ,CACN,QAAS,4DACX,EACA,KAAQ,CAAE,QAAS,uBAAwB,EAC3C,OAAQ,CAAE,QAAS,yBAA0B,EAC7C,KAAQ,CAAE,QAAS,qBAAsB,EACzC,OAAQ,CACN,QAAS,wDACX,EACA,KAAQ,CAAE,QAAS,4BAA6B,EAChD,KAAQ,CACN,QAAS,8DACX,EACA,KAAM,CAAE,QAAS,4BAA6B,CAChD,EAEO,MAAMC,UAAoCF,CAA+C,CAC9F,YAAY,CACV,QAAAG,EACA,UAAAC,CACF,EAAgD,CAC9C,MAAM,CAAE,IAAK,oCAAqC,QAAAD,EAAS,UAAAC,CAAU,CAAC,CACxE,CACF,CAUO,MAAMC,CAEb,CACW,KAAO,kBACP,KACA,sBAAwB,GAEjC,YAAYC,EAA2B,CACrC,KAAK,KAAOA,CACd,CAEA,SAAgB,CACd,MAAMC,EAAsC,CAC1C,IAAK,IACL,IAAK,EACL,GAAI,KAAK,KAAK,SACd,GAAI,CACN,EACA,OAAO,IAAIb,EAAYa,CAAkB,EACtC,gBAAgB,KAAK,KAAK,WAAW,EACrC,MAAM,CACX,CAEA,cAAcC,EAA0D,CACtE,GAAIV,EAAa,kBAAkBU,CAAY,EAC7C,OAAOZ,EAAqB,CAC1B,KAAM,MACR,CAAC,EAGH,MAAMQ,EADS,IAAIT,EAAWa,CAAY,EACjB,mBAAmBA,EAAa,UAAU,EACnE,OAAIX,EAAmBO,EAAWH,CAAuB,EAChDL,EAAqB,CAC1B,MAAO,IAAIM,EAA4B,CACrC,GAAGD,EAAwBG,CAAS,EACpC,UAAAA,CACF,CAAC,CACH,CAAC,EAEIR,EAAqB,CAC1B,MAAOG,EAA0B,OAAOS,CAAY,CACtD,CAAC,CACH,CACF",
  "names": ["ApduBuilder", "ApduParser", "CommandResultFactory", "isCommandErrorCode", "CommandUtils", "GlobalCommandErrorHandler", "DeviceExchangeError", "LOAD_CERTIFICATE_ERRORS", "LoadCertificateCommandError", "message", "errorCode", "LoadCertificateCommand", "args", "providePkiApduArgs", "apduResponse"]
}

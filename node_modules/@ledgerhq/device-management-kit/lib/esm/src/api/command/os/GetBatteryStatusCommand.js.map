{
  "version": 3,
  "sources": ["../../../../../../src/api/command/os/GetBatteryStatusCommand.ts"],
  "sourcesContent": ["import { type Apdu } from \"@api/apdu/model/Apdu\";\nimport { ApduBuilder, type ApduBuilderArgs } from \"@api/apdu/utils/ApduBuilder\";\nimport { ApduParser } from \"@api/apdu/utils/ApduParser\";\nimport { type Command } from \"@api/command/Command\";\nimport {\n  InvalidBatteryDataError,\n  InvalidBatteryStatusTypeError,\n} from \"@api/command/Errors\";\nimport {\n  type CommandResult,\n  CommandResultFactory,\n} from \"@api/command/model/CommandResult\";\nimport { type ApduResponse } from \"@api/device-session/ApduResponse\";\n\n/**\n * The type of battery information to retrieve.\n */\nexport enum BatteryStatusType {\n  /**\n   * The command response will be the battery percentage.\n   */\n  BATTERY_PERCENTAGE = 0x00,\n  /**\n   * The command response will be the battery voltage in mV.\n   */\n  BATTERY_VOLTAGE = 0x01,\n  /**\n   * The command response will be the battery temperature in degree celsius\n   */\n  BATTERY_TEMPERATURE = 0x02,\n  /**\n   * The command response will be the battery current in mA.\n   */\n  BATTERY_CURRENT = 0x03,\n  /**\n   * The command response will be the battery status (cf. `BatteryStatusFlags`)\n   */\n  BATTERY_FLAGS = 0x04,\n}\n\nexport enum ChargingMode {\n  NONE = 0x00,\n  USB = 0x01,\n  QI = 0x02,\n}\n\nenum FlagMasks {\n  CHARGING = 0x00000001,\n  USB = 0x00000002,\n  USB_POWERED = 0x00000008,\n  BLE = 0x00000004,\n  ISSUE_BATTERY = 0x00000080,\n  ISSUE_CHARGING = 0x00000010,\n  ISSUE_TEMPERATURE = 0x00000020,\n}\n\nexport type BatteryStatusFlags = {\n  readonly charging: ChargingMode;\n  readonly issueCharging: boolean;\n  readonly issueTemperature: boolean;\n  readonly issueBattery: boolean;\n};\n\n/**\n * The response type depends on the `statusType` parameter sent with the command,\n * cf. `BatteryStatusType`.\n */\nexport type GetBatteryStatusResponse = number | BatteryStatusFlags;\n\nexport type GetBatteryStatusArgs = {\n  readonly statusType: BatteryStatusType;\n};\n\n/**\n * Command to get the battery status of the device.\n * The parameter statusType defines the type of information to retrieve, cf.\n * `BatteryStatusType`.\n *\n * WARNING: this command should not be sent within a logic of polling as it is\n * going to decrease the overall performance of the communication with the device.\n */\nexport class GetBatteryStatusCommand\n  implements Command<GetBatteryStatusResponse, GetBatteryStatusArgs>\n{\n  readonly name = \"getBatteryStatus\";\n  readonly args: GetBatteryStatusArgs;\n\n  constructor(args: GetBatteryStatusArgs) {\n    this.args = args;\n  }\n\n  getApdu(): Apdu {\n    const getBatteryStatusArgs: ApduBuilderArgs = {\n      cla: 0xe0,\n      ins: 0x10,\n      p1: 0x00,\n      p2: this.args.statusType,\n    };\n    return new ApduBuilder(getBatteryStatusArgs).build();\n  }\n\n  parseResponse(\n    apduResponse: ApduResponse,\n  ): CommandResult<GetBatteryStatusResponse> {\n    const parser = new ApduParser(apduResponse);\n\n    switch (this.args.statusType) {\n      case BatteryStatusType.BATTERY_PERCENTAGE: {\n        const percentage = parser.extract8BitUInt();\n        if (percentage === undefined) {\n          return CommandResultFactory({\n            error: new InvalidBatteryDataError(\"Cannot parse APDU response\"),\n          });\n        }\n        return CommandResultFactory({\n          data: percentage > 100 ? -1 : percentage,\n        });\n      }\n      case BatteryStatusType.BATTERY_VOLTAGE: {\n        const data = parser.extract16BitUInt();\n        if (data === undefined) {\n          return CommandResultFactory({\n            error: new InvalidBatteryDataError(\"Cannot parse APDU response\"),\n          });\n        }\n        return CommandResultFactory({\n          data,\n        });\n      }\n      case BatteryStatusType.BATTERY_TEMPERATURE:\n      case BatteryStatusType.BATTERY_CURRENT: {\n        const data = parser.extract8BitUInt();\n        if (data === undefined) {\n          return CommandResultFactory({\n            error: new InvalidBatteryDataError(\"Cannot parse APDU response\"),\n          });\n        }\n        return CommandResultFactory({\n          data: (data << 24) >> 24,\n        });\n      }\n      case BatteryStatusType.BATTERY_FLAGS: {\n        const flags = parser.extract32BitUInt();\n        if (flags === undefined) {\n          return CommandResultFactory({\n            error: new InvalidBatteryDataError(\"Cannot parse APDU response\"),\n          });\n        }\n        const chargingUSB = !!(flags & FlagMasks.USB_POWERED);\n        const chargingQi = !chargingUSB && !!(flags & FlagMasks.CHARGING);\n        return CommandResultFactory({\n          data: {\n            charging: chargingQi\n              ? ChargingMode.QI\n              : chargingUSB\n                ? ChargingMode.USB\n                : ChargingMode.NONE,\n            issueCharging: !!(flags & FlagMasks.ISSUE_CHARGING),\n            issueTemperature: !!(flags & FlagMasks.ISSUE_TEMPERATURE),\n            issueBattery: !!(flags & FlagMasks.ISSUE_BATTERY),\n          },\n        });\n      }\n      default:\n        return CommandResultFactory({\n          error: new InvalidBatteryStatusTypeError(\n            \"One or some case(s) not covered\",\n          ),\n        });\n    }\n  }\n}\n"],
  "mappings": "AACA,OAAS,eAAAA,MAAyC,8BAClD,OAAS,cAAAC,MAAkB,6BAE3B,OACE,2BAAAC,EACA,iCAAAC,MACK,sBACP,OAEE,wBAAAC,MACK,mCAMA,IAAKC,OAIVA,IAAA,mBAAqB,GAArB,qBAIAA,IAAA,gBAAkB,GAAlB,kBAIAA,IAAA,oBAAsB,GAAtB,sBAIAA,IAAA,gBAAkB,GAAlB,kBAIAA,IAAA,cAAgB,GAAhB,gBApBUA,OAAA,IAuBAC,OACVA,IAAA,KAAO,GAAP,OACAA,IAAA,IAAM,GAAN,MACAA,IAAA,GAAK,GAAL,KAHUA,OAAA,IAyCL,MAAMC,CAEb,CACW,KAAO,mBACP,KAET,YAAYC,EAA4B,CACtC,KAAK,KAAOA,CACd,CAEA,SAAgB,CACd,MAAMC,EAAwC,CAC5C,IAAK,IACL,IAAK,GACL,GAAI,EACJ,GAAI,KAAK,KAAK,UAChB,EACA,OAAO,IAAIC,EAAYD,CAAoB,EAAE,MAAM,CACrD,CAEA,cACEE,EACyC,CACzC,MAAMC,EAAS,IAAIC,EAAWF,CAAY,EAE1C,OAAQ,KAAK,KAAK,WAAY,CAC5B,IAAK,GAAsC,CACzC,MAAMG,EAAaF,EAAO,gBAAgB,EAC1C,OAAIE,IAAe,OACVC,EAAqB,CAC1B,MAAO,IAAIC,EAAwB,4BAA4B,CACjE,CAAC,EAEID,EAAqB,CAC1B,KAAMD,EAAa,IAAM,GAAKA,CAChC,CAAC,CACH,CACA,IAAK,GAAmC,CACtC,MAAMG,EAAOL,EAAO,iBAAiB,EACrC,OAAIK,IAAS,OACJF,EAAqB,CAC1B,MAAO,IAAIC,EAAwB,4BAA4B,CACjE,CAAC,EAEID,EAAqB,CAC1B,KAAAE,CACF,CAAC,CACH,CACA,IAAK,GACL,IAAK,GAAmC,CACtC,MAAMA,EAAOL,EAAO,gBAAgB,EACpC,OAAIK,IAAS,OACJF,EAAqB,CAC1B,MAAO,IAAIC,EAAwB,4BAA4B,CACjE,CAAC,EAEID,EAAqB,CAC1B,KAAOE,GAAQ,IAAO,EACxB,CAAC,CACH,CACA,IAAK,GAAiC,CACpC,MAAMC,EAAQN,EAAO,iBAAiB,EACtC,GAAIM,IAAU,OACZ,OAAOH,EAAqB,CAC1B,MAAO,IAAIC,EAAwB,4BAA4B,CACjE,CAAC,EAEH,MAAMG,EAAc,CAAC,EAAED,EAAQ,GACzBE,EAAa,CAACD,GAAe,CAAC,EAAED,EAAQ,GAC9C,OAAOH,EAAqB,CAC1B,KAAM,CACJ,SAAUK,EACN,EACAD,EACE,EACA,EACN,cAAe,CAAC,EAAED,EAAQ,IAC1B,iBAAkB,CAAC,EAAEA,EAAQ,IAC7B,aAAc,CAAC,EAAEA,EAAQ,IAC3B,CACF,CAAC,CACH,CACA,QACE,OAAOH,EAAqB,CAC1B,MAAO,IAAIM,EACT,iCACF,CACF,CAAC,CACL,CACF,CACF",
  "names": ["ApduBuilder", "ApduParser", "InvalidBatteryDataError", "InvalidBatteryStatusTypeError", "CommandResultFactory", "BatteryStatusType", "ChargingMode", "GetBatteryStatusCommand", "args", "getBatteryStatusArgs", "ApduBuilder", "apduResponse", "parser", "ApduParser", "percentage", "CommandResultFactory", "InvalidBatteryDataError", "data", "flags", "chargingUSB", "chargingQi", "InvalidBatteryStatusTypeError"]
}

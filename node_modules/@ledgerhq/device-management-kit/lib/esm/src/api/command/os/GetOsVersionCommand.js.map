{
  "version": 3,
  "sources": ["../../../../../../src/api/command/os/GetOsVersionCommand.ts"],
  "sourcesContent": ["import { coerce, gte } from \"semver\";\n\nimport { type Apdu } from \"@api/apdu/model/Apdu\";\nimport { ApduBuilder, type ApduBuilderArgs } from \"@api/apdu/utils/ApduBuilder\";\nimport { ApduParser } from \"@api/apdu/utils/ApduParser\";\nimport { type Command } from \"@api/command/Command\";\nimport { InvalidStatusWordError } from \"@api/command/Errors\";\nimport {\n  type CommandResult,\n  CommandResultFactory,\n} from \"@api/command/model/CommandResult\";\nimport { CommandUtils } from \"@api/command/utils/CommandUtils\";\nimport { GlobalCommandErrorHandler } from \"@api/command/utils/GlobalCommandError\";\nimport { DeviceModelId } from \"@api/device/DeviceModel\";\nimport {\n  type DeviceGeneralState,\n  type EndorsementInformation,\n  type OnboardingStatus,\n  type WordsInformation,\n} from \"@api/device/SecureElementFlags\";\nimport { type ApduResponse } from \"@api/device-session/ApduResponse\";\n\nimport { SecureElementFlagsParser } from \"./SecureElementFlagsParser\";\n\n/**\n * Response of the GetOsVersionCommand.\n */\nexport type GetOsVersionResponse = {\n  /**\n   * Indicated if the device is running in bootloader mode.\n   * It can happens during a firmware update process.\n   */\n  readonly isBootloader: boolean;\n\n  /**\n   * Indicated if the device firmware is an OS Updater (OSU).\n   * It can happens during a firmware update process.\n   */\n  readonly isOsu: boolean;\n\n  /**\n   * Target identifier.\n   */\n  readonly targetId: number;\n\n  /**\n   * Target identifier of the secure element.\n   * Not always available when the device is in bootloader mode.\n   */\n  readonly seTargetId: number | undefined;\n\n  /**\n   * Target identifier of the microcontroller unit (MCU).\n   * Only available when the device is in bootloader mode.\n   */\n  readonly mcuTargetId: number | undefined;\n\n  /**\n   * Version of BOLOS on the secure element (SE).\n   * {@link https://developers.ledger.com/docs/device-app/architecture/bolos/hardware-architecture | Hardware Architecture}\n   */\n  readonly seVersion: string;\n\n  /**\n   * Secure element flags.\n   * Used to represent the current state of the secure element.\n   */\n  readonly seFlags: Uint8Array;\n\n  /**\n   * Version of the microcontroller unit (MCU) SEPH, which is the SE-MCU link protocol.\n   * {@link https://developers.ledger.com/docs/device-app/architecture/bolos/hardware-architecture | Hardware Architecture}\n   */\n  readonly mcuSephVersion: string;\n\n  /**\n   * Version of the MCU bootloader.\n   */\n  readonly mcuBootloaderVersion: string;\n\n  /**\n   * Hardware revision version.\n   * Only available for Ledger Nano X in which case it's \"00\" or \"01\".\n   */\n  readonly hwVersion: string;\n\n  /**\n   * Identifier of the installed language pack.\n   * Can be one of:\n   * - \"00\": English\n   * - \"01\": French\n   * - \"02\": Spanish\n   * - \"03\": Portuguese\n   * - \"04\": German\n   * - \"05\": Russian\n   * - \"06\": Turkish\n   */\n  readonly langId: number | undefined;\n\n  /**\n   * State for Ledger Recover. // [SHOULD] Add more information about this field\n   */\n  readonly recoverState: number | undefined;\n\n  /**\n   * The parsed secure element flags.\n   */\n  readonly secureElementFlags: DeviceGeneralState &\n    EndorsementInformation &\n    WordsInformation &\n    OnboardingStatus;\n};\n\nexport type GetOsVersionCommandResult = CommandResult<GetOsVersionResponse>;\n\n/**\n * Command to get information about the device firmware.\n */\nexport class GetOsVersionCommand implements Command<GetOsVersionResponse> {\n  readonly name = \"getOsVersion\";\n  readonly args = undefined;\n\n  getApdu(): Apdu {\n    const getOsVersionApduArgs: ApduBuilderArgs = {\n      cla: 0xe0,\n      ins: 0x01,\n      p1: 0x00,\n      p2: 0x00,\n    };\n    return new ApduBuilder(getOsVersionApduArgs).build();\n  }\n\n  parseResponse(\n    apduResponse: ApduResponse,\n    deviceModelId: DeviceModelId,\n  ): GetOsVersionCommandResult {\n    if (!CommandUtils.isSuccessResponse(apduResponse)) {\n      return CommandResultFactory({\n        error: GlobalCommandErrorHandler.handle(apduResponse),\n      });\n    }\n    const parser = new ApduParser(apduResponse);\n    const targetId = parser.extract32BitUInt();\n    if (targetId === undefined) {\n      return CommandResultFactory({\n        error: new InvalidStatusWordError(\"Missing target ID in OS version\"),\n      });\n    }\n\n    let version = parser.encodeToString(parser.extractFieldLVEncoded());\n    let seFlags = parser.extractFieldLVEncoded() ?? new Uint8Array(0);\n    const seFlagsParser = new SecureElementFlagsParser(seFlags);\n    // This is the parsed secure element flags.\n    const secureElementFlags = { ...seFlagsParser.generalDeviceState() };\n\n    // Handle old firmwares with no version\n    if (!version) {\n      version = \"0.0.0\";\n      seFlags = new Uint8Array();\n    }\n\n    const isBootloader = (targetId & 0xf0000000) !== 0x30000000;\n    const isOsu = version.includes(\"-osu\");\n    let seVersion: string = \"\";\n    let mcuSephVersion: string = \"\";\n    let mcuBootloaderVersion: string = \"\";\n    let hwVersion: string = \"\";\n    let mcuTargetId: number | undefined = undefined;\n    let seTargetId: number | undefined = undefined;\n    let langId: number | undefined = undefined;\n    let recoverState: number | undefined = undefined;\n\n    if (isBootloader) {\n      mcuBootloaderVersion = version;\n      mcuTargetId = targetId;\n\n      const seData = parser.extractFieldLVEncoded();\n      if (seData) {\n        if (seData.length >= 5) {\n          // It means it's a version followed by the seTargetId\n          seVersion = parser.encodeToString(seData);\n          seTargetId = parseInt(\n            parser.encodeToHexaString(parser.extractFieldLVEncoded()),\n            16,\n          );\n        } else {\n          // It's the seTargetId\n          seTargetId = parseInt(parser.encodeToHexaString(seData), 16);\n        }\n      }\n    } else {\n      seVersion = version;\n      seTargetId = targetId;\n\n      mcuSephVersion = parser.encodeToString(parser.extractFieldLVEncoded());\n\n      if (this.isBootloaderVersionSupported(seVersion, deviceModelId)) {\n        mcuBootloaderVersion = parser.encodeToString(\n          parser.extractFieldLVEncoded(),\n        );\n      }\n\n      if (this.isHardwareVersionSupported(seVersion, deviceModelId)) {\n        hwVersion = parser.encodeToHexaString(parser.extractFieldLVEncoded());\n      } else {\n        hwVersion = \"00\";\n      }\n\n      if (this.isLocalizationSupported(seVersion, deviceModelId)) {\n        const langIdBuffer = parser.extractFieldLVEncoded();\n        if (langIdBuffer !== undefined) {\n          langId = parseInt(parser.encodeToHexaString(langIdBuffer), 16);\n        }\n      }\n\n      if (this.isRecoverSupported(seVersion, deviceModelId)) {\n        const recoverStateBuffer = parser.extractFieldLVEncoded();\n        if (recoverStateBuffer !== undefined) {\n          recoverState = parseInt(\n            parser.encodeToHexaString(recoverStateBuffer),\n            16,\n          );\n        }\n      }\n    }\n\n    return CommandResultFactory({\n      data: {\n        isBootloader,\n        isOsu,\n        targetId,\n        seTargetId,\n        mcuTargetId,\n        seVersion,\n        seFlags,\n        mcuSephVersion,\n        mcuBootloaderVersion,\n        hwVersion,\n        langId,\n        recoverState,\n        secureElementFlags,\n      },\n    });\n  }\n\n  private isBootloaderVersionSupported(\n    seVersion: string,\n    deviceModelId: DeviceModelId,\n  ): boolean {\n    const version = coerce(seVersion) ?? \"\";\n    switch (deviceModelId) {\n      case DeviceModelId.NANO_S:\n      case DeviceModelId.NANO_X:\n        return gte(version, \"2.0.0\");\n      default:\n        return true;\n    }\n  }\n\n  private isHardwareVersionSupported(\n    seVersion: string,\n    deviceModelId: DeviceModelId,\n  ): boolean {\n    const version = coerce(seVersion) ?? \"\";\n    switch (deviceModelId) {\n      case DeviceModelId.NANO_X:\n        return gte(version, \"2.0.0\");\n      default:\n        return false;\n    }\n  }\n\n  private isLocalizationSupported(\n    seVersion: string,\n    deviceModelId: DeviceModelId,\n  ): boolean {\n    const version = coerce(seVersion) ?? \"\";\n    switch (deviceModelId) {\n      case DeviceModelId.NANO_S:\n        return false;\n      case DeviceModelId.NANO_SP:\n        return gte(version, \"1.1.0\");\n      case DeviceModelId.NANO_X:\n        return gte(version, \"2.1.0\");\n      default:\n        return true;\n    }\n  }\n\n  private isRecoverSupported(\n    seVersion: string,\n    deviceModelId: DeviceModelId,\n  ): boolean {\n    const version = coerce(seVersion) ?? \"\";\n    switch (deviceModelId) {\n      case DeviceModelId.NANO_S:\n        return false;\n      case DeviceModelId.NANO_SP:\n        return gte(version, \"1.1.2\");\n      case DeviceModelId.NANO_X:\n        return gte(version, \"2.2.3\");\n      case DeviceModelId.STAX:\n        return gte(version, \"1.4.0\");\n      case DeviceModelId.FLEX:\n        return gte(version, \"1.0.1\");\n      default:\n        return true;\n    }\n  }\n}\n"],
  "mappings": "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",
  "names": ["coerce", "gte", "ApduBuilder", "ApduParser", "InvalidStatusWordError", "CommandResultFactory", "CommandUtils", "GlobalCommandErrorHandler", "DeviceModelId", "SecureElementFlagsParser", "GetOsVersionCommand", "getOsVersionApduArgs", "apduResponse", "deviceModelId", "parser", "targetId", "version", "seFlags", "secureElementFlags", "isBootloader", "isOsu", "seVersion", "mcuSephVersion", "mcuBootloaderVersion", "hwVersion", "mcuTargetId", "seTargetId", "langId", "recoverState", "seData", "langIdBuffer", "recoverStateBuffer"]
}

import{coerce as u,gte as s}from"semver";import{ApduBuilder as v}from"../../apdu/utils/ApduBuilder";import{ApduParser as O}from"../../apdu/utils/ApduParser";import{InvalidStatusWordError as b}from"../../command/Errors";import{CommandResultFactory as f}from"../../command/model/CommandResult";import{CommandUtils as F}from"../../command/utils/CommandUtils";import{GlobalCommandErrorHandler as N}from"../../command/utils/GlobalCommandError";import{DeviceModelId as t}from"../../device/DeviceModel";import{SecureElementFlagsParser as E}from"./SecureElementFlagsParser";class P{name="getOsVersion";args=void 0;getApdu(){const r={cla:224,ins:1,p1:0,p2:0};return new v(r).build()}parseResponse(r,n){if(!F.isSuccessResponse(r))return f({error:N.handle(r)});const e=new O(r),d=e.extract32BitUInt();if(d===void 0)return f({error:new b("Missing target ID in OS version")});let a=e.encodeToString(e.extractFieldLVEncoded()),c=e.extractFieldLVEncoded()??new Uint8Array(0);const x={...new E(c).generalDeviceState()};a||(a="0.0.0",c=new Uint8Array);const g=(d&4026531840)!==805306368,I=a.includes("-osu");let i="",S="",m="",p="",y,l,V,A;if(g){m=a,y=d;const o=e.extractFieldLVEncoded();o&&(o.length>=5?(i=e.encodeToString(o),l=parseInt(e.encodeToHexaString(e.extractFieldLVEncoded()),16)):l=parseInt(e.encodeToHexaString(o),16))}else{if(i=a,l=d,S=e.encodeToString(e.extractFieldLVEncoded()),this.isBootloaderVersionSupported(i,n)&&(m=e.encodeToString(e.extractFieldLVEncoded())),this.isHardwareVersionSupported(i,n)?p=e.encodeToHexaString(e.extractFieldLVEncoded()):p="00",this.isLocalizationSupported(i,n)){const o=e.extractFieldLVEncoded();o!==void 0&&(V=parseInt(e.encodeToHexaString(o),16))}if(this.isRecoverSupported(i,n)){const o=e.extractFieldLVEncoded();o!==void 0&&(A=parseInt(e.encodeToHexaString(o),16))}}return f({data:{isBootloader:g,isOsu:I,targetId:d,seTargetId:l,mcuTargetId:y,seVersion:i,seFlags:c,mcuSephVersion:S,mcuBootloaderVersion:m,hwVersion:p,langId:V,recoverState:A,secureElementFlags:x}})}isBootloaderVersionSupported(r,n){const e=u(r)??"";switch(n){case t.NANO_S:case t.NANO_X:return s(e,"2.0.0");default:return!0}}isHardwareVersionSupported(r,n){const e=u(r)??"";switch(n){case t.NANO_X:return s(e,"2.0.0");default:return!1}}isLocalizationSupported(r,n){const e=u(r)??"";switch(n){case t.NANO_S:return!1;case t.NANO_SP:return s(e,"1.1.0");case t.NANO_X:return s(e,"2.1.0");default:return!0}}isRecoverSupported(r,n){const e=u(r)??"";switch(n){case t.NANO_S:return!1;case t.NANO_SP:return s(e,"1.1.2");case t.NANO_X:return s(e,"2.2.3");case t.STAX:return s(e,"1.4.0");case t.FLEX:return s(e,"1.0.1");default:return!0}}}export{P as GetOsVersionCommand};
//# sourceMappingURL=GetOsVersionCommand.js.map

{
  "version": 3,
  "sources": ["../../../../../../src/api/device-action/task/GetApplicationsMetadataTask.ts"],
  "sourcesContent": ["import { gt } from \"semver\";\n\nimport { InvalidStatusWordError } from \"@api/command/Errors\";\nimport {\n  type CommandResult,\n  CommandResultFactory,\n  isSuccessCommandResult,\n} from \"@api/command/model/CommandResult\";\nimport { ListLanguagePackCommand } from \"@api/command/os/ListLanguagePackCommand\";\nimport type { InternalApi } from \"@api/device-action/DeviceAction\";\nimport {\n  type Catalog,\n  type FirmwareVersion,\n  type InstalledLanguagePackage,\n} from \"@api/device-session/DeviceSessionState\";\nimport { type Application } from \"@internal/manager-api/model/Application\";\nimport { type DeviceVersion } from \"@internal/manager-api/model/Device\";\nimport { type FinalFirmware } from \"@internal/manager-api/model/Firmware\";\n\nexport type InstalledApp = {\n  hash: string;\n  hashCode: string;\n  name: string;\n};\n\nexport type GetApplicationsMetadataTaskArgs = {\n  deviceVersion: DeviceVersion;\n  firmware: FinalFirmware;\n  firmwareVersion: FirmwareVersion;\n  installedApps: InstalledApp[];\n};\n\nexport type GetApplicationsMetadataTaskResult = CommandResult<{\n  applications: Application[];\n  applicationsUpdates: Application[];\n  installedLanguages: InstalledLanguagePackage[];\n  catalog: Catalog;\n}>;\n\nconst ZERO_HASH =\n  \"0000000000000000000000000000000000000000000000000000000000000000\";\n\nexport class GetApplicationsMetadataTask {\n  constructor(\n    private readonly api: InternalApi,\n    private readonly args: GetApplicationsMetadataTaskArgs,\n  ) {}\n\n  async run(): Promise<GetApplicationsMetadataTaskResult> {\n    // Get applications metadata\n    const installedApps = this.args.installedApps.filter((app) =>\n      this.isApplication(app),\n    );\n    const manager = this.api.getManagerApiService();\n    const appHashes = installedApps.map((app) => app.hash);\n    const result = await manager\n      .getAppsByHash(appHashes)\n      .chain((applications) =>\n        manager\n          .getAppList(this.args.firmwareVersion.metadata!)\n          .map((catalog) => ({ applications, catalog })),\n      );\n    if (result.isLeft()) {\n      return CommandResultFactory({\n        error: new InvalidStatusWordError(\"Cannot get the application catalog\"),\n      });\n    }\n    const { applications, catalog } = result.unsafeCoerce();\n\n    // Complete applications metadata using the catalog if needed\n    const appsWithMetadata = applications.reduce((apps, app, index) => {\n      if (app !== null) {\n        // Is the app hash was found in app store, append its metadata\n        return [...apps, app];\n      }\n      // For apps with non-deterministic hash (ie. Security Key, sideloaded app, ...),\n      // use metadata of latest version from the catalog\n      const installedApp = installedApps[index]!;\n      const catalogApp = catalog.find(\n        (c) => c.versionName === installedApp.name,\n      );\n      return catalogApp ? [...apps, catalogApp] : apps;\n    }, [] as Application[]);\n\n    // Filter apps metadata and catalog\n    const filteredApps = applications.filter((app) => app !== null);\n    const filteredCatalog = filteredApps.reduce((apps, app) => {\n      const catalogApp = catalog.find((c) => c.versionName === app.versionName);\n      if (catalogApp && gt(catalogApp.version, app.version)) {\n        return [...apps, catalogApp];\n      }\n      return apps;\n    }, [] as Application[]);\n\n    // Get install language packages\n    let installedLanguages: InstalledLanguagePackage[] = [];\n    for (let i = 0; ; i++) {\n      const language = await this.api.sendCommand(\n        new ListLanguagePackCommand({ firstChunk: i === 0 }),\n      );\n      if (!isSuccessCommandResult(language) || language.data === undefined) {\n        break;\n      }\n      installedLanguages = [...installedLanguages, language.data];\n    }\n\n    // Get all the available language packs for the device\n    const languages = await manager.getLanguagePackages(\n      this.args.deviceVersion,\n      this.args.firmware,\n    );\n    if (languages.isRight()) {\n      // Return the application metadata\n      return CommandResultFactory({\n        data: {\n          applications: appsWithMetadata,\n          applicationsUpdates: filteredCatalog,\n          installedLanguages,\n          catalog: {\n            applications: catalog,\n            languagePackages: languages.extract(),\n          },\n        },\n      });\n    } else {\n      return CommandResultFactory({\n        error: new InvalidStatusWordError(\"Cannot get the languages catalog\"),\n      });\n    }\n  }\n\n  private isApplication(app: InstalledApp): boolean {\n    // Applications with no \"code\" hash are not real applications\n    // (typically a language package).\n    return app.hashCode !== ZERO_HASH;\n  }\n}\n"],
  "mappings": "AAAA,OAAS,MAAAA,MAAU,SAEnB,OAAS,0BAAAC,MAA8B,sBACvC,OAEE,wBAAAC,EACA,0BAAAC,MACK,mCACP,OAAS,2BAAAC,MAA+B,0CA+BxC,MAAMC,EACJ,mEAEK,MAAMC,CAA4B,CACvC,YACmBC,EACAC,EACjB,CAFiB,SAAAD,EACA,UAAAC,CAChB,CAEH,MAAM,KAAkD,CAEtD,MAAMC,EAAgB,KAAK,KAAK,cAAc,OAAQC,GACpD,KAAK,cAAcA,CAAG,CACxB,EACMC,EAAU,KAAK,IAAI,qBAAqB,EACxCC,EAAYH,EAAc,IAAKC,GAAQA,EAAI,IAAI,EAC/CG,EAAS,MAAMF,EAClB,cAAcC,CAAS,EACvB,MAAOE,GACNH,EACG,WAAW,KAAK,KAAK,gBAAgB,QAAS,EAC9C,IAAKI,IAAa,CAAE,aAAAD,EAAc,QAAAC,CAAQ,EAAE,CACjD,EACF,GAAIF,EAAO,OAAO,EAChB,OAAOX,EAAqB,CAC1B,MAAO,IAAID,EAAuB,oCAAoC,CACxE,CAAC,EAEH,KAAM,CAAE,aAAAa,EAAc,QAAAC,CAAQ,EAAIF,EAAO,aAAa,EAGhDG,EAAmBF,EAAa,OAAO,CAACG,EAAMP,EAAKQ,IAAU,CACjE,GAAIR,IAAQ,KAEV,MAAO,CAAC,GAAGO,EAAMP,CAAG,EAItB,MAAMS,EAAeV,EAAcS,CAAK,EAClCE,EAAaL,EAAQ,KACxBM,GAAMA,EAAE,cAAgBF,EAAa,IACxC,EACA,OAAOC,EAAa,CAAC,GAAGH,EAAMG,CAAU,EAAIH,CAC9C,EAAG,CAAC,CAAkB,EAIhBK,EADeR,EAAa,OAAQJ,GAAQA,IAAQ,IAAI,EACzB,OAAO,CAACO,EAAMP,IAAQ,CACzD,MAAMU,EAAaL,EAAQ,KAAMM,GAAMA,EAAE,cAAgBX,EAAI,WAAW,EACxE,OAAIU,GAAcpB,EAAGoB,EAAW,QAASV,EAAI,OAAO,EAC3C,CAAC,GAAGO,EAAMG,CAAU,EAEtBH,CACT,EAAG,CAAC,CAAkB,EAGtB,IAAIM,EAAiD,CAAC,EACtD,QAASC,EAAI,GAAKA,IAAK,CACrB,MAAMC,EAAW,MAAM,KAAK,IAAI,YAC9B,IAAIrB,EAAwB,CAAE,WAAYoB,IAAM,CAAE,CAAC,CACrD,EACA,GAAI,CAACrB,EAAuBsB,CAAQ,GAAKA,EAAS,OAAS,OACzD,MAEFF,EAAqB,CAAC,GAAGA,EAAoBE,EAAS,IAAI,CAC5D,CAGA,MAAMC,EAAY,MAAMf,EAAQ,oBAC9B,KAAK,KAAK,cACV,KAAK,KAAK,QACZ,EACA,OAAIe,EAAU,QAAQ,EAEbxB,EAAqB,CAC1B,KAAM,CACJ,aAAcc,EACd,oBAAqBM,EACrB,mBAAAC,EACA,QAAS,CACP,aAAcR,EACd,iBAAkBW,EAAU,QAAQ,CACtC,CACF,CACF,CAAC,EAEMxB,EAAqB,CAC1B,MAAO,IAAID,EAAuB,kCAAkC,CACtE,CAAC,CAEL,CAEQ,cAAcS,EAA4B,CAGhD,OAAOA,EAAI,WAAaL,CAC1B,CACF",
  "names": ["gt", "InvalidStatusWordError", "CommandResultFactory", "isSuccessCommandResult", "ListLanguagePackCommand", "ZERO_HASH", "GetApplicationsMetadataTask", "api", "args", "installedApps", "app", "manager", "appHashes", "result", "applications", "catalog", "appsWithMetadata", "apps", "index", "installedApp", "catalogApp", "c", "filteredCatalog", "installedLanguages", "i", "language", "languages"]
}

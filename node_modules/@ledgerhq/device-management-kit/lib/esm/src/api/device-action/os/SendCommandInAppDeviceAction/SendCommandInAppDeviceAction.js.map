{
  "version": 3,
  "sources": ["../../../../../../../src/api/device-action/os/SendCommandInAppDeviceAction/SendCommandInAppDeviceAction.ts"],
  "sourcesContent": ["import { Left, Right } from \"purify-ts\";\nimport { assign, fromPromise, setup } from \"xstate\";\n\nimport {\n  type CommandResult,\n  isSuccessCommandResult,\n} from \"@api/command/model/CommandResult\";\nimport { type InternalApi } from \"@api/device-action/DeviceAction\";\nimport { UserInteractionRequired } from \"@api/device-action/model/UserInteractionRequired\";\nimport { UnknownDAError } from \"@api/device-action/os/Errors\";\nimport { OpenAppDeviceAction } from \"@api/device-action/os/OpenAppDeviceAction/OpenAppDeviceAction\";\nimport { type StateMachineTypes } from \"@api/device-action/xstate-utils/StateMachineTypes\";\nimport {\n  type DeviceActionStateMachine,\n  XStateDeviceAction,\n} from \"@api/device-action/xstate-utils/XStateDeviceAction\";\nimport { type Command } from \"@api/types\";\n\nimport {\n  type SendCommandInAppDAError,\n  type SendCommandInAppDAInput,\n  type SendCommandInAppDAIntermediateValue,\n  type SendCommandInAppDAInternalState,\n  type SendCommandInAppDAOutput,\n} from \"./SendCommandInAppDeviceActionTypes\";\n\n/**\n * Tries to open an app on the device, and if it is successful, sends a command\n * to the app.\n * The output will be the result of the command.\n *\n * ```ts\n * input: {\n *  appName: string;\n *  command: Command<CommandResult, CommandArgs>;\n *  requiredUserInteraction: UserInteraction;\n * }\n * ```\n *\n * Example of usage:\n *\n * ```ts\n * const deviceAction = new SendCommandInAppDeviceAction({\n *  input: {\n *   appName: \"MyApp\",\n *   command: new MyAppSpecificCommand({commandSpecificArg: \"foo\"}),\n *   requiredUserInteraction: UserInteractionRequired.None,\n *  },\n * });\n * dmk.executeDeviceAction({ sessionId: \"mySessionId\", deviceAction });\n * ```\n */\nexport class SendCommandInAppDeviceAction<\n  CommandResponse,\n  CommandArgs,\n  CommandErrorCodes,\n  UserInteraction extends UserInteractionRequired,\n> extends XStateDeviceAction<\n  SendCommandInAppDAOutput<CommandResponse>,\n  SendCommandInAppDAInput<\n    CommandResponse,\n    CommandArgs,\n    CommandErrorCodes,\n    UserInteraction\n  >,\n  SendCommandInAppDAError<CommandErrorCodes>,\n  SendCommandInAppDAIntermediateValue<UserInteraction>,\n  SendCommandInAppDAInternalState<CommandResponse, CommandErrorCodes>\n> {\n  makeStateMachine(\n    internalAPI: InternalApi,\n  ): DeviceActionStateMachine<\n    SendCommandInAppDAOutput<CommandResponse>,\n    SendCommandInAppDAInput<\n      CommandResponse,\n      CommandArgs,\n      CommandErrorCodes,\n      UserInteraction\n    >,\n    SendCommandInAppDAError<CommandErrorCodes>,\n    SendCommandInAppDAIntermediateValue<UserInteraction>,\n    SendCommandInAppDAInternalState<CommandResponse, CommandErrorCodes>\n  > {\n    type types = StateMachineTypes<\n      SendCommandInAppDAOutput<CommandResponse>,\n      SendCommandInAppDAInput<\n        CommandResponse,\n        CommandArgs,\n        CommandErrorCodes,\n        UserInteraction\n      >,\n      SendCommandInAppDAError<CommandErrorCodes>,\n      SendCommandInAppDAIntermediateValue<UserInteraction>,\n      SendCommandInAppDAInternalState<CommandResponse, CommandErrorCodes>\n    >;\n\n    const { sendCommand } = this.extractDependencies(internalAPI);\n\n    return setup({\n      types: {\n        input: {} as types[\"input\"],\n        context: {} as types[\"context\"],\n        output: {} as types[\"output\"],\n      },\n      actors: {\n        sendCommand: fromPromise(sendCommand),\n        openAppStateMachine: new OpenAppDeviceAction({\n          input: {\n            appName: this.input.appName,\n          },\n        }).makeStateMachine(internalAPI),\n      },\n      guards: {\n        skipOpenApp: () => this.input.skipOpenApp,\n        noInternalError: ({ context }) => context._internalState.error === null,\n      },\n      actions: {\n        assignErrorFromEvent: assign({\n          _internalState: (_) => ({\n            ..._.context._internalState,\n            error: _.event[\"error\"], // NOTE: it should never happen, the error is not typed anymore here\n          }),\n        }),\n      },\n    }).createMachine({\n      /** @xstate-layout N4IgpgJg5mDOIC5QFEAuALA0mAngJwEsA7KAcTFQEEII85YARMANwIGMxK3UCB7IgHQB5AA5gilESKasOXHvwDEEfmAHFmvANZreYiVIDKqAIaowAWRNt0xMAG0ADAF1EoEb1gEFRNyAAeiACMQQDsAgAcACwAzKEArABMUfGpEQCcEYkANCA4iFGO8QKhjokxERUpQenp8QC+9bloWLiEJORUNHSwjCzsnNx8ggDC6GBsWqLiktL9ckP8AEpwAK4ANqiKTq5IIB5ePn6BCEFR4YkAbKE1Zemh55URufkI8fcC8TGXl0EVoelHJcio1mhhsPhiGQKNRaPQZAN5MMBGMJlN9LMEQsfCtYBstvYgrt3J5vMNjgUQgJLokHlEgldko50rEXoh3uEvj8-hEAUCQU0QC0Ie1oV04b0sYMfAJOrCerARrwALbKkxECDKVTqIiaHQCGDihVK1XqiA7PwHMn8CmnRJBASOFIxKJXJ21GLpHJ5RARGoCEL3CKXDLpS4pCKgoXgtpQuXdeHzaXI+MSxUqtUaxRgPB4Xh4AQidZmABm+eVBphCd6Jsz5pcltJRz2Jyiv0dvIeNJi8UqoWePoQIccn3iId+sSqkajRF4EDgfmFsY6VbTUqRNr2VuboBOAFpLmzTpd0iV+0EkkEylcAVEo0vISujYnZMn+MIMVJ14tfFum+SWwKb1XkSMdIhuQFEidYNSjvQUH1FVMFW-GVUUmaYDDmV8NyIXF8UbQ4AN3X0ogEF17S9eJQhiJ0ojbI8khHc54mvRwGUBXl7xjR8xXlF9ER-WVV2NDMzQI61f2IhBXUdRw5NDX54gvXkjx+CIzxuMdfnKd44LBVoeKQ-jsWRQxVjYDhenEncAmCcMBHKBlqKyIEYivGIjzDGJqQSYMamDa4BX0kU42E4y30EZBc3zayiNshBSmKFjqn7GCMgHV57lIz0aT9P0lL+S5GkaIA */\n      id: \"SendCommandInAppDeviceAction\",\n      initial: \"InitialState\",\n      context: ({ input }) => {\n        return {\n          input: input,\n          intermediateValue: {\n            requiredUserInteraction: UserInteractionRequired.None,\n          },\n          _internalState: {\n            commandResponse: null,\n            error: null,\n          },\n        };\n      },\n      states: {\n        InitialState: {\n          always: [\n            {\n              target: \"SendCommand\",\n              guard: \"skipOpenApp\",\n            },\n            \"OpenAppDeviceAction\",\n          ],\n        },\n        OpenAppDeviceAction: {\n          invoke: {\n            id: \"openAppStateMachine\",\n            input: {\n              appName: this.input.appName,\n            },\n            src: \"openAppStateMachine\",\n            onSnapshot: {\n              actions: assign({\n                intermediateValue: (_) =>\n                  _.event.snapshot.context.intermediateValue,\n              }),\n            },\n            onDone: {\n              actions: assign({\n                _internalState: (_) => {\n                  return _.event.output.caseOf<\n                    SendCommandInAppDAInternalState<\n                      CommandResponse,\n                      CommandErrorCodes\n                    >\n                  >({\n                    Right: () => _.context._internalState,\n                    Left: (error) => ({\n                      ..._.context._internalState,\n                      error,\n                    }),\n                  });\n                },\n              }),\n              target: \"CheckOpenAppDeviceActionResult\",\n            },\n          },\n        },\n        CheckOpenAppDeviceActionResult: {\n          always: [\n            {\n              target: \"SendCommand\",\n              guard: \"noInternalError\",\n            },\n            \"Error\",\n          ],\n        },\n        SendCommand: {\n          entry: assign({\n            intermediateValue: {\n              requiredUserInteraction: this.input.requiredUserInteraction,\n            },\n          }),\n          exit: assign({\n            intermediateValue: {\n              requiredUserInteraction: UserInteractionRequired.None,\n            },\n          }),\n          invoke: {\n            id: \"sendCommand\",\n            src: \"sendCommand\",\n            input: ({ context }) => context.input.command,\n            onDone: {\n              target: \"SendCommandResultCheck\",\n              actions: [\n                assign({\n                  _internalState: ({ event, context }) => {\n                    if (isSuccessCommandResult(event.output)) {\n                      return {\n                        ...context._internalState,\n                        commandResponse: event.output.data,\n                      };\n                    }\n                    return {\n                      ...context._internalState,\n                      error: event.output.error,\n                    };\n                  },\n                }),\n              ],\n            },\n            onError: {\n              target: \"Error\",\n              actions: \"assignErrorFromEvent\",\n            },\n          },\n        },\n        SendCommandResultCheck: {\n          always: [\n            {\n              target: \"Success\",\n              guard: \"noInternalError\",\n            },\n            \"Error\",\n          ],\n        },\n        Success: {\n          type: \"final\",\n        },\n        Error: {\n          type: \"final\",\n        },\n      },\n      output: ({ context }) =>\n        context._internalState.commandResponse\n          ? Right(context._internalState.commandResponse)\n          : Left(\n              context._internalState.error ||\n                new UnknownDAError(\"No error in final state\"),\n            ),\n    });\n  }\n\n  extractDependencies(internalApi: InternalApi) {\n    return {\n      sendCommand: (_: {\n        input: Command<CommandResponse, CommandArgs, CommandErrorCodes>;\n      }): Promise<CommandResult<CommandResponse, CommandErrorCodes>> =>\n        internalApi.sendCommand(_.input),\n    };\n  }\n}\n"],
  "mappings": "AAAA,OAAS,QAAAA,EAAM,SAAAC,MAAa,YAC5B,OAAS,UAAAC,EAAQ,eAAAC,EAAa,SAAAC,MAAa,SAE3C,OAEE,0BAAAC,MACK,mCAEP,OAAS,2BAAAC,MAA+B,mDACxC,OAAS,kBAAAC,MAAsB,+BAC/B,OAAS,uBAAAC,MAA2B,gEAEpC,OAEE,sBAAAC,MACK,qDAqCA,MAAMC,UAKHD,CAWR,CACA,iBACEE,EAYA,CAcA,KAAM,CAAE,YAAAC,CAAY,EAAI,KAAK,oBAAoBD,CAAW,EAE5D,OAAOP,EAAM,CACX,MAAO,CACL,MAAO,CAAC,EACR,QAAS,CAAC,EACV,OAAQ,CAAC,CACX,EACA,OAAQ,CACN,YAAaD,EAAYS,CAAW,EACpC,oBAAqB,IAAIJ,EAAoB,CAC3C,MAAO,CACL,QAAS,KAAK,MAAM,OACtB,CACF,CAAC,EAAE,iBAAiBG,CAAW,CACjC,EACA,OAAQ,CACN,YAAa,IAAM,KAAK,MAAM,YAC9B,gBAAiB,CAAC,CAAE,QAAAE,CAAQ,IAAMA,EAAQ,eAAe,QAAU,IACrE,EACA,QAAS,CACP,qBAAsBX,EAAO,CAC3B,eAAiBY,IAAO,CACtB,GAAGA,EAAE,QAAQ,eACb,MAAOA,EAAE,MAAM,KACjB,EACF,CAAC,CACH,CACF,CAAC,EAAE,cAAc,CAEf,GAAI,+BACJ,QAAS,eACT,QAAS,CAAC,CAAE,MAAAC,CAAM,KACT,CACL,MAAOA,EACP,kBAAmB,CACjB,wBAAyBT,EAAwB,IACnD,EACA,eAAgB,CACd,gBAAiB,KACjB,MAAO,IACT,CACF,GAEF,OAAQ,CACN,aAAc,CACZ,OAAQ,CACN,CACE,OAAQ,cACR,MAAO,aACT,EACA,qBACF,CACF,EACA,oBAAqB,CACnB,OAAQ,CACN,GAAI,sBACJ,MAAO,CACL,QAAS,KAAK,MAAM,OACtB,EACA,IAAK,sBACL,WAAY,CACV,QAASJ,EAAO,CACd,kBAAoBY,GAClBA,EAAE,MAAM,SAAS,QAAQ,iBAC7B,CAAC,CACH,EACA,OAAQ,CACN,QAASZ,EAAO,CACd,eAAiBY,GACRA,EAAE,MAAM,OAAO,OAKpB,CACA,MAAO,IAAMA,EAAE,QAAQ,eACvB,KAAOE,IAAW,CAChB,GAAGF,EAAE,QAAQ,eACb,MAAAE,CACF,EACF,CAAC,CAEL,CAAC,EACD,OAAQ,gCACV,CACF,CACF,EACA,+BAAgC,CAC9B,OAAQ,CACN,CACE,OAAQ,cACR,MAAO,iBACT,EACA,OACF,CACF,EACA,YAAa,CACX,MAAOd,EAAO,CACZ,kBAAmB,CACjB,wBAAyB,KAAK,MAAM,uBACtC,CACF,CAAC,EACD,KAAMA,EAAO,CACX,kBAAmB,CACjB,wBAAyBI,EAAwB,IACnD,CACF,CAAC,EACD,OAAQ,CACN,GAAI,cACJ,IAAK,cACL,MAAO,CAAC,CAAE,QAAAO,CAAQ,IAAMA,EAAQ,MAAM,QACtC,OAAQ,CACN,OAAQ,yBACR,QAAS,CACPX,EAAO,CACL,eAAgB,CAAC,CAAE,MAAAe,EAAO,QAAAJ,CAAQ,IAC5BR,EAAuBY,EAAM,MAAM,EAC9B,CACL,GAAGJ,EAAQ,eACX,gBAAiBI,EAAM,OAAO,IAChC,EAEK,CACL,GAAGJ,EAAQ,eACX,MAAOI,EAAM,OAAO,KACtB,CAEJ,CAAC,CACH,CACF,EACA,QAAS,CACP,OAAQ,QACR,QAAS,sBACX,CACF,CACF,EACA,uBAAwB,CACtB,OAAQ,CACN,CACE,OAAQ,UACR,MAAO,iBACT,EACA,OACF,CACF,EACA,QAAS,CACP,KAAM,OACR,EACA,MAAO,CACL,KAAM,OACR,CACF,EACA,OAAQ,CAAC,CAAE,QAAAJ,CAAQ,IACjBA,EAAQ,eAAe,gBACnBZ,EAAMY,EAAQ,eAAe,eAAe,EAC5Cb,EACEa,EAAQ,eAAe,OACrB,IAAIN,EAAe,yBAAyB,CAChD,CACR,CAAC,CACH,CAEA,oBAAoBW,EAA0B,CAC5C,MAAO,CACL,YAAcJ,GAGZI,EAAY,YAAYJ,EAAE,KAAK,CACnC,CACF,CACF",
  "names": ["Left", "Right", "assign", "fromPromise", "setup", "isSuccessCommandResult", "UserInteractionRequired", "UnknownDAError", "OpenAppDeviceAction", "XStateDeviceAction", "SendCommandInAppDeviceAction", "internalAPI", "sendCommand", "context", "_", "input", "error", "event", "internalApi"]
}

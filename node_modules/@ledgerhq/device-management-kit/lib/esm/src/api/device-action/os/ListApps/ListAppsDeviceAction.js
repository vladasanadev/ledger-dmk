import{Left as u,Right as c}from"purify-ts";import{assign as e,fromPromise as l,setup as A}from"xstate";import{isSuccessCommandResult as i}from"../../../command/model/CommandResult";import{ListAppsCommand as m}from"../../../command/os/ListAppsCommand";import{UserInteractionRequired as a}from"../../../device-action/model/UserInteractionRequired";import{DEFAULT_UNLOCK_TIMEOUT_MS as d}from"../../../device-action/os/Const";import{GoToDashboardDeviceAction as h}from"../../../device-action/os/GoToDashboard/GoToDashboardDeviceAction";import{XStateDeviceAction as D}from"../../../device-action/xstate-utils/XStateDeviceAction";class I extends D{makeStateMachine(n){const{listApps:s}=this.extractDependencies(n),r=this.input.unlockTimeout??d,o=new h({input:{unlockTimeout:r}}).makeStateMachine(n);return A({types:{input:{unlockTimeout:r},context:{},output:{}},actors:{listApps:l(s),goToDashboard:o},guards:{hasError:({context:t})=>t._internalState.error!==null,hasMoreApps:t=>t.context._internalState.shouldContinue},actions:{assignAllowListApps:e({intermediateValue:t=>({requiredUserInteraction:a.AllowListApps})}),assignErrorFromEvent:e({_internalState:t=>({...t.context._internalState,error:t.event.error})})}}).createMachine({id:"ListAppsDeviceAction",initial:"DeviceReady",context:t=>({input:{unlockTimeout:t.input.unlockTimeout},intermediateValue:{requiredUserInteraction:a.None},_internalState:{error:null,apps:[],shouldContinue:!1}}),states:{DeviceReady:{always:{target:"GoToDashboard"}},GoToDashboard:{invoke:{id:"dashboard",src:"goToDashboard",input:t=>({unlockTimeout:t.context.input.unlockTimeout}),onSnapshot:{actions:e({intermediateValue:t=>t.event.snapshot.context.intermediateValue})},onDone:{target:"GoToDashboardCheck",actions:e({_internalState:t=>t.event.output.caseOf({Right:()=>t.context._internalState,Left:p=>({...t.context._internalState,error:p})})})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},GoToDashboardCheck:{always:[{target:"Error",guard:"hasError"},{target:"ListApps"}]},ListApps:{entry:"assignAllowListApps",invoke:{src:"listApps",input:t=>!1,onDone:{target:"Continue",actions:e({_internalState:t=>i(t.event.output)?{...t.context._internalState,apps:t.context._internalState.apps.concat(t.event.output.data),shouldContinue:t.event.output.data.length>=2}:{...t.context._internalState,error:t.event.output.error},intermediateValue:t=>({...t.context.intermediateValue,requiredUserInteraction:a.None})})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},ListAppsCheck:{always:[{target:"Error",guard:"hasError"},"ListAppsContinue"]},ListAppsContinue:{invoke:{src:"listApps",input:t=>!0,onDone:{target:"Continue",actions:e({_internalState:t=>i(t.event.output)?{...t.context._internalState,apps:t.context._internalState.apps.concat(t.event.output.data),shouldContinue:t.event.output.data.length>=2}:{...t.context._internalState,error:t.event.output.error}})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},Continue:{always:[{target:"ListAppsContinue",guard:"hasMoreApps"},{target:"Success"}]},Success:{type:"final"},Error:{type:"final"}},output:t=>t.context._internalState.error?u(t.context._internalState.error):c(t.context._internalState.apps)})}extractDependencies(n){return{listApps:async({input:r})=>{const o=new m({isContinue:r});return n.sendCommand(o)}}}}export{I as ListAppsDeviceAction};
//# sourceMappingURL=ListAppsDeviceAction.js.map

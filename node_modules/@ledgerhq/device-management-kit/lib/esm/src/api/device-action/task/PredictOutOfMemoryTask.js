import{UnknownDAError as d}from"../../device-action/os/Errors";import{DeviceSessionStateType as u}from"../../device-session/DeviceSessionState";class M{constructor(e,t){this.api=e;this.args=t;this.deviceModel=e.getDeviceModel()}deviceModel;run(){const e=this.api.getDeviceSessionState();if(e.sessionStateType===u.Connected)return{error:new d("Invalid device state")};const{firmwareUpdateContext:t,customImage:r,firmwareVersion:o,installedLanguages:n,installedApps:a}=e;if(t===void 0||r===void 0||o===void 0||n===void 0)return{error:new d("Device metadata not fetched")};const{blockSize:i,totalMemoryBlocks:l}=this.getMemoryConstants(o),c=this.getCurrentMemoryBlocksUsage({firmwareUpdateContext:t,customImage:r,installedApps:a,installedLanguages:n,blockSize:i}),m=this.getInstallPlanMemoryBlocksUsage(this.args.installPlan,i);return{outOfMemory:c+m>l}}getMemoryConstants(e){const t=this.deviceModel.getBlockSize({firmwareVersion:e.os}),r=Math.floor(this.deviceModel.memorySize/t);return{blockSize:t,totalMemoryBlocks:r}}getCurrentMemoryBlocksUsage({firmwareUpdateContext:e,customImage:t,installedApps:r,installedLanguages:o,blockSize:n}){const a=s=>Math.ceil(s/n),i=a(e.currentFirmware.bytes||0),l=a(t.size||0),c=r.reduce((s,p)=>s+a(p.bytes||0),0),m=o.reduce((s,p)=>s+a(p.size),0);return i+l+c+m}getInstallPlanMemoryBlocksUsage(e,t){const r=o=>Math.ceil(o/t);return e.reduce((o,n)=>o+r(n.bytes||0),0)}}export{M as PredictOutOfMemoryTask};
//# sourceMappingURL=PredictOutOfMemoryTask.js.map

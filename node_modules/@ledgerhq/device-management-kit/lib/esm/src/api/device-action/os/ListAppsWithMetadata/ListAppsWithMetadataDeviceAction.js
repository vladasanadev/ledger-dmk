import{Left as d,Right as S}from"purify-ts";import{assign as n,fromCallback as M,fromPromise as D,setup as y}from"xstate";import{UserInteractionRequired as u}from"../../../device-action/model/UserInteractionRequired";import{DEFAULT_UNLOCK_TIMEOUT_MS as m}from"../../../device-action/os/Const";import{ListAppsDeviceAction as v}from"../../../device-action/os/ListApps/ListAppsDeviceAction";import{XStateDeviceAction as L}from"../../../device-action/xstate-utils/XStateDeviceAction";class O extends L{makeStateMachine(a){const{getAppsByHash:c,setDeviceSessionState:i,getDeviceSessionState:r}=this.extractDependencies(a),s=this.input.unlockTimeout??m,p=new v({input:{unlockTimeout:s}}).makeStateMachine(a);return y({types:{input:{unlockTimeout:s},context:{},output:{}},actors:{listApps:p,getAppsByHash:D(c),updateDeviceSessionState:M(({input:t,sendBack:e})=>{const{appsWithMetadata:A}=t,h=A.filter(o=>o!==null),l={...r(),installedApps:h};try{i(l),e({type:"done"})}catch(o){e({type:"error",error:o})}})},guards:{hasError:({context:t})=>t._internalState.error!==null,hasNoAppsInstalled:({context:t})=>t._internalState.apps.length===0},actions:{assignErrorFromEvent:n({_internalState:t=>({...t.context._internalState,error:t.event.error})})}}).createMachine({id:"ListAppsWithMetadataDeviceAction",initial:"DeviceReady",context:t=>({input:t.input,_internalState:{error:null,apps:[],appsWithMetadata:[]},intermediateValue:{requiredUserInteraction:u.None}}),states:{DeviceReady:{always:{target:"ListApps"}},ListApps:{invoke:{id:"listApps",src:"listApps",input:t=>({unlockTimeout:t.context.input.unlockTimeout}),onSnapshot:{actions:n({intermediateValue:t=>t.event.snapshot.context.intermediateValue})},onDone:{target:"ListAppsCheck",actions:n({intermediateValue:t=>({requiredUserInteraction:u.None}),_internalState:t=>t.event.output.caseOf({Right:e=>({...t.context._internalState,apps:e}),Left:e=>({...t.context._internalState,error:e})})})}}},ListAppsCheck:{always:[{target:"Error",guard:"hasError"},{target:"Success",guard:"hasNoAppsInstalled",actions:n({_internalState:t=>({...t.context._internalState,appsWithMetadata:[]})})},{target:"FetchMetadata"}]},FetchMetadata:{invoke:{id:"getAppsByHash",src:"getAppsByHash",input:t=>t.context._internalState.apps,onDone:{target:"FetchMetadataCheck",actions:n({_internalState:t=>t.event.output.caseOf({Right:e=>({...t.context._internalState,appsWithMetadata:e}),Left:e=>({...t.context._internalState,error:e})})})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},FetchMetadataCheck:{always:[{target:"Error",guard:"hasError"},{target:"SaveSession"}]},SaveSession:{invoke:{src:"updateDeviceSessionState",input:t=>({appsWithMetadata:t.context._internalState.appsWithMetadata})},on:{done:{target:"Success"},error:{target:"Error",actions:"assignErrorFromEvent"}}},Success:{type:"final"},Error:{type:"final"}},output:t=>t.context._internalState.error?d(t.context._internalState.error):S(t.context._internalState.appsWithMetadata)})}extractDependencies(a){return{getAppsByHash:({input:i})=>{const r=i.reduce((s,p)=>p.appFullHash?s.concat(p.appFullHash):s,[]);return a.getManagerApiService().getAppsByHash(r)},getDeviceSessionState:()=>a.getDeviceSessionState(),setDeviceSessionState:i=>a.setDeviceSessionState(i)}}}export{O as ListAppsWithMetadataDeviceAction};
//# sourceMappingURL=ListAppsWithMetadataDeviceAction.js.map

import{concat as V,of as A,throwError as y}from"rxjs";import{DeviceStatus as D}from"../../../device/DeviceStatus";import{makeDeviceActionInternalApiMock as f}from"../../../device-action/__test-utils__/makeInternalApi";import{setupGoToDashboardMock as I}from"../../../device-action/__test-utils__/setupTestMachine";import{setupGetDeviceMetadataMock as c}from"../../../device-action/__test-utils__/setupTestMachine";import{testDeviceActionStates as d}from"../../../device-action/__test-utils__/testDeviceActionStates";import{DeviceActionStatus as e}from"../../../device-action/model/DeviceActionState";import{UserInteractionRequired as n}from"../../../device-action/model/UserInteractionRequired";import{UnknownDAError as m}from"../../../device-action/os/Errors";import{OutOfMemoryDAError as S}from"../../../device-action/os/Errors";import{DeviceSessionStateType as N}from"../../../device-session/DeviceSessionState";import{SecureChannelEventType as p}from"../../../secure-channel/task/types";import{InstallOrUpdateAppsDeviceAction as P}from"./InstallOrUpdateAppsDeviceAction";vi.mock("@api/device-action/os/GoToDashboard/GoToDashboardDeviceAction");vi.mock("@api/device-action/os/GetDeviceMetadata/GetDeviceMetadataDeviceAction");describe("InstallOrUpdateAppsDeviceAction",()=>{const o=f(),l=vi.fn(),g=vi.fn(),v=vi.fn();function u(){return{buildInstallPlan:l,predictOutOfMemory:g,installApp:v}}beforeEach(()=>{vi.clearAllMocks(),o.getDeviceSessionState.mockReturnValue({sessionStateType:N.Connected,deviceStatus:D.CONNECTED})}),describe("success cases",()=>{it("Install two applications",()=>new Promise((r,i)=>{I(),c({firmwareVersion:{metadata:{targetId:857735172}}});const a=new P({input:{applications:[{name:"Bitcoin"},{name:"Ethereum"},{name:"Solana"},{name:"XRP"},{name:"MyShitCoin"}],allowMissingApplication:!1}}),t={installPlan:[{versionName:"Bitcoin"},{versionName:"XRP"}],alreadyInstalled:["Ethereum","Solana"],missingApplications:["MyShitCoin"]};l.mockResolvedValueOnce(t),g.mockResolvedValueOnce({outOfMemory:!1}),v.mockReturnValueOnce(A({type:p.PermissionRequested},{type:p.PermissionGranted},{type:p.Progress,payload:{progress:.5}},{type:p.Progress,payload:{progress:1}})).mockReturnValueOnce(A({type:p.Progress,payload:{progress:.25}},{type:p.Progress,payload:{progress:.75}},{type:p.Progress,payload:{progress:1}})),vi.spyOn(a,"extractDependencies").mockReturnValue(u());const s=[{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.AllowSecureConnection,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:.5}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:1}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:1}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:1}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:1,currentProgress:.25}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:1,currentProgress:.75}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:1,currentProgress:1}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:1,currentProgress:1}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:1,currentProgress:1}},status:e.Pending},{output:{successfullyInstalled:[{versionName:"Bitcoin"},{versionName:"XRP"}],alreadyInstalled:["Ethereum","Solana"],missingApplications:["MyShitCoin"]},status:e.Completed}];d(a,s,o,{onDone:r,onError:i})})),it("No install is needed",()=>new Promise((r,i)=>{I(),c({firmwareVersion:{metadata:{targetId:857735172}}});const a=new P({input:{applications:[{name:"Bitcoin"},{name:"Ethereum"},{name:"Solana"},{name:"XRP"},{name:"MyShitCoin"}],allowMissingApplication:!1}}),t={installPlan:[],alreadyInstalled:["Ethereum","Solana","Bitcoin","XRP"],missingApplications:["MyShitCoin"]};l.mockResolvedValueOnce(t),vi.spyOn(a,"extractDependencies").mockReturnValue(u());const s=[{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{output:{successfullyInstalled:[],alreadyInstalled:["Ethereum","Solana","Bitcoin","XRP"],missingApplications:["MyShitCoin"]},status:e.Completed}];d(a,s,o,{onDone:r,onError:i})}))}),describe("error cases",()=>{it("Update device metadata failure",()=>new Promise((r,i)=>{c({firmwareVersion:{metadata:{targetId:857735172}}},!0);const a=new P({input:{applications:[{name:"Bitcoin"}],allowMissingApplication:!1}});vi.spyOn(a,"extractDependencies").mockReturnValue(u());const t=[{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{error:new m("GetDeviceMetadata failed"),status:e.Error}];d(a,t,o,{onDone:r,onError:i})})),it("Build install plan failure",()=>new Promise((r,i)=>{c({firmwareVersion:{metadata:{targetId:857735172}}});const a=new P({input:{applications:[{name:"Bitcoin"}],allowMissingApplication:!1}});l.mockResolvedValueOnce({error:new m("BuildInstallPlan failed")}),vi.spyOn(a,"extractDependencies").mockReturnValue(u());const t=[{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{error:new m("BuildInstallPlan failed"),status:e.Error}];d(a,t,o,{onDone:r,onError:i})})),it("Predict out of memory failure",()=>new Promise((r,i)=>{c({firmwareVersion:{metadata:{targetId:857735172}}});const a=new P({input:{applications:[{name:"Bitcoin"},{name:"Ethereum"},{name:"Solana"},{name:"XRP"},{name:"MyShitCoin"}],allowMissingApplication:!1}}),t={installPlan:[{versionName:"Bitcoin"},{versionName:"XRP"}],alreadyInstalled:["Ethereum","Solana"],missingApplications:["MyShitCoin"]};l.mockResolvedValueOnce(t),g.mockResolvedValueOnce({error:new m("PredictOutOfMemory failed")}),vi.spyOn(a,"extractDependencies").mockReturnValue(u());const s=[{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.Pending},{error:new m("PredictOutOfMemory failed"),status:e.Error}];d(a,s,o,{onDone:r,onError:i})})),it("Is out of memory",()=>new Promise((r,i)=>{c({firmwareVersion:{metadata:{targetId:857735172}}});const a=new P({input:{applications:[{name:"Bitcoin"},{name:"Ethereum"},{name:"Solana"},{name:"XRP"},{name:"MyShitCoin"}],allowMissingApplication:!1}}),t={installPlan:[{versionName:"Bitcoin"},{versionName:"XRP"}],alreadyInstalled:["Ethereum","Solana"],missingApplications:["MyShitCoin"]};l.mockResolvedValueOnce(t),g.mockResolvedValueOnce({outOfMemory:!0}),vi.spyOn(a,"extractDependencies").mockReturnValue(u());const s=[{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.Pending},{error:new S("Not enough memory for those applications"),status:e.Error}];d(a,s,o,{onDone:r,onError:i})})),it("Go to dashboard failure",()=>new Promise((r,i)=>{I(!0),c({firmwareVersion:{metadata:{targetId:857735172}}});const a=new P({input:{applications:[{name:"Bitcoin"},{name:"Ethereum"},{name:"Solana"},{name:"XRP"},{name:"MyShitCoin"}],allowMissingApplication:!1}}),t={installPlan:[{versionName:"Bitcoin"},{versionName:"XRP"}],alreadyInstalled:["Ethereum","Solana"],missingApplications:["MyShitCoin"]};l.mockResolvedValueOnce(t),g.mockResolvedValueOnce({outOfMemory:!1}),vi.spyOn(a,"extractDependencies").mockReturnValue(u());const s=[{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.Pending},{error:new m("GoToDashboard failed"),status:e.Error}];d(a,s,o,{onDone:r,onError:i})})),it("Install app failure",()=>new Promise((r,i)=>{I(),c({firmwareVersion:{metadata:{targetId:857735172}}});const a=new P({input:{applications:[{name:"Bitcoin"},{name:"Ethereum"},{name:"Solana"},{name:"XRP"},{name:"MyShitCoin"}],allowMissingApplication:!1}}),t={installPlan:[{versionName:"Bitcoin"},{versionName:"XRP"}],alreadyInstalled:["Ethereum","Solana"],missingApplications:["MyShitCoin"]};l.mockResolvedValueOnce(t),g.mockResolvedValueOnce({outOfMemory:!1}),v.mockReturnValue(V(A({type:p.Exchange,payload:{data:new Uint8Array([0,1,2,3])}}),y(()=>new m("Secure channel error")))),vi.spyOn(a,"extractDependencies").mockReturnValue(u());const s=[{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:null},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.Pending},{intermediateValue:{requiredUserInteraction:n.None,installPlan:{...t,currentIndex:0,currentProgress:0}},status:e.Pending},{error:new m("Secure channel error"),status:e.Error}];d(a,s,o,{onDone:r,onError:i})}))})});
//# sourceMappingURL=InstallOrUpdateAppsDeviceAction.test.js.map

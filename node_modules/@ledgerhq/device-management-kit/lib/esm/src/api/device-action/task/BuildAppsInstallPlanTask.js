import{gte as p}from"semver";import{UnknownDAError as d,UnsupportedApplicationDAError as u,UnsupportedFirmwareDAError as c}from"../../device-action/os/Errors";import{DeviceSessionStateType as m}from"../../device-session/DeviceSessionState";class w{constructor(n,i){this.api=n;this.args=i;const r=n.getDeviceModel();this.deviceModelId=r.id}deviceModelId;run(){const n=this.api.getDeviceSessionState();if(n.sessionStateType===m.Connected)return{error:new d("Invalid device state")};if(n.catalog===void 0)return{error:new d("Device apps metadata not fetched")};let i=[],r=[],t=[];for(const e of this.args.applications){const a=n.catalog.applications.find(l=>l.versionName===e.name),o=n.installedApps.find(l=>l.versionName===e.name);if(o!==void 0&&this.validateConstraint(o,a,e.constraints)){r=[...r,e.name];continue}if(a!==void 0&&this.validateConstraint(a,void 0,e.constraints))i=[...i,a];else if(this.args.allowMissingApplication)t=[...t,e.name];else return n.firmwareUpdateContext?.availableUpdate!==void 0&&a!==void 0?{error:new c(`Application ${e.name} needs latest firmware`)}:n.firmwareUpdateContext?.availableUpdate!==void 0?{error:new c(`Application ${e.name} needs latest firmware`)}:{error:new u(`Application ${e.name} not supported for this device`)}}return i=[...i.reduce((e,a)=>{const o=a.parentName;if(o){const l=n.catalog.applications.find(s=>s.versionName===o),f=n.installedApps.find(s=>s.versionName===o);if(l&&!f)return[...e,l]}return e},[]),...i],{installPlan:i.filter((e,a)=>i.findIndex(o=>o.versionName===e.versionName)===a),missingApplications:t,alreadyInstalled:r}}validateConstraint(n,i,r){if(r===void 0)return!0;for(const t of r)if(!(t.exemptModels!==void 0&&t.exemptModels.includes(this.deviceModelId))&&!(t.applicableModels!==void 0&&!t.applicableModels.includes(this.deviceModelId)))return t.minVersion==="latest"?!i||p(n.version,i.version):p(n.version,t.minVersion);return!0}}export{w as BuildAppsInstallPlanTask};
//# sourceMappingURL=BuildAppsInstallPlanTask.js.map

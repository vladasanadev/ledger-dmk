import{Left as M,Right as l}from"purify-ts";import{DeviceStatus as V}from"../../../device/DeviceStatus";import{BTC_APP as A,BTC_APP_METADATA as d,CUSTOM_LOCK_SCREEN_APP as f,CUSTOM_LOCK_SCREEN_APP_METADATA as g,ETH_APP as k,ETH_APP_METADATA as w}from"../../../device-action/__test-utils__/data";import{makeDeviceActionInternalApiMock as a}from"../../../device-action/__test-utils__/makeInternalApi";import{setupListAppsMock as o}from"../../../device-action/__test-utils__/setupTestMachine";import{testDeviceActionStates as p}from"../../../device-action/__test-utils__/testDeviceActionStates";import{DeviceActionStatus as e}from"../../../device-action/model/DeviceActionState";import{UserInteractionRequired as t}from"../../../device-action/model/UserInteractionRequired";import{UnknownDAError as m}from"../../../device-action/os/Errors";import{DeviceSessionStateType as I}from"../../../device-session/DeviceSessionState";import{HttpFetchApiError as U}from"../../../../internal/manager-api/model/Errors";import{ListAppsWithMetadataDeviceAction as c}from"./ListAppsWithMetadataDeviceAction";vi.mock("@api/device-action/os/ListApps/ListAppsDeviceAction");describe("ListAppsWithMetadataDeviceAction",()=>{const{getManagerApiService:u}=a(),v=vi.fn(),h=vi.fn(),S=vi.fn();function P(){return{getAppsByHash:S,getDeviceSessionState:h,setDeviceSessionState:v}}beforeEach(()=>{vi.resetAllMocks()}),describe("success case",()=>{it("should run the device actions with no apps installed",()=>new Promise((r,s)=>{o([]);const i=new c({input:{}});u.mockReturnValue({getAppsByHash:vi.fn().mockResolvedValue(l([]))});const n=[{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.AllowListApps},status:e.Pending},{status:e.Completed,output:[]}];p(i,n,a(),{onDone:r,onError:s})})),it("should run the device actions with 1 app installed",()=>new Promise((r,s)=>{o([A]);const i=new c({input:{}});u.mockReturnValue({getAppsByHash:vi.fn().mockResolvedValue(l([d]))});const n=[{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.AllowListApps},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{status:e.Completed,output:[d]}];p(i,n,a(),{onDone:r,onError:s})})),it("should run the device actions with 2 apps installed",()=>new Promise((r,s)=>{o([A,k]);const i=new c({input:{}});u.mockReturnValue({getAppsByHash:vi.fn().mockResolvedValue(l([d,w]))});const n=[{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.AllowListApps},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{status:e.Completed,output:[d,w]}];p(i,n,a(),{onDone:r,onError:s})})),it("should run the device actions with 1 app installed and a custom lock screen",()=>new Promise((r,s)=>{o([A,f]);const i=new c({input:{}});u.mockReturnValue({getAppsByHash:vi.fn().mockResolvedValue(l([d,g]))});const n=[{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.AllowListApps},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{status:e.Completed,output:[d,g]}];p(i,n,a(),{onDone:r,onError:s})}))}),describe("error case",()=>{it("should error when ListApps fails",()=>new Promise((r,s)=>{o([],!0);const i=new c({input:{}}),n=[{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.AllowListApps},status:e.Pending},{status:e.Error,error:new m("ListApps failed")}];p(i,n,a(),{onDone:r,onError:s})})),it("should error when getAppsByHash rejects",()=>new Promise((r,s)=>{o([A]);const i=new c({input:{}});u.mockReturnValue({getAppsByHash:vi.fn().mockRejectedValue(new m("getAppsByHash failed"))});const n=[{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.AllowListApps},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{status:e.Error,error:new m("getAppsByHash failed")}];p(i,n,a(),{onDone:r,onError:s})})),it("should error when getAppsByHash fails but error is known",()=>new Promise((r,s)=>{o([A]);const i=new c({input:{}}),n=new U(new Error("Failed to fetch data"));u.mockReturnValue({getAppsByHash:vi.fn().mockResolvedValue(M(n))});const D=[{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.AllowListApps},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{status:e.Error,error:n}];p(i,D,a(),{onDone:r,onError:s})})),it("should error when SaveSession fails",()=>new Promise((r,s)=>{o([A]);const i=new c({input:{}});S.mockImplementation(async()=>Promise.resolve(l([d]))),vi.spyOn(i,"extractDependencies").mockReturnValue(P()),h.mockReturnValue({sessionStateType:I.ReadyWithoutSecureChannel,deviceStatus:V.CONNECTED,currentApp:"BOLOS",installedApps:[]}),v.mockImplementation(()=>{throw new m("SaveSession failed")});const n=[{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.AllowListApps},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{status:e.Error,error:new m("SaveSession failed")}];p(i,n,a(),{onDone:r,onError:s})}))})});
//# sourceMappingURL=ListAppsWithMetadataDeviceAction.test.js.map

{
  "version": 3,
  "sources": ["../../../../../../../src/api/device-action/os/ListApps/ListAppsDeviceAction.ts"],
  "sourcesContent": ["import { Left, Right } from \"purify-ts\";\nimport { assign, fromPromise, setup } from \"xstate\";\n\nimport { isSuccessCommandResult } from \"@api/command/model/CommandResult\";\nimport {\n  type AppResponse,\n  ListAppsCommand,\n  type ListAppsCommandResult,\n} from \"@api/command/os/ListAppsCommand\";\nimport { type InternalApi } from \"@api/device-action/DeviceAction\";\nimport { UserInteractionRequired } from \"@api/device-action/model/UserInteractionRequired\";\nimport { DEFAULT_UNLOCK_TIMEOUT_MS } from \"@api/device-action/os/Const\";\nimport { GoToDashboardDeviceAction } from \"@api/device-action/os/GoToDashboard/GoToDashboardDeviceAction\";\nimport { type StateMachineTypes } from \"@api/device-action/xstate-utils/StateMachineTypes\";\nimport {\n  type DeviceActionStateMachine,\n  XStateDeviceAction,\n} from \"@api/device-action/xstate-utils/XStateDeviceAction\";\n\nimport {\n  type ListAppsDAError,\n  type ListAppsDAInput,\n  type ListAppsDAIntermediateValue,\n  type ListAppsDAOutput,\n} from \"./types\";\n\ntype ListAppsMachineInternalState = {\n  readonly error: ListAppsDAError | null;\n  readonly apps: AppResponse[];\n  readonly shouldContinue: boolean;\n};\n\nexport type MachineDependencies = {\n  readonly listApps: ({\n    input,\n  }: {\n    input: boolean;\n  }) => Promise<ListAppsCommandResult>;\n};\n\nexport type ExtractMachineDependencies = (\n  internalApi: InternalApi,\n) => MachineDependencies;\n\nexport class ListAppsDeviceAction extends XStateDeviceAction<\n  ListAppsDAOutput,\n  ListAppsDAInput,\n  ListAppsDAError,\n  ListAppsDAIntermediateValue,\n  ListAppsMachineInternalState\n> {\n  makeStateMachine(\n    internalApi: InternalApi,\n  ): DeviceActionStateMachine<\n    ListAppsDAOutput,\n    ListAppsDAInput,\n    ListAppsDAError,\n    ListAppsDAIntermediateValue,\n    ListAppsMachineInternalState\n  > {\n    type types = StateMachineTypes<\n      ListAppsDAOutput,\n      ListAppsDAInput,\n      ListAppsDAError,\n      ListAppsDAIntermediateValue,\n      ListAppsMachineInternalState\n    >;\n\n    const { listApps } = this.extractDependencies(internalApi);\n\n    const unlockTimeout = this.input.unlockTimeout ?? DEFAULT_UNLOCK_TIMEOUT_MS;\n\n    const goToDashboardMachine = new GoToDashboardDeviceAction({\n      input: {\n        unlockTimeout,\n      },\n    }).makeStateMachine(internalApi);\n\n    return setup({\n      types: {\n        input: {\n          unlockTimeout,\n        } as types[\"input\"],\n        context: {} as types[\"context\"],\n        output: {} as types[\"output\"],\n      },\n      actors: {\n        listApps: fromPromise<ListAppsCommandResult, boolean>(listApps),\n        goToDashboard: goToDashboardMachine,\n      },\n      guards: {\n        hasError: ({ context }: { context: types[\"context\"] }) => {\n          return context._internalState.error !== null;\n        },\n        hasMoreApps: (_) => _.context._internalState.shouldContinue,\n      },\n      actions: {\n        assignAllowListApps: assign({\n          intermediateValue: (_) =>\n            ({\n              requiredUserInteraction: UserInteractionRequired.AllowListApps,\n            }) satisfies types[\"context\"][\"intermediateValue\"],\n        }),\n        assignErrorFromEvent: assign({\n          _internalState: (_) => ({\n            ..._.context._internalState,\n            error: _.event[\"error\"], // NOTE: it should never happen, the error is not typed anymore here\n          }),\n        }),\n      },\n    }).createMachine({\n      /** @xstate-layout N4IgpgJg5mDOIC5QBkCWsAuBBADj2AImAG6oDGYWZGqA9gHYB0RpFASmAIYQCeAxAG0ADAF1EoHLVioaDcSAAeiAIwBOIYwAcANgDsyzat2HlAJgDMegDQgeKg412ntAVm3mdp1af0uAvn42aJi4+CzklNR0TADitAAqtAScsAAWAEa0nABOEHwQDGCMqPTEtADWRRApGVm5wmJIIJLSsvTySgguquaMACy6rvrKfSOqfTZ2CKZC2v3K2ou6xn2mms7+gSDB2HiEJBFUbYxxiclpmTl5YNnZtNmMOAA2nBgAZvcAtozVF3UQDXkLRk0Q6iG6vQGQ2UIzGE1siE0ykYLiEaLRuiECxcbmUASC6F2YQOFCO0ROCSSNUuuQAwqkwGRyoJRECpCC5E1OsosZpHAZBi5zKpuhjJohTBZHBt3N5UapVGp8dtCaF9qxIsdTlS-ld6YzmQJlI0JOy2mCEDyHPpNILhaKhLpxQg+kI+ZjzGZdD0seYPMqdmrwqSogxGIG9vlCsVShUihHiRqyWGE7AECUymRXtEGoCmsDzVyVAM+cpzGtzKjvdp1ppnZWNNosW4+sLNEJUdo+gHVXtg5ryam+Dc7g9nq8Ptlvqn+8mmKn07Gs21c6z82bQUXLSXGGWK1XVDW1s6XMZ+kKzLaZk3XD2Qn2SQOU738HwFJhXkVOG8MDcABTKKiaIAJR8DOj5zuGL6wHmpqtJuoDcjue6aA21a1s6ejIuo2imDiCy6H0PS6HeRLqocobztBtIMDQ9AAK5gFG9BFBmcZQfeiYUccqY0fQdGMYumbZgwq4ms0G6cohKiaC4pZCOMQjlu4bguPWqyMJKrhdpKmLLNopFBhBlEcWRfECUxI73I8LzvF8plGUmJm8bRJSCWxy45qIsESfBUmKBKMzIjMnpyTitp+uY9ZyburYWDCfQ1ro5aGQ+TnHOZblMT5BYIQFlqoaojDaCK5iuq2XY1s6iW6I4h54bJlheKlXEhhlrkMdlxpsn57RbgYbiMLMeFrLpMxCiewqOOV4xEai6x4sq9C0BAcDyOB6V5bl-mdAAtNozq7S4jAKqdFgKdW+4teRbXkv2HDcFMcEcn10kuqYzowrVTjaR4TXrNds4mdq5y1FcPUvRaazHaVl5Cq66hqQiCDjJpMplQYmijClWwbdx5Ig9S-z6kyEOFm97bIqsh4KsKZYlQdyOSnywrluYsxDJTmwEpxN1PlRvNk3l3IGMiOIDB2ZWtq6H3I5WtV9BePhYm6gymIDxk8dRHWMULO0SlicyyYBPRlt4jXRXM2hqN6lg8j0GubWGmWdXrr35QsOhDbJh5+l44XwlM5hOCixhej4Ip9Ei3a49BQPHAAyvRZAULA8Drr1UM4nMMxeM4NaoR4TrI0KOczX0cWKo7+NhgAorc9xu1DoxFYBuE6O2OgKfWZ46EYimzAsXYBAEQA */\n      id: \"ListAppsDeviceAction\",\n      initial: \"DeviceReady\",\n      context: (_) => {\n        return {\n          input: {\n            unlockTimeout: _.input.unlockTimeout,\n          },\n          intermediateValue: {\n            requiredUserInteraction: UserInteractionRequired.None,\n          },\n          _internalState: {\n            error: null,\n            apps: [],\n            shouldContinue: false,\n          },\n        };\n      },\n      states: {\n        DeviceReady: {\n          always: {\n            target: \"GoToDashboard\",\n          },\n        },\n        GoToDashboard: {\n          invoke: {\n            id: \"dashboard\",\n            src: \"goToDashboard\",\n            input: (_) => ({\n              unlockTimeout: _.context.input.unlockTimeout,\n            }),\n            onSnapshot: {\n              actions: assign({\n                intermediateValue: (_) =>\n                  _.event.snapshot.context.intermediateValue,\n              }),\n            },\n            onDone: {\n              target: \"GoToDashboardCheck\",\n              actions: assign({\n                _internalState: (_) => {\n                  return _.event.output.caseOf<ListAppsMachineInternalState>({\n                    Right: () => _.context._internalState,\n                    Left: (error) => ({\n                      ..._.context._internalState,\n                      error,\n                    }),\n                  });\n                },\n              }),\n            },\n            onError: {\n              target: \"Error\",\n              actions: \"assignErrorFromEvent\",\n            },\n          },\n        },\n        GoToDashboardCheck: {\n          always: [\n            {\n              target: \"Error\",\n              guard: \"hasError\",\n            },\n            {\n              target: \"ListApps\",\n            },\n          ],\n        },\n        ListApps: {\n          // NOTE: This is a timeout that is currently not used\n          // We need to discuss this as a team, how do we want to\n          // handle the case when the user does not validate or reject on the device\n          // after: {\n          //   15000: \"Error\",\n          //   actions: assign({\n          //     _internalState: (_) => ({\n          //       error: new UnknownDAError(\"ListAppsTimeout\"),\n          //     }),\n          //   }),\n          // },\n          entry: \"assignAllowListApps\",\n          invoke: {\n            src: \"listApps\",\n            input: (_) => false,\n            onDone: {\n              target: \"Continue\",\n              actions: assign({\n                _internalState: (_) => {\n                  if (isSuccessCommandResult(_.event.output)) {\n                    return {\n                      ..._.context._internalState,\n                      apps: _.context._internalState.apps.concat(\n                        _.event.output.data,\n                      ),\n                      shouldContinue: _.event.output.data.length >= 2,\n                    };\n                  }\n                  return {\n                    ..._.context._internalState,\n                    error: _.event.output.error,\n                  };\n                },\n                intermediateValue: (_) => ({\n                  ..._.context.intermediateValue,\n                  requiredUserInteraction: UserInteractionRequired.None,\n                }),\n              }),\n            },\n            onError: {\n              target: \"Error\",\n              actions: \"assignErrorFromEvent\",\n            },\n          },\n        },\n        ListAppsCheck: {\n          always: [\n            {\n              target: \"Error\",\n              guard: \"hasError\",\n            },\n            \"ListAppsContinue\",\n          ],\n        },\n        ListAppsContinue: {\n          invoke: {\n            src: \"listApps\",\n            input: (_) => true,\n            onDone: {\n              target: \"Continue\",\n              actions: assign({\n                _internalState: (_) => {\n                  if (isSuccessCommandResult(_.event.output)) {\n                    return {\n                      ..._.context._internalState,\n                      apps: _.context._internalState.apps.concat(\n                        _.event.output.data,\n                      ),\n                      shouldContinue: _.event.output.data.length >= 2,\n                    };\n                  }\n                  return {\n                    ..._.context._internalState,\n                    error: _.event.output.error,\n                  };\n                },\n              }),\n            },\n            onError: {\n              target: \"Error\",\n              actions: \"assignErrorFromEvent\",\n            },\n          },\n        },\n        Continue: {\n          always: [\n            {\n              target: \"ListAppsContinue\",\n              guard: \"hasMoreApps\",\n            },\n            {\n              target: \"Success\",\n            },\n          ],\n        },\n        Success: {\n          type: \"final\",\n        },\n        Error: {\n          type: \"final\",\n        },\n      },\n      output: (_) => {\n        if (_.context._internalState.error) {\n          return Left(_.context._internalState.error);\n        }\n\n        return Right(_.context._internalState.apps);\n      },\n    });\n  }\n\n  extractDependencies(internalApi: InternalApi): MachineDependencies {\n    const listApps = async ({ input }: { input: boolean }) => {\n      const command = new ListAppsCommand({ isContinue: input });\n      return internalApi.sendCommand(command);\n    };\n\n    return {\n      listApps,\n    };\n  }\n}\n"],
  "mappings": "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",
  "names": ["Left", "Right", "assign", "fromPromise", "setup", "isSuccessCommandResult", "ListAppsCommand", "UserInteractionRequired", "DEFAULT_UNLOCK_TIMEOUT_MS", "GoToDashboardDeviceAction", "XStateDeviceAction", "ListAppsDeviceAction", "internalApi", "listApps", "unlockTimeout", "goToDashboardMachine", "context", "_", "error", "input", "command"]
}

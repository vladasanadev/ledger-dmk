import{concat as h,of as x,throwError as M}from"rxjs";import{CommandResultFactory as u}from"../../../command/model/CommandResult";import{DeviceStatus as C}from"../../../device/DeviceStatus";import{BTC_APP as R}from"../../../device-action/__test-utils__/data";import{makeDeviceActionInternalApiMock as O}from"../../../device-action/__test-utils__/makeInternalApi";import{setupGoToDashboardMock as I}from"../../../device-action/__test-utils__/setupTestMachine";import{setupListAppsMock as S}from"../../../device-action/__test-utils__/setupTestMachine";import{testDeviceActionStates as V}from"../../../device-action/__test-utils__/testDeviceActionStates";import{DeviceActionStatus as e}from"../../../device-action/model/DeviceActionState";import{UserInteractionRequired as t}from"../../../device-action/model/UserInteractionRequired";import{UnknownDAError as q}from"../../../device-action/os/Errors";import{DeviceSessionStateType as E}from"../../../device-session/DeviceSessionState";import{UnknownDeviceExchangeError as N}from"../../../Error";import{SecureChannelEventType as k}from"../../../secure-channel/task/types";import{GetDeviceMetadataDeviceAction as v}from"./GetDeviceMetadataDeviceAction";vi.mock("@api/device-action/os/GoToDashboard/GoToDashboardDeviceAction");vi.mock("@api/device-action/os/ListApps/ListAppsDeviceAction");describe("GetDeviceMetadataDeviceAction",()=>{const c=O(),w=vi.fn(),A=vi.fn(),D=vi.fn(),y=vi.fn(),P="device_version",f="firmware",o="firmware_version",s="fm_update",d="image",l="apps",m="apps_update",p="lang",g="catalog";function U(){return{getDeviceMetadata:w,getFirmwareMetadata:A,getApplicationsMetadata:D,listAppsSecureChannel:y}}beforeEach(()=>{vi.clearAllMocks(),c.getDeviceSessionState.mockReturnValue({sessionStateType:E.Connected,deviceStatus:C.CONNECTED})}),describe("success cases",()=>{it("get metadata from device state",()=>new Promise((n,r)=>{const a=new v({input:{}});w.mockResolvedValueOnce({firmwareVersion:o,firmwareUpdateContext:s,customImage:d,applications:l,applicationsUpdates:m,installedLanguages:p,catalog:g}),vi.spyOn(a,"extractDependencies").mockReturnValue(U());const i=[{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{output:{firmwareVersion:o,firmwareUpdateContext:s,customImage:d,applications:l,applicationsUpdates:m,installedLanguages:p,catalog:g},status:e.Completed}];V(a,i,c,{onDone:n,onError:r})})),it("fetch metadata without secure channel",()=>new Promise((n,r)=>{I(),S([R]);const a=new v({input:{}});w.mockResolvedValueOnce(null),A.mockResolvedValueOnce(u({data:{deviceVersion:P,firmware:f,firmwareVersion:o,firmwareUpdateContext:s,customImage:d}})),D.mockResolvedValueOnce(u({data:{applications:l,applicationsUpdates:m,installedLanguages:p,catalog:g}})),vi.spyOn(a,"extractDependencies").mockReturnValue(U());const i=[{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.AllowListApps},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{output:{firmwareVersion:o,firmwareUpdateContext:s,customImage:d,applications:l,applicationsUpdates:m,installedLanguages:p,catalog:g},status:e.Completed}];V(a,i,c,{onDone:n,onError:r})})),it("fetch metadata with forced update",()=>new Promise((n,r)=>{I(),S([R]);const a=new v({input:{forceUpdate:!0}});A.mockResolvedValueOnce(u({data:{deviceVersion:P,firmware:f,firmwareVersion:o,firmwareUpdateContext:s,customImage:d}})),D.mockResolvedValueOnce(u({data:{applications:l,applicationsUpdates:m,installedLanguages:p,catalog:g}})),vi.spyOn(a,"extractDependencies").mockReturnValue(U());const i=[{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.AllowListApps},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{output:{firmwareVersion:o,firmwareUpdateContext:s,customImage:d,applications:l,applicationsUpdates:m,installedLanguages:p,catalog:g},status:e.Completed}];V(a,i,c,{onDone:n,onError:r})})),it("fetch metadata with secure channel",()=>new Promise((n,r)=>{I();const a=new v({input:{useSecureChannel:!0}});w.mockResolvedValueOnce(null),A.mockResolvedValueOnce(u({data:{deviceVersion:P,firmware:f,firmwareVersion:o,firmwareUpdateContext:s,customImage:d}})),y.mockReturnValue(x({type:k.Exchange},{type:k.PermissionRequested},{type:k.PermissionGranted},{type:k.Result,payload:[{flags:123456,hash:"hash_test",hash_code_data:"hash_code_data_test",name:"Bitcoin"}]})),D.mockResolvedValueOnce(u({data:{applications:l,applicationsUpdates:m,installedLanguages:p,catalog:g}})),vi.spyOn(a,"extractDependencies").mockReturnValue(U());const i=[{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.AllowSecureConnection},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{output:{firmwareVersion:o,firmwareUpdateContext:s,customImage:d,applications:l,applicationsUpdates:m,installedLanguages:p,catalog:g},status:e.Completed}];V(a,i,c,{onDone:n,onError:r})})),it("get metadata from device state with external dependencies",()=>new Promise((n,r)=>{const a=new v({input:{}});c.getDeviceSessionState.mockReturnValue({sessionStateType:E.ReadyWithoutSecureChannel,deviceStatus:C.CONNECTED,firmwareVersion:{metadata:o},firmwareUpdateContext:s,customImage:d,installedApps:[l],appsUpdates:m,installedLanguages:p,catalog:g});const i=[{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{output:{firmwareVersion:{metadata:o},firmwareUpdateContext:s,customImage:d,applications:[l],applicationsUpdates:m,installedLanguages:p,catalog:g},status:e.Completed}];V(a,i,c,{onDone:n,onError:r})}))}),describe("Error cases",()=>{it("error during GoToDashboard",()=>new Promise((n,r)=>{I(!0);const a=new v({input:{}});w.mockResolvedValueOnce(null),vi.spyOn(a,"extractDependencies").mockReturnValue(U());const i=[{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{error:new q("GoToDashboard failed"),status:e.Error}];V(a,i,c,{onDone:n,onError:r})})),it("error during GetFirmwareMetadata",()=>new Promise((n,r)=>{I();const a=new v({input:{}});w.mockResolvedValueOnce(null),A.mockResolvedValueOnce(u({error:new N("GetFirmwareMetadata failed")})),vi.spyOn(a,"extractDependencies").mockReturnValue(U());const i=[{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{error:new N("GetFirmwareMetadata failed"),status:e.Error}];V(a,i,c,{onDone:n,onError:r})})),it("error during ListApps",()=>new Promise((n,r)=>{I(),S([],!0);const a=new v({input:{}});w.mockResolvedValueOnce(null),A.mockResolvedValueOnce(u({data:{deviceVersion:P,firmware:f,firmwareVersion:o,firmwareUpdateContext:s,customImage:d}})),vi.spyOn(a,"extractDependencies").mockReturnValue(U());const i=[{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.AllowListApps},status:e.Pending},{error:new q("ListApps failed"),status:e.Error}];V(a,i,c,{onDone:n,onError:r})})),it("error during GetApplicationsMetadata",()=>new Promise((n,r)=>{I(),S([R]);const a=new v({input:{}});w.mockResolvedValueOnce(null),A.mockResolvedValueOnce(u({data:{deviceVersion:P,firmware:f,firmwareVersion:o,firmwareUpdateContext:s,customImage:d}})),D.mockResolvedValueOnce(u({error:new N("GetApplicationsMetadata failed")})),vi.spyOn(a,"extractDependencies").mockReturnValue(U());const i=[{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.AllowListApps},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{error:new N("GetApplicationsMetadata failed"),status:e.Error}];V(a,i,c,{onDone:n,onError:r})})),it("error during ListAppsSecureChannel",()=>new Promise((n,r)=>{I();const a=new v({input:{useSecureChannel:!0}});w.mockResolvedValueOnce(null),A.mockResolvedValueOnce(u({data:{deviceVersion:P,firmware:f,firmwareVersion:o,firmwareUpdateContext:s,customImage:d}})),y.mockReturnValue(h(x({type:k.Exchange,payload:{data:new Uint8Array([0,1,2,3])}}),M(()=>new q("Secure channel error")))),vi.spyOn(a,"extractDependencies").mockReturnValue(U());const i=[{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{intermediateValue:{requiredUserInteraction:t.None},status:e.Pending},{error:new q("Secure channel error"),status:e.Error}];V(a,i,c,{onDone:n,onError:r})}))})});
//# sourceMappingURL=GetDeviceMetadataDeviceAction.test.js.map

{
  "version": 3,
  "sources": ["../../../../../../../src/api/device-action/os/CallTaskInAppDeviceAction/CallTaskInAppDeviceAction.test.ts"],
  "sourcesContent": ["/* eslint @typescript-eslint/consistent-type-imports:0 */\nimport { Left, Right } from \"purify-ts\";\nimport { type Mock } from \"vitest\";\nimport { assign, createMachine } from \"xstate\";\n\nimport { type Apdu } from \"@api/apdu/model/Apdu\";\nimport { ApduBuilder } from \"@api/apdu/utils/ApduBuilder\";\nimport { CommandResultFactory } from \"@api/command/model/CommandResult\";\nimport { makeDeviceActionInternalApiMock } from \"@api/device-action/__test-utils__/makeInternalApi\";\nimport { testDeviceActionStates } from \"@api/device-action/__test-utils__/testDeviceActionStates\";\nimport {\n  type DeviceActionState,\n  DeviceActionStatus,\n} from \"@api/device-action/model/DeviceActionState\";\nimport { UserInteractionRequired } from \"@api/device-action/model/UserInteractionRequired\";\nimport { UnknownDAError } from \"@api/device-action/os/Errors\";\nimport { OpenAppDeviceAction } from \"@api/device-action/os/OpenAppDeviceAction/OpenAppDeviceAction\";\nimport { type Command } from \"@api/types\";\nimport { UnknownDeviceExchangeError } from \"@root/src\";\n\nimport { CallTaskInAppDeviceAction } from \"./CallTaskInAppDeviceAction\";\nimport {\n  type CallTaskInAppDAError,\n  type CallTaskInAppDAIntermediateValue,\n  type CallTaskInAppDAOutput,\n} from \"./CallTaskInAppDeviceActionTypes\";\n\nvi.mock(\n  \"@api/device-action/os/OpenAppDeviceAction/OpenAppDeviceAction\",\n  async (importOriginal) => {\n    const original =\n      await importOriginal<\n        typeof import(\"@api/device-action/os/OpenAppDeviceAction/OpenAppDeviceAction\")\n      >();\n    return {\n      ...original,\n      OpenAppDeviceAction: vi.fn(() => ({\n        ...original.OpenAppDeviceAction,\n        makeStateMachine: vi.fn(),\n      })),\n    };\n  },\n);\n\nconst setupOpenAppDAMock = (error?: unknown) => {\n  (OpenAppDeviceAction as Mock).mockImplementation(() => ({\n    makeStateMachine: vi.fn().mockImplementation(() =>\n      createMachine({\n        initial: \"pending\",\n        states: {\n          pending: {\n            entry: assign({\n              intermediateValue: {\n                requiredUserInteraction: UserInteractionRequired.ConfirmOpenApp,\n              },\n            }),\n            after: {\n              0: \"done\",\n            },\n          },\n          done: {\n            type: \"final\",\n          },\n        },\n        output: () => (error ? Left(error) : Right(undefined)),\n      }),\n    ),\n  }));\n};\n\ndescribe(\"CallTaskInAppDeviceAction\", () => {\n  const callMyTask = vi.fn();\n\n  const extractDependenciesMock = () => ({\n    callTask: callMyTask,\n  });\n\n  const { sendCommand: apiSendCommandMock } = makeDeviceActionInternalApiMock();\n\n  const commandParams = {\n    paramString: \"aParameter\",\n    paramNumber: 1234,\n  };\n  const mockedCommandResponse = {\n    aNumber: 5678,\n    aString: \"mockedResponseString\",\n  };\n  beforeEach(() => {\n    vi.resetAllMocks();\n  });\n\n  describe(\"without mocking extractDependencies\", () => {\n    it(\"should call sendCommand on internalApi with the correct parameters\", async () => {\n      setupOpenAppDAMock();\n      apiSendCommandMock.mockResolvedValue(\n        CommandResultFactory({ data: undefined }),\n      );\n\n      const deviceAction = new CallTaskInAppDeviceAction({\n        input: {\n          task: async (internalApi) =>\n            await internalApi.sendCommand(new TestCommand(commandParams)),\n          appName: \"MyApp\",\n          requiredUserInteraction: UserInteractionRequired.VerifyAddress,\n          skipOpenApp: false,\n        },\n      });\n      await new Promise<void>((resolve, reject) => {\n        deviceAction\n          ._execute(makeDeviceActionInternalApiMock())\n          .observable.subscribe({\n            error: () => reject(),\n            complete: () => resolve(),\n            next: () => {},\n          });\n      });\n\n      expect(apiSendCommandMock).toHaveBeenCalledWith(\n        new TestCommand(commandParams),\n      );\n    });\n  });\n\n  describe(\"error cases\", () => {\n    it(\"should error and output the error if the open app fails\", () =>\n      new Promise<void>((resolve, reject) => {\n        setupOpenAppDAMock(new UnknownDAError(\"Mocked error\"));\n\n        const expectedStates: MyCommandCallTaskDAState[] = [\n          {\n            status: DeviceActionStatus.Pending,\n            intermediateValue: {\n              requiredUserInteraction: UserInteractionRequired.None,\n            },\n          },\n          {\n            status: DeviceActionStatus.Pending,\n            intermediateValue: {\n              requiredUserInteraction: UserInteractionRequired.ConfirmOpenApp,\n            },\n          },\n          {\n            status: DeviceActionStatus.Error,\n            error: new UnknownDAError(\"Mocked error\"),\n          },\n        ];\n\n        testDeviceActionStates(\n          new CallTaskInAppDeviceAction({\n            input: {\n              task: async (internalApi) =>\n                await internalApi.sendCommand(new TestCommand(commandParams)),\n              appName: \"MyApp\",\n              requiredUserInteraction: UserInteractionRequired.VerifyAddress,\n              skipOpenApp: false,\n            },\n          }),\n          expectedStates,\n          makeDeviceActionInternalApiMock(),\n          {\n            onDone: resolve,\n            onError: reject,\n          },\n        );\n      }));\n\n    it(\"should error and output an error if the call task fails\", () =>\n      new Promise<void>((resolve, reject) => {\n        setupOpenAppDAMock();\n\n        callMyTask.mockResolvedValue(\n          CommandResultFactory({\n            error: new UnknownDeviceExchangeError(\"Mocked error\"),\n          }),\n        );\n\n        const deviceAction = new CallTaskInAppDeviceAction({\n          input: {\n            task: async (internalApi) =>\n              await internalApi.sendCommand(new TestCommand(commandParams)),\n            appName: \"MyApp\",\n            requiredUserInteraction: UserInteractionRequired.VerifyAddress,\n            skipOpenApp: false,\n          },\n        });\n\n        vi.spyOn(deviceAction, \"extractDependencies\").mockImplementation(\n          extractDependenciesMock,\n        );\n\n        const expectedStates: MyCommandCallTaskDAState[] = [\n          {\n            status: DeviceActionStatus.Pending,\n            intermediateValue: {\n              requiredUserInteraction: UserInteractionRequired.None,\n            },\n          },\n          {\n            status: DeviceActionStatus.Pending,\n            intermediateValue: {\n              requiredUserInteraction: UserInteractionRequired.ConfirmOpenApp,\n            },\n          },\n          {\n            status: DeviceActionStatus.Pending,\n            intermediateValue: {\n              requiredUserInteraction: UserInteractionRequired.VerifyAddress,\n            },\n          },\n          {\n            status: DeviceActionStatus.Error,\n            error: new UnknownDeviceExchangeError(\"Mocked error\"),\n          },\n        ];\n\n        testDeviceActionStates(\n          deviceAction,\n          expectedStates,\n          makeDeviceActionInternalApiMock(),\n          {\n            onDone: resolve,\n            onError: reject,\n          },\n        );\n      }));\n  });\n\n  describe(\"success cases\", () => {\n    it(\"should succeed and output the command result if the send command succeeds\", () =>\n      new Promise<void>((resolve, reject) => {\n        setupOpenAppDAMock();\n\n        callMyTask.mockResolvedValue(\n          CommandResultFactory({ data: mockedCommandResponse }),\n        );\n\n        const deviceAction = new CallTaskInAppDeviceAction({\n          input: {\n            task: async (internalApi) =>\n              await internalApi.sendCommand(new TestCommand(commandParams)),\n            appName: \"MyApp\",\n            requiredUserInteraction: UserInteractionRequired.VerifyAddress,\n            skipOpenApp: false,\n          },\n        });\n\n        vi.spyOn(deviceAction, \"extractDependencies\").mockImplementation(\n          extractDependenciesMock,\n        );\n\n        const expectedStates: MyCommandCallTaskDAState[] = [\n          {\n            status: DeviceActionStatus.Pending,\n            intermediateValue: {\n              requiredUserInteraction: UserInteractionRequired.None,\n            },\n          },\n          {\n            status: DeviceActionStatus.Pending,\n            intermediateValue: {\n              requiredUserInteraction: UserInteractionRequired.ConfirmOpenApp,\n            },\n          },\n          {\n            status: DeviceActionStatus.Pending,\n            intermediateValue: {\n              requiredUserInteraction: UserInteractionRequired.VerifyAddress,\n            },\n          },\n          {\n            status: DeviceActionStatus.Completed,\n            output: mockedCommandResponse,\n          },\n        ];\n\n        testDeviceActionStates(\n          deviceAction,\n          expectedStates,\n          makeDeviceActionInternalApiMock(),\n          {\n            onDone: resolve,\n            onError: reject,\n          },\n        );\n      }));\n\n    it(\"should succeed while skipping OpenApp\", () =>\n      new Promise<void>((resolve, reject) => {\n        setupOpenAppDAMock();\n\n        callMyTask.mockResolvedValue(\n          CommandResultFactory({ data: mockedCommandResponse }),\n        );\n\n        const deviceAction = new CallTaskInAppDeviceAction({\n          input: {\n            task: async (internalApi) =>\n              await internalApi.sendCommand(new TestCommand(commandParams)),\n            appName: \"MyApp\",\n            requiredUserInteraction: UserInteractionRequired.VerifyAddress,\n            skipOpenApp: true,\n          },\n        });\n\n        vi.spyOn(deviceAction, \"extractDependencies\").mockImplementation(\n          extractDependenciesMock,\n        );\n\n        const expectedStates: MyCommandCallTaskDAState[] = [\n          {\n            status: DeviceActionStatus.Pending,\n            intermediateValue: {\n              requiredUserInteraction: UserInteractionRequired.VerifyAddress,\n            },\n          },\n          {\n            status: DeviceActionStatus.Completed,\n            output: mockedCommandResponse,\n          },\n        ];\n\n        testDeviceActionStates(\n          deviceAction,\n          expectedStates,\n          makeDeviceActionInternalApiMock(),\n          {\n            onDone: resolve,\n            onError: reject,\n          },\n        );\n      }));\n  });\n});\n\ntype MyCommandResponse = {\n  aNumber: number;\n  aString: string;\n};\n\ntype MyCommandParams = {\n  paramString: string;\n  paramNumber: number;\n};\n\nclass TestCommand implements Command<MyCommandResponse, MyCommandParams> {\n  readonly name = \"testCommand\";\n\n  params: MyCommandParams;\n  constructor(params: MyCommandParams) {\n    this.params = params;\n  }\n  getApdu(): Apdu {\n    return new ApduBuilder({ cla: 0x00, ins: 0x01, p1: 0x02, p2: 0x03 })\n      .add32BitUIntToData(this.params.paramNumber)\n      .addAsciiStringToData(this.params.paramString)\n      .build();\n  }\n  parseResponse() {\n    return CommandResultFactory({ data: { aNumber: 1, aString: \"aString\" } });\n  }\n}\n\ntype MyCommandCallTaskDAState = DeviceActionState<\n  CallTaskInAppDAOutput<MyCommandResponse>,\n  CallTaskInAppDAError<UnknownDAError>,\n  CallTaskInAppDAIntermediateValue<\n    UserInteractionRequired.None | UserInteractionRequired.VerifyAddress\n  >\n>;\n"],
  "mappings": "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",
  "names": ["Left", "Right", "assign", "createMachine", "ApduBuilder", "CommandResultFactory", "makeDeviceActionInternalApiMock", "testDeviceActionStates", "DeviceActionStatus", "UserInteractionRequired", "UnknownDAError", "OpenAppDeviceAction", "UnknownDeviceExchangeError", "CallTaskInAppDeviceAction", "importOriginal", "original", "setupOpenAppDAMock", "error", "callMyTask", "extractDependenciesMock", "apiSendCommandMock", "commandParams", "mockedCommandResponse", "deviceAction", "internalApi", "TestCommand", "resolve", "reject", "expectedStates", "params"]
}

{
  "version": 3,
  "sources": ["../../../../../../../src/api/device-action/os/OpenAppWithDependencies/OpenAppWithDependenciesDeviceAction.ts"],
  "sourcesContent": ["import { Left, Right } from \"purify-ts\";\nimport { assign, setup } from \"xstate\";\n\nimport { type InternalApi } from \"@api/device-action/DeviceAction\";\nimport { UserInteractionRequired } from \"@api/device-action/model/UserInteractionRequired\";\nimport { DEFAULT_UNLOCK_TIMEOUT_MS } from \"@api/device-action/os/Const\";\nimport { UnsupportedFirmwareDAError } from \"@api/device-action/os/Errors\";\nimport { GetDeviceMetadataDeviceAction } from \"@api/device-action/os/GetDeviceMetadata/GetDeviceMetadataDeviceAction\";\nimport type { GetDeviceMetadataDAOutput } from \"@api/device-action/os/GetDeviceMetadata/types\";\nimport { InstallOrUpdateAppsDeviceAction } from \"@api/device-action/os/InstallOrUpdateApps/InstallOrUpdateAppsDeviceAction\";\nimport type { InstallOrUpdateAppsDAOutput } from \"@api/device-action/os/InstallOrUpdateApps/types\";\nimport { OpenAppDeviceAction } from \"@api/device-action/os/OpenAppDeviceAction/OpenAppDeviceAction\";\nimport { type StateMachineTypes } from \"@api/device-action/xstate-utils/StateMachineTypes\";\nimport {\n  type DeviceActionStateMachine,\n  XStateDeviceAction,\n} from \"@api/device-action/xstate-utils/XStateDeviceAction\";\n\nimport {\n  type OpenAppWithDependenciesDAError,\n  type OpenAppWithDependenciesDAInput,\n  type OpenAppWithDependenciesDAIntermediateValue,\n  type OpenAppWithDependenciesDAOutput,\n} from \"./types\";\n\ntype OpenAppWithDependenciesMachineInternalState = {\n  readonly error: OpenAppWithDependenciesDAError | null;\n  readonly deviceMetadata: GetDeviceMetadataDAOutput | null;\n  readonly installResult: InstallOrUpdateAppsDAOutput | null;\n};\n\nexport class OpenAppWithDependenciesDeviceAction extends XStateDeviceAction<\n  OpenAppWithDependenciesDAOutput,\n  OpenAppWithDependenciesDAInput,\n  OpenAppWithDependenciesDAError,\n  OpenAppWithDependenciesDAIntermediateValue,\n  OpenAppWithDependenciesMachineInternalState\n> {\n  makeStateMachine(\n    internalApi: InternalApi,\n  ): DeviceActionStateMachine<\n    OpenAppWithDependenciesDAOutput,\n    OpenAppWithDependenciesDAInput,\n    OpenAppWithDependenciesDAError,\n    OpenAppWithDependenciesDAIntermediateValue,\n    OpenAppWithDependenciesMachineInternalState\n  > {\n    type types = StateMachineTypes<\n      OpenAppWithDependenciesDAOutput,\n      OpenAppWithDependenciesDAInput,\n      OpenAppWithDependenciesDAError,\n      OpenAppWithDependenciesDAIntermediateValue,\n      OpenAppWithDependenciesMachineInternalState\n    >;\n\n    const unlockTimeout = this.input.unlockTimeout ?? DEFAULT_UNLOCK_TIMEOUT_MS;\n\n    const getMetadataMachine = new GetDeviceMetadataDeviceAction({\n      input: {\n        unlockTimeout,\n        useSecureChannel: true,\n        forceUpdate: false,\n      },\n    }).makeStateMachine(internalApi);\n\n    const installAppsMachine = new InstallOrUpdateAppsDeviceAction({\n      input: {\n        unlockTimeout,\n        applications: [...this.input.dependencies, this.input.application],\n        allowMissingApplication: false,\n      },\n    }).makeStateMachine(internalApi);\n\n    const openAppMachine = new OpenAppDeviceAction({\n      input: {\n        unlockTimeout,\n        appName: this.input.application.name,\n      },\n    }).makeStateMachine(internalApi);\n\n    return setup({\n      types: {\n        input: {\n          unlockTimeout,\n        } as types[\"input\"],\n        context: {} as types[\"context\"],\n        output: {} as types[\"output\"],\n      },\n      actors: {\n        getMetadata: getMetadataMachine,\n        installApps: installAppsMachine,\n        openApp: openAppMachine,\n      },\n      guards: {\n        hasError: ({ context }) => context._internalState.error !== null,\n      },\n      actions: {\n        assignErrorFromEvent: assign({\n          _internalState: (_) => ({\n            ..._.context._internalState,\n            error: _.event[\"error\"], // NOTE: it should never happen, the error is not typed anymore here\n          }),\n        }),\n      },\n    }).createMachine({\n      id: \"OpenAppWithDependenciesDeviceAction\",\n      initial: \"DeviceReady\",\n      context: (_) => {\n        return {\n          input: {\n            application: _.input.application,\n            dependencies: _.input.dependencies,\n            requireLatestFirmware: _.input.requireLatestFirmware,\n            unlockTimeout: _.input.unlockTimeout,\n          },\n          intermediateValue: {\n            requiredUserInteraction: UserInteractionRequired.None,\n            installPlan: null,\n          },\n          _internalState: {\n            error: null,\n            deviceMetadata: null,\n            installResult: null,\n          },\n        };\n      },\n      states: {\n        DeviceReady: {\n          always: [\n            {\n              target: \"GetDeviceMetadata\",\n            },\n          ],\n        },\n        GetDeviceMetadata: {\n          exit: assign({\n            intermediateValue: (_) => ({\n              ..._.context.intermediateValue,\n              requiredUserInteraction: UserInteractionRequired.None,\n            }),\n          }),\n          invoke: {\n            id: \"getMetadata\",\n            src: \"getMetadata\",\n            input: (_) => ({\n              unlockTimeout: _.context.input.unlockTimeout,\n              useSecureChannel: true,\n              forceUpdate: false,\n            }),\n            onSnapshot: {\n              actions: assign({\n                intermediateValue: (_) => ({\n                  ..._.context.intermediateValue,\n                  requiredUserInteraction:\n                    _.event.snapshot.context.intermediateValue\n                      .requiredUserInteraction,\n                  deviceId:\n                    _.event.snapshot.context.intermediateValue.deviceId ??\n                    _.context.intermediateValue.deviceId,\n                }),\n              }),\n            },\n            onDone: {\n              target: \"GetDeviceMetadataCheck\",\n              actions: assign({\n                _internalState: (_) =>\n                  _.event.output.caseOf<OpenAppWithDependenciesMachineInternalState>(\n                    {\n                      Right: (data) => {\n                        if (\n                          _.context.input.requireLatestFirmware &&\n                          data.firmwareUpdateContext.availableUpdate !==\n                            undefined\n                        ) {\n                          return {\n                            ..._.context._internalState,\n                            error: new UnsupportedFirmwareDAError(\n                              \"Firmware is not the latest version\",\n                            ),\n                          };\n                        } else {\n                          return {\n                            ..._.context._internalState,\n                            deviceMetadata: data,\n                          };\n                        }\n                      },\n                      Left: (error) => ({\n                        ..._.context._internalState,\n                        error,\n                      }),\n                    },\n                  ),\n              }),\n            },\n            onError: {\n              target: \"Error\",\n              actions: \"assignErrorFromEvent\",\n            },\n          },\n        },\n        GetDeviceMetadataCheck: {\n          always: [\n            {\n              target: \"Error\",\n              guard: \"hasError\",\n            },\n            {\n              target: \"InstallDependencies\",\n            },\n          ],\n        },\n        InstallDependencies: {\n          exit: assign({\n            intermediateValue: (_) => ({\n              ..._.context.intermediateValue,\n              requiredUserInteraction: UserInteractionRequired.None,\n            }),\n          }),\n          invoke: {\n            src: \"installApps\",\n            input: (_) => ({\n              unlockTimeout: _.context.input.unlockTimeout,\n              applications: [\n                ..._.context.input.dependencies,\n                _.context.input.application,\n              ],\n              allowMissingApplication: false,\n            }),\n            onSnapshot: {\n              actions: assign({\n                intermediateValue: (_) => ({\n                  ..._.context.intermediateValue,\n                  requiredUserInteraction:\n                    _.event.snapshot.context.intermediateValue\n                      .requiredUserInteraction,\n                  installPlan:\n                    _.event.snapshot.context.intermediateValue.installPlan,\n                  deviceId:\n                    _.event.snapshot.context.intermediateValue.deviceId ??\n                    _.context.intermediateValue.deviceId,\n                }),\n              }),\n            },\n            onDone: {\n              target: \"InstallDependenciesCheck\",\n              actions: assign({\n                _internalState: (_) =>\n                  _.event.output.caseOf<OpenAppWithDependenciesMachineInternalState>(\n                    {\n                      Right: (data) => ({\n                        ..._.context._internalState,\n                        installResult: data,\n                      }),\n                      Left: (error) => ({\n                        ..._.context._internalState,\n                        error,\n                      }),\n                    },\n                  ),\n              }),\n            },\n            onError: {\n              target: \"Error\",\n              actions: \"assignErrorFromEvent\",\n            },\n          },\n        },\n        InstallDependenciesCheck: {\n          always: [\n            {\n              guard: \"hasError\",\n              target: \"Error\",\n            },\n            {\n              target: \"OpenApp\",\n            },\n          ],\n        },\n        OpenApp: {\n          exit: assign({\n            intermediateValue: (_) => ({\n              ..._.context.intermediateValue,\n              requiredUserInteraction: UserInteractionRequired.None,\n            }),\n          }),\n          invoke: {\n            src: \"openApp\",\n            input: (_) => ({\n              unlockTimeout: _.context.input.unlockTimeout,\n              appName: _.context.input.application.name,\n            }),\n            onSnapshot: {\n              actions: assign({\n                intermediateValue: (_) => ({\n                  ..._.context.intermediateValue,\n                  requiredUserInteraction:\n                    _.event.snapshot.context.intermediateValue\n                      .requiredUserInteraction,\n                  installPlan: null,\n                }),\n              }),\n            },\n            onDone: {\n              target: \"OpenAppCheck\",\n              actions: assign({\n                _internalState: (_) =>\n                  _.event.output.caseOf<OpenAppWithDependenciesMachineInternalState>(\n                    {\n                      Right: () => _.context._internalState,\n                      Left: (error) => ({\n                        ..._.context._internalState,\n                        error,\n                      }),\n                    },\n                  ),\n              }),\n            },\n            onError: {\n              target: \"Error\",\n              actions: \"assignErrorFromEvent\",\n            },\n          },\n        },\n        OpenAppCheck: {\n          always: [\n            {\n              guard: \"hasError\",\n              target: \"Error\",\n            },\n            {\n              target: \"Success\",\n            },\n          ],\n        },\n        Success: {\n          type: \"final\",\n        },\n        Error: {\n          type: \"final\",\n        },\n      },\n      output: (args) => {\n        const { context } = args;\n        const { error, deviceMetadata, installResult } = context._internalState;\n        if (error) {\n          return Left(error);\n        }\n        return Right({\n          deviceMetadata: deviceMetadata!,\n          installResult: installResult!,\n        });\n      },\n    });\n  }\n}\n"],
  "mappings": "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",
  "names": ["Left", "Right", "assign", "setup", "UserInteractionRequired", "DEFAULT_UNLOCK_TIMEOUT_MS", "UnsupportedFirmwareDAError", "GetDeviceMetadataDeviceAction", "InstallOrUpdateAppsDeviceAction", "OpenAppDeviceAction", "XStateDeviceAction", "OpenAppWithDependenciesDeviceAction", "internalApi", "unlockTimeout", "getMetadataMachine", "installAppsMachine", "openAppMachine", "context", "_", "data", "error", "args", "deviceMetadata", "installResult"]
}

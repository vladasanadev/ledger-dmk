{
  "version": 3,
  "sources": ["../../../../../../src/api/secure-channel/task/ConnectToSecureChannelTask.test.ts"],
  "sourcesContent": ["import WebSocket from \"isomorphic-ws\";\nimport { Right } from \"purify-ts\";\nimport { describe, it, vi } from \"vitest\";\n\nimport { type InternalApi } from \"@api/index\";\nimport {\n  type SecureChannelEvent,\n  SecureChannelEventType,\n} from \"@api/secure-channel/task/types\";\nimport {\n  SecureChannelError,\n  SecureChannelErrorType,\n} from \"@internal/secure-channel/model/Errors\";\n\nimport {\n  ConnectToSecureChannelTask,\n  type ConnectToSecureChannelTaskArgs,\n} from \"./ConnectToSecureChannelTask\";\n\nvi.mock(\"isomorphic-ws\", () => ({\n  ...vi.importActual(\"isomorphic-ws\"),\n  __esModule: true,\n  default: class {\n    onopen: (() => void) | null = null;\n    onmessage: ((event: { data: string }) => void) | null = null;\n    send = vi.fn();\n    close = vi.fn();\n    url: string;\n    constructor(url: string) {\n      this.url = url;\n    }\n  },\n}));\n\nconst TEST_DELAY = 5;\n\ndescribe(\"ConnectToSecureChannelTask\", () => {\n  let mockWebSocket: WebSocket;\n  let mockInternalApi: InternalApi;\n  let taskArgs: ConnectToSecureChannelTaskArgs;\n  let task: ConnectToSecureChannelTask;\n  const sendApduFn = vi.fn();\n  const mockMessage = {\n    uuid: \"5b776c8d-8af2-48c0-8250-04edca2ef5e9\",\n    session: \"39ce749e-00a4-4c31-a697-1dc1a29e2cab\",\n    query: \"success\",\n    nonce: 15,\n  };\n\n  beforeEach(() => {\n    // vi.useFakeTimers({ shouldAdvanceTime: true });\n\n    mockWebSocket = new WebSocket(\"wss://test-host.com\");\n    mockInternalApi = {\n      sendApdu: sendApduFn,\n      disableRefresher: (_: unknown) => vi.fn(),\n    } as unknown as InternalApi;\n    taskArgs = { connection: Right(mockWebSocket) };\n    task = new ConnectToSecureChannelTask(mockInternalApi, taskArgs);\n  });\n\n  afterEach(() => {\n    vi.resetAllMocks();\n  });\n\n  it(\"should emit Opened event on WebSocket open\", async () => {\n    const events: SecureChannelEvent[] = [];\n    const obs = task.run();\n    obs.subscribe((e) => events.push(e));\n\n    expect(mockWebSocket.onopen).toBeDefined();\n    mockWebSocket.onopen!({\n      type: \"open\",\n      target: {} as WebSocket,\n    });\n\n    await new Promise((resolve) => setTimeout(resolve, TEST_DELAY));\n\n    expect(events).toStrictEqual([{ type: SecureChannelEventType.Opened }]);\n  });\n\n  it(\"Error on wrongly formatted message\", async () => {\n    const events: SecureChannelEvent[] = [];\n    const obs = task.run();\n    obs.subscribe({\n      next: (event) => {\n        events.push(event);\n      },\n    });\n\n    expect(mockWebSocket.onmessage).toBeDefined();\n    mockWebSocket.onmessage!({\n      data: \"invalidData\",\n      type: \"\",\n      target: {} as WebSocket,\n    });\n\n    await new Promise((resolve) => setTimeout(resolve, TEST_DELAY));\n\n    expect(events).toStrictEqual([\n      {\n        type: SecureChannelEventType.Error,\n        error: new SecureChannelError({\n          url: \"wss://test-host.com\",\n          errorMessage: \"Invalid message received: invalidData\",\n        }),\n      },\n    ]);\n  });\n\n  it(\"should handle incoming EXCHANGE message including requesting user permission\", async () => {\n    sendApduFn.mockResolvedValue(\n      Right({\n        data: new Uint8Array([0x90, 0x00]),\n        statusCode: new Uint8Array([0x90, 0x00]),\n      }),\n    );\n\n    const sendSpy = vi.spyOn(mockWebSocket, \"send\");\n    vi.spyOn(task, \"isSecureConnectionAllowed\").mockReturnValueOnce(false);\n\n    const events: SecureChannelEvent[] = [];\n    const obs = task.run();\n    obs.subscribe({\n      next: (event) => {\n        events.push(event);\n      },\n    });\n\n    expect(mockWebSocket.onmessage).toBeDefined();\n    mockWebSocket.onmessage!({\n      data: JSON.stringify({\n        ...mockMessage,\n        query: \"exchange\",\n        nonce: 1,\n        data: \"e051000000\",\n      }),\n      type: \"\",\n      target: {} as WebSocket,\n    });\n\n    await new Promise((resolve) => setTimeout(resolve, TEST_DELAY));\n\n    expect(sendSpy).toHaveBeenCalledExactlyOnceWith(\n      JSON.stringify({\n        nonce: 1,\n        response: \"success\",\n        data: \"9000\",\n      }),\n    );\n    expect(events).toStrictEqual([\n      {\n        type: SecureChannelEventType.PreExchange,\n        payload: {\n          nonce: 1,\n          apdu: new Uint8Array([0xe0, 0x51, 0x00, 0x00, 0x00]),\n        },\n      },\n      {\n        type: SecureChannelEventType.PermissionRequested,\n      },\n      {\n        type: SecureChannelEventType.Exchange,\n        payload: {\n          nonce: 1,\n          apdu: new Uint8Array([0xe0, 0x51, 0x00, 0x00, 0x00]),\n          data: new Uint8Array([0x90, 0x00]),\n          status: new Uint8Array([0x90, 0x00]),\n        },\n      },\n      {\n        type: SecureChannelEventType.PermissionGranted,\n      },\n    ]);\n  });\n\n  it(\"should capture and emit device ID on first GetCertificate APDU\", async () => {\n    // Mock response for GetCertificate\n    const mockResponse = new Uint8Array([\n      0x07, 0x4a, 0x07, 0xa1, 0x52, 0xe6, 0xbb, 0xc1, 0x41, 0x04, 0x1c, 0x74,\n      0x7a, 0x4e, 0x08, 0x1b, 0x5c, 0x1e, 0xd0, 0x27, 0xfc, 0xaf, 0x80, 0xda,\n      0xda, 0x1f, 0x84, 0xfc, 0x8e, 0x43, 0x60, 0xcb, 0x53, 0xc4, 0xb6, 0x9e,\n      0x63, 0xcb, 0x91, 0xb7, 0xca, 0xd3, 0x15, 0x63, 0x68, 0x59, 0x1b, 0xfb,\n      0x05, 0x8f, 0x72, 0x0f, 0x97, 0xaf, 0xc4, 0x73, 0xf9, 0x78, 0x55, 0xfb,\n      0x96, 0xe4, 0x54, 0xd4, 0x80, 0x18, 0x16, 0x00, 0x34, 0x9f, 0xd8, 0xdc,\n      0x12, 0x51, 0x46, 0x30, 0x44, 0x02, 0x20, 0x7e, 0x3c, 0xdd, 0x1d, 0x15,\n      0x08, 0xf6, 0x8d, 0x16, 0x63, 0x4a, 0x3a, 0x1e, 0xe1, 0x97, 0xc4, 0x50,\n      0xc9, 0x17, 0x65, 0xe5, 0xe2, 0x48, 0x24, 0x17, 0xb2, 0x5e, 0xe3, 0xa0,\n      0x19, 0x81, 0xc8, 0x02, 0x20, 0x59, 0x79, 0x5d, 0x09, 0x29, 0xc7, 0xd8,\n      0x4b, 0xad, 0xad, 0xe5, 0x05, 0x0e, 0x3b, 0x21, 0x19, 0x7d, 0xaa, 0xff,\n      0xa3, 0x29, 0xea, 0x07, 0xd5, 0xb4, 0x29, 0x1c, 0xa6, 0xe9, 0x2a, 0x72,\n      0xd9,\n    ]);\n\n    sendApduFn.mockResolvedValue(\n      Right({\n        data: mockResponse,\n        statusCode: new Uint8Array([0x90, 0x00]),\n      }),\n    );\n\n    // Mock crypto service\n    const mockDeviceId = new Uint8Array([0xaa, 0xbb, 0xcc, 0xdd]);\n    const mockCryptoService = {\n      sha3_256: vi.fn().mockReturnValue(mockDeviceId),\n    };\n\n    const taskWithMockCrypto = new ConnectToSecureChannelTask(mockInternalApi, {\n      connection: Right(mockWebSocket),\n      cryptoService: mockCryptoService,\n    });\n\n    const events: SecureChannelEvent[] = [];\n    const obs = taskWithMockCrypto.run();\n    obs.subscribe({\n      next: (event) => {\n        events.push(event);\n      },\n    });\n\n    expect(mockWebSocket.onmessage).toBeDefined();\n    // Send GetCertificate APDU (e052000000)\n    mockWebSocket.onmessage!({\n      data: JSON.stringify({\n        ...mockMessage,\n        query: \"exchange\",\n        nonce: 1,\n        data: \"e052000000\",\n      }),\n      type: \"\",\n      target: {} as WebSocket,\n    });\n\n    await new Promise((resolve) => setTimeout(resolve, TEST_DELAY));\n\n    // Verify the mock crypto service was called\n    expect(mockCryptoService.sha3_256).toHaveBeenCalledWith(\n      Uint8Array.from([\n        0x04, 0x1c, 0x74, 0x7a, 0x4e, 0x08, 0x1b, 0x5c, 0x1e, 0xd0, 0x27, 0xfc,\n        0xaf, 0x80, 0xda, 0xda, 0x1f, 0x84, 0xfc, 0x8e, 0x43, 0x60, 0xcb, 0x53,\n        0xc4, 0xb6, 0x9e, 0x63, 0xcb, 0x91, 0xb7, 0xca, 0xd3, 0x15, 0x63, 0x68,\n        0x59, 0x1b, 0xfb, 0x05, 0x8f, 0x72, 0x0f, 0x97, 0xaf, 0xc4, 0x73, 0xf9,\n        0x78, 0x55, 0xfb, 0x96, 0xe4, 0x54, 0xd4, 0x80, 0x18, 0x16, 0x00, 0x34,\n        0x9f, 0xd8, 0xdc, 0x12, 0x51,\n      ]),\n    );\n\n    // Verify the device ID from the mock crypto service was emitted\n    const deviceIdEvent = events.find(\n      (e) => e.type === SecureChannelEventType.DeviceId,\n    );\n    expect(deviceIdEvent).toBeDefined();\n    expect(deviceIdEvent?.payload?.deviceId).toBe(mockDeviceId);\n  });\n\n  it(\"should handle incoming EXCHANGE message with a device error\", async () => {\n    sendApduFn.mockResolvedValue(\n      Right({\n        data: new Uint8Array([]),\n        statusCode: new Uint8Array([0x55, 0x15]),\n      }),\n    );\n\n    const sendSpy = vi.spyOn(mockWebSocket, \"send\");\n    const events: SecureChannelEvent[] = [];\n    const obs = task.run();\n    obs.subscribe({\n      next: (event) => {\n        events.push(event);\n      },\n    });\n\n    expect(mockWebSocket.onmessage).toBeDefined();\n    mockWebSocket.onmessage!({\n      data: JSON.stringify({\n        ...mockMessage,\n        query: \"exchange\",\n        nonce: 1,\n        data: \"e053000000\",\n      }),\n      type: \"\",\n      target: {} as WebSocket,\n    });\n\n    await new Promise((resolve) => setTimeout(resolve, TEST_DELAY));\n\n    expect(sendSpy).toHaveBeenCalledExactlyOnceWith(\n      JSON.stringify({\n        nonce: 1,\n        response: \"error\",\n        data: \"\",\n      }),\n    );\n    expect(events).toStrictEqual([\n      {\n        type: SecureChannelEventType.PreExchange,\n        payload: {\n          nonce: 1,\n          apdu: new Uint8Array([0xe0, 0x53, 0x00, 0x00, 0x00]),\n        },\n      },\n      {\n        type: SecureChannelEventType.Error,\n        error: new SecureChannelError(\n          {\n            url: \"wss://test-host.com\",\n            errorMessage: \"Device is locked\",\n          },\n          SecureChannelErrorType.DeviceLocked,\n        ),\n      },\n    ]);\n  });\n\n  it(\"should handle incoming BULK message\", async () => {\n    sendApduFn.mockResolvedValue(\n      Right({\n        data: new Uint8Array([0x90, 0x00]),\n        statusCode: new Uint8Array([0x90, 0x00]),\n      }),\n    );\n    const completeFn: () => void = vi.fn();\n    const obs = task.run();\n    const events: SecureChannelEvent[] = [];\n    obs.subscribe({\n      next: (event: SecureChannelEvent) => {\n        events.push(event);\n      },\n      complete: () => completeFn(),\n    });\n\n    expect(mockWebSocket.onmessage).toBeDefined();\n    mockWebSocket.onmessage!({\n      data: JSON.stringify({\n        ...mockMessage,\n        query: \"bulk\",\n        nonce: 1,\n        data: [\"0000000100\", \"0000000200\", \"0000000300\"],\n      }),\n      type: \"\",\n      target: {} as WebSocket,\n    });\n\n    await new Promise((resolve) => setTimeout(resolve, TEST_DELAY));\n\n    expect(sendApduFn).toHaveBeenCalledTimes(3);\n    expect(events).toStrictEqual([\n      {\n        type: SecureChannelEventType.Progress,\n        payload: { progress: 0.33, index: 0, total: 3 },\n      },\n      {\n        type: SecureChannelEventType.Progress,\n        payload: { progress: 0.67, index: 1, total: 3 },\n      },\n      {\n        type: SecureChannelEventType.Progress,\n        payload: { progress: 1.0, index: 2, total: 3 },\n      },\n    ]);\n    expect(completeFn).toHaveBeenCalledOnce();\n  });\n\n  it(\"should handle incoming BULK message with a device error\", async () => {\n    sendApduFn.mockResolvedValue(\n      Right({\n        data: new Uint8Array([]),\n        statusCode: new Uint8Array([0x55, 0x01]),\n      }),\n    );\n    const completeFn: () => void = vi.fn();\n    const obs = task.run();\n    const events: SecureChannelEvent[] = [];\n    obs.subscribe({\n      next: (event: SecureChannelEvent) => {\n        events.push(event);\n      },\n      complete: () => completeFn(),\n    });\n\n    expect(mockWebSocket.onmessage).toBeDefined();\n    mockWebSocket.onmessage!({\n      data: JSON.stringify({\n        ...mockMessage,\n        query: \"bulk\",\n        nonce: 1,\n        data: [\"0000000100\", \"0000000200\", \"0000000300\"],\n      }),\n      type: \"\",\n      target: {} as WebSocket,\n    });\n\n    await new Promise((resolve) => setTimeout(resolve, TEST_DELAY));\n\n    expect(sendApduFn).toHaveBeenCalledTimes(1);\n    expect(events).toStrictEqual([\n      {\n        type: SecureChannelEventType.Error,\n        error: new SecureChannelError(\n          {\n            url: \"wss://test-host.com\",\n            errorMessage: \"User refused on the device\",\n          },\n          SecureChannelErrorType.RefusedByUser,\n        ),\n      },\n    ]);\n    expect(completeFn).toHaveBeenCalledOnce();\n  });\n\n  it(\"should handle incoming SUCCESS message\", () => {\n    const completeFn: () => void = vi.fn();\n    const events: SecureChannelEvent[] = [];\n    const observable = task.run();\n    observable.subscribe({\n      next: (event: SecureChannelEvent) => events.push(event),\n      complete: () => completeFn(),\n    });\n\n    mockWebSocket.onmessage!({\n      data: JSON.stringify({\n        ...mockMessage,\n        query: \"success\",\n        nonce: 1,\n        result: \"success result\",\n      }),\n      type: \"\",\n      target: {} as WebSocket,\n    });\n\n    expect(events).toStrictEqual([\n      { type: SecureChannelEventType.Result, payload: \"success result\" },\n    ]);\n    expect(completeFn).toHaveBeenCalledOnce();\n  });\n\n  it(\"should handle incoming WARNING message\", () => {\n    const events: SecureChannelEvent[] = [];\n    const observable = task.run();\n    observable.subscribe({\n      next: (event: SecureChannelEvent) => events.push(event),\n    });\n\n    expect(mockWebSocket.onmessage).toBeDefined();\n    mockWebSocket.onmessage!({\n      data: JSON.stringify({\n        ...mockMessage,\n        query: \"warning\",\n        nonce: 1,\n        data: \"warning message\",\n      }),\n      type: \"\",\n      target: {} as WebSocket,\n    });\n\n    expect(events).toStrictEqual([\n      {\n        type: SecureChannelEventType.Warning,\n        payload: { message: \"warning message\" },\n      },\n    ]);\n  });\n\n  it(\"should handle incoming ERROR message\", () => {\n    const events: SecureChannelEvent[] = [];\n    const observable = task.run();\n    observable.subscribe({\n      next: (event: SecureChannelEvent) => events.push(event),\n    });\n\n    expect(mockWebSocket.onmessage).toBeDefined();\n    mockWebSocket.onmessage!({\n      data: JSON.stringify({\n        ...mockMessage,\n        query: \"error\",\n        data: \"My error\",\n      }),\n      type: \"\",\n      target: {} as WebSocket,\n    });\n\n    expect(events).toStrictEqual([\n      {\n        type: SecureChannelEventType.Error,\n        error: new SecureChannelError({\n          url: \"wss://test-host.com\",\n          errorMessage: \"My error\",\n        }),\n      },\n    ]);\n  });\n});\n"],
  "mappings": "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",
  "names": ["WebSocket", "Right", "describe", "it", "vi", "SecureChannelEventType", "SecureChannelError", "SecureChannelErrorType", "ConnectToSecureChannelTask", "url", "TEST_DELAY", "mockWebSocket", "mockInternalApi", "taskArgs", "task", "sendApduFn", "mockMessage", "_", "events", "e", "resolve", "event", "sendSpy", "mockResponse", "mockDeviceId", "mockCryptoService", "taskWithMockCrypto", "deviceIdEvent", "completeFn", "obs"]
}

import{Left as I,Right as g}from"purify-ts";import{assign as i,fromObservable as D,fromPromise as p,setup as h}from"xstate";import{isSuccessCommandResult as V}from"../../../command/model/CommandResult";import{GetOsVersionCommand as A}from"../../../command/os/GetOsVersionCommand";import{UserInteractionRequired as l}from"../../../device-action/model/UserInteractionRequired";import{DEFAULT_UNLOCK_TIMEOUT_MS as f}from"../../../device-action/os/Const";import{GoToDashboardDeviceAction as x}from"../../../device-action/os/GoToDashboard/GoToDashboardDeviceAction";import{XStateDeviceAction as y}from"../../../device-action/xstate-utils/XStateDeviceAction";import{DeviceSessionStateType as E}from"../../../device-session/DeviceSessionState";import{ConnectToSecureChannelTask as L}from"../../../secure-channel/task/ConnectToSecureChannelTask";import{SecureChannelEventType as a}from"../../../secure-channel/task/types";import{installedAppResultGuard as w}from"./types";class _ extends y{makeStateMachine(n){const{getOsVersion:u,getDeviceVersion:d,getFirmwareVersion:m,listInstalledApps:S,getDeviceSessionState:r,setDeviceSessionState:s}=this.extractDependencies(n),o=this.input.unlockTimeout??f,c=new x({input:{unlockTimeout:o}}).makeStateMachine(n);return h({types:{input:{},context:{},output:{}},actors:{goToDashboard:c,getOsVersion:p(u),getDeviceVersion:p(d),getFirmwareVersion:p(m),listInstalledApps:D(S)},guards:{hasError:e=>e.context._internalState.error!==null},actions:{assignErrorFromEvent:i({_internalState:e=>({...e.context._internalState,error:e.event.error})})}}).createMachine({id:"ListInstalledAppsDeviceAction",initial:"DeviceReady",context:e=>({input:{unlockTimeout:e.input.unlockTimeout},intermediateValue:{requiredUserInteraction:l.None},_internalState:{error:null,getOsVersionResponse:null,deviceVersion:null,firmwareVersion:null,result:{installedApps:[]}}}),states:{DeviceReady:{always:{target:"GoToDashboard"}},GoToDashboard:{invoke:{id:"goToDashboard",src:"goToDashboard",input:e=>({unlockTimeout:e.context.input.unlockTimeout}),onSnapshot:{actions:i({intermediateValue:e=>({...e.context.intermediateValue,requiredUserInteraction:e.event.snapshot.context.intermediateValue.requiredUserInteraction})})},onDone:{target:"GoToDashboardCheck",actions:i({_internalState:e=>e.event.output.caseOf({Right:()=>e.context._internalState,Left:t=>({...e.context._internalState,error:t})})})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},GoToDashboardCheck:{always:[{target:"Error",guard:"hasError"},{target:"GetOsVersion"}]},GetOsVersion:{invoke:{id:"getOsVersion",src:"getOsVersion",input:e=>{},onDone:{target:"GetOsVersionCheck",actions:i({_internalState:e=>{if(V(e.event.output)){const t=r(),v=e.event.output.data.secureElementFlags.isSecureConnectionAllowed;return t.sessionStateType!==E.Connected&&s({...t,isSecureConnectionAllowed:v}),{...e.context._internalState,getOsVersionResponse:e.event.output.data}}return{...e.context._internalState,error:e.event.output.error}}})}}},GetOsVersionCheck:{always:[{target:"Error",guard:"hasError"},{target:"GetDeviceVersion"}]},GetDeviceVersion:{invoke:{id:"getDeviceVersion",src:"getDeviceVersion",input:e=>({deviceInfo:e.context._internalState.getOsVersionResponse}),onDone:{target:"GetDeviceVersionCheck",actions:i({_internalState:e=>e.event.output.caseOf({Right:t=>({...e.context._internalState,deviceVersion:t}),Left:t=>({...e.context._internalState,error:t})})})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},GetDeviceVersionCheck:{always:[{target:"Error",guard:"hasError"},{target:"GetFirmwareVersion"}]},GetFirmwareVersion:{invoke:{id:"getFirmwareVersion",src:"getFirmwareVersion",input:e=>({deviceInfo:e.context._internalState.getOsVersionResponse,deviceVersion:e.context._internalState.deviceVersion}),onDone:{target:"GetFirmwareVersionCheck",actions:i({_internalState:e=>e.event.output.caseOf({Right:t=>({...e.context._internalState,firmwareVersion:t}),Left:t=>({...e.context._internalState,error:t})})})},onError:{target:"Error",actions:"assignErrorFromEvent"}}},GetFirmwareVersionCheck:{always:[{target:"Error",guard:"hasError"},{target:"ListInstalledApps"}]},ListInstalledApps:{invoke:{id:"listInstalledApps",src:"listInstalledApps",input:e=>({deviceInfo:e.context._internalState.getOsVersionResponse,finalFirmware:e.context._internalState.firmwareVersion}),onSnapshot:{actions:i({intermediateValue:e=>{switch(e.event.snapshot.context?.type){case a.DeviceId:return{...e.context.intermediateValue,deviceId:e.event.snapshot.context.payload.deviceId};case a.PermissionRequested:return{...e.context.intermediateValue,requiredUserInteraction:l.AllowSecureConnection};case a.PermissionGranted:return{...e.context.intermediateValue,requiredUserInteraction:l.None};default:return{...e.context.intermediateValue}}},_internalState:e=>{if(e.event.snapshot.context?.type===a.Error)return{...e.context._internalState,error:e.event.snapshot.context.error.mapDAErrors()};if(e.event.snapshot.context?.type===a.Result){if(w(e.event.snapshot.context.payload))return{...e.context._internalState,result:{installedApps:e.event.snapshot.context.payload}};throw new Error(`Invalid result ${JSON.stringify(e.event.snapshot.context.payload)}`)}return{...e.context._internalState}}})},onDone:{target:"Success"},onError:{target:"Error",actions:"assignErrorFromEvent"}}},ListInstalledAppsCheck:{always:[{target:"Error",guard:"hasError"},{target:"Success"}]},Success:{type:"final"},Error:{type:"final"}},output:e=>e.context._internalState.error?I(e.context._internalState.error):g(e.context._internalState.result)})}extractDependencies(n){return{getOsVersion:()=>n.sendCommand(new A),getDeviceVersion:({input:r})=>{const{deviceInfo:s}=r;return n.getManagerApiService().getDeviceVersion(s)},getFirmwareVersion:({input:r})=>{const{deviceInfo:s,deviceVersion:o}=r;return n.getManagerApiService().getFirmwareVersion(s,o)},listInstalledApps:({input:r})=>{const{deviceInfo:s,finalFirmware:o}=r,c=n.getSecureChannelService().listInstalledApps(s,o);return new L(n,{connection:c}).run()},getDeviceSessionState:()=>n.getDeviceSessionState(),setDeviceSessionState:r=>n.setDeviceSessionState(r)}}}export{_ as ListInstalledAppsDeviceAction};
//# sourceMappingURL=ListInstalledAppsDeviceAction.js.map

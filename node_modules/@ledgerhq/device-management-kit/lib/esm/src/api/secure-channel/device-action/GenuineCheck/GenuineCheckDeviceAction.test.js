import{Left as C,Right as s}from"purify-ts";import{concat as P,of as v,throwError as I}from"rxjs";import{CommandResultFactory as g}from"../../../command/model/CommandResult";import{DeviceStatus as h}from"../../../device/DeviceStatus";import{makeDeviceActionInternalApiMock as V}from"../../../device-action/__test-utils__/makeInternalApi";import{setupGoToDashboardMock as S}from"../../../device-action/__test-utils__/setupTestMachine";import{testDeviceActionStates as k}from"../../../device-action/__test-utils__/testDeviceActionStates";import{DeviceActionStatus as e}from"../../../device-action/model/DeviceActionState";import{UserInteractionRequired as n}from"../../../device-action/model/UserInteractionRequired";import{DeviceSessionStateType as y}from"../../../device-session/DeviceSessionState";import{SecureChannelEventType as r}from"../../../secure-channel/task/types";import{HttpFetchApiError as f}from"../../../../internal/manager-api/model/Errors";import{SecureChannelError as w}from"../../../../internal/secure-channel/model/Errors";import{GenuineCheckDeviceAction as D}from"./GenuineCheckDeviceAction";vi.mock("@api/device-action/os/GoToDashboard/GoToDashboardDeviceAction");describe("GenuineCheckDeviceAction",()=>{const c=vi.fn(),u=vi.fn(),d=vi.fn(),l=vi.fn(),m=vi.fn(),A=vi.fn(),p=()=>({getOsVersion:c,getDeviceVersion:u,getFirmwareVersion:d,genuineCheck:l,getDeviceSessionState:m,setDeviceSessionState:A});beforeEach(()=>{vi.resetAllMocks()}),it("should return the result of the genuine check",()=>new Promise((i,o)=>{S(),c.mockResolvedValue(g({data:{targetId:"123456",secureElementFlags:{isSecureConnectionAllowed:!1}}})),u.mockResolvedValue(s({id:123456})),d.mockResolvedValue(s({perso:"perso_test"})),m.mockReturnValue({sessionStateType:y.ReadyWithoutSecureChannel,deviceStatus:h.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),l.mockReturnValue(v({type:r.Exchange,payload:{data:new Uint8Array([0,1,2,3])}},{type:r.PermissionRequested},{type:r.PermissionGranted},{type:r.Result,payload:"0000"}));const a=[{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.AllowSecureConnection}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Completed,output:{isGenuine:!0}}],t=new D({input:{}});vi.spyOn(t,"extractDependencies").mockImplementation(p),k(t,a,V(),{onDone:i,onError:o})})),it("should return error when error occurs in fetching device version",()=>new Promise((i,o)=>{S(),c.mockResolvedValue(g({data:{targetId:"123456",secureElementFlags:{isSecureConnectionAllowed:!1}}})),u.mockResolvedValue(C(new f("Device version fetch failed"))),d.mockResolvedValue(s({perso:"perso_test"})),m.mockReturnValue({sessionStateType:y.ReadyWithoutSecureChannel,deviceStatus:h.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),l.mockReturnValue(v({type:r.Exchange,payload:{data:new Uint8Array([0,1,2,3])}},{type:r.Result,payload:"0000"}));const a=[{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Error,error:new f("Device version fetch failed")}],t=new D({input:{}});vi.spyOn(t,"extractDependencies").mockImplementation(p),k(t,a,V(),{onDone:i,onError:o})})),it("should return error when error occurs in fetching firmware version",()=>new Promise((i,o)=>{S(),c.mockResolvedValue(g({data:{targetId:"123456",secureElementFlags:{isSecureConnectionAllowed:!1}}})),u.mockResolvedValue(s({id:123456})),d.mockResolvedValue(C(new f("Firmware version fetch failed"))),m.mockReturnValue({sessionStateType:y.ReadyWithoutSecureChannel,deviceStatus:h.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),l.mockReturnValue(v({type:r.Exchange,payload:{data:new Uint8Array([0,1,2,3])}},{type:r.Result,payload:"0000"}));const a=[{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Error,error:new f("Firmware version fetch failed")}],t=new D({input:{}});vi.spyOn(t,"extractDependencies").mockImplementation(p),k(t,a,V(),{onDone:i,onError:o})})),it("should return error when error occurs in communicating with secure channel",()=>new Promise((i,o)=>{S(),c.mockResolvedValue(g({data:{targetId:"123456",secureElementFlags:{isSecureConnectionAllowed:!1}}})),u.mockResolvedValue(s({id:123456})),d.mockResolvedValue(s({perso:"perso_test"})),m.mockReturnValue({sessionStateType:y.ReadyWithoutSecureChannel,deviceStatus:h.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),l.mockReturnValue(P(v({type:r.Exchange,payload:{data:new Uint8Array([0,1,2,3])}}),I(()=>new w("Secure channel error"))));const a=[{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:n.None}},{status:e.Error,error:new w("Secure channel error")}],t=new D({input:{}});vi.spyOn(t,"extractDependencies").mockImplementation(p),k(t,a,V(),{onDone:i,onError:o})}))});
//# sourceMappingURL=GenuineCheckDeviceAction.test.js.map

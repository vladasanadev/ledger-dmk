import{Right as A}from"purify-ts";import{of as N,throwError as U}from"rxjs";import{CommandResultFactory as v}from"../../../command/model/CommandResult";import{DeviceStatus as I}from"../../../device/DeviceStatus";import{makeDeviceActionInternalApiMock as u}from"../../../device-action/__test-utils__/makeInternalApi";import{setupGoToDashboardMock as f,setupListInstalledAppsMock as p}from"../../../device-action/__test-utils__/setupTestMachine";import{testDeviceActionStates as d}from"../../../device-action/__test-utils__/testDeviceActionStates";import{DeviceActionStatus as e}from"../../../device-action/model/DeviceActionState";import{UserInteractionRequired as t}from"../../../device-action/model/UserInteractionRequired";import{UnknownDAError as S}from"../../../device-action/os/Errors";import{DeviceSessionStateType as V}from"../../../device-session/DeviceSessionState";import{SecureChannelEventType as y}from"../../../secure-channel/task/types";import{SecureChannelError as g}from"../../../../internal/secure-channel/model/Errors";import{UninstallAppDeviceAction as m}from"./UninstallAppDeviceAction";vi.mock("@api/secure-channel/device-action/ListInstalledApps/ListInstalledAppsDeviceAction");vi.mock("@api/device-action/os/GoToDashboard/GoToDashboardDeviceAction");describe("UninstallAppDeviceAction",()=>{const a=vi.fn(),o=vi.fn(),h=vi.fn(),c=vi.fn(),D=vi.fn(),l=()=>({getOsVersion:a,getAppsByHash:o,uninstallApp:h,getDeviceSessionState:c,setDeviceSessionState:D});beforeEach(()=>{vi.resetAllMocks()}),it("should finish successfully when the app is not installed on the device",()=>new Promise((i,s)=>{p([{installedApps:[{name:"Bitcoin"}]}]);const r=[{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Completed,output:void 0}],n=new m({input:{appName:"Ethereum"}});vi.spyOn(n,"extractDependencies").mockImplementation(l),d(n,r,u(),{onDone:i,onError:s})})),it("should finish successfully when the app is installed on the device",()=>new Promise((i,s)=>{p([{installedApps:[{name:"Bitcoin"}]},{installedApps:[]}]),f(),a.mockResolvedValue(v({data:{targetId:12345678,secureElementFlags:{isSecureConnectionAllowed:!0}}})),c.mockReturnValue({sessionStateType:V.ReadyWithoutSecureChannel,deviceStatus:I.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),o.mockResolvedValue(A([{versionName:"Bitcoin",perso:"test_perso",firmware:"test_firmware_for_bitcoin",firmwareKey:"test_firmware_key_for_bitcoin",hash:"test_hash_for_bitcoin"}])),h.mockReturnValue(N({type:y.Exchange}));const r=[{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Completed,output:void 0}],n=new m({input:{appName:"Bitcoin"}});vi.spyOn(n,"extractDependencies").mockImplementation(l),d(n,r,u(),{onDone:i,onError:s})})),it("should finish unsuccessfully when the app is a dependency of other installed apps",()=>new Promise((i,s)=>{p([{installedApps:[{name:"Bitcoin"},{name:"Testcoin"}]}]),f(),a.mockResolvedValue(v({data:{targetId:12345678,secureElementFlags:{isSecureConnectionAllowed:!0}}})),c.mockReturnValue({sessionStateType:V.ReadyWithoutSecureChannel,deviceStatus:I.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),o.mockResolvedValue(A([{versionName:"Testcoin",parentName:"Bitcoin"},{versionName:"Bitcoin"}]));const r=[{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Error,error:new S("App to uninstall is a dependency of another installed app")}],n=new m({input:{appName:"Bitcoin"}});vi.spyOn(n,"extractDependencies").mockImplementation(l),d(n,r,u(),{onDone:i,onError:s})})),it("should finish unsuccessfully when the app is not found in manager API",()=>new Promise((i,s)=>{p([{installedApps:[{name:"Bitcoin"}]}]),f(),a.mockResolvedValue(v({data:{targetId:12345678,secureElementFlags:{isSecureConnectionAllowed:!0}}})),c.mockReturnValue({}),o.mockResolvedValueOnce(A([]));const r=[{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Error,error:new S("App to uninstall not found in manager API")}],n=new m({input:{appName:"Bitcoin"}});vi.spyOn(n,"extractDependencies").mockImplementation(l),d(n,r,u(),{onDone:i,onError:s})})),it("should finish unsuccessfully when there is error in uninstallApp",()=>new Promise((i,s)=>{p([{installedApps:[{name:"Bitcoin"}]}]),f(),a.mockResolvedValue(v({data:{targetId:12345678,secureElementFlags:{isSecureConnectionAllowed:!0}}})),c.mockReturnValue({}),o.mockResolvedValueOnce(A([{versionName:"Bitcoin"}])),h.mockReturnValue(U(()=>new g("Uninstall app error in secure channel")));const r=[{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Error,error:new g("Uninstall app error in secure channel")}],n=new m({input:{appName:"Bitcoin"}});vi.spyOn(n,"extractDependencies").mockImplementation(l),d(n,r,u(),{onDone:i,onError:s})}))});
//# sourceMappingURL=UninstallAppDeviceAction.test.js.map

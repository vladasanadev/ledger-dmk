import{Left as y,Right as s}from"purify-ts";import{concat as E,of as v,throwError as N}from"rxjs";import{CommandResultFactory as h}from"../../../command/model/CommandResult";import{DeviceStatus as V}from"../../../device/DeviceStatus";import{makeDeviceActionInternalApiMock as g}from"../../../device-action/__test-utils__/makeInternalApi";import{setupGoToDashboardMock as S}from"../../../device-action/__test-utils__/setupTestMachine";import{testDeviceActionStates as A}from"../../../device-action/__test-utils__/testDeviceActionStates";import{DeviceActionStatus as e}from"../../../device-action/model/DeviceActionState";import{UserInteractionRequired as t}from"../../../device-action/model/UserInteractionRequired";import{DeviceSessionStateType as I}from"../../../device-session/DeviceSessionState";import{SecureChannelEventType as o}from"../../../secure-channel/task/types";import{HttpFetchApiError as f}from"../../../../internal/manager-api/model/Errors";import{SecureChannelError as w}from"../../../../internal/secure-channel/model/Errors";import{ListInstalledAppsDeviceAction as D}from"./ListInstalledAppsDeviceAction";vi.mock("@api/device-action/os/GoToDashboard/GoToDashboardDeviceAction");describe("ListInstalledAppsDeviceAction",()=>{const c=vi.fn(),d=vi.fn(),l=vi.fn(),u=vi.fn(),m=vi.fn(),k=vi.fn(),p=()=>({getOsVersion:c,getDeviceVersion:d,getFirmwareVersion:l,listInstalledApps:u,getDeviceSessionState:m,setDeviceSessionState:k});beforeEach(()=>{vi.resetAllMocks()}),it("should return a list that contains all installed apps on the device",()=>new Promise((r,i)=>{S(),c.mockResolvedValue(h({data:{targetId:"123456",secureElementFlags:{isSecureConnectionAllowed:!0}}})),d.mockResolvedValue(s({id:123456})),l.mockResolvedValue(s({perso:"perso_test"})),m.mockReturnValue({sessionStateType:I.ReadyWithoutSecureChannel,deviceStatus:V.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),u.mockReturnValue(v({type:o.Exchange},{type:o.Result,payload:[{flags:123456,hash:"hash_test",hash_code_data:"hash_code_data_test",name:"Bitcoin"}]}));const a=[{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Completed,output:{installedApps:[{flags:123456,hash:"hash_test",hash_code_data:"hash_code_data_test",name:"Bitcoin"}]}}],n=new D({input:{}});vi.spyOn(n,"extractDependencies").mockImplementation(p),A(n,a,g(),{onDone:r,onError:i})})),it("should return error when error occurs in fetching device version",()=>new Promise((r,i)=>{S(),c.mockResolvedValue(h({data:{targetId:"123456",secureElementFlags:{isSecureConnectionAllowed:!1}}})),d.mockResolvedValue(y(new f("Device version fetch failed"))),l.mockResolvedValue(s({perso:"perso_test"})),m.mockReturnValue({sessionStateType:I.ReadyWithoutSecureChannel,deviceStatus:V.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),u.mockReturnValue(v({type:o.Exchange,payload:{data:new Uint8Array([0,1,2,3])}},{type:o.Result,payload:[]}));const a=[{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Error,error:new f("Device version fetch failed")}],n=new D({input:{}});vi.spyOn(n,"extractDependencies").mockImplementation(p),A(n,a,g(),{onDone:r,onError:i})})),it("should return error when error occurs in fetching firmware version",()=>new Promise((r,i)=>{S(),c.mockResolvedValue(h({data:{targetId:"123456",secureElementFlags:{isSecureConnectionAllowed:!1}}})),d.mockResolvedValue(s({id:123456})),l.mockResolvedValue(y(new f("Firmware version fetch failed"))),m.mockReturnValue({sessionStateType:I.ReadyWithoutSecureChannel,deviceStatus:V.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),u.mockReturnValue(v({type:o.Exchange,payload:{data:new Uint8Array([0,1,2,3])}},{type:o.Result,payload:[]}));const a=[{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Error,error:new f("Firmware version fetch failed")}],n=new D({input:{}});vi.spyOn(n,"extractDependencies").mockImplementation(p),A(n,a,g(),{onDone:r,onError:i})})),it("should return error when error occurs in communicating with secure channel",()=>new Promise((r,i)=>{S(),c.mockResolvedValue(h({data:{targetId:"123456",secureElementFlags:{isSecureConnectionAllowed:!1}}})),d.mockResolvedValue(s({id:123456})),l.mockResolvedValue(s({perso:"perso_test"})),m.mockReturnValue({sessionStateType:I.ReadyWithoutSecureChannel,deviceStatus:V.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),u.mockReturnValue(E(v({type:o.Exchange,payload:{data:new Uint8Array([0,1,2,3])}}),N(()=>new w("Secure channel error"))));const a=[{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None}},{status:e.Error,error:new w("Secure channel error")}],n=new D({input:{}});vi.spyOn(n,"extractDependencies").mockImplementation(p),A(n,a,g(),{onDone:r,onError:i})}))});
//# sourceMappingURL=ListInstalledAppsDeviceAction.test.js.map

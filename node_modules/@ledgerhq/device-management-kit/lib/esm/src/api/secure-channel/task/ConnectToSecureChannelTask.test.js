import S from"isomorphic-ws";import{Right as l}from"purify-ts";import{describe as w,it as c,vi as x}from"vitest";import{SecureChannelEventType as o}from"../../secure-channel/task/types";import{SecureChannelError as m,SecureChannelErrorType as f}from"../../../internal/secure-channel/model/Errors";import{ConnectToSecureChannelTask as v}from"./ConnectToSecureChannelTask";x.mock("isomorphic-ws",()=>({...x.importActual("isomorphic-ws"),__esModule:!0,default:class{onopen=null;onmessage=null;send=x.fn();close=x.fn();url;constructor(n){this.url=n}}}));const u=5;w("ConnectToSecureChannelTask",()=>{let n,y,b,r;const i=x.fn(),d={uuid:"5b776c8d-8af2-48c0-8250-04edca2ef5e9",session:"39ce749e-00a4-4c31-a697-1dc1a29e2cab",query:"success",nonce:15};beforeEach(()=>{n=new S("wss://test-host.com"),y={sendApdu:i,disableRefresher:e=>x.fn()},b={connection:l(n)},r=new v(y,b)}),afterEach(()=>{x.resetAllMocks()}),c("should emit Opened event on WebSocket open",async()=>{const e=[];r.run().subscribe(t=>e.push(t)),expect(n.onopen).toBeDefined(),n.onopen({type:"open",target:{}}),await new Promise(t=>setTimeout(t,u)),expect(e).toStrictEqual([{type:o.Opened}])}),c("Error on wrongly formatted message",async()=>{const e=[];r.run().subscribe({next:t=>{e.push(t)}}),expect(n.onmessage).toBeDefined(),n.onmessage({data:"invalidData",type:"",target:{}}),await new Promise(t=>setTimeout(t,u)),expect(e).toStrictEqual([{type:o.Error,error:new m({url:"wss://test-host.com",errorMessage:"Invalid message received: invalidData"})}])}),c("should handle incoming EXCHANGE message including requesting user permission",async()=>{i.mockResolvedValue(l({data:new Uint8Array([144,0]),statusCode:new Uint8Array([144,0])}));const e=x.spyOn(n,"send");x.spyOn(r,"isSecureConnectionAllowed").mockReturnValueOnce(!1);const s=[];r.run().subscribe({next:a=>{s.push(a)}}),expect(n.onmessage).toBeDefined(),n.onmessage({data:JSON.stringify({...d,query:"exchange",nonce:1,data:"e051000000"}),type:"",target:{}}),await new Promise(a=>setTimeout(a,u)),expect(e).toHaveBeenCalledExactlyOnceWith(JSON.stringify({nonce:1,response:"success",data:"9000"})),expect(s).toStrictEqual([{type:o.PreExchange,payload:{nonce:1,apdu:new Uint8Array([224,81,0,0,0])}},{type:o.PermissionRequested},{type:o.Exchange,payload:{nonce:1,apdu:new Uint8Array([224,81,0,0,0]),data:new Uint8Array([144,0]),status:new Uint8Array([144,0])}},{type:o.PermissionGranted}])}),c("should capture and emit device ID on first GetCertificate APDU",async()=>{const e=new Uint8Array([7,74,7,161,82,230,187,193,65,4,28,116,122,78,8,27,92,30,208,39,252,175,128,218,218,31,132,252,142,67,96,203,83,196,182,158,99,203,145,183,202,211,21,99,104,89,27,251,5,143,114,15,151,175,196,115,249,120,85,251,150,228,84,212,128,24,22,0,52,159,216,220,18,81,70,48,68,2,32,126,60,221,29,21,8,246,141,22,99,74,58,30,225,151,196,80,201,23,101,229,226,72,36,23,178,94,227,160,25,129,200,2,32,89,121,93,9,41,199,216,75,173,173,229,5,14,59,33,25,125,170,255,163,41,234,7,213,180,41,28,166,233,42,114,217]);i.mockResolvedValue(l({data:e,statusCode:new Uint8Array([144,0])}));const s=new Uint8Array([170,187,204,221]),t={sha3_256:x.fn().mockReturnValue(s)},a=new v(y,{connection:l(n),cryptoService:t}),g=[];a.run().subscribe({next:p=>{g.push(p)}}),expect(n.onmessage).toBeDefined(),n.onmessage({data:JSON.stringify({...d,query:"exchange",nonce:1,data:"e052000000"}),type:"",target:{}}),await new Promise(p=>setTimeout(p,u)),expect(t.sha3_256).toHaveBeenCalledWith(Uint8Array.from([4,28,116,122,78,8,27,92,30,208,39,252,175,128,218,218,31,132,252,142,67,96,203,83,196,182,158,99,203,145,183,202,211,21,99,104,89,27,251,5,143,114,15,151,175,196,115,249,120,85,251,150,228,84,212,128,24,22,0,52,159,216,220,18,81]));const h=g.find(p=>p.type===o.DeviceId);expect(h).toBeDefined(),expect(h?.payload?.deviceId).toBe(s)}),c("should handle incoming EXCHANGE message with a device error",async()=>{i.mockResolvedValue(l({data:new Uint8Array([]),statusCode:new Uint8Array([85,21])}));const e=x.spyOn(n,"send"),s=[];r.run().subscribe({next:a=>{s.push(a)}}),expect(n.onmessage).toBeDefined(),n.onmessage({data:JSON.stringify({...d,query:"exchange",nonce:1,data:"e053000000"}),type:"",target:{}}),await new Promise(a=>setTimeout(a,u)),expect(e).toHaveBeenCalledExactlyOnceWith(JSON.stringify({nonce:1,response:"error",data:""})),expect(s).toStrictEqual([{type:o.PreExchange,payload:{nonce:1,apdu:new Uint8Array([224,83,0,0,0])}},{type:o.Error,error:new m({url:"wss://test-host.com",errorMessage:"Device is locked"},f.DeviceLocked)}])}),c("should handle incoming BULK message",async()=>{i.mockResolvedValue(l({data:new Uint8Array([144,0]),statusCode:new Uint8Array([144,0])}));const e=x.fn(),s=r.run(),t=[];s.subscribe({next:a=>{t.push(a)},complete:()=>e()}),expect(n.onmessage).toBeDefined(),n.onmessage({data:JSON.stringify({...d,query:"bulk",nonce:1,data:["0000000100","0000000200","0000000300"]}),type:"",target:{}}),await new Promise(a=>setTimeout(a,u)),expect(i).toHaveBeenCalledTimes(3),expect(t).toStrictEqual([{type:o.Progress,payload:{progress:.33,index:0,total:3}},{type:o.Progress,payload:{progress:.67,index:1,total:3}},{type:o.Progress,payload:{progress:1,index:2,total:3}}]),expect(e).toHaveBeenCalledOnce()}),c("should handle incoming BULK message with a device error",async()=>{i.mockResolvedValue(l({data:new Uint8Array([]),statusCode:new Uint8Array([85,1])}));const e=x.fn(),s=r.run(),t=[];s.subscribe({next:a=>{t.push(a)},complete:()=>e()}),expect(n.onmessage).toBeDefined(),n.onmessage({data:JSON.stringify({...d,query:"bulk",nonce:1,data:["0000000100","0000000200","0000000300"]}),type:"",target:{}}),await new Promise(a=>setTimeout(a,u)),expect(i).toHaveBeenCalledTimes(1),expect(t).toStrictEqual([{type:o.Error,error:new m({url:"wss://test-host.com",errorMessage:"User refused on the device"},f.RefusedByUser)}]),expect(e).toHaveBeenCalledOnce()}),c("should handle incoming SUCCESS message",()=>{const e=x.fn(),s=[];r.run().subscribe({next:a=>s.push(a),complete:()=>e()}),n.onmessage({data:JSON.stringify({...d,query:"success",nonce:1,result:"success result"}),type:"",target:{}}),expect(s).toStrictEqual([{type:o.Result,payload:"success result"}]),expect(e).toHaveBeenCalledOnce()}),c("should handle incoming WARNING message",()=>{const e=[];r.run().subscribe({next:t=>e.push(t)}),expect(n.onmessage).toBeDefined(),n.onmessage({data:JSON.stringify({...d,query:"warning",nonce:1,data:"warning message"}),type:"",target:{}}),expect(e).toStrictEqual([{type:o.Warning,payload:{message:"warning message"}}])}),c("should handle incoming ERROR message",()=>{const e=[];r.run().subscribe({next:t=>e.push(t)}),expect(n.onmessage).toBeDefined(),n.onmessage({data:JSON.stringify({...d,query:"error",data:"My error"}),type:"",target:{}}),expect(e).toStrictEqual([{type:o.Error,error:new m({url:"wss://test-host.com",errorMessage:"My error"})}])})});
//# sourceMappingURL=ConnectToSecureChannelTask.test.js.map

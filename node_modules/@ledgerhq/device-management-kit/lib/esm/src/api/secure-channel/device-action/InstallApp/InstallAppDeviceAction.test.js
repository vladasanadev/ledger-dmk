import{Right as g}from"purify-ts";import{of as D,throwError as y}from"rxjs";import{CommandResultFactory as A}from"../../../command/model/CommandResult";import{DeviceStatus as P}from"../../../device/DeviceStatus";import{makeDeviceActionInternalApiMock as l}from"../../../device-action/__test-utils__/makeInternalApi";import{setupGoToDashboardMock as I,setupListInstalledAppsMock as u}from"../../../device-action/__test-utils__/setupTestMachine";import{testDeviceActionStates as d}from"../../../device-action/__test-utils__/testDeviceActionStates";import{DeviceActionStatus as e}from"../../../device-action/model/DeviceActionState";import{UserInteractionRequired as t}from"../../../device-action/model/UserInteractionRequired";import{UnknownDAError as S}from"../../../device-action/os/Errors";import{DeviceSessionStateType as f}from"../../../device-session/DeviceSessionState";import{SecureChannelEventType as V}from"../../../secure-channel/task/types";import{SecureChannelError as N}from"../../../../internal/secure-channel/model/Errors";import{InstallAppDeviceAction as m}from"./InstallAppDeviceAction";vi.mock("@api/secure-channel/device-action/ListInstalledApps/ListInstalledAppsDeviceAction");vi.mock("@api/device-action/os/GoToDashboard/GoToDashboardDeviceAction");describe("InstallAppDeviceAction",()=>{const o=vi.fn(),a=vi.fn(),v=vi.fn(),p=vi.fn(),h=vi.fn(),c=()=>({getOsVersion:o,getAppList:a,installApp:v,getDeviceSessionState:p,setDeviceSessionState:h});beforeEach(()=>{vi.resetAllMocks()}),it("should finish successfully when the app is already installed on the device",()=>new Promise((r,s)=>{u([{installedApps:[{name:"Bitcoin"}]}]);const i=[{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Completed,output:void 0}],n=new m({input:{appName:"Bitcoin"}});vi.spyOn(n,"extractDependencies").mockImplementation(c),d(n,i,l(),{onDone:r,onError:s})})),it("should finish successfully when the app is not installed",()=>new Promise((r,s)=>{u([{installedApps:[]},{installedApps:[{name:"Bitcoin"}]}]),I(),o.mockResolvedValue(A({data:{targetId:12345678,secureElementFlags:{isSecureConnectionAllowed:!0}}})),p.mockReturnValue({sessionStateType:f.ReadyWithoutSecureChannel,deviceStatus:P.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),a.mockResolvedValue(g([{versionName:"Bitcoin",perso:"test_perso",firmware:"test_firmware_for_bitcoin",firmwareKey:"test_firmware_key_for_bitcoin",hash:"test_hash_for_bitcoin"}])),v.mockImplementation(()=>D({type:V.Progress,payload:{progress:0}},{type:V.Progress,payload:{progress:.55}},{type:V.Progress,payload:{progress:1}}));const i=[{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:.55}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:1}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:1}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:1}},{status:e.Completed,output:void 0}],n=new m({input:{appName:"Bitcoin"}});vi.spyOn(n,"extractDependencies").mockImplementation(c),d(n,i,l(),{onDone:r,onError:s})})),it("should finish unsuccessfully when the dep app is not installed",()=>new Promise((r,s)=>{u([{installedApps:[]}]),I(),o.mockResolvedValue(A({data:{targetId:12345678,secureElementFlags:{isSecureConnectionAllowed:!0}}})),p.mockReturnValue({sessionStateType:f.ReadyWithoutSecureChannel,deviceStatus:P.CONNECTED,currentApp:{name:"BOLOS",version:"0.0.0"},isSecureConnectionAllowed:!1}),a.mockResolvedValue(g([{versionName:"Bitcoin",parentName:"test_parent"}]));const i=[{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Error,error:new S("Dep app is not installed on the device")}],n=new m({input:{appName:"Bitcoin"}});vi.spyOn(n,"extractDependencies").mockImplementation(c),d(n,i,l(),{onDone:r,onError:s})})),it("should finish unsuccessfully when the app is not found in manager API",()=>new Promise((r,s)=>{u([{installedApps:[]}]),I(),o.mockResolvedValue(A({data:{targetId:12345678,secureElementFlags:{isSecureConnectionAllowed:!0}}})),p.mockReturnValue({}),a.mockResolvedValueOnce(g([]));const i=[{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Error,error:new S("App to install not found in manager API")}],n=new m({input:{appName:"Bitcoin"}});vi.spyOn(n,"extractDependencies").mockImplementation(c),d(n,i,l(),{onDone:r,onError:s})})),it("should finish unsuccessfully when there is error in installApp",()=>new Promise((r,s)=>{u([{installedApps:[]}]),I(),o.mockResolvedValue(A({data:{targetId:12345678,secureElementFlags:{isSecureConnectionAllowed:!0}}})),p.mockReturnValue({}),a.mockResolvedValueOnce(g([{versionName:"Bitcoin"}])),v.mockReturnValue(y(()=>new N("Install app error in secure channel")));const i=[{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Pending,intermediateValue:{requiredUserInteraction:t.None,progress:0}},{status:e.Error,error:new N("Install app error in secure channel")}],n=new m({input:{appName:"Bitcoin"}});vi.spyOn(n,"extractDependencies").mockImplementation(c),d(n,i,l(),{onDone:r,onError:s})}))});
//# sourceMappingURL=InstallAppDeviceAction.test.js.map

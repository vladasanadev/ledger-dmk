var S=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var d=(s,e,r,t)=>{for(var n=t>1?void 0:t?N(e,r):e,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=(t?a(e,r,n):a(n))||n);return t&&n&&S(e,r,n),n},l=(s,e)=>(r,t)=>e(r,t,s);import{inject as R,injectable as T}from"inversify";import{Just as u,Left as F,Maybe as U,Nothing as p,Right as H}from"purify-ts";import{v4 as C}from"uuid";import{ApduResponse as D}from"../../../api/device-session/ApduResponse";import{APDU_DATA_LENGTH_LENGTH as G,CHANNEL_LENGTH as P,HEAD_TAG_LENGTH as o,INDEX_LENGTH as c}from"../../../api/device-session/data/FramerConst";import{FramerUtils as h}from"../../../api/device-session/utils/FramerUtils";import{APDU_RESPONSE_STATUS_CODE_LENGTH as _}from"../../device-session/data/ApduResponseConst";import{ReceiverApduError as A}from"../../device-session/model/Errors";import{Frame as z}from"../../device-session/model/Frame";import{FrameHeader as x}from"../../device-session/model/FrameHeader";import{loggerTypes as B}from"../../logger-publisher/di/loggerTypes";let g=class{_channel;_logger;_pendingFrames;constructor({channel:e=U.zero()},r){this._channel=e,this._logger=r("ApduReceiverService"),this._pendingFrames=[]}handleFrame(e){return this.getFrameFromBytes(e).map(t=>{if(this._pendingFrames.push(t),!this._pendingFrames[0])return p;const n=this._pendingFrames[0].getHeader().getDataLength();return this.getCompleteFrame(n)})}getCompleteFrame(e){return e.chain(r=>{if(!this.isComplete(r))return this._logger.debug("frame is not complete, waiting for more"),p;const t=h.getFirstBytesFrom(this.concatFrames(this._pendingFrames),r),n=h.getFirstBytesFrom(t,t.length-_),i=h.getLastBytesFrom(t,_);return this._pendingFrames=[],u(new D({data:n,statusCode:i}))})}getFrameFromBytes(e){const r=this._channel.caseOf({Just:()=>P,Nothing:()=>0}),t=e.slice(r,r+o),n=e.slice(r+o,r+o+c),i=n.reduce((L,b)=>L+b,0)===0;if(!i&&this._pendingFrames.length===0)return F(new A);const a=r+o+c,m=i?G:0;if(e.length<r+o+c+m)return F(new A("Unable to parse header from apdu"));const f=i?u(e.slice(a,a+m)):p,y=a+m,v=e.slice(y),E=new z({header:new x({uuid:C(),channel:this._channel,dataSize:f,headTag:t,index:n,length:r+o+c+m}),data:v});return H(E)}isComplete(e){return this._pendingFrames.reduce((t,n)=>t+n.getData().length,0)>=e}concatFrames(e){return e.reduce((r,t)=>Uint8Array.from([...r,...t.getData()]),new Uint8Array(0))}};g=d([T(),l(1,R(B.LoggerPublisherServiceFactory))],g);export{g as DefaultApduReceiverService};
//# sourceMappingURL=DefaultApduReceiverService.js.map

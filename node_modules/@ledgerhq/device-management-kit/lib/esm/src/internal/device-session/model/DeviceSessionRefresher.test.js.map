{
  "version": 3,
  "sources": ["../../../../../../src/internal/device-session/model/DeviceSessionRefresher.test.ts"],
  "sourcesContent": ["import { Subject } from \"rxjs\";\nimport { afterEach, beforeEach, describe, expect, it, vi } from \"vitest\";\n\nimport { DeviceModelId } from \"@api/device/DeviceModel\";\nimport { type TransportConnectedDevice } from \"@api/transport/model/TransportConnectedDevice\";\nimport type { LoggerPublisherService } from \"@api/types\";\nimport {\n  DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL,\n  DEVICE_SESSION_REFRESHER_POLLING_INTERVAL,\n} from \"@internal/device-session/data/DeviceSessionRefresherConst\";\nimport type {\n  DeviceSessionEventDispatcher,\n  NewEvent,\n} from \"@internal/device-session/model/DeviceSessionEventDispatcher\";\nimport { SessionEvents } from \"@internal/device-session/model/DeviceSessionEventDispatcher\";\n\nimport {\n  DeviceSessionRefresher,\n  type DeviceSessionRefresherOptions,\n} from \"./DeviceSessionRefresher\";\n\ndescribe(\"DeviceSessionRefresher\", () => {\n  let subject: Subject<NewEvent>;\n  let mockSessionEventDispatcher: DeviceSessionEventDispatcher;\n  let mockLogger: LoggerPublisherService & {\n    info: ReturnType<typeof vi.fn>;\n    warn: ReturnType<typeof vi.fn>;\n    error: ReturnType<typeof vi.fn>;\n    debug: ReturnType<typeof vi.fn>;\n    subscribers?: unknown[];\n  };\n\n  const stubDefaultDevice = {\n    deviceModel: {\n      id: DeviceModelId.FLEX,\n    },\n  } as TransportConnectedDevice;\n\n  const stubNanoSDevice = {\n    deviceModel: {\n      id: DeviceModelId.NANO_S,\n    },\n  } as TransportConnectedDevice;\n\n  const mockedLoggerModuleFactory = vi.fn(() => mockLogger);\n  let refresher: DeviceSessionRefresher;\n\n  beforeEach(() => {\n    vi.useFakeTimers();\n    subject = new Subject<NewEvent>();\n    mockSessionEventDispatcher = {\n      listen: () => subject.asObservable(),\n      dispatch: vi.fn(),\n    } as unknown as DeviceSessionEventDispatcher;\n    mockLogger = {\n      info: vi.fn(),\n      warn: vi.fn(),\n      error: vi.fn(),\n      debug: vi.fn(),\n      subscribers: [],\n    };\n  });\n\n  afterEach(() => {\n    refresher?.destroy();\n    vi.useRealTimers();\n    vi.restoreAllMocks();\n  });\n\n  it(\"should not start refresher if disabled\", () => {\n    const options: DeviceSessionRefresherOptions = {\n      isRefresherDisabled: true,\n      pollingInterval: 1000,\n    };\n\n    refresher = new DeviceSessionRefresher(\n      mockedLoggerModuleFactory,\n      options,\n      mockSessionEventDispatcher,\n      stubDefaultDevice,\n    );\n    refresher.startRefresher();\n    vi.advanceTimersByTime(2000);\n\n    expect(mockSessionEventDispatcher.dispatch).not.toHaveBeenCalled();\n  });\n\n  it(\"should warn and use minimum polling interval for default device when provided interval is too low\", () => {\n    const lowInterval = DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL - 100;\n    const options: DeviceSessionRefresherOptions = {\n      isRefresherDisabled: false,\n      pollingInterval: lowInterval,\n    };\n\n    refresher = new DeviceSessionRefresher(\n      mockedLoggerModuleFactory,\n      options,\n      mockSessionEventDispatcher,\n      stubDefaultDevice,\n    );\n    refresher.startRefresher();\n\n    const expectedMessage = `Polling interval of ${lowInterval} is too low, setting to minimum as ${DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL}`;\n    expect(mockLogger.warn).toHaveBeenCalledWith(expectedMessage);\n  });\n\n  it(\"should warn and use minimum polling interval for NANO_S device when provided interval is too low\", () => {\n    const defaultNanoPollingInterval =\n      DEVICE_SESSION_REFRESHER_POLLING_INTERVAL * 2;\n    const lowInterval = defaultNanoPollingInterval - 100;\n    const options: DeviceSessionRefresherOptions = {\n      isRefresherDisabled: false,\n      pollingInterval: lowInterval,\n    };\n\n    refresher = new DeviceSessionRefresher(\n      mockedLoggerModuleFactory,\n      options,\n      mockSessionEventDispatcher,\n      stubNanoSDevice,\n    );\n    refresher.startRefresher();\n\n    const expectedMessage = `Polling interval of ${lowInterval} is too low, setting to minimum as ${defaultNanoPollingInterval}`;\n    expect(mockLogger.warn).toHaveBeenCalledWith(expectedMessage);\n  });\n\n  it(\"should not warn when provided polling interval is valid for default device\", () => {\n    const validInterval =\n      DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL + 100;\n    const options: DeviceSessionRefresherOptions = {\n      isRefresherDisabled: false,\n      pollingInterval: validInterval,\n    };\n\n    refresher = new DeviceSessionRefresher(\n      mockedLoggerModuleFactory,\n      options,\n      mockSessionEventDispatcher,\n      stubDefaultDevice,\n    );\n    refresher.startRefresher();\n\n    expect(mockLogger.warn).not.toHaveBeenCalled();\n  });\n\n  it(\"should dispatch refresh event on timer ticks\", () => {\n    const validInterval =\n      DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL + 100;\n    const options: DeviceSessionRefresherOptions = {\n      isRefresherDisabled: false,\n      pollingInterval: validInterval,\n    };\n\n    refresher = new DeviceSessionRefresher(\n      mockedLoggerModuleFactory,\n      options,\n      mockSessionEventDispatcher,\n      stubDefaultDevice,\n    );\n    refresher.startRefresher();\n\n    const timerInterval = validInterval * 2;\n\n    vi.advanceTimersByTime(timerInterval * 3);\n\n    expect(\n      (mockSessionEventDispatcher.dispatch as ReturnType<typeof vi.fn>).mock\n        .calls.length,\n    ).toBe(4);\n    expect(\n      (mockSessionEventDispatcher.dispatch as ReturnType<typeof vi.fn>).mock\n        .calls[0]![0],\n    ).toEqual({\n      eventName: SessionEvents.REFRESH_NEEDED,\n    });\n  });\n\n  it(\"should stop refresher\", () => {\n    const options: DeviceSessionRefresherOptions = {\n      isRefresherDisabled: false,\n      pollingInterval: 1000,\n    };\n    refresher = new DeviceSessionRefresher(\n      mockedLoggerModuleFactory,\n      options,\n      mockSessionEventDispatcher,\n      stubDefaultDevice,\n    );\n    refresher.startRefresher();\n    (\n      mockSessionEventDispatcher.dispatch as ReturnType<typeof vi.fn>\n    ).mockClear();\n\n    refresher.stopRefresher();\n    vi.advanceTimersByTime(2000);\n\n    expect(mockSessionEventDispatcher.dispatch).not.toHaveBeenCalled();\n    expect(mockLogger.info).toHaveBeenCalledWith(\"Refresher stopped.\");\n  });\n\n  it(\"should restart refresher\", () => {\n    const options: DeviceSessionRefresherOptions = {\n      isRefresherDisabled: false,\n      pollingInterval: 1000,\n    };\n    refresher = new DeviceSessionRefresher(\n      mockedLoggerModuleFactory,\n      options,\n      mockSessionEventDispatcher,\n      stubDefaultDevice,\n    );\n    refresher.startRefresher();\n    (\n      mockSessionEventDispatcher.dispatch as ReturnType<typeof vi.fn>\n    ).mockClear();\n    vi.clearAllTimers();\n\n    refresher.restartRefresher();\n    expect(mockLogger.info).toHaveBeenCalledWith(\"Refresher stopped.\");\n    expect(mockLogger.info).toHaveBeenCalledWith(\"Refresher restarted.\");\n\n    vi.advanceTimersByTime(2000);\n    expect(\n      (mockSessionEventDispatcher.dispatch as ReturnType<typeof vi.fn>).mock\n        .calls.length,\n    ).toBeGreaterThan(0);\n  });\n\n  it(\"should destroy refresher\", () => {\n    const options: DeviceSessionRefresherOptions = {\n      isRefresherDisabled: false,\n      pollingInterval: 1000,\n    };\n    refresher = new DeviceSessionRefresher(\n      mockedLoggerModuleFactory,\n      options,\n      mockSessionEventDispatcher,\n      stubDefaultDevice,\n    );\n    refresher.startRefresher();\n\n    refresher.destroy();\n    vi.advanceTimersByTime(2000);\n\n    expect(mockSessionEventDispatcher.dispatch).not.toHaveBeenCalled();\n  });\n});\n"],
  "mappings": "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",
  "names": ["Subject", "afterEach", "beforeEach", "describe", "expect", "it", "vi", "DeviceModelId", "DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL", "DEVICE_SESSION_REFRESHER_POLLING_INTERVAL", "SessionEvents", "DeviceSessionRefresher", "subject", "mockSessionEventDispatcher", "mockLogger", "stubDefaultDevice", "stubNanoSDevice", "mockedLoggerModuleFactory", "refresher", "options", "lowInterval", "expectedMessage", "defaultNanoPollingInterval", "validInterval", "timerInterval"]
}

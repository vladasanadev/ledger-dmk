import{Just as t,Left as l,Nothing as c,Right as d}from"purify-ts";import{ApduResponse as s}from"../../../api/device-session/ApduResponse";import{ReceiverApduError as u}from"../../device-session/model/Errors";import{DefaultLoggerPublisherService as b}from"../../logger-publisher/service/DefaultLoggerPublisherService";import{DefaultApduReceiverService as f}from"./DefaultApduReceiverService";vi.mock("uuid");const h=new b([],"frame"),o=new Uint8Array([170,170,5,0,0,0,33,51,0,0,4,5,50,46,50,46,51,4,230,0,0,0,4,50,46,51,48,4,49,46,49,54,1,1,1,0,1,0,144,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),m=new Uint8Array([170,170,5,0,0,0,2,85,21,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),r=[new Uint8Array([170,170,5,0,0,0,158,1,77,0,19,202,80,250,161,145,64,154,107,250,108,15,187,178,231,196,169,207,229,87,65,0,93,189,132,171,154,189,102,199,108,144,221,8,121,13,8,71,185,58,143,167,111,96,51,174,211,37,215,177,229,124,235,215]),new Uint8Array([170,170,5,0,1,75,46,44,159,180,70,120,222,5,95,158,128,10,7,66,105,116,99,111,105,110,78,0,21,202,64,6,3,40,248,143,198,214,66,152,208,73,0,199,4,152,25,27,108,235,237,216,203,132,93,245,75,227,189,187,37,122,63,111]),new Uint8Array([170,170,5,0,2,104,143,84,239,127,170,196,34,170,84,231,184,10,200,163,47,150,229,94,67,45,243,163,69,141,142,170,241,78,209,30,8,69,116,104,101,114,101,117,109,144,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])];describe("DefaultApduReceiverService",()=>{let a;beforeAll(()=>{vi.mock("uuid",()=>({v4:vi.fn().mockReturnValue("42")}))}),describe("without dataSize",()=>{beforeEach(()=>{a=new f({channel:t(new Uint8Array([170,170]))},()=>h)}),it("should return a left error when the first frame has no dataSize",()=>{const x=r[1],e=a.handleFrame(x);expect(e).toEqual(l(new u))})}),describe("[USB] With padding and channel",()=>{beforeEach(()=>{a=new f({channel:t(new Uint8Array([170,170]))},()=>h)}),it("should return a response directly when a frame is complete",()=>{const x=o,e=a.handleFrame(x);expect(e).toEqual(d(t(new s({data:o.slice(7,38),statusCode:new Uint8Array([144,0])}))))}),it("should return a response on a third frame when the two first are not complete",()=>{const x=[...r];let e=c;const n=[];for(;e.isNothing();){const i=x.shift();a.handleFrame(i).map(p=>{e=p,n.push(e)})}expect(n).toEqual([c,c,t(new s({data:new Uint8Array([...Array.from(r[0].slice(7)),...Array.from(r[1].slice(5)),...Array.from(r[2]).slice(5,45)]),statusCode:new Uint8Array([144,0])}))])}),it("should return two response directly when each frame is complete",()=>{const x=m,e=o,n=a.handleFrame(x),i=a.handleFrame(e);expect(n).toEqual(d(t(new s({data:new Uint8Array([]),statusCode:new Uint8Array([85,21])})))),expect(i).toEqual(d(t(new s({data:o.slice(7,38),statusCode:new Uint8Array([144,0])}))))}),it("should return an error if the frame is without index",()=>{const x=r[0].slice(0,4),e=a.handleFrame(x);expect(e).toEqual(l(new u("Unable to parse header from apdu")))}),it("should return an error if the frame is without datasize",()=>{const x=r[0].slice(0,6),e=a.handleFrame(x);expect(e).toEqual(l(new u("Unable to parse header from apdu")))})}),describe("[BLE] Without padding nor channel",()=>{beforeEach(()=>{a=new f({},()=>h)}),it("should return a response directly when a frame is complete",()=>{const x=o.slice(2,40),e=a.handleFrame(x);expect(e).toEqual(d(t(new s({data:o.slice(7,38),statusCode:new Uint8Array([144,0])}))))}),it("should return a response on a third frame when the two first are not complete",()=>{const x=[r[0].slice(2),r[1].slice(2),r[2].slice(2,47)];let e=c;const n=[];for(;e.isNothing();){const i=x.shift();a.handleFrame(i).map(p=>{e=p,n.push(e)})}expect(n).toEqual([c,c,t(new s({data:new Uint8Array([...Array.from(r[0].slice(7)),...Array.from(r[1].slice(5)),...Array.from(r[2]).slice(5,45)]),statusCode:new Uint8Array([144,0])}))])}),it("should return two response directly when each frame is complete",()=>{const x=m.slice(2,9),e=o.slice(2,40),n=a.handleFrame(x),i=a.handleFrame(e);expect(n).toEqual(d(t(new s({data:new Uint8Array([]),statusCode:new Uint8Array([85,21])})))),expect(i).toEqual(d(t(new s({data:o.slice(7,38),statusCode:new Uint8Array([144,0])}))))}),it("should return an error if the frame is without index",()=>{const x=r[0].slice(2,4),e=a.handleFrame(x);expect(e).toEqual(l(new u("Unable to parse header from apdu")))}),it("should return an error if the frame is without datasize",()=>{const x=r[0].slice(2,6),e=a.handleFrame(x);expect(e).toEqual(l(new u("Unable to parse header from apdu")))})})});
//# sourceMappingURL=DefaultApduReceiverService.test.js.map

{
  "version": 3,
  "sources": ["../../../../../../src/internal/device-session/model/DeviceSessionStateHandler.test.ts"],
  "sourcesContent": ["import { BehaviorSubject, Subject } from \"rxjs\";\nimport { expect, type Mock } from \"vitest\";\n\nimport { type DeviceSessionState } from \"@api/device-session/DeviceSessionState\";\nimport {\n  CommandResultStatus,\n  DeviceModelId,\n  DeviceSessionStateType,\n  DeviceStatus,\n} from \"@api/index\";\nimport {\n  type DeviceSessionEventDispatcher,\n  type NewEvent,\n  SessionEvents,\n} from \"@internal/device-session/model/DeviceSessionEventDispatcher\";\nimport { type Application } from \"@internal/manager-api/model/Application\";\n\nimport {\n  DeviceSessionStateHandler,\n  type SetDeviceSessionStateFn,\n} from \"./DeviceSessionStateHandler\";\n\ndescribe(\"DeviceSessionStateHandler\", () => {\n  let fakeEventSubject: Subject<NewEvent>;\n  let fakeSessionEventDispatcher: DeviceSessionEventDispatcher;\n  let mockLogger: {\n    error: (message: string, meta?: Record<string, unknown>) => void;\n    debug: (message: string, meta?: Record<string, unknown>) => void;\n  };\n  const mockLoggerModuleFactory = vi.fn(() => mockLogger);\n  let fakeConnectedDevice: { deviceModel: { id: string } };\n  let deviceState: BehaviorSubject<DeviceSessionState>;\n  let setDeviceSessionState: Mock<SetDeviceSessionStateFn>;\n  let handler: DeviceSessionStateHandler;\n\n  beforeEach(() => {\n    fakeEventSubject = new Subject<NewEvent>();\n    //@ts-expect-error mock\n    fakeSessionEventDispatcher = {\n      listen: () => fakeEventSubject,\n      dispatch: vi.fn(),\n    };\n\n    mockLogger = {\n      error: vi.fn(),\n      debug: vi.fn(),\n    };\n\n    fakeConnectedDevice = {\n      deviceModel: {\n        id: \"device-model-1\",\n      },\n    };\n\n    deviceState = new BehaviorSubject<DeviceSessionState>({\n      sessionStateType: DeviceSessionStateType.Connected,\n      deviceStatus: DeviceStatus.CONNECTED,\n      deviceModelId: DeviceModelId.NANO_X,\n    });\n\n    setDeviceSessionState = vi.fn();\n\n    handler = new DeviceSessionStateHandler(\n      //@ts-expect-error mock\n      mockLoggerModuleFactory,\n      fakeSessionEventDispatcher,\n      fakeConnectedDevice,\n      deviceState,\n      setDeviceSessionState,\n    );\n  });\n\n  afterEach(() => {\n    if (handler && typeof handler.unsubscribe === \"function\") {\n      handler.unsubscribe();\n    }\n  });\n\n  it(\"updates device state on COMMAND_SUCCEEDED event with a successful response\", () => {\n    // Given\n    const fakeCommandResult = {\n      data: {\n        name: \"TestApp\",\n        version: \"1.0.0\",\n      },\n      status: CommandResultStatus.Success,\n    };\n\n    // When\n    fakeEventSubject.next({\n      eventName: SessionEvents.COMMAND_SUCCEEDED,\n      //@ts-expect-error mock\n      eventData: fakeCommandResult,\n    });\n\n    // Then\n    expect(setDeviceSessionState).toHaveBeenCalledWith({\n      sessionStateType: DeviceSessionStateType.ReadyWithoutSecureChannel,\n      deviceStatus: DeviceStatus.CONNECTED,\n      deviceModelId: \"device-model-1\",\n      currentApp: { name: \"TestApp\", version: \"1.0.0\" },\n      installedApps: [],\n      isSecureConnectionAllowed: false,\n    });\n  });\n\n  it(\"updates device state on COMMAND_SUCCEEDED event when device is ready\", () => {\n    // Given\n    deviceState.next({\n      sessionStateType: DeviceSessionStateType.ReadyWithoutSecureChannel,\n      deviceStatus: DeviceStatus.CONNECTED,\n      deviceModelId: DeviceModelId.NANO_X,\n      currentApp: { name: \"\", version: \"\" },\n      installedApps: [\"Bitcoin\", \"Ethereum\"] as unknown as Application[],\n      isSecureConnectionAllowed: true,\n    });\n    const fakeCommandResult = {\n      data: {\n        name: \"TestApp\",\n        version: \"1.0.0\",\n      },\n      status: CommandResultStatus.Success,\n    };\n\n    // When\n    fakeEventSubject.next({\n      eventName: SessionEvents.COMMAND_SUCCEEDED,\n      //@ts-expect-error mock\n      eventData: fakeCommandResult,\n    });\n\n    // Then\n    expect(setDeviceSessionState).toHaveBeenCalledWith({\n      sessionStateType: DeviceSessionStateType.ReadyWithoutSecureChannel,\n      deviceStatus: DeviceStatus.CONNECTED,\n      deviceModelId: \"device-model-1\",\n      currentApp: { name: \"TestApp\", version: \"1.0.0\" },\n      installedApps: [\"Bitcoin\", \"Ethereum\"] as unknown as Application[],\n      isSecureConnectionAllowed: true,\n    });\n  });\n\n  it(\"updates device state on DEVICE_STATE_UPDATE_BUSY event\", () => {\n    // When\n    fakeEventSubject.next({\n      eventName: SessionEvents.DEVICE_STATE_UPDATE_BUSY,\n    });\n\n    // Then\n    expect(setDeviceSessionState).toHaveBeenCalledWith(\n      expect.objectContaining({ deviceStatus: DeviceStatus.BUSY }),\n    );\n  });\n\n  it(\"updates device state on DEVICE_STATE_UPDATE_CONNECTED event\", () => {\n    // When\n    fakeEventSubject.next({\n      eventName: SessionEvents.DEVICE_STATE_UPDATE_CONNECTED,\n    });\n\n    // Then\n    expect(setDeviceSessionState).toHaveBeenCalledWith(\n      expect.objectContaining({ deviceStatus: DeviceStatus.CONNECTED }),\n    );\n  });\n\n  it(\"logs error and does not update state if command result is unsuccessful\", () => {\n    // Given\n    const fakeErrorCommandResult = {\n      data: null,\n      error: { _tag: \"SomeOtherError\" },\n    };\n\n    // When\n    fakeEventSubject.next({\n      eventName: SessionEvents.COMMAND_SUCCEEDED,\n      //@ts-expect-error mock\n      eventData: fakeErrorCommandResult,\n    });\n\n    // Then\n    expect(mockLogger.debug).toHaveBeenCalledWith(\n      \"Error while parsing APDU response\",\n      { data: { parsedResponse: fakeErrorCommandResult } },\n    );\n    expect(setDeviceSessionState).not.toHaveBeenCalled();\n  });\n\n  it(\"does not update state if command result is not a success\", () => {\n    // Given\n    const fakeErrorCommandResult = {\n      data: null,\n      error: { _tag: \"SomeOtherError\" },\n    };\n\n    // When\n    fakeEventSubject.next({\n      eventName: SessionEvents.COMMAND_SUCCEEDED,\n      //@ts-expect-error mock\n      eventData: fakeErrorCommandResult,\n    });\n\n    // Then\n    expect(setDeviceSessionState).not.toHaveBeenCalled();\n  });\n});\n"],
  "mappings": "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",
  "names": ["BehaviorSubject", "Subject", "expect", "CommandResultStatus", "DeviceModelId", "DeviceSessionStateType", "DeviceStatus", "SessionEvents", "DeviceSessionStateHandler", "fakeEventSubject", "fakeSessionEventDispatcher", "mockLogger", "mockLoggerModuleFactory", "fakeConnectedDevice", "deviceState", "setDeviceSessionState", "handler", "fakeCommandResult", "fakeErrorCommandResult"]
}

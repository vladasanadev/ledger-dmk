{
  "version": 3,
  "sources": ["../../../../../../src/internal/device-session/model/DeviceSessionRefresher.ts"],
  "sourcesContent": ["import { type Subscription, timer } from \"rxjs\";\n\nimport { DeviceModelId } from \"@api/device/DeviceModel\";\nimport { type TransportConnectedDevice } from \"@api/transport/model/TransportConnectedDevice\";\nimport { type LoggerPublisherService } from \"@api/types\";\nimport {\n  DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL,\n  DEVICE_SESSION_REFRESHER_POLLING_INTERVAL,\n} from \"@internal/device-session/data/DeviceSessionRefresherConst\";\nimport {\n  type DeviceSessionEventDispatcher,\n  SessionEvents,\n} from \"@internal/device-session/model/DeviceSessionEventDispatcher\";\n\nexport interface DeviceSessionRefresherOptions {\n  isRefresherDisabled: boolean;\n  pollingInterval?: number;\n}\n\nexport class DeviceSessionRefresher {\n  private _refresherSubscription!: Subscription | undefined;\n  private _refresherOptions: DeviceSessionRefresherOptions;\n  private readonly _logger: LoggerPublisherService;\n  private _connectedDeviceID: DeviceModelId;\n\n  constructor(\n    loggerModuleFactory: (tag: string) => LoggerPublisherService,\n    refresherOptions: DeviceSessionRefresherOptions,\n    private _sessionEventDispatcher: DeviceSessionEventDispatcher,\n    connectedDevice: TransportConnectedDevice,\n  ) {\n    this._refresherOptions = refresherOptions;\n    this._logger = loggerModuleFactory(\"device-session-refresher\");\n    this._connectedDeviceID = connectedDevice.deviceModel.id;\n  }\n\n  public startRefresher(): void {\n    if (this._refresherOptions.isRefresherDisabled) return;\n\n    const pollingInterval =\n      this.getValidPollingInterval(this._refresherOptions, this._logger) * 2;\n\n    this._refresherSubscription = timer(0, pollingInterval).subscribe(() => {\n      this._sessionEventDispatcher.dispatch({\n        eventName: SessionEvents.REFRESH_NEEDED,\n      });\n    });\n  }\n\n  public stopRefresher(): void {\n    if (this._refresherSubscription) {\n      this._refresherSubscription.unsubscribe();\n      this._refresherSubscription = undefined;\n      this._logger.info(\"Refresher stopped.\");\n    }\n  }\n\n  public restartRefresher(): void {\n    this.stopRefresher();\n    this.startRefresher();\n    this._logger.info(\"Refresher restarted.\");\n  }\n\n  public destroy(): void {\n    this.stopRefresher();\n  }\n\n  private getValidPollingInterval = (\n    refresherOptions: DeviceSessionRefresherOptions,\n    logger: LoggerPublisherService,\n  ): number => {\n    const { pollingInterval } = refresherOptions;\n    switch (this._connectedDeviceID) {\n      case DeviceModelId.NANO_S: {\n        const defaultNanoPollingInterval =\n          DEVICE_SESSION_REFRESHER_POLLING_INTERVAL * 2;\n        if (\n          pollingInterval !== undefined &&\n          pollingInterval < defaultNanoPollingInterval\n        ) {\n          logger.warn(\n            `Polling interval of ${pollingInterval} is too low, setting to minimum as ${defaultNanoPollingInterval}`,\n          );\n          return defaultNanoPollingInterval;\n        }\n        return pollingInterval ?? defaultNanoPollingInterval;\n      }\n      default:\n        if (\n          pollingInterval !== undefined &&\n          pollingInterval < DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL\n        ) {\n          logger.warn(\n            `Polling interval of ${pollingInterval} is too low, setting to minimum as ${DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL}`,\n          );\n          return DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL;\n        }\n\n        return pollingInterval ?? DEVICE_SESSION_REFRESHER_POLLING_INTERVAL;\n    }\n  };\n}\n"],
  "mappings": "AAAA,OAA4B,SAAAA,MAAa,OAEzC,OAAS,iBAAAC,MAAqB,0BAG9B,OACE,qDAAAC,EACA,6CAAAC,MACK,4DACP,OAEE,iBAAAC,MACK,8DAOA,MAAMC,CAAuB,CAMlC,YACEC,EACAC,EACQC,EACRC,EACA,CAFQ,6BAAAD,EAGR,KAAK,kBAAoBD,EACzB,KAAK,QAAUD,EAAoB,0BAA0B,EAC7D,KAAK,mBAAqBG,EAAgB,YAAY,EACxD,CAdQ,uBACA,kBACS,QACT,mBAaD,gBAAuB,CAC5B,GAAI,KAAK,kBAAkB,oBAAqB,OAEhD,MAAMC,EACJ,KAAK,wBAAwB,KAAK,kBAAmB,KAAK,OAAO,EAAI,EAEvE,KAAK,uBAAyBV,EAAM,EAAGU,CAAe,EAAE,UAAU,IAAM,CACtE,KAAK,wBAAwB,SAAS,CACpC,UAAWN,EAAc,cAC3B,CAAC,CACH,CAAC,CACH,CAEO,eAAsB,CACvB,KAAK,yBACP,KAAK,uBAAuB,YAAY,EACxC,KAAK,uBAAyB,OAC9B,KAAK,QAAQ,KAAK,oBAAoB,EAE1C,CAEO,kBAAyB,CAC9B,KAAK,cAAc,EACnB,KAAK,eAAe,EACpB,KAAK,QAAQ,KAAK,sBAAsB,CAC1C,CAEO,SAAgB,CACrB,KAAK,cAAc,CACrB,CAEQ,wBAA0B,CAChCG,EACAI,IACW,CACX,KAAM,CAAE,gBAAAD,CAAgB,EAAIH,EAC5B,OAAQ,KAAK,mBAAoB,CAC/B,KAAKN,EAAc,OAAQ,CACzB,MAAMW,EACJT,EAA4C,EAC9C,OACEO,IAAoB,QACpBA,EAAkBE,GAElBD,EAAO,KACL,uBAAuBD,CAAe,sCAAsCE,CAA0B,EACxG,EACOA,GAEFF,GAAmBE,CAC5B,CACA,QACE,OACEF,IAAoB,QACpBA,EAAkBR,GAElBS,EAAO,KACL,uBAAuBD,CAAe,sCAAsCR,CAAiD,EAC/H,EACOA,GAGFQ,GAAmBP,CAC9B,CACF,CACF",
  "names": ["timer", "DeviceModelId", "DEVICE_SESSION_REFRESHER_MINIMUM_POLLING_INTERVAL", "DEVICE_SESSION_REFRESHER_POLLING_INTERVAL", "SessionEvents", "DeviceSessionRefresher", "loggerModuleFactory", "refresherOptions", "_sessionEventDispatcher", "connectedDevice", "pollingInterval", "logger", "defaultNanoPollingInterval"]
}

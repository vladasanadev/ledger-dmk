{
  "version": 3,
  "sources": ["../../../../../../src/internal/discovery/use-case/ConnectUseCase.test.ts"],
  "sourcesContent": ["import { Left, Maybe, Right } from \"purify-ts\";\n\nimport { type DeviceModel, type DeviceModelId } from \"@api/device/DeviceModel\";\nimport { type DeviceSessionState } from \"@api/device-session/DeviceSessionState\";\nimport { type ConnectionType } from \"@api/discovery/ConnectionType\";\nimport { type DmkConfig } from \"@api/DmkConfig\";\nimport { type LoggerPublisherService } from \"@api/logger-publisher/service/LoggerPublisherService\";\nimport { TransportMock } from \"@api/transport/model/__mocks__/TransportMock\";\nimport { type ConnectedDevice } from \"@api/transport/model/ConnectedDevice\";\nimport { type DiscoveredDevice } from \"@api/transport/model/DiscoveredDevice\";\nimport { UnknownDeviceError } from \"@api/transport/model/Errors\";\nimport { type Transport } from \"@api/transport/model/Transport\";\nimport { connectedDeviceStubBuilder } from \"@api/transport/model/TransportConnectedDevice.stub\";\nimport { DefaultDeviceSessionService } from \"@internal/device-session/service/DefaultDeviceSessionService\";\nimport { type DeviceSessionService } from \"@internal/device-session/service/DeviceSessionService\";\nimport { DefaultLoggerPublisherService } from \"@internal/logger-publisher/service/DefaultLoggerPublisherService\";\nimport { AxiosManagerApiDataSource } from \"@internal/manager-api/data/AxiosManagerApiDataSource\";\nimport { type ManagerApiDataSource } from \"@internal/manager-api/data/ManagerApiDataSource\";\nimport { DefaultManagerApiService } from \"@internal/manager-api/service/DefaultManagerApiService\";\nimport { type ManagerApiService } from \"@internal/manager-api/service/ManagerApiService\";\nimport { DefaultSecureChannelDataSource } from \"@internal/secure-channel/data/DefaultSecureChannelDataSource\";\nimport { type SecureChannelDataSource } from \"@internal/secure-channel/data/SecureChannelDataSource\";\nimport { DefaultSecureChannelService } from \"@internal/secure-channel/service/DefaultSecureChannelService\";\nimport { type SecureChannelService } from \"@internal/secure-channel/service/SecureChannelService\";\nimport { DefaultTransportService } from \"@internal/transport/service/DefaultTransportService\";\nimport { type TransportService } from \"@internal/transport/service/TransportService\";\n\nimport { ConnectUseCase } from \"./ConnectUseCase\";\n\nvi.mock(\"uuid\", () => ({\n  v4: vi.fn().mockReturnValue(\"fakeSessionId\"),\n}));\n\nvi.mock(\"@internal/manager-api/data/AxiosManagerApiDataSource\");\nvi.mock(\"@internal/transport/service/DefaultTransportService\");\n\n// TODO test several transports\n// let transports: WebUsbHidTransport[];\nlet transport: Transport;\nlet transportService: TransportService;\nlet logger: LoggerPublisherService;\nlet sessionService: DeviceSessionService;\nlet managerApi: ManagerApiService;\nlet managerApiDataSource: ManagerApiDataSource;\nlet secureChannelDataSource: SecureChannelDataSource;\nlet secureChannel: SecureChannelService;\nconst fakeSessionId = \"fakeSessionId\";\nconst fakeSessionIdConnectedDevice = \"fakeSessionIdConnectedDevice\";\n\ndescribe(\"ConnectUseCase\", () => {\n  const stubDiscoveredDevice: DiscoveredDevice = {\n    id: \"\",\n    deviceModel: {} as DeviceModel,\n    transport: \"USB\",\n    name: \"TEST\",\n  };\n  const stubTransportConnectedDevice = connectedDeviceStubBuilder({ id: \"1\" });\n  const stubConnectedDevice = {\n    id: \"1\",\n    sessionId: fakeSessionIdConnectedDevice,\n    modelId: \"model-id\" as unknown as DeviceModelId,\n    name: \"device-name\",\n    type: \"MOCK\" as unknown as ConnectionType,\n    transport: \"USB\",\n  } as unknown as ConnectedDevice;\n  const tag = \"logger-tag\";\n\n  beforeAll(() => {\n    logger = new DefaultLoggerPublisherService([], tag);\n    transport = new TransportMock();\n    sessionService = new DefaultDeviceSessionService(() => logger);\n    managerApiDataSource = new AxiosManagerApiDataSource({} as DmkConfig);\n    managerApi = new DefaultManagerApiService(managerApiDataSource);\n    secureChannelDataSource = new DefaultSecureChannelDataSource(\n      {} as DmkConfig,\n    );\n    secureChannel = new DefaultSecureChannelService(secureChannelDataSource);\n    // @ts-expect-error mock\n    transportService = new DefaultTransportService();\n  });\n\n  afterEach(() => {\n    for (const session of sessionService.getDeviceSessions()) {\n      sessionService.removeDeviceSession(session.id);\n    }\n  });\n\n  afterAll(() => {\n    vi.restoreAllMocks();\n  });\n\n  test(\"If connect use case encounter an error, return it\", async () => {\n    vi.spyOn(transport, \"connect\").mockResolvedValue(\n      Left(new UnknownDeviceError()),\n    );\n\n    vi.spyOn(transportService, \"getTransport\").mockReturnValue(\n      Maybe.of(transport),\n    );\n\n    const usecase = new ConnectUseCase(\n      transportService,\n      sessionService,\n      () => logger,\n      managerApi,\n      secureChannel,\n    );\n\n    await expect(\n      usecase.execute({ device: stubDiscoveredDevice }),\n    ).rejects.toBeInstanceOf(UnknownDeviceError);\n  });\n\n  test(\"If connect is in success, return a deviceSession id\", async () => {\n    vi.spyOn(transport, \"connect\").mockResolvedValue(\n      Right(stubTransportConnectedDevice),\n    );\n    vi.spyOn(transportService, \"getTransport\").mockReturnValue(\n      Maybe.of(transport),\n    );\n    vi.spyOn(sessionService, \"addDeviceSession\").mockImplementation(\n      (deviceSession) => {\n        deviceSession.setDeviceSessionState({} as DeviceSessionState);\n        return sessionService;\n      },\n    );\n\n    const usecase = new ConnectUseCase(\n      transportService,\n      sessionService,\n      () => logger,\n      managerApi,\n      secureChannel,\n    );\n\n    const sessionId = await usecase.execute({\n      device: stubDiscoveredDevice,\n    });\n    expect(sessionId).toBe(fakeSessionId);\n    sessionService.removeDeviceSession(sessionId);\n  });\n\n  test(\"If connect is in success after a reconnect, return the same deviceSession id\", async () => {\n    vi.spyOn(transport, \"connect\").mockResolvedValue(\n      Right(stubTransportConnectedDevice),\n    );\n    vi.spyOn(transportService, \"getTransport\").mockReturnValue(\n      Maybe.of(transport),\n    );\n    vi.spyOn(sessionService, \"addDeviceSession\").mockImplementation(\n      (deviceSession) => {\n        deviceSession.setDeviceSessionState({} as DeviceSessionState);\n        return sessionService;\n      },\n    );\n\n    const usecase = new ConnectUseCase(\n      transportService,\n      sessionService,\n      () => logger,\n      managerApi,\n      secureChannel,\n    );\n\n    const sessionId = await usecase.execute({\n      device: stubConnectedDevice,\n    });\n    expect(sessionId).toBe(fakeSessionIdConnectedDevice); // same session id as the connected device\n    sessionService.removeDeviceSession(sessionId);\n  });\n});\n"],
  "mappings": "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",
  "names": ["Left", "Maybe", "Right", "TransportMock", "UnknownDeviceError", "connectedDeviceStubBuilder", "DefaultDeviceSessionService", "DefaultLoggerPublisherService", "AxiosManagerApiDataSource", "DefaultManagerApiService", "DefaultSecureChannelDataSource", "DefaultSecureChannelService", "DefaultTransportService", "ConnectUseCase", "transport", "transportService", "logger", "sessionService", "managerApi", "managerApiDataSource", "secureChannelDataSource", "secureChannel", "fakeSessionId", "fakeSessionIdConnectedDevice", "stubDiscoveredDevice", "stubTransportConnectedDevice", "stubConnectedDevice", "tag", "session", "usecase", "deviceSession", "sessionId"]
}

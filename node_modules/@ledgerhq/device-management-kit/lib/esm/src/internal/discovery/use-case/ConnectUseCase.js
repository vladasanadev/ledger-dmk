var S=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var p=(c,e,s,i)=>{for(var o=i>1?void 0:i?g(e,s):e,r=c.length-1,n;r>=0;r--)(n=c[r])&&(o=(i?n(e,s,o):n(o))||o);return i&&o&&S(e,s,o),o},t=(c,e)=>(s,i)=>e(s,i,c);import{inject as a,injectable as m}from"inversify";import{EitherAsync as h}from"purify-ts";import{TransportNotSupportedError as d}from"../../../api/transport/model/Errors";import{deviceSessionTypes as l}from"../../device-session/di/deviceSessionTypes";import{DeviceSession as f}from"../../device-session/model/DeviceSession";import{loggerTypes as D}from"../../logger-publisher/di/loggerTypes";import{managerApiTypes as y}from"../../manager-api/di/managerApiTypes";import{secureChannelTypes as u}from"../../secure-channel/di/secureChannelTypes";import{transportDiTypes as _}from"../../transport/di/transportDiTypes";let v=class{_transportService;_sessionService;_loggerFactory;_managerApi;_secureChannel;_logger;constructor(e,s,i,o,r){this._sessionService=s,this._transportService=e,this._loggerFactory=i,this._logger=i("ConnectUseCase"),this._managerApi=o,this._secureChannel=r}handleDeviceDisconnect(e){this._sessionService.getDeviceSessionsByDeviceId(e).ifRight(s=>{s.forEach(i=>{this._sessionService.removeDeviceSession(i.id),this._logger.info("Session removed",{data:{deviceId:e,sessionId:i.id}})})})}async execute({device:e,sessionRefresherOptions:s}){const i=this._transportService.getTransport(e.transport),o="sessionId"in e?e.sessionId:void 0;return h.liftEither(i.toEither(new d(new Error("Unknown transport")))).chain(async r=>r.connect({deviceId:e.id,onDisconnect:n=>this.handleDeviceDisconnect(n)})).ifLeft(r=>{this._logger.error("Error connecting to device",{data:{deviceId:e.id,error:r}})}).map(async r=>{const n=new f({connectedDevice:r,id:o},this._loggerFactory,this._managerApi,this._secureChannel,s);return this._sessionService.addDeviceSession(n),await n.initialiseSession(),n.id}).caseOf({Left:r=>{throw r},Right:r=>r})}};v=p([m(),t(0,a(_.TransportService)),t(1,a(l.DeviceSessionService)),t(2,a(D.LoggerPublisherServiceFactory)),t(3,a(y.ManagerApiService)),t(4,a(u.SecureChannelService))],v);export{v as ConnectUseCase};
//# sourceMappingURL=ConnectUseCase.js.map

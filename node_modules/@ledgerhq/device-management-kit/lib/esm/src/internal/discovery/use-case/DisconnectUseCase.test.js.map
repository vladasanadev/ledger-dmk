{
  "version": 3,
  "sources": ["../../../../../../src/internal/discovery/use-case/DisconnectUseCase.test.ts"],
  "sourcesContent": ["import { Left, Maybe, Right } from \"purify-ts\";\n\nimport { TransportMock } from \"@api/transport/model/__mocks__/TransportMock\";\nimport { DisconnectError } from \"@api/transport/model/Errors\";\nimport { connectedDeviceStubBuilder } from \"@api/transport/model/TransportConnectedDevice.stub\";\nimport type { DmkConfig, Transport } from \"@api/types\";\nimport { DEVICE_SESSION_REFRESHER_DEFAULT_OPTIONS } from \"@internal/device-session/data/DeviceSessionRefresherConst\";\nimport { deviceSessionStubBuilder } from \"@internal/device-session/model/DeviceSession.stub\";\nimport { DeviceSessionNotFound } from \"@internal/device-session/model/Errors\";\nimport { DefaultDeviceSessionService } from \"@internal/device-session/service/DefaultDeviceSessionService\";\nimport { DefaultLoggerPublisherService } from \"@internal/logger-publisher/service/DefaultLoggerPublisherService\";\nimport { AxiosManagerApiDataSource } from \"@internal/manager-api/data/AxiosManagerApiDataSource\";\nimport { type ManagerApiDataSource } from \"@internal/manager-api/data/ManagerApiDataSource\";\nimport { DefaultManagerApiService } from \"@internal/manager-api/service/DefaultManagerApiService\";\nimport { type ManagerApiService } from \"@internal/manager-api/service/ManagerApiService\";\nimport { DefaultSecureChannelDataSource } from \"@internal/secure-channel/data/DefaultSecureChannelDataSource\";\nimport { type SecureChannelDataSource } from \"@internal/secure-channel/data/SecureChannelDataSource\";\nimport { DefaultSecureChannelService } from \"@internal/secure-channel/service/DefaultSecureChannelService\";\nimport { type SecureChannelService } from \"@internal/secure-channel/service/SecureChannelService\";\nimport { DefaultTransportService } from \"@internal/transport/service/DefaultTransportService\";\nimport { type TransportService } from \"@internal/transport/service/TransportService\";\n\nimport { DisconnectUseCase } from \"./DisconnectUseCase\";\n\nvi.mock(\"@internal/transport/service/DefaultTransportService\");\n\nlet sessionService: DefaultDeviceSessionService;\n// TODO test several transports\nlet transport: Transport;\nlet transports: Transport[] = [];\nconst loggerFactory = vi\n  .fn()\n  .mockReturnValue(\n    new DefaultLoggerPublisherService([], \"DisconnectUseCaseTest\"),\n  );\nlet transportService: TransportService;\nlet managerApi: ManagerApiService;\nlet managerApiDataSource: ManagerApiDataSource;\nlet secureChannelDataSource: SecureChannelDataSource;\nlet secureChannel: SecureChannelService;\n\nconst sessionId = \"sessionId\";\n\ndescribe(\"DisconnectUseCase\", () => {\n  beforeAll(() => {\n    transport = new TransportMock();\n    transports = [transport];\n    sessionService = new DefaultDeviceSessionService(loggerFactory);\n    // @ts-expect-error mock\n    transportService = new DefaultTransportService();\n    vi.spyOn(transportService, \"getTransport\").mockReturnValue(\n      Maybe.of(transport),\n    );\n  });\n\n  it(\"should disconnect from a device\", async () => {\n    // Given\n    const connectedDevice = connectedDeviceStubBuilder();\n    managerApiDataSource = new AxiosManagerApiDataSource({} as DmkConfig);\n    managerApi = new DefaultManagerApiService(managerApiDataSource);\n    secureChannelDataSource = new DefaultSecureChannelDataSource(\n      {} as DmkConfig,\n    );\n    secureChannel = new DefaultSecureChannelService(secureChannelDataSource);\n    const deviceSession = deviceSessionStubBuilder(\n      {\n        id: sessionId,\n        connectedDevice,\n      },\n      loggerFactory,\n      managerApi,\n      secureChannel,\n      DEVICE_SESSION_REFRESHER_DEFAULT_OPTIONS,\n    );\n    vi.spyOn(sessionService, \"getDeviceSessionById\").mockImplementation(() =>\n      Right(deviceSession),\n    );\n    vi.spyOn(deviceSession, \"close\");\n    vi.spyOn(sessionService, \"removeDeviceSession\");\n    vi.spyOn(transports[0]!, \"disconnect\").mockImplementation(() =>\n      Promise.resolve(Right(undefined)),\n    );\n    const disconnectUseCase = new DisconnectUseCase(\n      transportService,\n      sessionService,\n      loggerFactory,\n    );\n    // When\n    await disconnectUseCase.execute({ sessionId });\n\n    // Then\n    expect(deviceSession.close).toHaveBeenCalled();\n    expect(sessionService.removeDeviceSession).toHaveBeenCalledWith(sessionId);\n    expect(transports[0]!.disconnect).toHaveBeenCalledWith({\n      connectedDevice,\n    });\n  });\n\n  it(\"should throw an error when deviceSession not found\", async () => {\n    // Given\n    const disconnectUseCase = new DisconnectUseCase(\n      transportService,\n      sessionService,\n      loggerFactory,\n    );\n\n    // When\n    try {\n      await disconnectUseCase.execute({ sessionId });\n    } catch (e) {\n      // Then\n      expect(e).toStrictEqual(new DeviceSessionNotFound());\n    }\n  });\n\n  it(\"should throw an error if usb hid disconnection fails\", async () => {\n    // Given\n    vi.spyOn(sessionService, \"getDeviceSessionById\").mockImplementation(() =>\n      Right(\n        deviceSessionStubBuilder(\n          { id: sessionId },\n          loggerFactory,\n          managerApi,\n          secureChannel,\n          DEVICE_SESSION_REFRESHER_DEFAULT_OPTIONS,\n        ),\n      ),\n    );\n\n    vi.spyOn(transports[0]!, \"disconnect\").mockResolvedValue(\n      Left(new DisconnectError()),\n    );\n\n    const disconnectUseCase = new DisconnectUseCase(\n      transportService,\n      sessionService,\n      loggerFactory,\n    );\n\n    // When\n    try {\n      await disconnectUseCase.execute({ sessionId });\n    } catch (e) {\n      // Then\n      expect(e).toStrictEqual(new DisconnectError());\n    }\n  });\n});\n"],
  "mappings": "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",
  "names": ["Left", "Maybe", "Right", "TransportMock", "DisconnectError", "connectedDeviceStubBuilder", "DEVICE_SESSION_REFRESHER_DEFAULT_OPTIONS", "deviceSessionStubBuilder", "DeviceSessionNotFound", "DefaultDeviceSessionService", "DefaultLoggerPublisherService", "AxiosManagerApiDataSource", "DefaultManagerApiService", "DefaultSecureChannelDataSource", "DefaultSecureChannelService", "DefaultTransportService", "DisconnectUseCase", "sessionService", "transport", "transports", "loggerFactory", "transportService", "managerApi", "managerApiDataSource", "secureChannelDataSource", "secureChannel", "sessionId", "connectedDevice", "deviceSession", "disconnectUseCase", "e"]
}

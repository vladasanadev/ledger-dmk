{
  "version": 3,
  "sources": ["../../../../../../src/internal/transport/service/DefaultTransportService.test.ts"],
  "sourcesContent": ["import { Maybe } from \"purify-ts\";\nimport { type MockInstance } from \"vitest\";\n\nimport { type DeviceModelDataSource } from \"@api/device-model/data/DeviceModelDataSource\";\nimport { StaticDeviceModelDataSource } from \"@api/device-model/data/StaticDeviceModelDataSource\";\nimport { type ApduReceiverServiceFactory } from \"@api/device-session/service/ApduReceiverService\";\nimport { type ApduSenderServiceFactory } from \"@api/device-session/service/ApduSenderService\";\nimport { defaultApduReceiverServiceStubBuilder } from \"@api/device-session/service/DefaultApduReceiverService.stub\";\nimport { defaultApduSenderServiceStubBuilder } from \"@api/device-session/service/DefaultApduSenderService.stub\";\nimport { type DmkConfig } from \"@api/DmkConfig\";\nimport { type LoggerPublisherService } from \"@api/logger-publisher/service/LoggerPublisherService\";\nimport { TransportMock } from \"@api/transport/model/__mocks__/TransportMock\";\nimport {\n  NoTransportProvidedError,\n  TransportAlreadyExistsError,\n} from \"@api/transport/model/Errors\";\nimport {\n  type Transport,\n  type TransportFactory,\n} from \"@api/transport/model/Transport\";\nimport { type LogPublisherOptions } from \"@internal/logger-publisher/model/LogPublisherOptions\";\nimport { DefaultLoggerPublisherService } from \"@internal/logger-publisher/service/DefaultLoggerPublisherService\";\n\nimport { DefaultTransportService } from \"./DefaultTransportService\";\n\nlet apduSenderService: ApduSenderServiceFactory;\nlet apduReceiverService: ApduReceiverServiceFactory;\nlet logger: LoggerPublisherService;\nlet config: DmkConfig;\nlet transportFactory: TransportFactory;\nlet transport: Transport;\nlet transportFactory2: TransportFactory;\nlet transport2: Transport;\nlet deviceModelDataSource: DeviceModelDataSource;\nlet transportService: DefaultTransportService;\nlet loggerFactory: () => LoggerPublisherService;\n\ndescribe(\"TransportService\", () => {\n  beforeEach(() => {\n    logger = new DefaultLoggerPublisherService([], \"transport-service\");\n    apduSenderService = vi.fn().mockImplementation(() => {\n      return defaultApduSenderServiceStubBuilder(undefined, () => logger);\n    });\n    apduReceiverService = vi.fn().mockImplementation(() => {\n      return defaultApduReceiverServiceStubBuilder(undefined, () => logger);\n    });\n    deviceModelDataSource = new StaticDeviceModelDataSource();\n    config = {} as DmkConfig;\n    transport = new TransportMock();\n    transport2 = new TransportMock();\n    vi.spyOn(transport, \"getIdentifier\").mockReturnValue(\"transport\");\n    vi.spyOn(transport2, \"getIdentifier\").mockReturnValue(\"transport2\");\n    transportFactory = vi.fn().mockImplementation(() => transport);\n    transportFactory2 = vi.fn().mockImplementation(() => transport2);\n    loggerFactory = vi.fn().mockImplementation(() => logger);\n  });\n\n  afterEach(() => {\n    vi.resetAllMocks();\n  });\n\n  describe(\"constructor\", () => {\n    describe(\"when no transports are provided\", () => {\n      let spy: MockInstance<\n        (message: string, options?: LogPublisherOptions) => void\n      >;\n      beforeEach(() => {\n        spy = vi.spyOn(logger, \"warn\");\n      });\n\n      it(\"should throw an error\", () => {\n        try {\n          transportService = new DefaultTransportService(\n            [],\n            config,\n            loggerFactory,\n            deviceModelDataSource,\n            apduSenderService,\n            apduReceiverService,\n          );\n        } catch (error) {\n          expect(spy).toHaveBeenCalledWith(\n            \"No transports provided, please check your configuration\",\n          );\n          expect(error).toBeInstanceOf(NoTransportProvidedError);\n        }\n      });\n    });\n\n    describe(\"when transports are provided\", () => {\n      it(\"should add 1 transport\", () => {\n        transportService = new DefaultTransportService(\n          [transportFactory],\n          config,\n          loggerFactory,\n          deviceModelDataSource,\n          apduSenderService,\n          apduReceiverService,\n        );\n\n        expect(transportService.getAllTransports()).toEqual([transport]);\n      });\n\n      it(\"should add multiple transports\", () => {\n        transportService = new DefaultTransportService(\n          [transportFactory, transportFactory2],\n          config,\n          loggerFactory,\n          deviceModelDataSource,\n          apduSenderService,\n          apduReceiverService,\n        );\n\n        const transports = transportService.getAllTransports();\n        expect(transports).toEqual([transport, transport2]);\n      });\n\n      it(\"should not add duplicate transports\", () => {\n        try {\n          new DefaultTransportService(\n            [transportFactory, transportFactory],\n            config,\n            loggerFactory,\n            deviceModelDataSource,\n            apduSenderService,\n            apduReceiverService,\n          );\n        } catch (error) {\n          expect(error).toBeInstanceOf(TransportAlreadyExistsError);\n        }\n      });\n    });\n  });\n\n  describe(\"addTransport\", () => {\n    beforeEach(() => {\n      transportService = new DefaultTransportService(\n        [transportFactory],\n        config,\n        loggerFactory,\n        deviceModelDataSource,\n        apduSenderService,\n        apduReceiverService,\n      );\n    });\n\n    it(\"can add a new transport\", () => {\n      transportService.addTransport(transportFactory2);\n\n      const transports = transportService.getAllTransports();\n      expect(transports).toEqual([transport, transport2]);\n    });\n\n    it(\"calls the transport factory function with the correct arguments\", () => {\n      transportService.addTransport(transportFactory2);\n\n      expect(transportFactory2).toHaveBeenCalledWith({\n        loggerServiceFactory: loggerFactory,\n        config,\n        apduSenderServiceFactory: apduSenderService,\n        apduReceiverServiceFactory: apduReceiverService,\n        deviceModelDataSource,\n      });\n    });\n\n    it(\"throw if transport already exists\", () => {\n      try {\n        transportService.addTransport(transportFactory);\n      } catch (error) {\n        expect(error).toBeInstanceOf(TransportAlreadyExistsError);\n      }\n    });\n  });\n\n  describe(\"getTransport\", () => {\n    beforeEach(() => {\n      transportService = new DefaultTransportService(\n        [transportFactory],\n        config,\n        loggerFactory,\n        deviceModelDataSource,\n        apduSenderService,\n        apduReceiverService,\n      );\n    });\n\n    it(\"returns the transport\", () => {\n      const t = transportService.getTransport(\"transport\");\n      expect(t).toEqual(Maybe.of(transport));\n    });\n\n    it(\"returns Nothing if the transport identifier does not exist\", () => {\n      const t = transportService.getTransport(\"transport2\");\n      expect(t).toEqual(Maybe.empty());\n    });\n  });\n\n  describe(\"getAllTransports\", () => {\n    it(\"returns all transports (1 transport)\", () => {\n      transportService = new DefaultTransportService(\n        [transportFactory],\n        config,\n        loggerFactory,\n        deviceModelDataSource,\n        apduSenderService,\n        apduReceiverService,\n      );\n      const transports = transportService.getAllTransports();\n      expect(transports).toEqual([transport]);\n    });\n\n    it(\"returns all transports (2 transports)\", () => {\n      transportService = new DefaultTransportService(\n        [transportFactory, transportFactory2],\n        config,\n        loggerFactory,\n        deviceModelDataSource,\n        apduSenderService,\n        apduReceiverService,\n      );\n\n      const transports = transportService.getAllTransports();\n      expect(transports).toEqual([transport, transport2]);\n    });\n  });\n});\n"],
  "mappings": "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",
  "names": ["Maybe", "StaticDeviceModelDataSource", "defaultApduReceiverServiceStubBuilder", "defaultApduSenderServiceStubBuilder", "TransportMock", "NoTransportProvidedError", "TransportAlreadyExistsError", "DefaultLoggerPublisherService", "DefaultTransportService", "apduSenderService", "apduReceiverService", "logger", "config", "transportFactory", "transport", "transportFactory2", "transport2", "deviceModelDataSource", "transportService", "loggerFactory", "spy", "error", "transports", "t"]
}

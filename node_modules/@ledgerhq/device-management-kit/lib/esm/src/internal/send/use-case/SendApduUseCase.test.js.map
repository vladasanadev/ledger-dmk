{
  "version": 3,
  "sources": ["../../../../../../src/internal/send/use-case/SendApduUseCase.test.ts"],
  "sourcesContent": ["import { Left } from \"purify-ts\";\n\nimport { type DmkConfig } from \"@api/DmkConfig\";\nimport { type LoggerPublisherService } from \"@api/logger-publisher/service/LoggerPublisherService\";\nimport { connectedDeviceStubBuilder } from \"@api/transport/model/TransportConnectedDevice.stub\";\nimport { DEVICE_SESSION_REFRESHER_DEFAULT_OPTIONS } from \"@internal/device-session/data/DeviceSessionRefresherConst\";\nimport { deviceSessionStubBuilder } from \"@internal/device-session/model/DeviceSession.stub\";\nimport {\n  DeviceSessionNotFound,\n  ReceiverApduError,\n} from \"@internal/device-session/model/Errors\";\nimport { DefaultDeviceSessionService } from \"@internal/device-session/service/DefaultDeviceSessionService\";\nimport { type DeviceSessionService } from \"@internal/device-session/service/DeviceSessionService\";\nimport { DefaultLoggerPublisherService } from \"@internal/logger-publisher/service/DefaultLoggerPublisherService\";\nimport { AxiosManagerApiDataSource } from \"@internal/manager-api/data/AxiosManagerApiDataSource\";\nimport { type ManagerApiDataSource } from \"@internal/manager-api/data/ManagerApiDataSource\";\nimport { DefaultManagerApiService } from \"@internal/manager-api/service/DefaultManagerApiService\";\nimport { type ManagerApiService } from \"@internal/manager-api/service/ManagerApiService\";\nimport { DefaultSecureChannelDataSource } from \"@internal/secure-channel/data/DefaultSecureChannelDataSource\";\nimport { type SecureChannelDataSource } from \"@internal/secure-channel/data/SecureChannelDataSource\";\nimport { DefaultSecureChannelService } from \"@internal/secure-channel/service/DefaultSecureChannelService\";\nimport { type SecureChannelService } from \"@internal/secure-channel/service/SecureChannelService\";\nimport { SendApduUseCase } from \"@internal/send/use-case/SendApduUseCase\";\n\nvi.mock(\"@internal/manager-api/data/AxiosManagerApiDataSource\");\n\nlet logger: LoggerPublisherService;\nlet sessionService: DeviceSessionService;\nlet managerApiDataSource: ManagerApiDataSource;\nlet managerApi: ManagerApiService;\nlet secureChannelDataSource: SecureChannelDataSource;\nlet secureChannel: SecureChannelService;\nconst fakeSessionId = \"fakeSessionId\";\n\ndescribe(\"SendApduUseCase\", () => {\n  beforeEach(() => {\n    logger = new DefaultLoggerPublisherService([], \"send-apdu-use-case\");\n    sessionService = new DefaultDeviceSessionService(() => logger);\n    managerApiDataSource = new AxiosManagerApiDataSource({} as DmkConfig);\n    managerApi = new DefaultManagerApiService(managerApiDataSource);\n    secureChannelDataSource = new DefaultSecureChannelDataSource(\n      {} as DmkConfig,\n    );\n    secureChannel = new DefaultSecureChannelService(secureChannelDataSource);\n  });\n\n  it(\"should send an APDU to a connected device\", async () => {\n    // given\n    const deviceSession = deviceSessionStubBuilder(\n      {},\n      () => logger,\n      managerApi,\n      secureChannel,\n      DEVICE_SESSION_REFRESHER_DEFAULT_OPTIONS,\n    );\n    sessionService.addDeviceSession(deviceSession);\n    const useCase = new SendApduUseCase(sessionService, () => logger);\n\n    // when\n    const response = await useCase.execute({\n      sessionId: fakeSessionId,\n      apdu: new Uint8Array([0x00, 0x01, 0x02, 0x03]),\n    });\n\n    deviceSession.close();\n    // then\n    expect(deviceSession.connectedDevice.sendApdu).toHaveBeenCalledTimes(1);\n    expect(response).toBeDefined();\n  });\n\n  it(\"should throw an error if the deviceSession is not found\", async () => {\n    // given\n    const useCase = new SendApduUseCase(sessionService, () => logger);\n\n    // when\n    const response = useCase.execute({\n      sessionId: fakeSessionId,\n      apdu: new Uint8Array([0x00, 0x01, 0x02, 0x03]),\n    });\n\n    // then\n    await expect(response).rejects.toBeInstanceOf(DeviceSessionNotFound);\n  });\n\n  it(\"should throw an error if the apdu receiver failed\", async () => {\n    // given\n    const connectedDevice = connectedDeviceStubBuilder({\n      sendApdu: vi.fn(async () =>\n        Promise.resolve(Left(new ReceiverApduError())),\n      ),\n    });\n    const deviceSession = deviceSessionStubBuilder(\n      { connectedDevice },\n      () => logger,\n      managerApi,\n      secureChannel,\n      DEVICE_SESSION_REFRESHER_DEFAULT_OPTIONS,\n    );\n    sessionService.addDeviceSession(deviceSession);\n    const useCase = new SendApduUseCase(sessionService, () => logger);\n\n    // when\n    const response = useCase.execute({\n      sessionId: fakeSessionId,\n      apdu: new Uint8Array([0x00, 0x01, 0x02, 0x03]),\n    });\n\n    deviceSession.close();\n\n    // then\n    await expect(response).rejects.toBeInstanceOf(ReceiverApduError);\n  });\n});\n"],
  "mappings": "AAAA,OAAS,QAAAA,MAAY,YAIrB,OAAS,8BAAAC,MAAkC,qDAC3C,OAAS,4CAAAC,MAAgD,4DACzD,OAAS,4BAAAC,MAAgC,oDACzC,OACE,yBAAAC,EACA,qBAAAC,MACK,wCACP,OAAS,+BAAAC,MAAmC,+DAE5C,OAAS,iCAAAC,MAAqC,mEAC9C,OAAS,6BAAAC,MAAiC,uDAE1C,OAAS,4BAAAC,MAAgC,yDAEzC,OAAS,kCAAAC,MAAsC,+DAE/C,OAAS,+BAAAC,MAAmC,+DAE5C,OAAS,mBAAAC,MAAuB,0CAEhC,GAAG,KAAK,sDAAsD,EAE9D,IAAIC,EACAC,EACAC,EACAC,EACAC,EACAC,EACJ,MAAMC,EAAgB,gBAEtB,SAAS,kBAAmB,IAAM,CAChC,WAAW,IAAM,CACfN,EAAS,IAAIN,EAA8B,CAAC,EAAG,oBAAoB,EACnEO,EAAiB,IAAIR,EAA4B,IAAMO,CAAM,EAC7DE,EAAuB,IAAIP,EAA0B,CAAC,CAAc,EACpEQ,EAAa,IAAIP,EAAyBM,CAAoB,EAC9DE,EAA0B,IAAIP,EAC5B,CAAC,CACH,EACAQ,EAAgB,IAAIP,EAA4BM,CAAuB,CACzE,CAAC,EAED,GAAG,4CAA6C,SAAY,CAE1D,MAAMG,EAAgBjB,EACpB,CAAC,EACD,IAAMU,EACNG,EACAE,EACAhB,CACF,EACAY,EAAe,iBAAiBM,CAAa,EAI7C,MAAMC,EAAW,MAHD,IAAIT,EAAgBE,EAAgB,IAAMD,CAAM,EAGjC,QAAQ,CACrC,UAAWM,EACX,KAAM,IAAI,WAAW,CAAC,EAAM,EAAM,EAAM,CAAI,CAAC,CAC/C,CAAC,EAEDC,EAAc,MAAM,EAEpB,OAAOA,EAAc,gBAAgB,QAAQ,EAAE,sBAAsB,CAAC,EACtE,OAAOC,CAAQ,EAAE,YAAY,CAC/B,CAAC,EAED,GAAG,0DAA2D,SAAY,CAKxE,MAAMA,EAHU,IAAIT,EAAgBE,EAAgB,IAAMD,CAAM,EAGvC,QAAQ,CAC/B,UAAWM,EACX,KAAM,IAAI,WAAW,CAAC,EAAM,EAAM,EAAM,CAAI,CAAC,CAC/C,CAAC,EAGD,MAAM,OAAOE,CAAQ,EAAE,QAAQ,eAAejB,CAAqB,CACrE,CAAC,EAED,GAAG,oDAAqD,SAAY,CAElE,MAAMkB,EAAkBrB,EAA2B,CACjD,SAAU,GAAG,GAAG,SACd,QAAQ,QAAQD,EAAK,IAAIK,CAAmB,CAAC,CAC/C,CACF,CAAC,EACKe,EAAgBjB,EACpB,CAAE,gBAAAmB,CAAgB,EAClB,IAAMT,EACNG,EACAE,EACAhB,CACF,EACAY,EAAe,iBAAiBM,CAAa,EAI7C,MAAMC,EAHU,IAAIT,EAAgBE,EAAgB,IAAMD,CAAM,EAGvC,QAAQ,CAC/B,UAAWM,EACX,KAAM,IAAI,WAAW,CAAC,EAAM,EAAM,EAAM,CAAI,CAAC,CAC/C,CAAC,EAEDC,EAAc,MAAM,EAGpB,MAAM,OAAOC,CAAQ,EAAE,QAAQ,eAAehB,CAAiB,CACjE,CAAC,CACH,CAAC",
  "names": ["Left", "connectedDeviceStubBuilder", "DEVICE_SESSION_REFRESHER_DEFAULT_OPTIONS", "deviceSessionStubBuilder", "DeviceSessionNotFound", "ReceiverApduError", "DefaultDeviceSessionService", "DefaultLoggerPublisherService", "AxiosManagerApiDataSource", "DefaultManagerApiService", "DefaultSecureChannelDataSource", "DefaultSecureChannelService", "SendApduUseCase", "logger", "sessionService", "managerApiDataSource", "managerApi", "secureChannelDataSource", "secureChannel", "fakeSessionId", "deviceSession", "response", "connectedDevice"]
}
